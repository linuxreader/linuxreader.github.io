<!DOCTYPE html>
<html lang="en-us" dir="ltr" itemscope itemtype="http://schema.org/Article" data-r-output-format="print">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="height=device-height, width=device-width, initial-scale=1.0, minimum-scale=1.0">
    <meta name="generator" content="Hugo 0.152.2">
    <meta name="generator" content="Relearn 8.2.0+d150cc8909ed7836ff5d545e76544f6923ffacf5">
    <meta name="description" content="SSH Connections">
    <meta name="author" content="David Thomas">
    <meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="SSH Connections :: Linux Reader">
    <meta name="twitter:description" content="SSH Connections">
    <meta property="og:url" content="http://linuxreader.com/ansible/ssh-connections/">
    <meta property="og:site_name" content="Linux Reader">
    <meta property="og:title" content="SSH Connections :: Linux Reader">
    <meta property="og:description" content="SSH Connections">
    <meta property="og:locale" content="en_us">
    <meta property="og:type" content="article">
    <meta property="article:section" content="Ansible">
    <meta itemprop="name" content="SSH Connections :: Linux Reader">
    <meta itemprop="description" content="SSH Connections">
    <meta itemprop="wordCount" content="1186">
    <title>SSH Connections :: Linux Reader</title>
    <link href="http://linuxreader.com/ansible/ssh-connections/" rel="canonical" type="text/html" title="SSH Connections :: Linux Reader">
    <link href="/ansible/ssh-connections/index.xml" rel="alternate" type="application/rss+xml" title="SSH Connections :: Linux Reader">
    <link href="/images/favicon.svg?1765108392" rel="icon" type="image/svg+xml">
    <link href="/css/auto-complete/auto-complete.min.css?1765108392" rel="stylesheet">
    <script src="/js/auto-complete/auto-complete.min.js?1765108392" defer></script>
    <script src="/js/search-lunr.min.js?1765108392" defer></script>
    <script src="/js/search.min.js?1765108392" defer></script>
    <script>
      window.relearn = window.relearn || {};
      window.relearn.index_js_url="/searchindex.en.js?1765108392";
    </script>
    <script src="/js/lunr/lunr.min.js?1765108392" defer></script>
    <script src="/js/lunr/lunr.stemmer.support.min.js?1765108392" defer></script>
    <script src="/js/lunr/lunr.multi.min.js?1765108392" defer></script>
    <script src="/js/lunr/lunr.en.min.js?1765108392" defer></script>
    <script>
      window.relearn = window.relearn || {};
      window.relearn.contentLangs=['en'];
    </script>
    <link href="/fonts/fontawesome/css/fontawesome-all.min.css?1765108392" rel="stylesheet" media="print" onload="this.media='all';this.onload=null;"><noscript><link href="/fonts/fontawesome/css/fontawesome-all.min.css?1765108392" rel="stylesheet"></noscript>
    <link href="/css/perfect-scrollbar/perfect-scrollbar.min.css?1765108392" rel="stylesheet">
    <link href="/css/theme.min.css?1765108392" rel="stylesheet">
    <link href="/css/format-print.min.css?1765108392" rel="stylesheet" id="R-format-style">
    <script>
      window.relearn = window.relearn || {};
      // configuration
      window.relearn.min = `.min`;
      window.relearn.path='\/ansible\/ssh-connections\/';
      window.relearn.relBasePath='..\/..';
      window.relearn.relBaseUri='..\/..';
      window.relearn.absBaseUri='http:\/\/linuxreader.com';
      window.relearn.disableAnchorCopy=false;
      window.relearn.disableAnchorScrolling=false;
      window.relearn.disableInlineCopyToClipboard=true;
      window.relearn.enableBlockCodeWrap=true;
      // legal
      window.relearn.getItem = (s,n) => {return s.getItem(n)};
      window.relearn.setItem = (s,n,v) => {return s.setItem(n,v)};
      window.relearn.removeItem = (s,n) => {return s.removeItem(n)};
      // translations
      window.T_Copy_to_clipboard = `Copy to clipboard`;
      window.T_Copied_to_clipboard = `Copied to clipboard!`;
      window.T_Copy_link_to_clipboard = `Copy link to clipboard`;
      window.T_Link_copied_to_clipboard = `Copied link to clipboard!`;
      window.T_Reset_view = `Reset view`;
      window.T_View_reset = `View reset!`;
      window.T_No_results_found = `No results found for "{0}"`;
      window.T_N_results_found = `{1} results found for "{0}"`;
      // variant stuff
      window.relearn.themevariants = [ 'oled' ];
      window.relearn.customvariantname = "my-custom-variant";
      window.relearn.changeVariant = function(variant) {
        var oldVariant = document.documentElement.dataset.rThemeVariant;
        window.relearn.setItem(window.localStorage, window.relearn.absBaseUri + "/variant", variant);
        document.documentElement.dataset.rThemeVariant = variant;
        if (oldVariant != variant) {
          document.dispatchEvent( new CustomEvent('themeVariantLoaded', { detail: { variant, oldVariant } }) );
          window.relearn.markVariant();
        }
      }
      window.relearn.markVariant = function() {
        var variant = window.relearn.getItem(window.localStorage, window.relearn.absBaseUri + "/variant");
        document.querySelectorAll(".R-variantswitcher select").forEach((select) => {select.value = variant;});
      }
      window.relearn.initVariant = function() {
        var variant = window.relearn.getItem(window.localStorage, window.relearn.absBaseUri + "/variant") ?? "";
        if( variant == window.relearn.customvariantname ){
        }else if( !variant || !window.relearn.themevariants.includes(variant) ){
          variant = window.relearn.themevariants[0];
          window.relearn.setItem(window.localStorage, window.relearn.absBaseUri + "/variant", variant);
        }
        document.documentElement.dataset.rThemeVariant = variant;
      }
      window.relearn.initVariant();
      window.relearn.markVariant();
    </script>




   
   <!-- Thanks for using github/divinerites/plausible-hugo v1.22.0. Please, consider leaving a star on Github if you like it. -->











    
        <link rel="preconnect" href="https://https://analytics.linuxreader.com:8443">
    
        
            
            <script defer  data-domain="linuxreader.com" src="https://https://analytics.linuxreader.com:8443/js/script.js" ></script>

<!-- If you are using Content-Security-Policy, do not forget to add this code to your CSP : 
  script-src 'unsafe-inline' https://https://analytics.linuxreader.com:8443
  connect-src 'unsafe-inline' https://https://analytics.linuxreader.com:8443
  or just add the partial 'plausible_csp.html' to those 2 csp directives in your 'index.headers' file
-->



    
    <script>window.plausible = window.plausible || function() { (window.plausible.q = window.plausible.q || []).push(arguments) }</script>
    <script>
         
         
         
    </script>

    

<style>
:root {
    --MENU-WIDTH-S: 14.375rem;
    --MENU-WIDTH-M: 14.375rem;
    --MENU-WIDTH-L: 18.75rem;
    --MAIN-WIDTH-MAX: 80rem;
    font-size: 1.2rem;
}
</style>

  </head>
  <body class="mobile-support print" data-url="/ansible/ssh-connections/">
    <div id="R-body" class="default-animation">
      <div id="R-body-overlay"></div>
      <nav id="R-topbar">
        <div class="topbar-wrapper">
          <div class="topbar-sidebar-divider"></div>
          <div class="topbar-area topbar-area-start" data-area="start">
            <div class="topbar-button topbar-button-sidebar" data-content-empty="disable" data-width-s="show" data-width-m="hide" data-width-l="hide">
<span class="btn cstyle link noborder notitle interactive"><button onclick="toggleNav()" type="button" title="Menu (CTRL&#43;ALT&#43;n)"><i class="fa-fw fas fa-bars"></i></button></span>
            </div>
            <div class="topbar-button topbar-button-prev" data-content-empty="disable" data-width-s="show" data-width-m="show" data-width-l="show">
<span class="btn cstyle link noborder notitle interactive"><a href="/ansible/setting-up-an-ansible-lab/" title="Setting up an Ansible Lab (ü°ê)"><i class="fa-fw fas fa-chevron-left"></i></a></span>
            </div>

            <div class="topbar-button topbar-button-toc" data-content-empty="hide" data-width-s="show" data-width-m="show" data-width-l="show">
<span class="btn cstyle link noborder notitle interactive"><button onclick="toggleTopbarFlyout(this)" type="button" title="Table of Contents (CTRL&#43;ALT&#43;t)"><i class="fa-fw fas fa-list-alt"></i></button></span>
              <div class="topbar-content">
                <div class="topbar-content-wrapper">
<nav class="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#managing-ssh-connections">Managing SSH Connections</a></li>
      </ul>
    </li>
  </ul>
</nav>
                </div>
              </div>
            </div>


          </div>
          <span class="topbar-breadcrumbs highlightable">
            SSH Connections
          </span>
          <div class="topbar-area topbar-area-end" data-area="end">
            <div class="topbar-button topbar-button-print" data-content-empty="disable" data-width-s="area-more" data-width-m="show" data-width-l="show">
<span class="btn cstyle link noborder notitle interactive"><a href="/ansible/ssh-connections/index.print.html" title="Print whole chapter (CTRL+ALT+p)"><i class="fa-fw fas fa-print"></i></a></span>
            </div>

            <div class="topbar-button topbar-button-next" data-content-empty="disable" data-width-s="show" data-width-m="show" data-width-l="show">
<span class="btn cstyle link noborder notitle interactive"><a href="/ansible/troubleshooting-common-scenarios/" title="Troubleshooting Common Scenarios (ü°í)"><i class="fa-fw fas fa-chevron-right"></i></a></span>
            </div>







          </div>
        </div>
      </nav>
      <div id="R-main-overlay"></div>
      <main id="R-body-inner" class="highlightable ansible" tabindex="-1">
        <div class="flex-block-wrapper">
<article class="default">
  <header class="headline">
  </header>

<h1 id="ssh-connections">SSH Connections</h1>

<h3 id="managing-ssh-connections">Managing SSH Connections</h3>
<ul>
<li>How to provide for SSH keys for new users in such a way that users are provided with SSH keys without having to set them up themselves.</li>
<li>To do this, you use the authorized_key module together with the¬†<strong>generate_ssh_key</strong>¬†argument to the user module.</li>
</ul>
<h4 id="understanding-ssh-connection-management-requirements">Understanding SSH Connection Management Requirements</h4>
<p>How SSH keys are used in the communication process between a user and an SSH server:</p>
<ol>
<li>The user initiates a session with an SSH server.</li>
<li>The server sends back an identification token that is encrypted with the server private key to the user.</li>
<li>The user uses the server‚Äôs public key fingerprint, which is stored in the ~/.ssh/known_hosts file to verify the identification token.</li>
<li>If no public key fingerprint was stored yet in the ~/.ssh/known_hosts file, the user is prompted to store the remote server identity in the ~/.ssh/known_hosts file. At this point there is no good way to verify whether the user is indeed communicating with the intended server.</li>
<li>After establishing the identity of the remote server, the user can either send over a password or generate an authentication token that is based on the user‚Äôs private key.</li>
<li>If an authentication token that was based on the user‚Äôs private key is sent over, this token is received by the server, which tries to match it against the user‚Äôs public key that is stored in the ~/.ssh/authorized_keys file.</li>
<li>After the incoming authentication token to the stored user public key in the authorized_keys file is matched, the user is authenticated. If this authentication fails and password authentication is allowed, password authentication is attempted next.</li>
</ol>
<p>In the authentication procedure, two key pairs play an important role. First, there is the server‚Äôs public/private key pair, which is used to establish a secure connection.
To manage the host public key, you can use the Ansible known_hosts module. Next, there is the user‚Äôs public/private key pair, which the user uses to authenticate. To manage the public key in this key pair, you can use the Ansible authorized_key module.</p>
<h4 id="lookup-plug-in">Lookup Plug-in</h4>
<ul>
<li>Enables Ansible to access data from outside sources.</li>
<li>Read the file system or contact external datastores and services.</li>
<li>Ran on the Ansible control host.</li>
<li>Results are usually stored in variables or templates.</li>
</ul>
<p>Set the value of a variable to the contents of a file:</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yml" data-lang="yml"><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span>- <span style="color:#ff6ac1">name</span>: simple demo with the lookup plugin
</span></span><span style="display:flex;"><span>  <span style="color:#ff6ac1">hosts</span>: localhost
</span></span><span style="display:flex;"><span>  <span style="color:#ff6ac1">vars</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">file_contents</span>: <span style="color:#5af78e">&#34;{{lookup(‚Äòfile‚Äô, ‚Äò/etc/hosts‚Äô)}}&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff6ac1">tasks</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ff6ac1">debug</span>:
</span></span><span style="display:flex;"><span>                <span style="color:#ff6ac1">var</span>: file_contents</span></span></code></pre></div>
<h4 id="setting-up-ssh-user-keys">Setting Up SSH User Keys</h4>
<ul>
<li>To use SSH to connect to a user account on a managed host you can copy over the local user public key to the remote user ~/.ssh/authorized_keys file.</li>
<li>If the target authorized_keys file just has to contain one single key, you could use the copy module to copy it over.</li>
<li>To manage multiple keys in the remote user authorized_keys file, you‚Äôre better off using the authorized_key module.</li>
</ul>
<p>authorized_key module</p>
<ul>
<li>Copy the authorized_key for a user</li>
<li>/home/ansible/.ssh/id_rsa.pub is used as the source.</li>
<li>lookup plug-in is used to refer to the file contents that should be used:</li>
</ul>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yml" data-lang="yml"><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span>- <span style="color:#ff6ac1">name</span>: authorized_key simple demo
</span></span><span style="display:flex;"><span>  <span style="color:#ff6ac1">hosts</span>: ansible2
</span></span><span style="display:flex;"><span>  <span style="color:#ff6ac1">tasks</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ff6ac1">name</span>: copy authorized key for ansible user
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">authorized_key</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">user</span>: ansible
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">state</span>: present
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">key</span>: <span style="color:#5af78e">&#34;{{ lookup(‚Äòfile‚Äô, ‚Äò/home/ansible/.ssh/id_rsa.pub‚Äô) }}&#34;</span></span></span></code></pre></div>
<p>Do the same for multiple users:
vars/users</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yml" data-lang="yml"><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span><span style="color:#ff6ac1">users</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ff6ac1">username</span>: linda
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">groups</span>: sales
</span></span><span style="display:flex;"><span>  - <span style="color:#ff6ac1">username</span>: lori
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">groups</span>: sales
</span></span><span style="display:flex;"><span>  - <span style="color:#ff6ac1">username</span>: lisa
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">groups</span>: account
</span></span><span style="display:flex;"><span>  - <span style="color:#ff6ac1">username</span>: lucy
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">groups</span>: account</span></span></code></pre></div>
<p>vars/groups</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yml" data-lang="yml"><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span><span style="color:#ff6ac1">usergroups</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ff6ac1">groupname</span>: sales
</span></span><span style="display:flex;"><span>  - <span style="color:#ff6ac1">groupname</span>: account</span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yml" data-lang="yml"><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span>- <span style="color:#ff6ac1">name</span>: configure users with SSH keys
</span></span><span style="display:flex;"><span>  <span style="color:#ff6ac1">hosts</span>: ansible2
</span></span><span style="display:flex;"><span>  <span style="color:#ff6ac1">vars_files</span>:
</span></span><span style="display:flex;"><span>    - vars/users
</span></span><span style="display:flex;"><span>    - vars/groups
</span></span><span style="display:flex;"><span>  <span style="color:#ff6ac1">tasks</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ff6ac1">name</span>: add groups
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">group</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">name</span>: <span style="color:#5af78e">&#34;{{ item.groupname }}&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">loop</span>: <span style="color:#5af78e">&#34;{{ usergroups }}&#34;</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#ff6ac1">name</span>: add users
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">user</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">name</span>: <span style="color:#5af78e">&#34;{{ item.username }}&#34;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">groups</span>: <span style="color:#5af78e">&#34;{{ item.groups }}&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">loop</span>: <span style="color:#5af78e">&#34;{{ users }}&#34;</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#ff6ac1">name</span>: add SSH public keys
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">authorized_key</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">user</span>: <span style="color:#5af78e">&#34;{{ item.username }}&#34;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">key</span>: <span style="color:#5af78e">&#34;{{ lookup(‚Äòfile‚Äô, ‚Äòfiles/‚Äô+ item.username + ‚Äò/id_rsa.pub‚Äô) }}&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">loop</span>: <span style="color:#5af78e">&#34;{{ users }}&#34;</span></span></span></code></pre></div>
<ul>
<li>
<p>authorized_key module is set up to work on¬†<strong>item.username</strong>, using a¬†<strong>loop</strong>¬†on the¬†<strong>users</strong>¬†variable.</p>
</li>
<li>
<p>The id_rsa.pub files that have to be copied over are expected to exist in the files directory, which exists in the current project directory.</p>
</li>
<li>
<p>Copying over the user public keys to the project directory is a solution because the authorized_keys module cannot read files from a hidden directory.</p>
</li>
<li>
<p>It would be much nicer to use¬†<strong>key: ‚Äú{{ lookup(‚Äòfile‚Äô, ‚Äò/home/‚Äô+ item.username + ‚Äò.ssh/id_rsa.pub‚Äô) }}‚Äù</strong>, but that doesn‚Äôt work.</p>
</li>
<li>
<p>In the first task you create a local user, including an SSH key.</p>
</li>
<li>
<p>Because an SSH key should include the name of the user and host that it applies to, you need to use the¬†<strong>generate_ssh_key</strong>¬†argument, as well as the¬†<strong>ssh_key_comment</strong>¬†argument to write the correct comment into the public key.</p>
</li>
<li>
<p>Without this content, the key will have generic content and not be considered a valid key.</p>
</li>
</ul>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yml" data-lang="yml"><span style="display:flex;"><span>- <span style="color:#ff6ac1">name</span>: create the local user, including SSH key
</span></span><span style="display:flex;"><span>  <span style="color:#ff6ac1">user</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">name</span>: <span style="color:#5af78e">&#34;{{ username }}&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">generate_ssh_key</span>: <span style="color:#ff6ac1">true</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">ssh_key_comment</span>: <span style="color:#5af78e">&#34;{{ username }}@{{ ansible_fqdn }}&#34;</span></span></span></code></pre></div>
<ul>
<li>After creating the SSH keys this way, you aren‚Äôt able to fetch the key directly from the user home directory.</li>
<li>To fix that problem, you create a directory with the name of the user in the project directory and copy the user public key from there by using the shell module:</li>
</ul>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yml" data-lang="yml"><span style="display:flex;"><span>- <span style="color:#ff6ac1">name</span>: create a directory to store the file
</span></span><span style="display:flex;"><span>  <span style="color:#ff6ac1">file</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">name</span>: <span style="color:#5af78e">&#34;{{ username }}&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">state</span>: directory
</span></span><span style="display:flex;"><span>- <span style="color:#ff6ac1">name</span>: copy the local user ssh key to temporary {{ username }} key
</span></span><span style="display:flex;"><span>  <span style="color:#ff6ac1">shell</span>: ‚Äòcat /home/{{ username }}/.ssh/id_rsa.pub &gt; {{ username }}/id_rsa.pub‚Äô
</span></span><span style="display:flex;"><span>- <span style="color:#ff6ac1">name</span>: verify that file exists
</span></span><span style="display:flex;"><span>  <span style="color:#ff6ac1">command</span>: ls -l {{ username }}/</span></span></code></pre></div>
<ul>
<li>Next, in the second play you create the remote user and use the authorized_key module to copy the key from the temporary directory to the new user home directory.</li>
</ul>
<p><strong>Exercise 13-2 Managing Users with SSH Keys</strong>
Steps</p>
<ol>
<li>Create a user on localhost.</li>
<li>Use the appropriate arguments to create the SSH public/private key pair according to the required format.</li>
<li>Make sure the public key is copied to a directory where it can be accessed.</li>
<li>Uses the user module to create the user, as well as the authorized_key module to fetch the key from localhost and copy it to the .ssh/authorized_keys file in the remote user home directory.</li>
<li>Use the command¬†<strong>ansible-playbook exercise132.yaml -e username=radha</strong>¬†to create the user radha with the appropriate SSH keys.</li>
<li>To verify it has worked, use¬†<strong>sudo su - radha</strong>¬†on the control host, and type the command¬†<strong>ssh ansible1</strong>. You should able to log in without entering a password.</li>
</ol>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yml" data-lang="yml"><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span>- <span style="color:#ff6ac1">name</span>: prepare localhost
</span></span><span style="display:flex;"><span>  <span style="color:#ff6ac1">hosts</span>: localhost
</span></span><span style="display:flex;"><span>  <span style="color:#ff6ac1">tasks</span>:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  - <span style="color:#ff6ac1">name</span>: create the local user, including SSH key
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">user</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">name</span>: <span style="color:#5af78e">&#34;{{ username }}&#34;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">generate_ssh_key</span>: <span style="color:#ff6ac1">true</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">ssh_key_comment</span>: <span style="color:#5af78e">&#34;{{ username }}@{{ ansible_fqdn }}&#34;</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>  - <span style="color:#ff6ac1">name</span>: create a directory to store the file
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">file</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">name</span>: <span style="color:#5af78e">&#34;{{ username }}&#34;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">state</span>: directory
</span></span><span style="display:flex;"><span>      
</span></span><span style="display:flex;"><span>  - <span style="color:#ff6ac1">name</span>: copy the local user ssh key to temporary {{ username }} key
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">shell</span>: ‚Äòcat /home/{{ username }}/.ssh/id_rsa.pub &gt; {{ username }}/id_rsa.pub‚Äô
</span></span><span style="display:flex;"><span>  - <span style="color:#ff6ac1">name</span>: verify that file exists
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">command</span>: ls -l {{ username }}/
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>- <span style="color:#ff6ac1">name</span>: setup remote host
</span></span><span style="display:flex;"><span>  <span style="color:#ff6ac1">hosts</span>: ansible1
</span></span><span style="display:flex;"><span>  <span style="color:#ff6ac1">tasks</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ff6ac1">name</span>: create remote user, no need for SSH key
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">user</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">name</span>: <span style="color:#5af78e">&#34;{{ username }}&#34;</span>
</span></span><span style="display:flex;"><span>      
</span></span><span style="display:flex;"><span>  - <span style="color:#ff6ac1">name</span>: use authorized_key to set the password
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">authorized_key</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">user</span>: <span style="color:#5af78e">&#34;{{ username }}&#34;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">key</span>: <span style="color:#5af78e">&#34;{{ lookup(‚Äòfile‚Äô, ‚Äò./‚Äô+ username +‚Äô/id_rsa.pub‚Äô) }}&#34;</span></span></span></code></pre></div>

  <footer class="footline">
  </footer>
</article>
        </div>
      </main>
    </div>
    <script>
      window.MathJax = Object.assign( window.MathJax || {}, {
        tex: {
          inlineMath:  [['\\(', '\\)'], ['$',  '$']],  
          displayMath: [['\\[', '\\]'], ['$$', '$$']], 
        },
        options: {
          enableMenu: false 
        }
      }, JSON.parse("{}") );
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="/js/js-yaml/js-yaml.min.js?1765108392" defer></script>
    <script src="/js/d3/d3-color.min.js?1765108392" defer></script>
    <script src="/js/d3/d3-dispatch.min.js?1765108392" defer></script>
    <script src="/js/d3/d3-drag.min.js?1765108392" defer></script>
    <script src="/js/d3/d3-ease.min.js?1765108392" defer></script>
    <script src="/js/d3/d3-interpolate.min.js?1765108392" defer></script>
    <script src="/js/d3/d3-selection.min.js?1765108392" defer></script>
    <script src="/js/d3/d3-timer.min.js?1765108392" defer></script>
    <script src="/js/d3/d3-transition.min.js?1765108392" defer></script>
    <script src="/js/d3/d3-zoom.min.js?1765108392" defer></script>
    <script src="https://unpkg.com/mermaid/dist/mermaid.min.js" defer></script>
    <script>
      window.relearn.themeUseMermaid = JSON.parse("{ \"theme\": \"default\" }");
    </script>
    <script src="/js/clipboard/clipboard.min.js?1765108392" defer></script>
    <script src="/js/perfect-scrollbar/perfect-scrollbar.min.js?1765108392" defer></script>
    <script src="/js/theme.min.js?1765108392" defer></script><script async src="https://eomail5.com/form/d37e6864-cf88-11f0-8615-fbed900cb19e.js" data-form="d37e6864-cf88-11f0-8615-fbed900cb19e"></script>

  </body>
</html>
