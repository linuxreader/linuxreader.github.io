<!DOCTYPE html>
<html lang="en-us" dir="ltr" itemscope itemtype="http://schema.org/Article" data-r-output-format="print">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="height=device-height, width=device-width, initial-scale=1.0, minimum-scale=1.0">
    <meta name="generator" content="Hugo 0.152.2">
    <meta name="generator" content="Relearn 8.2.0+d150cc8909ed7836ff5d545e76544f6923ffacf5">
    <meta name="description" content="Ad Hoc Commands and ScriptingControl NodeDeploying FilesDeploying FilesExecution EnvironmentsInventoryManaging Processes and TasksManaging SoftwareManaging UsersModulesNetworkingPlaybooksRolesStorageTask ControlTroubleshootingVariable and Facts">
    <meta name="author" content="David Thomas">
    <meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="Ansible :: Linux Reader">
    <meta name="twitter:description" content="Ad Hoc Commands and ScriptingControl NodeDeploying FilesDeploying FilesExecution EnvironmentsInventoryManaging Processes and TasksManaging SoftwareManaging UsersModulesNetworkingPlaybooksRolesStorageTask ControlTroubleshootingVariable and Facts">
    <meta property="og:url" content="http://linuxreader.com/ansible/">
    <meta property="og:site_name" content="Linux Reader">
    <meta property="og:title" content="Ansible :: Linux Reader">
    <meta property="og:description" content="Ad Hoc Commands and ScriptingControl NodeDeploying FilesDeploying FilesExecution EnvironmentsInventoryManaging Processes and TasksManaging SoftwareManaging UsersModulesNetworkingPlaybooksRolesStorageTask ControlTroubleshootingVariable and Facts">
    <meta property="og:locale" content="en_us">
    <meta property="og:type" content="website">
    <meta itemprop="name" content="Ansible :: Linux Reader">
    <meta itemprop="description" content="Ad Hoc Commands and ScriptingControl NodeDeploying FilesDeploying FilesExecution EnvironmentsInventoryManaging Processes and TasksManaging SoftwareManaging UsersModulesNetworkingPlaybooksRolesStorageTask ControlTroubleshootingVariable and Facts">
    <meta itemprop="wordCount" content="33">
    <title>Ansible :: Linux Reader</title>
    <link href="http://linuxreader.com/ansible/" rel="canonical" type="text/html" title="Ansible :: Linux Reader">
    <link href="/ansible/index.xml" rel="alternate" type="application/rss+xml" title="Ansible :: Linux Reader">
    <link href="/images/favicon.svg?1762537089" rel="icon" type="image/svg+xml">
    <link href="/css/auto-complete/auto-complete.min.css?1762537089" rel="stylesheet">
    <script src="/js/auto-complete/auto-complete.min.js?1762537089" defer></script>
    <script src="/js/search-lunr.min.js?1762537089" defer></script>
    <script src="/js/search.min.js?1762537089" defer></script>
    <script>
      window.relearn = window.relearn || {};
      window.relearn.index_js_url="/searchindex.en.js?1762537089";
    </script>
    <script src="/js/lunr/lunr.min.js?1762537089" defer></script>
    <script src="/js/lunr/lunr.stemmer.support.min.js?1762537089" defer></script>
    <script src="/js/lunr/lunr.multi.min.js?1762537089" defer></script>
    <script src="/js/lunr/lunr.en.min.js?1762537089" defer></script>
    <script>
      window.relearn = window.relearn || {};
      window.relearn.contentLangs=['en'];
    </script>
    <link href="/fonts/fontawesome/css/fontawesome-all.min.css?1762537089" rel="stylesheet" media="print" onload="this.media='all';this.onload=null;"><noscript><link href="/fonts/fontawesome/css/fontawesome-all.min.css?1762537089" rel="stylesheet"></noscript>
    <link href="/css/perfect-scrollbar/perfect-scrollbar.min.css?1762537089" rel="stylesheet">
    <link href="/css/theme.min.css?1762537089" rel="stylesheet">
    <link href="/css/format-print.min.css?1762537089" rel="stylesheet" id="R-format-style">
    <script>
      window.relearn = window.relearn || {};
      // configuration
      window.relearn.min = `.min`;
      window.relearn.path='\/ansible\/';
      window.relearn.relBasePath='..';
      window.relearn.relBaseUri='..';
      window.relearn.absBaseUri='http:\/\/linuxreader.com';
      window.relearn.disableAnchorCopy=false;
      window.relearn.disableAnchorScrolling=false;
      window.relearn.disableInlineCopyToClipboard=true;
      window.relearn.enableBlockCodeWrap=true;
      // legal
      window.relearn.getItem = (s,n) => {return s.getItem(n)};
      window.relearn.setItem = (s,n,v) => {return s.setItem(n,v)};
      window.relearn.removeItem = (s,n) => {return s.removeItem(n)};
      // translations
      window.T_Copy_to_clipboard = `Copy to clipboard`;
      window.T_Copied_to_clipboard = `Copied to clipboard!`;
      window.T_Copy_link_to_clipboard = `Copy link to clipboard`;
      window.T_Link_copied_to_clipboard = `Copied link to clipboard!`;
      window.T_Reset_view = `Reset view`;
      window.T_View_reset = `View reset!`;
      window.T_No_results_found = `No results found for "{0}"`;
      window.T_N_results_found = `{1} results found for "{0}"`;
      // variant stuff
      window.relearn.themevariants = [ 'oled' ];
      window.relearn.customvariantname = "my-custom-variant";
      window.relearn.changeVariant = function(variant) {
        var oldVariant = document.documentElement.dataset.rThemeVariant;
        window.relearn.setItem(window.localStorage, window.relearn.absBaseUri + "/variant", variant);
        document.documentElement.dataset.rThemeVariant = variant;
        if (oldVariant != variant) {
          document.dispatchEvent( new CustomEvent('themeVariantLoaded', { detail: { variant, oldVariant } }) );
          window.relearn.markVariant();
        }
      }
      window.relearn.markVariant = function() {
        var variant = window.relearn.getItem(window.localStorage, window.relearn.absBaseUri + "/variant");
        document.querySelectorAll(".R-variantswitcher select").forEach((select) => {select.value = variant;});
      }
      window.relearn.initVariant = function() {
        var variant = window.relearn.getItem(window.localStorage, window.relearn.absBaseUri + "/variant") ?? "";
        if( variant == window.relearn.customvariantname ){
        }else if( !variant || !window.relearn.themevariants.includes(variant) ){
          variant = window.relearn.themevariants[0];
          window.relearn.setItem(window.localStorage, window.relearn.absBaseUri + "/variant", variant);
        }
        document.documentElement.dataset.rThemeVariant = variant;
      }
      window.relearn.initVariant();
      window.relearn.markVariant();
    </script><style>
:root {
    --MENU-WIDTH-S: 14.375rem;
    --MENU-WIDTH-M: 14.375rem;
    --MENU-WIDTH-L: 18.75rem;
    --MAIN-WIDTH-MAX: 80rem;
    font-size: 1.2rem;
}
</style>

  </head>
  <body class="mobile-support print" data-url="/ansible/">
    <div id="R-body" class="default-animation">
      <div id="R-body-overlay"></div>
      <nav id="R-topbar">
        <div class="topbar-wrapper">
          <div class="topbar-sidebar-divider"></div>
          <div class="topbar-area topbar-area-start" data-area="start">
            <div class="topbar-button topbar-button-sidebar" data-content-empty="disable" data-width-s="show" data-width-m="hide" data-width-l="hide">
<span class="btn cstyle link noborder notitle interactive"><button onclick="toggleNav()" type="button" title="Menu (CTRL&#43;ALT&#43;n)"><i class="fa-fw fas fa-bars"></i></button></span>
            </div>
            <div class="topbar-button topbar-button-prev" data-content-empty="disable" data-width-s="show" data-width-m="show" data-width-l="show">
<span class="btn cstyle link noborder notitle interactive"><a href="/" title="Linux Reader (ðŸ¡)"><i class="fa-fw fas fa-chevron-left"></i></a></span>
            </div>

            <div class="topbar-button topbar-button-toc" data-content-empty="hide" data-width-s="show" data-width-m="show" data-width-l="show">
<span class="btn cstyle link noborder notitle interactive"><button onclick="toggleTopbarFlyout(this)" type="button" title="Table of Contents (CTRL&#43;ALT&#43;t)"><i class="fa-fw fas fa-list-alt"></i></button></span>
              <div class="topbar-content">
                <div class="topbar-content-wrapper"> 
                </div>
              </div>
            </div>


          </div>
          <span class="topbar-breadcrumbs highlightable">
            Ansible
          </span>
          <div class="topbar-area topbar-area-end" data-area="end">
            <div class="topbar-button topbar-button-print" data-content-empty="disable" data-width-s="area-more" data-width-m="show" data-width-l="show">
<span class="btn cstyle link noborder notitle interactive"><a href="/ansible/index.print.html" title="Print whole chapter (CTRL+ALT+p)"><i class="fa-fw fas fa-print"></i></a></span>
            </div>

            <div class="topbar-button topbar-button-next" data-content-empty="disable" data-width-s="show" data-width-m="show" data-width-l="show">
<span class="btn cstyle link noborder notitle interactive"><a href="/ansible/ad-hoc-commands-and-scripting/" title="Ad Hoc Commands and Scripting (ðŸ¡’)"><i class="fa-fw fas fa-chevron-right"></i></a></span>
            </div>







          </div>
        </div>
      </nav>
      <div id="R-main-overlay"></div>
      <main id="R-body-inner" class="highlightable ansible" tabindex="-1">
        <div class="flex-block-wrapper">
<article class="default">
  <header class="headline">
  </header>

<h1 id="ansible">Ansible</h1>

<div class="children children-type-card children-sort-"><ul class="card-container">
<li>
  <article class="card card-popout" aria-labelledby="R-card-ca097a99c423743bad51473b0a6d18db">
    <div class="card-content">
      <div class="card-title" id="R-card-ca097a99c423743bad51473b0a6d18db">
        <a href="/ansible/ad-hoc-commands-and-scripting/">
        Ad Hoc Commands and Scripting
        </a>
      </div>
      <div class="card-content-text">
          <!-- raw HTML omitted -->

      </div>
    </div>
  </article>
</li>
<li>
  <article class="card card-popout" aria-labelledby="R-card-65d2362d89d6ce63fb71c6972c1958b4">
    <div class="card-content">
      <div class="card-title" id="R-card-65d2362d89d6ce63fb71c6972c1958b4">
        <a href="/ansible/control-node/">
        Control Node
        </a>
      </div>
      <div class="card-content-text">
          <!-- raw HTML omitted -->

      </div>
    </div>
  </article>
</li>
<li>
  <article class="card card-popout" aria-labelledby="R-card-0f2d30aa38ea05b7576af37180391d70">
    <div class="card-content">
      <div class="card-title" id="R-card-0f2d30aa38ea05b7576af37180391d70">
        <a href="/ansible/deploying-files/">
        Deploying Files
        </a>
      </div>
      <div class="card-content-text">
          <!-- raw HTML omitted -->

      </div>
    </div>
  </article>
</li>
<li>
  <article class="card card-popout" aria-labelledby="R-card-0f2d30aa38ea05b7576af37180391d70">
    <div class="card-content">
      <div class="card-title" id="R-card-0f2d30aa38ea05b7576af37180391d70">
        <a href="/ansible/deploying-systems/">
        Deploying Files
        </a>
      </div>
      <div class="card-content-text">
          <!-- raw HTML omitted -->

      </div>
    </div>
  </article>
</li>
<li>
  <article class="card card-popout" aria-labelledby="R-card-cfe2d229469758bb1d07c009de11f2ed">
    <div class="card-content">
      <div class="card-title" id="R-card-cfe2d229469758bb1d07c009de11f2ed">
        <a href="/ansible/execution-environments/">
        Execution Environments
        </a>
      </div>
      <div class="card-content-text">
          <!-- raw HTML omitted -->

      </div>
    </div>
  </article>
</li>
<li>
  <article class="card card-popout" aria-labelledby="R-card-2676f328272cf0c0459c483bcfccbc8f">
    <div class="card-content">
      <div class="card-title" id="R-card-2676f328272cf0c0459c483bcfccbc8f">
        <a href="/ansible/inventory/">
        Inventory
        </a>
      </div>
      <div class="card-content-text">
          <!-- raw HTML omitted -->

      </div>
    </div>
  </article>
</li>
<li>
  <article class="card card-popout" aria-labelledby="R-card-33decff74a86007b8c785827213d934f">
    <div class="card-content">
      <div class="card-title" id="R-card-33decff74a86007b8c785827213d934f">
        <a href="/ansible/managing-processes-and-tasks/">
        Managing Processes and Tasks
        </a>
      </div>
      <div class="card-content-text">
          <!-- raw HTML omitted -->

      </div>
    </div>
  </article>
</li>
<li>
  <article class="card card-popout" aria-labelledby="R-card-7cd3a3a558e4c83d7d85987b307d540c">
    <div class="card-content">
      <div class="card-title" id="R-card-7cd3a3a558e4c83d7d85987b307d540c">
        <a href="/ansible/managing-software/">
        Managing Software
        </a>
      </div>
      <div class="card-content-text">
          <!-- raw HTML omitted -->

      </div>
    </div>
  </article>
</li>
<li>
  <article class="card card-popout" aria-labelledby="R-card-758713cfb1bc0700e10c4b002280dc7b">
    <div class="card-content">
      <div class="card-title" id="R-card-758713cfb1bc0700e10c4b002280dc7b">
        <a href="/ansible/managing-users/">
        Managing Users
        </a>
      </div>
      <div class="card-content-text">
          <!-- raw HTML omitted -->

      </div>
    </div>
  </article>
</li>
<li>
  <article class="card card-popout" aria-labelledby="R-card-66036ddf6d03c9ce1fc742741417f128">
    <div class="card-content">
      <div class="card-title" id="R-card-66036ddf6d03c9ce1fc742741417f128">
        <a href="/ansible/modules/">
        Modules
        </a>
      </div>
      <div class="card-content-text">
          <!-- raw HTML omitted -->

      </div>
    </div>
  </article>
</li>
<li>
  <article class="card card-popout" aria-labelledby="R-card-33d12adf4c4e53000e7d571492c50faf">
    <div class="card-content">
      <div class="card-title" id="R-card-33d12adf4c4e53000e7d571492c50faf">
        <a href="/ansible/networking/">
        Networking
        </a>
      </div>
      <div class="card-content-text">
          <!-- raw HTML omitted -->

      </div>
    </div>
  </article>
</li>
<li>
  <article class="card card-popout" aria-labelledby="R-card-1501b12410a2176f0470ad9e2770b984">
    <div class="card-content">
      <div class="card-title" id="R-card-1501b12410a2176f0470ad9e2770b984">
        <a href="/ansible/playbooks/">
        Playbooks
        </a>
      </div>
      <div class="card-content-text">
          <!-- raw HTML omitted -->

      </div>
    </div>
  </article>
</li>
<li>
  <article class="card card-popout" aria-labelledby="R-card-6ed57d9a168fd5c71fdea3b5a532f250">
    <div class="card-content">
      <div class="card-title" id="R-card-6ed57d9a168fd5c71fdea3b5a532f250">
        <a href="/ansible/roles/">
        Roles
        </a>
      </div>
      <div class="card-content-text">
          <!-- raw HTML omitted -->

      </div>
    </div>
  </article>
</li>
<li>
  <article class="card card-popout" aria-labelledby="R-card-27e544d02593ae6d1bb0caed66111f93">
    <div class="card-content">
      <div class="card-title" id="R-card-27e544d02593ae6d1bb0caed66111f93">
        <a href="/ansible/storage/">
        Storage
        </a>
      </div>
      <div class="card-content-text">
          <!-- raw HTML omitted -->

      </div>
    </div>
  </article>
</li>
<li>
  <article class="card card-popout" aria-labelledby="R-card-6bbefcb86017bef050218c4da7f348a1">
    <div class="card-content">
      <div class="card-title" id="R-card-6bbefcb86017bef050218c4da7f348a1">
        <a href="/ansible/task-control/">
        Task Control
        </a>
      </div>
      <div class="card-content-text">
          <!-- raw HTML omitted -->

      </div>
    </div>
  </article>
</li>
<li>
  <article class="card card-popout" aria-labelledby="R-card-eafbe12e55b9e4afab348bfca7d8d677">
    <div class="card-content">
      <div class="card-title" id="R-card-eafbe12e55b9e4afab348bfca7d8d677">
        <a href="/ansible/troubleshooting/">
        Troubleshooting
        </a>
      </div>
      <div class="card-content-text">
          <!-- raw HTML omitted -->

      </div>
    </div>
  </article>
</li>
<li>
  <article class="card card-popout" aria-labelledby="R-card-8ea35a48e16d7d22e0d9bd6d97fbe3e4">
    <div class="card-content">
      <div class="card-title" id="R-card-8ea35a48e16d7d22e0d9bd6d97fbe3e4">
        <a href="/ansible/variables-and-facts/">
        Variable and Facts
        </a>
      </div>
      <div class="card-content-text">
          <!-- raw HTML omitted -->

      </div>
    </div>
  </article>
</li>
</ul>
</div>

  <footer class="footline">
  </footer>
</article>
          <section>
            <h1 class="a11y-only">Subsections of Ansible</h1>
<article class="default">
  <header class="headline">
  </header>

<h1 id="ad-hoc-commands-and-scripting">Ad Hoc Commands and Scripting</h1>

<div class="children children-type-card children-sort-"><ul class="card-container">
<li>
  <article class="card card-popout" aria-labelledby="R-card-14e82f02ece7ad0d07d192420d443d17">
    <div class="card-content">
      <div class="card-title" id="R-card-14e82f02ece7ad0d07d192420d443d17">
        <a href="/ansible/ad-hoc-commands-and-scripting/ad-hoc-ansible-commands/">
        Ad Hoc Ansible Commands
        </a>
      </div>
      <div class="card-content-text">
          <!-- raw HTML omitted -->

      </div>
    </div>
  </article>
</li>
<li>
  <article class="card card-popout" aria-labelledby="R-card-a7bf8b684b7a12f4f676eb77acd625c4">
    <div class="card-content">
      <div class="card-title" id="R-card-a7bf8b684b7a12f4f676eb77acd625c4">
        <a href="/ansible/ad-hoc-commands-and-scripting/using-ad-hoc-commands-in-scripts/">
        Using Ad Hoc commands in scripts
        </a>
      </div>
      <div class="card-content-text">
          <!-- raw HTML omitted -->

      </div>
    </div>
  </article>
</li>
</ul>
</div>

  <footer class="footline">
  </footer>
</article>
          <section>
            <h1 class="a11y-only">Subsections of Ad Hoc Commands and Scripting</h1>
<article class="default">
  <header class="headline">
  </header>

<h1 id="ad-hoc-ansible-commands">Ad Hoc Ansible Commands</h1>

<p>Ad hoc commands are ansible tasks you can run against managed hosts without the need of a playbook or script. These are used for bringing nodes to their desired states, verifying playbook results, and verifying nodes meet any needed criteria/pre-requisites. These must be ran as the ansible user (whatever your remote_user directive is set to under [defaults] in ansible.cfg)</p>
<p>Run the user module with the argument name=lisa on all hosts to make sure the user &ldquo;lisa&rdquo; exists. If the user doesn&rsquo;t exist, it will be created on the remote system:
<code>ansible all -m user -a &quot;name=lisa&quot;</code></p>
<p><code>{command} {host} -m {module} -a {&quot;argument1 argument2 argument3&quot;}</code></p>
<p>In our lab:</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>ansible all -m user -a <span style="color:#5af78e">&#34;name=lisa&#34;</span></span></span></code></pre></div>
<p>This Ad Hoc command created user &ldquo;Lisa&rdquo; on ansible1 and ansible2. If we run the command again, we get &ldquo;SUCCESS&rdquo; on the first line instead of &ldquo;CHANGED&rdquo;. Which means the hosts already meet the requirements:</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#ff6ac1">[</span>ansible@control base<span style="color:#ff6ac1">]</span>$ ansible all -m user -a <span style="color:#5af78e">&#34;name=lisa&#34;</span></span></span></code></pre></div>
<p><em>indempotent</em>
Regardless of current condition, the host is brought to the desired state. Even if you run the command multiple times.</p>
<p>Run the command <code>id lisa</code> on all managed hosts:</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#ff6ac1">[</span>ansible@control base<span style="color:#ff6ac1">]</span>$ ansible all -m <span style="color:#ff5c57">command</span> -a <span style="color:#5af78e">&#34;id lisa&#34;</span></span></span></code></pre></div>
<p>Here, the command module is used to run a command on the specified hosts. And the output is displayed on screen. To note, this does not show up in our ansible user&rsquo;s command history on the host:</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#ff6ac1">[</span>ansible@ansible1 ~<span style="color:#ff6ac1">]</span>$ history</span></span></code></pre></div>
<p>Remove the user lisa from all managed hosts:</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#ff6ac1">[</span>ansible@control base<span style="color:#ff6ac1">]</span>$ ansible all -m user -a <span style="color:#5af78e">&#34;name=lisa state=absent&#34;</span></span></span></code></pre></div>
<p>You can also use the <code>-u</code> option to specify the Ansible user that Ansible will use to run the command. Remember, with no modules specified, ansible uses the <code>command</code> module:
<code>ansible all -a &quot;free -m&quot; -u david</code>
`</p>

  <footer class="footline">
  </footer>
</article>
<article class="default">
  <header class="headline">
  </header>

<h1 id="using-ad-hoc-commands-in-scripts">Using Ad Hoc commands in scripts</h1>

<h2 id="ad-hoc-commands-in-scripts">Ad hoc commands in Scripts</h2>
<p>Follow normal bash scripting guidelines to run ansible commands in a script:</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#ff6ac1">[</span>ansible@control base<span style="color:#ff6ac1">]</span>$ vim httpd-ansible.sh</span></span></code></pre></div>
<p>Let&rsquo;s set up a script that installs and starts/enables httpd, creates a user called &ldquo;anna&rdquo;, and copies the ansible control node&rsquo;s /etc/hosts file to /tmp/ on the managed nodes:</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0"><code>#!/bin/bash

ansible all -m yum -a &#34;name=httpd state=latest&#34;
ansible all -m service -a &#34;name=httpd state=started enabled=yes&#34;
ansible all -m user -a &#34;name=anna&#34;
ansible all -m copy -a &#34;src=/etc/hosts dest=/tmp/hosts&#34;</code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#ff6ac1">[</span>ansible@control base<span style="color:#ff6ac1">]</span>$ chmod +x httpd-ansible.sh
</span></span><span style="display:flex;"><span><span style="color:#ff6ac1">[</span>ansible@control base<span style="color:#ff6ac1">]</span>$ ./httpd-ansible.sh 
</span></span><span style="display:flex;"><span>web2 | UNREACHABLE! <span style="color:#ff6ac1">=</span>&gt; <span style="color:#ff6ac1">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#5af78e">&#34;changed&#34;</span>: false,
</span></span><span style="display:flex;"><span>    <span style="color:#5af78e">&#34;msg&#34;</span>: <span style="color:#5af78e">&#34;Failed to connect to the host via ssh: ssh: Could not resolve hostname web2: Name or service not known&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#5af78e">&#34;unreachable&#34;</span>: <span style="color:#ff5c57">true</span>
</span></span><span style="display:flex;"><span><span style="color:#ff6ac1">}</span>
</span></span><span style="display:flex;"><span>web1 | UNREACHABLE! <span style="color:#ff6ac1">=</span>&gt; <span style="color:#ff6ac1">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#5af78e">&#34;changed&#34;</span>: false,
</span></span><span style="display:flex;"><span>    <span style="color:#5af78e">&#34;msg&#34;</span>: <span style="color:#5af78e">&#34;Failed to connect to the host via ssh: ssh: Could not resolve hostname web1: Name or service not known&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#5af78e">&#34;unreachable&#34;</span>: <span style="color:#ff5c57">true</span>
</span></span><span style="display:flex;"><span><span style="color:#ff6ac1">}</span>
</span></span><span style="display:flex;"><span>ansible1 | <span style="color:#ff5c57">SUCCESS</span> <span style="color:#ff6ac1">=</span>&gt; <span style="color:#ff6ac1">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#5af78e">&#34;ansible_facts&#34;</span>: <span style="color:#ff6ac1">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#5af78e">&#34;discovered_interpreter_python&#34;</span>: <span style="color:#5af78e">&#34;/usr/bin/python3&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">}</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#5af78e">&#34;changed&#34;</span>: false,
</span></span><span style="display:flex;"><span>    <span style="color:#5af78e">&#34;msg&#34;</span>: <span style="color:#5af78e">&#34;Nothing to do&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#5af78e">&#34;rc&#34;</span>: 0,
</span></span><span style="display:flex;"><span>    <span style="color:#5af78e">&#34;results&#34;</span>: <span style="color:#ff6ac1">[]</span>
</span></span><span style="display:flex;"><span><span style="color:#ff6ac1">}</span>
</span></span><span style="display:flex;"><span>ansible2 | <span style="color:#ff5c57">SUCCESS</span> <span style="color:#ff6ac1">=</span>&gt; <span style="color:#ff6ac1">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#5af78e">&#34;ansible_facts&#34;</span>: <span style="color:#ff6ac1">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#5af78e">&#34;discovered_interpreter_python&#34;</span>: <span style="color:#5af78e">&#34;/usr/bin/python3&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">}</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#5af78e">&#34;changed&#34;</span>: false,
</span></span><span style="display:flex;"><span>    <span style="color:#5af78e">&#34;msg&#34;</span>: <span style="color:#5af78e">&#34;Nothing to do&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#5af78e">&#34;rc&#34;</span>: 0,
</span></span><span style="display:flex;"><span>    <span style="color:#5af78e">&#34;results&#34;</span>: <span style="color:#ff6ac1">[]</span>
</span></span><span style="display:flex;"><span><span style="color:#ff6ac1">}</span>
</span></span><span style="display:flex;"><span>... &lt;-- Results truncated</span></span></code></pre></div>
<p>And from the ansible1 node we can verify:</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#ff6ac1">[</span>ansible@ansible1 ~<span style="color:#ff6ac1">]</span>$ cat /etc/passwd | grep anna
</span></span><span style="display:flex;"><span>anna:x:1001:1001::/home/anna:/bin/bash</span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#ff6ac1">[</span>ansible@ansible1 ~<span style="color:#ff6ac1">]</span>$ cat /tmp/hosts
</span></span><span style="display:flex;"><span>127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4
</span></span><span style="display:flex;"><span>::1         localhost localhost.localdomain localhost6 localhost6.localdomain6
</span></span><span style="display:flex;"><span>192.168.124.201 ansible1
</span></span><span style="display:flex;"><span>192.168.124.202 ansible2</span></span></code></pre></div>
<p>View a file from a managed node:
<code>ansible ansible1 -a &quot;cat /somfile.txt&quot;</code></p>

  <footer class="footline">
  </footer>
</article>
          </section>
<article class="default">
  <header class="headline">
  </header>

<h1 id="control-node">Control Node</h1>

<div class="children children-type-card children-sort-"><ul class="card-container">
<li>
  <article class="card card-popout" aria-labelledby="R-card-38305e45deb7ef53b565280c3e653f10">
    <div class="card-content">
      <div class="card-title" id="R-card-38305e45deb7ef53b565280c3e653f10">
        <a href="/ansible/control-node/ansible.cfg/">
        Ansible.cfg
        </a>
      </div>
      <div class="card-content-text">
          <!-- raw HTML omitted -->

      </div>
    </div>
  </article>
</li>
<li>
  <article class="card card-popout" aria-labelledby="R-card-5dcfaf70af03d9bf9081fecb4587744b">
    <div class="card-content">
      <div class="card-title" id="R-card-5dcfaf70af03d9bf9081fecb4587744b">
        <a href="/ansible/control-node/optimizing-ansible-processing/">
        Optimizing Ansible Processing
        </a>
      </div>
      <div class="card-content-text">
          <!-- raw HTML omitted -->

      </div>
    </div>
  </article>
</li>
<li>
  <article class="card card-popout" aria-labelledby="R-card-f0396facdfb865c325b85ab93eade4b4">
    <div class="card-content">
      <div class="card-title" id="R-card-f0396facdfb865c325b85ab93eade4b4">
        <a href="/ansible/control-node/setting-up-an-ansible-lab/">
        Setting up an Ansible Lab
        </a>
      </div>
      <div class="card-content-text">
          <!-- raw HTML omitted -->

      </div>
    </div>
  </article>
</li>
</ul>
</div>

  <footer class="footline">
  </footer>
</article>
          <section>
            <h1 class="a11y-only">Subsections of Control Node</h1>
<article class="default">
  <header class="headline">
  </header>

<h1 id="ansiblecfg">Ansible.cfg</h1>

<h2 id="ansiblecfg">ansible.cfg</h2>
<p>You can store this in a project&rsquo;s directory or a user&rsquo;s home directory, in the case that multiple user&rsquo;s want to have their own Ansible configuration. Or in /etc/ansible if the configuration will be the same for every user and every project. You can also specify these settings in Ansible playbooks. The settings in a playbook take precedence over the .cfg file.</p>
<p><strong>ansible.cfg precedence</strong> (Ansible uses the first one it finds and ignores the rest.)</p>
<ol>
<li>ANSIBLE_CONFIG environment variable</li>
<li>ansible.cfg in current directory</li>
<li>~/.ansible.cfg</li>
<li>/etc/ansible/ansible.cfg</li>
</ol>
<p>Generate an example config file in the current directory.  All directive are commented out by default:
<code>[ansible@control base]$ ansible-config init --disabled &gt; ansible.cfg</code></p>
<p>Include existing plugin to the file:
<code>ansible-config init --disabled -t all &gt; ansible.cfg</code></p>
<p>This generates an extremely large file. So I&rsquo;ll just show Van Vugt&rsquo;s example in .ini format:</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#ff6ac1">[</span>defaults<span style="color:#ff6ac1">]</span> &lt;-- General information
</span></span><span style="display:flex;"><span><span style="color:#ff5c57">remote_user</span> <span style="color:#ff6ac1">=</span> ansible &lt;--Required
</span></span><span style="display:flex;"><span><span style="color:#ff5c57">host_key_checking</span> <span style="color:#ff6ac1">=</span> <span style="color:#ff5c57">false</span> &lt;-- Disable SSH host key validity check
</span></span><span style="display:flex;"><span><span style="color:#ff5c57">inventory</span> <span style="color:#ff6ac1">=</span> inventory
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff6ac1">[</span>privilege_escalation<span style="color:#ff6ac1">]</span> &lt;-- Define how ansible user requires admin rights to connect to hosts
</span></span><span style="display:flex;"><span><span style="color:#ff5c57">become</span> <span style="color:#ff6ac1">=</span> True &lt;-- Escalation required
</span></span><span style="display:flex;"><span><span style="color:#ff5c57">become_method</span> <span style="color:#ff6ac1">=</span> sudo
</span></span><span style="display:flex;"><span><span style="color:#ff5c57">become_user</span> <span style="color:#ff6ac1">=</span> root &lt;-- Escalated user
</span></span><span style="display:flex;"><span><span style="color:#ff5c57">become_ask_pass</span> <span style="color:#ff6ac1">=</span> False &lt;-- Do not ask <span style="color:#ff6ac1">for</span> escalation password</span></span></code></pre></div>
<p>Privilege escalation parameters can be specified in ansible.cfg, playbooks, and on the command line.</p>

  <footer class="footline">
  </footer>
</article>
<article class="default">
  <header class="headline">
  </header>

<h1 id="optimizing-ansible-processing">Optimizing Ansible Processing</h1>

<h3 id="optimizing-ansible-processing">Optimizing Ansible Processing</h3>
<p><strong>Parallel task execution</strong></p>
<ul>
<li>manages the number of hosts on which tasks are executed simultaneously.
<strong>Serial task execution</strong></li>
<li>tasks are executed on a host or group of hosts before proceeding to the next host or group of hosts.</li>
</ul>
<h4 id="parallel-task-execution">Parallel Task Execution</h4>
<ul>
<li>Ansible can run tasks on all hosts at the same time, and in many cases that would not be a problem because processing is executed on the managed host anyway.</li>
<li>If, however, network devices or other nodes that do not have their own Python stack are involved, processing needs to be done on the control host.</li>
<li>To prevent the control host from being overloaded in that case, the maximum number of simultaneous connections by default is set to 5.</li>
<li>You can manage this setting by using the <strong>forks</strong> parameter in ansible.cfg.</li>
<li>Alternatively, you can use the <code>-f</code> option with the <code>ansible</code> and <code>ansible-playbook</code> commands.</li>
<li>If only Linux hosts are managed, there is no reason to keep the maximum number of simultaneous tasks much lower than 100.</li>
</ul>
<h4 id="managing-serial-task-execution">Managing Serial Task Execution</h4>
<ul>
<li>While executing tasks, Ansible processes tasks in a playbook one by one.</li>
<li>This means that, by default, the first task is executed on all managed hosts. Once that is done, the next task is processed, until all tasks have been executed.</li>
<li>There is no specific order in the execution of tasks, so you may see that in one run ansible1 is processed before ansible2, while on another run they might be processed in the opposite order.</li>
<li>In some cases, this is undesired behavior.</li>
<li>If, for instance, a playbook is used to update a cluster of hosts this way, this would create a situation where the old software has been updated, but the new version has not been started yet and the entire cluster would be down.</li>
<li>Use the <strong>serial</strong> keyword in the play header to configure
<ul>
<li><strong>serial: 3</strong>
<ul>
<li>all tasks are executed on three hosts, and after completely running all tasks on three hosts, the next group of three hosts is handled.</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="lab-managing-parallelism">Lab: Managing Parallelism</h3>
<ul>
<li>Add two more managed nodes with the names ansible3.example.com and ansible4.example.com.</li>
<li>Open the inventory file with an editor and add the following lines:</li>
</ul>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0"><code class="language-pre1" data-lang="pre1">ansible3
ansible4</code></pre></div>
<ul>
<li>Open the ansible.cfg file and add the line <code>forks = 4</code> to the <strong>[defaults]</strong> section.</li>
<li>Write a playbook with the name <strong>exercise102-install</strong> that installs and enables the Apache web server and another playbook with the name <strong>exercise102-remove</strong> that disables and removes the Apache web server.</li>
<li>Run <code>ansible-playbook exercise102-remove.yaml</code> to remove and disable the Apache web server on all hosts. This is just to make sure you start with a clean configuration.</li>
<li>Run the playbook to install and run the web server, using <code>time ansible-playbook exercise102-install.yaml</code>, and notice the time it takes to run the playbook.</li>
<li>Run <code>ansible-playbook exercise102-remove.yaml</code> again to get back to a clean state.</li>
<li>Edit <strong>ansible.cfg</strong> and change the <strong>forks</strong> parameter to <code>forks = 2</code>.</li>
<li>Run the <code>time ansible-playbook exercise102-install.yaml</code> command again to see how much time it takes now</li>
<li>Edit the <code>exercise102-install.yaml</code> playbook and include the line <code>serial: 2</code> in the play header.</li>
<li>Run the <code>ansible-playbook exercise102-remove.yaml</code> command again to get back to a clean state.</li>
<li>Run the <code>ansible-playbook exercise102-install.yaml</code> command again and observe that the entire play is executed on two hosts only before the next group of two hosts is taken care of.</li>
</ul>

  <footer class="footline">
  </footer>
</article>
<article class="default">
  <header class="headline">
  </header>

<h1 id="setting-up-an-ansible-lab">Setting up an Ansible Lab</h1>

<h2 id="requirements-for-ansible">Requirements for Ansible</h2>
<ul>
<li>Python 3 on control node and managed nodes</li>
<li>sudo ssh access to managed nodes</li>
<li>Ansible installed on the Control node</li>
</ul>
<h2 id="lab-setup">Lab Setup</h2>
<p>For this lab, we will need three virtual machines using RHEL 9. 1 control node and 2 managed nodes. Use IP addresses based on your lab network environment:</p>
<table>
  <thead>
      <tr>
          <th>Hostname</th>
          <th>pretty hostname</th>
          <th>ip addreess</th>
          <th>RAM</th>
          <th>Storage</th>
          <th>vCPUs</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>control.example.com</td>
          <td>control</td>
          <td>192.168.122.200</td>
          <td>2048MB</td>
          <td>20G</td>
          <td>2</td>
      </tr>
      <tr>
          <td>ansible1.example.com</td>
          <td>ansible1</td>
          <td>192.168.122.201</td>
          <td>2048MB</td>
          <td>20G</td>
          <td>2</td>
      </tr>
      <tr>
          <td>ansible2.example.com</td>
          <td>ansible2</td>
          <td>192.168.122.202</td>
          <td>2048MB</td>
          <td>20G</td>
          <td>2</td>
      </tr>
      <tr>
          <td>I have set these VMs up in virt-manager, then cloned them so I can rebuild the lab later. You can automate this using Vagrant or Ansible but that will come later. Ignore the Win10 VM. It&rsquo;s a necessary evil:</td>
          <td></td>
          <td></td>
          <td></td>
          <td></td>
          <td></td>
      </tr>
  </tbody>
</table>
<p><a href="#R-image-52e86f1c0c92565b04abe91ddf2dcd44" class="lightbox-link"><img class="lazy lightbox figure-image" loading="lazy" src="/images/Pasted%20image%2020250403052342.png" style="height: auto;width: auto;"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-52e86f1c0c92565b04abe91ddf2dcd44"><img class="lazy lightbox lightbox-image" loading="lazy" src="/images/Pasted%20image%2020250403052342.png"></a></p>
<h3 id="setting-hostnames-and-verifying-dependencies">Setting hostnames and verifying dependencies</h3>
<p>Set a hostname on all three machines:</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#ff6ac1">[</span>root@localhost ~<span style="color:#ff6ac1">]</span><span style="color:#78787e"># hostnamectl set-hostname control.example.com</span>
</span></span><span style="display:flex;"><span><span style="color:#ff6ac1">[</span>root@localhost ~<span style="color:#ff6ac1">]</span><span style="color:#78787e"># hostnamectl set-hostname --pretty control</span></span></span></code></pre></div>
<p>Install Ansible on Control Node</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#ff6ac1">[</span>root@localhost ~<span style="color:#ff6ac1">]</span><span style="color:#78787e"># dnf -y install ansible-core</span>
</span></span><span style="display:flex;"><span>...</span></span></code></pre></div>
<p>Verify python3 is installed:</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#ff6ac1">[</span>root@localhost ~<span style="color:#ff6ac1">]</span><span style="color:#78787e"># python --version</span>
</span></span><span style="display:flex;"><span>Python 3.9.18</span></span></code></pre></div>
<h3 id="configure-ansible-user-and-ssh">Configure Ansible user and SSH</h3>
<p>Add a user for Ansible. This can be any username you like, but we will use &ldquo;ansible&rdquo; as our lab user. Also, the ansible user needs sudo access.  We will also make it so no password is required for convenience. You will need to do this on the control node and both managed nodes:</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#ff6ac1">[</span>root@control ~<span style="color:#ff6ac1">]</span><span style="color:#78787e"># useradd ansible</span>
</span></span><span style="display:flex;"><span><span style="color:#ff6ac1">[</span>root@control ~<span style="color:#ff6ac1">]</span><span style="color:#78787e"># visudo</span></span></span></code></pre></div>
<p>Add this line to the file that comes up:
<code>ansible ALL=(ALL) NOPASSWD: ALL</code></p>
<p>Configure a password for the ansible user:</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#ff6ac1">[</span>root@control ~<span style="color:#ff6ac1">]</span><span style="color:#78787e"># passwd ansible</span>
</span></span><span style="display:flex;"><span>Changing password <span style="color:#ff6ac1">for</span> user ansible.
</span></span><span style="display:flex;"><span>New password: 
</span></span><span style="display:flex;"><span>BAD PASSWORD: The password is shorter than <span style="color:#ff9f43">8</span> characters
</span></span><span style="display:flex;"><span>Retype new password: 
</span></span><span style="display:flex;"><span>passwd: all authentication tokens updated successfully.</span></span></code></pre></div>
<p>On the control node only: Add host names of the nodes to /etc/hosts:</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#ff5c57">echo</span> <span style="color:#5af78e">&#34;192.168.124.201 ansible1 &gt;&gt; /etc/hosts
</span></span></span><span style="display:flex;"><span><span style="color:#5af78e">&gt; ^C
</span></span></span><span style="display:flex;"><span><span style="color:#5af78e">[root@control ~]# echo &#34;</span>192.168.124.201 ansible1<span style="color:#5af78e">&#34; &gt;&gt; /etc/hosts
</span></span></span><span style="display:flex;"><span><span style="color:#5af78e">[root@control ~]# echo &#34;</span>192.168.124.202 ansible2<span style="color:#5af78e">&#34; &gt;&gt; /etc/hosts
</span></span></span><span style="display:flex;"><span><span style="color:#5af78e">[root@control ~]# cat /etc/hosts
</span></span></span><span style="display:flex;"><span><span style="color:#5af78e">127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4
</span></span></span><span style="display:flex;"><span><span style="color:#5af78e">::1         localhost localhost.localdomain localhost6 localhost6.localdomain6
</span></span></span><span style="display:flex;"><span><span style="color:#5af78e">192.168.124.201 ansible1
</span></span></span><span style="display:flex;"><span><span style="color:#5af78e">192.168.124.202 ansible2</span></span></span></code></pre></div>
<p>Log in to the ansible user account for the remaining steps. Note, Ansible assumes passwordless (key-based) login for ssh. If you insist on using passwords, add the &ndash;ask-pass (-k) flag to your Ansible commands. (This may require sshpass package to work)</p>
<p>On the control node only:  Generate an ssh key to send to the hosts for passwordless Login:</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#ff6ac1">[</span>ansible@control ~<span style="color:#ff6ac1">]</span>$ ssh-keygen -N <span style="color:#5af78e">&#34;&#34;</span> -q
</span></span><span style="display:flex;"><span>Enter file in which to save the key <span style="color:#ff6ac1">(</span>/home/ansible/.ssh/id_rsa<span style="color:#ff6ac1">)</span>: </span></span></code></pre></div>
<p>Copy the public key to the nodes and test passwordless access and test passwordless login to the managed nodes:</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>^C<span style="color:#ff6ac1">[</span>ansible@control ~<span style="color:#ff6ac1">]</span>$ ssh-copy-id ansible@ansible1
</span></span><span style="display:flex;"><span>/usr/bin/ssh-copy-id: INFO: Source of key<span style="color:#ff6ac1">(</span>s<span style="color:#ff6ac1">)</span> to be installed: <span style="color:#5af78e">&#34;/home/ansible/.ssh/id_rsa.pub&#34;</span>
</span></span><span style="display:flex;"><span>/usr/bin/ssh-copy-id: INFO: attempting to log in with the new key<span style="color:#ff6ac1">(</span>s<span style="color:#ff6ac1">)</span>, to filter out any that are already installed
</span></span><span style="display:flex;"><span>/usr/bin/ssh-copy-id: INFO: <span style="color:#ff9f43">1</span> key<span style="color:#ff6ac1">(</span>s<span style="color:#ff6ac1">)</span> remain to be installed -- <span style="color:#ff6ac1">if</span> you are prompted now it is to install the new keys
</span></span><span style="display:flex;"><span>ansible@ansible1<span style="color:#5af78e">&#39;s password: 
</span></span></span><span style="display:flex;"><span><span style="color:#5af78e">
</span></span></span><span style="display:flex;"><span><span style="color:#5af78e">Number of key(s) added: 1
</span></span></span><span style="display:flex;"><span><span style="color:#5af78e">
</span></span></span><span style="display:flex;"><span><span style="color:#5af78e">Now try logging into the machine, with:   &#34;ssh &#39;</span>ansible@ansible1<span style="color:#5af78e">&#39;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#5af78e">and check to make sure that only the key(s) you wanted were added.
</span></span></span><span style="display:flex;"><span><span style="color:#5af78e">
</span></span></span><span style="display:flex;"><span><span style="color:#5af78e">[ansible@control ~]$ ssh-copy-id ansible@ansible2
</span></span></span><span style="display:flex;"><span><span style="color:#5af78e">/usr/bin/ssh-copy-id: INFO: Source of key(s) to be installed: &#34;/home/ansible/.ssh/id_rsa.pub&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#5af78e">The authenticity of host &#39;</span>ansible2 <span style="color:#ff6ac1">(</span>192.168.124.202<span style="color:#ff6ac1">)</span><span style="color:#5af78e">&#39; can&#39;</span>t be established.
</span></span><span style="display:flex;"><span>ED25519 key fingerprint is SHA256:r47sLc/WzVA4W4ifKk6w1gTnxB3Iim8K2K0KB82X9yo.
</span></span><span style="display:flex;"><span>This key is not known by any other names
</span></span><span style="display:flex;"><span>Are you sure you want to <span style="color:#ff6ac1">continue</span> connecting <span style="color:#ff6ac1">(</span>yes/no/<span style="color:#ff6ac1">[</span>fingerprint<span style="color:#ff6ac1">])</span>? yes
</span></span><span style="display:flex;"><span>/usr/bin/ssh-copy-id: INFO: attempting to log in with the new key<span style="color:#ff6ac1">(</span>s<span style="color:#ff6ac1">)</span>, to filter out any that are already installed
</span></span><span style="display:flex;"><span>/usr/bin/ssh-copy-id: INFO: <span style="color:#ff9f43">1</span> key<span style="color:#ff6ac1">(</span>s<span style="color:#ff6ac1">)</span> remain to be installed -- <span style="color:#ff6ac1">if</span> you are prompted now it is to install the new keys
</span></span><span style="display:flex;"><span>ansible@ansible2<span style="color:#5af78e">&#39;s password: 
</span></span></span><span style="display:flex;"><span><span style="color:#5af78e">
</span></span></span><span style="display:flex;"><span><span style="color:#5af78e">Number of key(s) added: 1
</span></span></span><span style="display:flex;"><span><span style="color:#5af78e">
</span></span></span><span style="display:flex;"><span><span style="color:#5af78e">Now try logging into the machine, with:   &#34;ssh &#39;</span>ansible@ansible2<span style="color:#ff5c57">&#39;</span><span style="color:#5af78e">&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#5af78e">and check to make sure that only the key(s) you wanted were added.
</span></span></span><span style="display:flex;"><span><span style="color:#5af78e">
</span></span></span><span style="display:flex;"><span><span style="color:#5af78e">[ansible@control ~]</span>$<span style="color:#5af78e"> ssh ansible1
</span></span></span><span style="display:flex;"><span><span style="color:#5af78e">Register this system with Red Hat Insights: insights-client --register
</span></span></span><span style="display:flex;"><span><span style="color:#5af78e">Create an account or view all your systems at https://red.ht/insights-dashboard
</span></span></span><span style="display:flex;"><span><span style="color:#5af78e">Last failed login: Thu Apr  3 05:34:20 MST 2025 from 192.168.124.200 on ssh:notty
</span></span></span><span style="display:flex;"><span><span style="color:#5af78e">There was 1 failed login attempt since the last successful login.
</span></span></span><span style="display:flex;"><span><span style="color:#5af78e">[ansible@ansible1 ~]</span>$<span style="color:#5af78e"> 
</span></span></span><span style="display:flex;"><span><span style="color:#5af78e">logout
</span></span></span><span style="display:flex;"><span><span style="color:#5af78e">Connection to ansible1 closed.
</span></span></span><span style="display:flex;"><span><span style="color:#5af78e">[ansible@control ~]</span>$<span style="color:#5af78e"> ssh ansible2
</span></span></span><span style="display:flex;"><span><span style="color:#5af78e">Register this system with Red Hat Insights: insights-client --register
</span></span></span><span style="display:flex;"><span><span style="color:#5af78e">Create an account or view all your systems at https://red.ht/insights-dashboard
</span></span></span><span style="display:flex;"><span><span style="color:#5af78e">[ansible@ansible2 ~]</span>$<span style="color:#5af78e"> 
</span></span></span><span style="display:flex;"><span><span style="color:#5af78e">logout
</span></span></span><span style="display:flex;"><span><span style="color:#5af78e">Connection to ansible2 closed.</span></span></span></code></pre></div>
<p>Install lab stuff from the RHCE guide:
<code>sudo dnf -y install git</code></p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#ff6ac1">[</span>ansible@control base<span style="color:#ff6ac1">]</span>$ <span style="color:#ff5c57">cd</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff6ac1">[</span>ansible@control ~<span style="color:#ff6ac1">]</span>$ git clone https://github.com/sandervanvugt/rhce8-book 
</span></span><span style="display:flex;"><span>Cloning into <span style="color:#5af78e">&#39;rhce8-book&#39;</span>...
</span></span><span style="display:flex;"><span>remote: Enumerating objects: 283, <span style="color:#ff6ac1">done</span>.
</span></span><span style="display:flex;"><span>remote: Counting objects: 100% <span style="color:#ff6ac1">(</span>283/283<span style="color:#ff6ac1">)</span>, <span style="color:#ff6ac1">done</span>.
</span></span><span style="display:flex;"><span>remote: Compressing objects: 100% <span style="color:#ff6ac1">(</span>233/233<span style="color:#ff6ac1">)</span>, <span style="color:#ff6ac1">done</span>.
</span></span><span style="display:flex;"><span>remote: Total <span style="color:#ff9f43">283</span> <span style="color:#ff6ac1">(</span>delta 27<span style="color:#ff6ac1">)</span>, reused <span style="color:#ff9f43">278</span> <span style="color:#ff6ac1">(</span>delta 24<span style="color:#ff6ac1">)</span>, pack-reused <span style="color:#ff9f43">0</span> <span style="color:#ff6ac1">(</span>from 0<span style="color:#ff6ac1">)</span>
</span></span><span style="display:flex;"><span>Receiving objects: 100% <span style="color:#ff6ac1">(</span>283/283<span style="color:#ff6ac1">)</span>, 62.79 KiB | 357.00 KiB/s, <span style="color:#ff6ac1">done</span>.
</span></span><span style="display:flex;"><span>Resolving deltas: 100% <span style="color:#ff6ac1">(</span>27/27<span style="color:#ff6ac1">)</span>, <span style="color:#ff6ac1">done</span>.</span></span></code></pre></div>

  <footer class="footline">
  </footer>
</article>
          </section>
<article class="default">
  <header class="headline">
  </header>

<h1 id="deploying-files">Deploying Files</h1>

<div class="children children-type-card children-sort-"><ul class="card-container">
<li>
  <article class="card card-popout" aria-labelledby="R-card-14c40bc5dcbc2a40cbc1edb11cea6ab1">
    <div class="card-content">
      <div class="card-title" id="R-card-14c40bc5dcbc2a40cbc1edb11cea6ab1">
        <a href="/ansible/deploying-files/deploying-files/">
        Deploying files
        </a>
      </div>
      <div class="card-content-text">
          <!-- raw HTML omitted -->

      </div>
    </div>
  </article>
</li>
<li>
  <article class="card card-popout" aria-labelledby="R-card-5608eb69ee3e2f0c13419f5d7f0f31f4">
    <div class="card-content">
      <div class="card-title" id="R-card-5608eb69ee3e2f0c13419f5d7f0f31f4">
        <a href="/ansible/deploying-files/jinja2-templates/">
        Jinja2 templates
        </a>
      </div>
      <div class="card-content-text">
          <!-- raw HTML omitted -->

      </div>
    </div>
  </article>
</li>
<li>
  <article class="card card-popout" aria-labelledby="R-card-5608eb69ee3e2f0c13419f5d7f0f31f4">
    <div class="card-content">
      <div class="card-title" id="R-card-5608eb69ee3e2f0c13419f5d7f0f31f4">
        <a href="/ansible/deploying-files/selinux-file-properties/">
        Jinja2 templates
        </a>
      </div>
      <div class="card-content-text">
          <!-- raw HTML omitted -->

      </div>
    </div>
  </article>
</li>
</ul>
</div>

  <footer class="footline">
  </footer>
</article>
          <section>
            <h1 class="a11y-only">Subsections of Deploying Files</h1>
<article class="default">
  <header class="headline">
  </header>

<h1 id="deploying-files">Deploying files</h1>

<p>This chapter covers the following subjects:</p>
<p>â€¢ Using Modules to Manipulate Files
â€¢ Managing SELinux Properties
â€¢ Using Jinja2 Templates</p>
<h3 id="rhce-exam-topics">RHCE exam topics</h3>
<p>â€¢ Use Ansible modules for system administration tasks that work with:
â€¢ File contents
â€¢ Use advanced Ansible features
â€¢ Create and use templates to create customized configuration files</p>
<h3 id="using-modules-to-manipulate-files">Using Modules to Manipulate Files</h3>
<h4 id="file-module-manipulation-overview">File Module Manipulation Overview</h4>
<p>Common modules to manipulate files
<strong>copy</strong></p>
<ul>
<li>Copies files to remote locations
<strong>fetch</strong></li>
<li>Fetches files from remote locations
<strong>file</strong></li>
<li>Manage file and file properties</li>
<li>Create new files or directories</li>
<li>Create links</li>
<li>Remove files</li>
<li>Set permissions and ownership</li>
</ul>
<p><strong>acl</strong></p>
<ul>
<li>Work with file system ACLs
<strong>find</strong></li>
<li>Find files based on properties
<strong>lineinfile</strong></li>
<li>Manages lines in text files
<strong>blockinfile</strong></li>
<li>Manage blocks in text files
<strong>replace</strong></li>
<li>Replaces strings in text files based on regex
<strong>synchronize</strong></li>
<li>Performs rsync-based synchronization tasks
<strong>stat</strong></li>
<li>Retrieves file or file system status</li>
<li>enables you to retrieve file status information.</li>
<li>gets status information and is not used to change anything</li>
<li>use it to check specific file and perform an action if the properties are not set as expected.
Shows:</li>
<li>which permission mode is set,</li>
<li>whether it is a link,</li>
<li>which checksum is set on the file</li>
<li>etc.</li>
<li>See <code>ansible-doc stat</code> for list of full output</li>
</ul>
<h3 id="lab-view-information-about-etchosts-file">Lab: View information about /etc/hosts file</h3>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yml" data-lang="yml"><span style="display:flex;"><span>- <span style="color:#ff6ac1">name</span>: stat module tests
</span></span><span style="display:flex;"><span>  <span style="color:#ff6ac1">hosts</span>: ansible1
</span></span><span style="display:flex;"><span>  <span style="color:#ff6ac1">tasks</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ff6ac1">stat</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">path</span>: /etc/hosts
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">register</span>: st
</span></span><span style="display:flex;"><span>  - <span style="color:#ff6ac1">name</span>: show current values
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">debug</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">msg</span>: current value of the st variable is {{ st }}</span></span></code></pre></div>
<h3 id="lab-write-a-message-if-the-expected-permission-mode-is-not-set">Lab: write a message if the expected permission mode is not set.</h3>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yml" data-lang="yml"><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span>- <span style="color:#ff6ac1">name</span>: stat module test
</span></span><span style="display:flex;"><span>  <span style="color:#ff6ac1">hosts</span>: ansible1
</span></span><span style="display:flex;"><span>  <span style="color:#ff6ac1">tasks</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ff6ac1">command</span>: touch /tmp/statfile
</span></span><span style="display:flex;"><span>  - <span style="color:#ff6ac1">stat</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">path</span>: /tmp/statfile
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">register</span>: st
</span></span><span style="display:flex;"><span>  - <span style="color:#ff6ac1">name</span>: show current values
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">debug</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">msg</span>: current value of the st variable is {{ st }}
</span></span><span style="display:flex;"><span>  - <span style="color:#ff6ac1">fail</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">msg</span>: <span style="color:#5af78e">&#34;unexpected file mode, should be set to 0640&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">when</span>: st.stat.mode != &#39;0640&#39;                               </span></span></code></pre></div>
<h3 id="lab--use-the-file-module-to-correct-file-properties-discovered-with-stat">Lab:  Use the file Module to Correct File Properties Discovered with stat</h3>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yml" data-lang="yml"><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span>- <span style="color:#ff6ac1">name</span>: stat module tests
</span></span><span style="display:flex;"><span>  <span style="color:#ff6ac1">hosts</span>: ansible1
</span></span><span style="display:flex;"><span>  <span style="color:#ff6ac1">tasks</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ff6ac1">command</span>: touch /tmp/statfile
</span></span><span style="display:flex;"><span>  - <span style="color:#ff6ac1">stat</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">path</span>: /tmp/statfile
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">register</span>: st
</span></span><span style="display:flex;"><span>  - <span style="color:#ff6ac1">name</span>: show current values
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">debug</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">msg</span>: current value of the st variable is {{ st }}
</span></span><span style="display:flex;"><span>  - <span style="color:#ff6ac1">name</span>: changing file permissions if that&#39;s needed
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">file</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">path</span>: /tmp/statfile
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">mode</span>: <span style="color:#ff9f43">0640</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">when</span>: st.stat.mode != &#39;0640&#39;</span></span></code></pre></div>
<h4 id="managing-file-contents">Managing File Contents</h4>
<p>Use lineinfile or blockinfile instead of copy to manage text in a file</p>
<h3 id="lab-change-a-string-based-on-a-regular-expression">Lab: Change a string, based on a regular expression.</h3>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yml" data-lang="yml"><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span>- <span style="color:#ff6ac1">name</span>: configuring SSH
</span></span><span style="display:flex;"><span>  <span style="color:#ff6ac1">hosts</span>: all
</span></span><span style="display:flex;"><span>  <span style="color:#ff6ac1">tasks</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ff6ac1">name</span>: disable root SSH login
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">lineinfile</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">dest</span>: /etc/ssh/sshd_config
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">regexp</span>: <span style="color:#5af78e">&#34;^PermitRootLogin&#34;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">line</span>: <span style="color:#5af78e">&#34;PermitRootLogin no&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">notify</span>: restart sshd
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff6ac1">handlers</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ff6ac1">name</span>: restart sshd
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">service</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">name</span>: sshd
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">state</span>: restarted</span></span></code></pre></div>
<h3 id="lab-manipulate-multiple-lines">Lab: Manipulate multiple lines</h3>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yml" data-lang="yml"><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span>- <span style="color:#ff6ac1">name</span>: modifying file
</span></span><span style="display:flex;"><span>  <span style="color:#ff6ac1">hosts</span>: all
</span></span><span style="display:flex;"><span>  <span style="color:#ff6ac1">tasks</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ff6ac1">name</span>: ensure /tmp/hosts exists
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">file</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">path</span>: /tmp/hosts
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">state</span>: touch
</span></span><span style="display:flex;"><span>  - <span style="color:#ff6ac1">name</span>: add some lines to /tmp/hosts
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">blockinfile</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">path</span>: /tmp/hosts
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">block</span>: |<span style="color:#5af78e">
</span></span></span><span style="display:flex;"><span><span style="color:#5af78e">        192.168.4.110 host1.example.com
</span></span></span><span style="display:flex;"><span><span style="color:#5af78e">        192.168.4.120 host2.example.com</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">state</span>: present</span></span></code></pre></div>
<p>When blockinfile is used, the text specified in the block is copied with a start and end indicator.</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#ff6ac1">[</span>ansible@ansible1 ~<span style="color:#ff6ac1">]</span>$ cat /tmp/hosts
</span></span><span style="display:flex;"><span>127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4
</span></span><span style="display:flex;"><span>::1         localhost localhost.localdomain localhost6 localhost6.localdomain6
</span></span><span style="display:flex;"><span>192.168.122.201 ansible1
</span></span><span style="display:flex;"><span>192.168.122.202 ansible2
</span></span><span style="display:flex;"><span>192.168.122.203 ansible3
</span></span><span style="display:flex;"><span><span style="color:#78787e"># BEGIN ANSIBLE MANAGED BLOCK</span>
</span></span><span style="display:flex;"><span>192.168.4.110 host1.example.com
</span></span><span style="display:flex;"><span>192.168.4.120 host2.example.com
</span></span><span style="display:flex;"><span><span style="color:#78787e"># END ANSIBLE MANAGED BLOCK</span></span></span></code></pre></div>
<h3 id="lab-creating-and-removing-files">Lab: Creating and Removing Files</h3>
<p>Use the file module to create a new directory and in that directory create an empty file, then remove the directory recursively.</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yml" data-lang="yml"><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span>- <span style="color:#ff6ac1">name</span>: using the file module
</span></span><span style="display:flex;"><span>  <span style="color:#ff6ac1">hosts</span>: ansible1
</span></span><span style="display:flex;"><span>  <span style="color:#ff6ac1">tasks</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ff6ac1">name</span>: create directory
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">file</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">path</span>: /newdir
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">owner</span>: ansible
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">group</span>: ansible
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">mode</span>: <span style="color:#ff9f43">770</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">state</span>: directory
</span></span><span style="display:flex;"><span>  - <span style="color:#ff6ac1">name</span>: create file in that directory
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">file</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">path</span>: /newdir/newfile
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">state</span>: touch
</span></span><span style="display:flex;"><span>  - <span style="color:#ff6ac1">name</span>: show the new file
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">stat</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">path</span>: /newdir/newfile
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">register</span>: result
</span></span><span style="display:flex;"><span>  - <span style="color:#ff6ac1">debug</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">msg</span>: |<span style="color:#5af78e">
</span></span></span><span style="display:flex;"><span><span style="color:#5af78e">        This shows that newfile was created
</span></span></span><span style="display:flex;"><span><span style="color:#5af78e">        &#34;{{ result }}&#34;</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#ff6ac1">name</span>: removing everything again
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">file</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">path</span>: /newdir
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">state</span>: absent               </span></span></code></pre></div>
<ul>
<li><strong>state: absent</strong> recursively removes the directory.</li>
</ul>
<h4 id="moving-files-around">Moving Files Around</h4>
<p>copy module
copies a file from the Ansible control host to a managed machine.</p>
<p>fetch module
enables you to do the opposite</p>
<p>synchronize module
performs Linux rsync-like tasks,
ensuring that a file from the control host is synchronized to a file with that name on the managed host.</p>
<p>copy module always creates a new file, whereas the synchronize module updates a current existing file.</p>
<h3 id="lab-moving-a-file-around-with-ansible">Lab: Moving a File Around with Ansible</h3>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yml" data-lang="yml"><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span>- <span style="color:#ff6ac1">name</span>: file copy modules
</span></span><span style="display:flex;"><span>  <span style="color:#ff6ac1">hosts</span>: all
</span></span><span style="display:flex;"><span>  <span style="color:#ff6ac1">tasks</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ff6ac1">name</span>: copy file demo
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">copy</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">src</span>: /etc/hosts
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">dest</span>: /tmp/
</span></span><span style="display:flex;"><span>  - <span style="color:#ff6ac1">name</span>: add some lines to /tmp/hosts
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">blockinfile</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">path</span>: /tmp/hosts
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">block</span>: |<span style="color:#5af78e">
</span></span></span><span style="display:flex;"><span><span style="color:#5af78e">        192.168.4.110 host1.example.com
</span></span></span><span style="display:flex;"><span><span style="color:#5af78e">        192.168.4.120 host2.example.com</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">state</span>: present
</span></span><span style="display:flex;"><span>  - <span style="color:#ff6ac1">name</span>: verify file checksum
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">stat</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">path</span>: /tmp/hosts
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">checksum_algorithm</span>: md5
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">register</span>: result
</span></span><span style="display:flex;"><span>  - <span style="color:#ff6ac1">debug</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">msg</span>: <span style="color:#5af78e">&#34;The checksum of /tmp/hosts is {{ result.stat.checksum }}&#34;</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#ff6ac1">name</span>: fetch a file
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">fetch</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">src</span>: /tmp/hosts
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">dest</span>: /tmp/</span></span></code></pre></div>
<ul>
<li>Ansible creates a subdirectory on the control node for each managed host in the dest directory and puts the file that fetch has copied from the remote host in that subdirectory:</li>
</ul>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>/tmp/ansible1/tmp/hosts
</span></span><span style="display:flex;"><span>/tmp/ansible2/tmp/hosts</span></span></code></pre></div>
<h3 id="lab-managing-files-with-ansible">Lab: Managing Files with Ansible</h3>
<p>1. Create a file with the name exercise81.yaml and give it the following play header:
2. Add a task that creates a new empty file:
3. Use the stat module to check on the status of the new file:
4. To see what the status module is doing, add a line that uses the debug module:
5. Now that you understand which values are stored in newfile, you can add a conditional play that changes the current owner if not set correctly:
6. Add a second play to the playbook that fetches a remote file:
7. Now that you have fetched the file so that it is on the Ansible control machine, use blockinfile to edit it:
8. In the final step, copy the modified file to ansible2 by including the following play:
9. At this point you&rsquo;re ready to run the playbook. Type <code>ansible-playbook exercise81.yaml</code> to run it and observe the results.
10. Type <code>ansible ansible2 -a &quot;cat /tmp/motd&quot;</code> to verify that the modified motd file was successfully copied to ansible2.</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yml" data-lang="yml"><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span>- <span style="color:#ff6ac1">name</span>: testing file manipulation skills
</span></span><span style="display:flex;"><span>  <span style="color:#ff6ac1">hosts</span>: ansible1
</span></span><span style="display:flex;"><span>  <span style="color:#ff6ac1">tasks</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#ff6ac1">name</span>: create new file
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">file</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">name</span>: /tmp/newfile
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">state</span>: touch
</span></span><span style="display:flex;"><span>    - <span style="color:#ff6ac1">name</span>: check the status of the new file
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">stat</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">path</span>: /tmp/newfile
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">register</span>: newfile
</span></span><span style="display:flex;"><span>    - <span style="color:#ff6ac1">name</span>: for debugging only
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">debug</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">msg</span>: the current values for newfile are {{ newfile }}
</span></span><span style="display:flex;"><span>    - <span style="color:#ff6ac1">name</span>: change file owner if needed
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">file</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">path</span>: /tmp/newfile
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">owner</span>: ansible
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">when</span>: newfile.stat.pw_name != &#39;ansible&#39;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>- <span style="color:#ff6ac1">name</span>: fetching a remote file
</span></span><span style="display:flex;"><span>  <span style="color:#ff6ac1">hosts</span>: ansible1
</span></span><span style="display:flex;"><span>  <span style="color:#ff6ac1">tasks</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#ff6ac1">name</span>: fetch file from remote machine
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">fetch</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">src</span>: /etc/motd
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">dest</span>: /tmp
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>- <span style="color:#ff6ac1">name</span>: adding text to the text file that is now on localhost
</span></span><span style="display:flex;"><span>  <span style="color:#ff6ac1">hosts</span>: localhost
</span></span><span style="display:flex;"><span>  <span style="color:#ff6ac1">tasks</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ff6ac1">name</span>: add a message
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">blockinfile</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">path</span>: /tmp/ansible1/etc/motd
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">block</span>: |<span style="color:#5af78e">
</span></span></span><span style="display:flex;"><span><span style="color:#5af78e">        welcome to this server
</span></span></span><span style="display:flex;"><span><span style="color:#5af78e">        for authorized users only</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">state</span>: present
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>- <span style="color:#ff6ac1">name</span>: copy the modified file to ansible2
</span></span><span style="display:flex;"><span>  <span style="color:#ff6ac1">hosts</span>: ansible2
</span></span><span style="display:flex;"><span>  <span style="color:#ff6ac1">tasks</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ff6ac1">name</span>: copy motd file
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">copy</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">src</span>: /tmp/ansible1/etc/motd
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">dest</span>: /tmp</span></span></code></pre></div>

  <footer class="footline">
  </footer>
</article>
<article class="default">
  <header class="headline">
  </header>

<h1 id="jinja2-templates">Jinja2 templates</h1>

<h3 id="using-jinja2-templates">Using Jinja2 Templates</h3>
<ul>
<li>A template is a configuration file that contains variables and, based on the variables, is generated on the managed hosts according to host-specific requirements.</li>
<li>Using templates allows for a structural way to generate configuration files, which is much more powerful than changing specific lines from specific files.</li>
<li>Ansible uses Jinja2 to generate templates.</li>
<li>Jinja2 is a generic templating language for Python developers.</li>
<li>It is used in Ansible templates, but Jinja2-based approaches are also found in other parts of Ansible. For instance, the way variables are referred to is based on Jinja2.</li>
</ul>
<p>In a Jinja2 template, three elements can be used.
<strong>data</strong></p>
<ul>
<li><code>sample text</code>
<strong>comment</strong></li>
<li><code>{# sample text #}</code>
<strong>variable</strong></li>
<li><code>{{ ansible_facts['default_ipv4']['address'] }}</code>
<strong>expression</strong></li>
</ul>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0"><code>{% for myhost in groups[&#39;web&#39;] %}
{{ myhost }}
{% endfor %}</code></pre></div>
<ul>
<li>To work with a template, you must create a template file, written in Jinja2.</li>
<li>Template file must be included in an Ansible playbook that uses the template module.</li>
</ul>
<p>Sample Template:</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0"><code># {{ ansible_managed }}

&lt;VirtualHost *:80&gt;
        ServerAdmin webmaster@{{ ansible_facts[&#39;fqdn&#39;] }}
        ServerName {{ ansible_facts[&#39;fqdn&#39;] }}
        ErrorLog logs/{{ ansible_facts[&#39;hostname&#39;] }}-error.log
        CustomLog       logs/{{ ansible_facts[&#39;hostname&#39;] }}-common.log common
        DocumentRoot /var/www/vhosts/{{ ansible_facts[&#39;hostname&#39;] }}/

        &lt;Directory /var/www/vhosts/{{ ansible_facts[&#39;hostname&#39;] }}&gt;
                Options +Indexes +FollowSymlinks +Includes
                Require all granted
        &lt;/Directory&gt;
&lt;/VirtualHost&gt;</code></pre></div>
<ul>
<li>
<p>starts with <strong># {{ ansible_managed }}</strong>.</p>
</li>
<li>
<p>This string is commonly used to identify that a file is managed by Ansible so that administrators are not going to change file contents by accident.</p>
</li>
<li>
<p>While processing the template, this string is replaced with the value of the <strong>ansible_managed</strong> variable.</p>
</li>
<li>
<p>This variable can be set in ansible.cfg.</p>
</li>
<li>
<p>For instance, you can use <strong>ansible_managed = This file is managed by Ansible</strong> to substitute the variable with its value while generating the template.</p>
</li>
<li>
<p>template file is just a text file that uses variables to substitute specific variables to their values.</p>
</li>
</ul>
<p>Calling a template:</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yml" data-lang="yml"><span style="display:flex;"><span>    ---
</span></span><span style="display:flex;"><span>    - <span style="color:#ff6ac1">name</span>: installing a template file
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">hosts</span>: ansible1
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">tasks</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#ff6ac1">name</span>: install httpd
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">yum</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#ff6ac1">name</span>: httpd
</span></span><span style="display:flex;"><span>          <span style="color:#ff6ac1">state</span>: latest
</span></span><span style="display:flex;"><span>      - <span style="color:#ff6ac1">name</span>: start and enable httpd
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">service</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#ff6ac1">name</span>: httpd
</span></span><span style="display:flex;"><span>          <span style="color:#ff6ac1">state</span>: started
</span></span><span style="display:flex;"><span>          <span style="color:#ff6ac1">enabled</span>: <span style="color:#ff6ac1">true</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#ff6ac1">name</span>: install vhost config file
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">template</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#ff6ac1">src</span>: listing813.j2
</span></span><span style="display:flex;"><span>          <span style="color:#ff6ac1">dest</span>: /etc/httpd/conf.d/vhost.conf
</span></span><span style="display:flex;"><span>          <span style="color:#ff6ac1">owner</span>: root
</span></span><span style="display:flex;"><span>          <span style="color:#ff6ac1">group</span>: root
</span></span><span style="display:flex;"><span>          <span style="color:#ff6ac1">mode</span>: <span style="color:#ff9f43">0644</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#ff6ac1">name</span>: restart httpd
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">service</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#ff6ac1">name</span>: httpd
</span></span><span style="display:flex;"><span>          <span style="color:#ff6ac1">state</span>: restarted</span></span></code></pre></div>
<h4 id="applying-control-structures-in-jinja2-using-for">Applying Control Structures in Jinja2 Using for</h4>
<ul>
<li>Control structures can be used to dynamically generate contents.</li>
<li>A <strong>for</strong> statement can be used to iterate over all elements that exist as the value of a variable.</li>
</ul>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0"><code>{% for node in groups[&#39;all&#39;] %}
host_port={{ node }}:8080
{% endfor %}</code></pre></div>
<ul>
<li>variable with the name <strong>host_ports</strong> is defined on the second line (which is the line that will be written to the target file).</li>
<li>To produce its value, the host group <strong>all</strong> is processed in the <strong>for</strong> statement on the first line.</li>
<li>While processing the host group, a temporary variable with the name <strong>node</strong> is defined.</li>
<li>This value of the <strong>node</strong> variable is replaced with the name of the host while it is processed, and after the host name, the string <strong>:8080</strong> is copied, which will result in a separate line for each host that was found.</li>
<li>As the last element, <strong>{% endfor %}</strong> is used to close the <strong>for</strong> loop.</li>
</ul>
<h3 id="lab-generating-a-template-with-a-conditional-statement">LAB: Generating a Template with a Conditional Statement</h3>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0"><code>    ---
    - name: generate host list
      hosts: ansible2
      tasks:
      - name: template loop
        template:
          src: listing815.j2
          dest: /tmp/hostports.txt</code></pre></div>
<p>To verify, you can use the ad hoc command <code>ansible ansible2 -a &quot;cat /tmp/hostports.txt&quot;</code></p>
<h4 id="using-conditional-statements-with-if">Using Conditional Statements with if</h4>
<ul>
<li>The <strong>for</strong> statement can be used in templates to iterate over a series of values.</li>
<li>The <strong>if</strong> statement can be used to include text only if a variable contains a specific value or evaluates to a Boolean true.</li>
</ul>
<p>Template Example with <strong>if</strong>
if.j2</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0"><code>    {% if apache_package == &#39;apache2&#39; %}
      Welcome to Apache2
    {% else %}
      Welcome to httpd
    {% endif %}</code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yml" data-lang="yml"><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span>- <span style="color:#ff6ac1">name</span>: work with template file
</span></span><span style="display:flex;"><span>  <span style="color:#ff6ac1">vars</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">apache_package</span>: <span style="color:#5af78e">&#39;httpd&#39;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff6ac1">hosts</span>: ansible2
</span></span><span style="display:flex;"><span>  <span style="color:#ff6ac1">tasks</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ff6ac1">template</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">src</span>: if.j2
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">dest</span>: /tmp/httpd.conf</span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#ff6ac1">[</span>ansible@control ~<span style="color:#ff6ac1">]</span>$ ansible ansible2 -a <span style="color:#5af78e">&#34;cat /tmp/httpd.conf&#34;</span>
</span></span><span style="display:flex;"><span>ansible2 | CHANGED | <span style="color:#ff5c57">rc</span><span style="color:#ff6ac1">=</span><span style="color:#ff9f43">0</span> &gt;&gt;
</span></span><span style="display:flex;"><span>  Welcome to httpd</span></span></code></pre></div>
<h4 id="using-filters">Using Filters</h4>
<ul>
<li>In Jinja2 templates, you can use filters.</li>
<li>Filters are a way to perform an operation on the value of a template expression, such as a variable.</li>
<li>The filter is included in the variable definition itself, and the result of the variable and its filter is used in the file that is generated.</li>
</ul>
<p>Common filters
<strong>{{ myvar | to_json }}</strong></p>
<ul>
<li>writes the contents of myvar in JSON format
<strong>{{ myvar || to_yaml }}</strong></li>
<li>writes the contents of myvar in YAML format
<strong>{{ myvar | ipaddr }}</strong></li>
<li>tests whether myvar contains an IP address</li>
</ul>
<h2 id="from-">From <a href="https://docs.ansible.com" rel="external" target="_blank">https://docs.ansible.com</a>:</h2>
<h4 id="how-do-i-loop-over-a-list-of-hosts-in-a-group-inside-of-a-template">How do I loop over a list of hosts in a group, inside of a template?</h4>
<p>A pretty common pattern is to iterate over a list of hosts inside of a host group, perhaps to populate a template configuration file with a list of servers. To do this, you can just access the â€œ$groupsâ€ dictionary in your template, like this:</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0"><code>{% for host in groups[&#39;db_servers&#39;] %}
    {{ host }}
{% endfor %}</code></pre></div>
<p>If you need to access facts about these hosts, for example, the IP address of each hostname, you need to make sure that the facts have been populated. For example, make sure you have a play that talks to db_servers:</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0"><code>- hosts:  db_servers
  tasks:
    - debug: msg=&#34;doesn&#39;t matter what you do, just that they were talked to previously.&#34;</code></pre></div>
<p>Then you can use the facts inside your template, like this:</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0"><code>{% for host in groups[&#39;db_servers&#39;] %}
   {{ hostvars[host][&#39;ansible_eth0&#39;][&#39;ipv4&#39;][&#39;address&#39;] }}
{% endfor %}</code></pre></div>
<h3 id="lab-working-with-conditional-statements-in-templates">Lab: Working with Conditional Statements in Templates</h3>
<p>1. Use your editor to create the file exercise83.j2. Include the following line to open the Jinja2 conditional statement:</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0"><code class="language-pre1" data-lang="pre1">{% for host in groups[&#39;all&#39;] %}</code></pre></div>
<p>2. This statement defines a variable with the name <strong>host</strong>. This variable iterates over the magic variable <strong>groups</strong>, which holds all Ansible host groups as defined in inventory. Of these groups, the <strong>all</strong> group (which holds all inventory host names) is processed.</p>
<p>3. Add the following line (write it as one line; it will wrap over two lines, but do not press Enter to insert a newline character):</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0"><code class="language-pre1" data-lang="pre1">{{ hostvars[host][&#39;ansible_default_ipv4&#39;][&#39;address&#39;] }} {{ hostvars[host][&#39;ansible_fqdn&#39;] }} {{ hostvars[host][&#39;ansible_hostname&#39;] }}</code></pre></div>
<ul>
<li>This line writes a single line for each inventory host, containing three items.</li>
<li>To do so, you use the magic variable <strong>hostvars</strong>, which can be used to identify Ansible facts that were discovered on the inventory host.</li>
<li>The <strong>[host]</strong> part is replaced with the name of the current host, and after that, the specific facts are referred to. As a result, for each host a line is produced that holds the IP address, the FQDN, and next the host name.</li>
</ul>
<p>4. Add the following line to close the <strong>for</strong> loop:</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0"><code class="language-pre1" data-lang="pre1">{% endfor %}</code></pre></div>
<p>5. Verify that the complete file contents look like the following and write and quit the file:</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0"><code class="language-pre1" data-lang="pre1">{% for host in groups[&#39;all&#39;] %}
{{ hostvars[host][&#39;ansible_default_ipv4&#39;][&#39;address&#39;] }} {{ hostvars[host][&#39;ansible_fqdn&#39;] }} {{ hostvars[host][&#39;ansible_hostname&#39;] }}
{% endfor %}</code></pre></div>
<p>6. Use your editor to create the file exercise83.yaml. It should contain the following lines:</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yml" data-lang="yml"><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span>- <span style="color:#ff6ac1">name</span>: generate /etc/hosts file
</span></span><span style="display:flex;"><span>  <span style="color:#ff6ac1">hosts</span>: all
</span></span><span style="display:flex;"><span>  <span style="color:#ff6ac1">tasks</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ff6ac1">name</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">template</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">src</span>: exercise83.j2
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">dest</span>: /tmp/hosts</span></span></code></pre></div>
<p>7. Run the playbook by using <code>ansible-playbook exercise83.yaml</code></p>
<p>8. Verify the /tmp/hosts file was generated by using <code>ansible all -a &quot;cat /tmp/hosts&quot;</code></p>
<p>This lab only worked if every host in the inventory file was reachable.</p>
<h3 id="lab-generate-an-etchosts-file">Lab: Generate an /etc/hosts File</h3>
<p>Write a playbook that generates an /etc/hosts file on all managed hosts.
Apply the following requirements:</p>
<p>â€¢ All hosts that are defined in inventory should be added to the
/etc/hosts file.</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0"><code>[ansible@control ~]$ cat hostfile.yaml
---
- name: generate /etc/hosts
  hosts: all
  gather_facts: yes
  tasks: 
  - name: Generate hosts file with template
    template: 
      src: hosts.j2
      dest: /etc/hosts
[ansible@control ~]$ cat hosts.j2
{% for host in groups[&#39;all&#39;] %}
{{ hostvars[host][&#39;ansible_default_ipv4&#39;][&#39;address&#39;] }} {{ hostvars[host][&#39;ansible_fqdn&#39;] }} {{ hostvars[host][&#39;ansible_hostname&#39;] }}
{% endfor %}}</code></pre></div>
<h3 id="lab-manage-a-vsftpd-service">Lab: Manage a vsftpd Service</h3>
<ul>
<li>Write a playbook that uses at least two plays to install a vsftpd service</li>
<li>configure the vsftpd service using templates</li>
<li>configure permissions as well as SELinux.</li>
<li>Install, start, and enable the vsftpd service.</li>
<li>open a port in the firewall to make it accessible.</li>
<li>Use the /etc/vsftpd/vsftpd.conf file to generate a template.</li>
<li>In this template, you should use the following variables to configure specific settings.</li>
<li>Replace these settings with the variables and leave all else unmodified:</li>
</ul>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0"><code>Anonymous_enable: yes
Local_enable: yes
Write_enable: yes
Anon_upload_enable: yes</code></pre></div>
<ul>
<li>Set permissions on the /var/ftp/pub directory to mode 0777.</li>
<li>Configure the <strong>ftpd_anon_write</strong> Boolean to allow anonymous user writes.</li>
<li>Set the <strong>public_content_rw_t</strong> SELinux context type to the /var/ftp/pub directory.</li>
<li>If any additional tasks are required to get this done, take care of them.</li>
</ul>
<p><code> vim vsftpd.yaml</code></p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yml" data-lang="yml"><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span>- <span style="color:#ff6ac1">name</span>: manage vsftpd
</span></span><span style="display:flex;"><span>  <span style="color:#ff6ac1">hosts</span>: ansible1
</span></span><span style="display:flex;"><span>  <span style="color:#ff6ac1">vars</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">anonymous_enable</span>: <span style="color:#ff6ac1">yes</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">local_enable</span>: <span style="color:#ff6ac1">yes</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">write_enable</span>: <span style="color:#ff6ac1">yes</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">Anon_upload_enable</span>: <span style="color:#ff6ac1">yes</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff6ac1">tasks</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#ff6ac1">name</span>: install vsftpd
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">dnf</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">name</span>: vsftpd
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">state</span>: latest
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    - <span style="color:#ff6ac1">name</span>: configure vsftpd configuration file
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">template</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">src</span>: vsftpd.j2
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">dest</span>: /etc/vsftpd/vsftpd.conf
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>- <span style="color:#ff6ac1">name</span>: apply permissions
</span></span><span style="display:flex;"><span>  <span style="color:#ff6ac1">hosts</span>: ansible1
</span></span><span style="display:flex;"><span>  <span style="color:#ff6ac1">tasks</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#ff6ac1">name</span>: set folder permissions to /var/ftp/pub
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">file</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">path</span>: /var/ftp/pub
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">mode</span>: <span style="color:#ff9f43">0777</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    - <span style="color:#ff6ac1">name</span>: set ftpd_anon_write boolean
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">seboolean</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">name</span>: ftpd_anon_write
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">state</span>: <span style="color:#ff6ac1">yes</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">persistent</span>: <span style="color:#ff6ac1">yes</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    - <span style="color:#ff6ac1">name</span>: set public_content_rw_t SELinux context type to /var/ftp/pub directory
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">sefcontext</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">target</span>: <span style="color:#5af78e">&#39;/var/ftp/pub(/.*)?&#39;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">setype</span>: public_content_rw_t
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">state</span>: present
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">notify</span>: restore selinux contexts
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    - <span style="color:#ff6ac1">name</span>: firewall stuff
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">firewalld</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">service</span>: ftp
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">state</span>: enabled
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">permanent</span>: <span style="color:#ff6ac1">true</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">immediate</span>: <span style="color:#ff6ac1">true</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    - <span style="color:#ff6ac1">name</span>: start and enable fsftpd
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">service</span>: 
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">name</span>: vsftpd
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">state</span>: started
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">enabled</span>: <span style="color:#ff6ac1">yes</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff6ac1">handlers</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#ff6ac1">name</span>: restore selinux contexts
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">command</span>: restorecon -v /var/ftp/pub</span></span></code></pre></div>
<p>vsftpd.j2</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0"><code>{{ ansible_managed }}

anonymous_enable={{ anonymous_enable }}
local_enable={{ local_enable }}
write_enable={{ write_enable }}
Anon_upload_enable{{ Anon_upload_enable }}
local_umask=022
dirmessage_enable=YES
xferlog_enable=YES
connect_from_port_20=YES
xferlog_std_format=YES
listen=NO
listen_ipv6=YES
pam_service_name=vsftpd
userlist_enable=YES</code></pre></div>

  <footer class="footline">
  </footer>
</article>
<article class="default">
  <header class="headline">
  </header>

<h1 id="jinja2-templates">Jinja2 templates</h1>

<h3 id="managing-selinux-properties">Managing SELinux Properties</h3>
<ul>
<li>SELinux can be used on files to manage file context</li>
<li>context can be set on ports</li>
<li>SELinux properties can be managed using Booleans.</li>
</ul>
<p>Modules for Managing Changes on SELinux:
<strong>file</strong></p>
<ul>
<li>Manages context on files but not in the SELinux Policy
<strong>sefcontext</strong></li>
<li>Manages file context in the SELinux policy
<strong>command</strong></li>
<li>Is required to run the <code>restorecon</code> command after using sefcontext
<strong>selinux</strong></li>
<li>Manages current SELinux state
<strong>seboolean</strong></li>
<li>Manages SELinux Booleans</li>
</ul>
<h4 id="managing-selinux-file-context">Managing SELinux File Context</h4>
<ul>
<li>The context type that is set on the file defines which processes can work with the files.</li>
<li>The file context type can be set on a file directly, or it can be set on the SELinux policy.</li>
<li>All SELinux properties should be set in the SELinux policy.</li>
</ul>
<p><strong>sefcontext</strong> module.</p>
<ul>
<li>Setting a context type in the policy doesn&rsquo;t automatically apply it to files though.</li>
<li>You still need to run the Linux <code>restorecon</code> command to do this.</li>
<li>Ansible does not offer a module to run this command; it needs to be invoked using the command module.</li>
</ul>
<p><strong>file</strong> module</p>
<ul>
<li>Can set SELinux context.</li>
<li>The context is set directly on the file, not in the SELinux policy.</li>
<li>As a result, if at any time default context is applied from the policy to the file system, all context that has been set with the Ansible file module risks being overwritten.</li>
</ul>
<p><strong>policycoreutils-python-utils RPM</strong></p>
<ul>
<li>Not installed by default in all installation patterns.</li>
<li>Needed to be able to work with the Ansible sefcontext module and the Linux <code>restorecon</code> command</li>
</ul>
<h3 id="lab-managing-selinux-context-with-sefcontext">Lab Managing SELinux Context with sefcontext</h3>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yml" data-lang="yml"><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span>- <span style="color:#ff6ac1">name</span>: show selinux
</span></span><span style="display:flex;"><span>  <span style="color:#ff6ac1">hosts</span>: all
</span></span><span style="display:flex;"><span>  <span style="color:#ff6ac1">tasks</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ff6ac1">name</span>: install required packages
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">yum</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">name</span>: policycoreutils-python-utils
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">state</span>: present
</span></span><span style="display:flex;"><span>  - <span style="color:#ff6ac1">name</span>: create testfile
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">file</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">name</span>: /tmp/selinux
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">state</span>: touch
</span></span><span style="display:flex;"><span>  - <span style="color:#ff6ac1">name</span>: set selinux context
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">sefcontext</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">target</span>: /tmp/selinux
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">setype</span>: httpd_sys_content_t
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">state</span>: present
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">notify</span>:
</span></span><span style="display:flex;"><span>      - run restorecon
</span></span><span style="display:flex;"><span>  <span style="color:#ff6ac1">handlers</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#ff6ac1">name</span>: run restorecon
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">command</span>: restorecon -v /tmp/selinux</span></span></code></pre></div>
<ul>
<li>You might just have to configure a service with a nondefault documentroot, which means that SELinux will deny access to the service.</li>
<li>You should ask yourself if this task requires any changes at an SELinux level.</li>
</ul>
<h4 id="applying-generic-selinux-management-tasks">Applying Generic SELinux Management Tasks</h4>
<p><strong>selinux</strong> module</p>
<ul>
<li>enables you to set the current state of SELinux to either permissive, enforcing, or disabled.</li>
</ul>
<p><strong>seboolean</strong> module</p>
<ul>
<li>enables you to easily enable or disable functionality in SELinux using Booleans.</li>
</ul>
<h3 id="lab-changing-selinux-state-and-booleans">Lab: Changing SELinux State and Booleans</h3>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yml" data-lang="yml"><span style="display:flex;"><span>    ---
</span></span><span style="display:flex;"><span>    - <span style="color:#ff6ac1">name</span>: enabling SELinux and a boolean
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">hosts</span>: ansible1
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">vars</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">myboolean</span>: httpd_read_user_content
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">tasks</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#ff6ac1">name</span>: enabling SELinux
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">selinux</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#ff6ac1">policy</span>: targeted &lt;--- must specify policy
</span></span><span style="display:flex;"><span>          <span style="color:#ff6ac1">state</span>: enforcing
</span></span><span style="display:flex;"><span>      - <span style="color:#ff6ac1">name</span>: checking current {{ myboolean }} Boolean status
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">shell</span>: getsebool -a | grep {{ myboolean }}
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">register</span>: bool_stat
</span></span><span style="display:flex;"><span>      - <span style="color:#ff6ac1">name</span>: showing boolean status
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">debug</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#ff6ac1">msg</span>: the current {{ myboolean }} status is {{ bool_stat.stdout }}
</span></span><span style="display:flex;"><span>      - <span style="color:#ff6ac1">name</span>: enabling boolean
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">seboolean</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#ff6ac1">name</span>: <span style="color:#5af78e">&#34;{{ myboolean }}&#34;</span>
</span></span><span style="display:flex;"><span>          <span style="color:#ff6ac1">state</span>: <span style="color:#ff6ac1">yes</span>
</span></span><span style="display:flex;"><span>          <span style="color:#ff6ac1">persistent</span>: <span style="color:#ff6ac1">yes</span></span></span></code></pre></div>
<h3 id="lab-changing-selinux-context">Lab: Changing SELinux Context</h3>
<ul>
<li>Install, start, and configure a web server that has the DocumentRoot set to the /web directory.</li>
<li>In this directory, create a file named index.html that shows the message &ldquo;welcome to the webserver.&rdquo;</li>
<li>Ensure that SELinux is enabled and allows access to the web server document root.</li>
<li>Also ensure that SELinux allows users to publish web pages from their home directory.</li>
</ul>
<p>1. Start by creating a playbook outline. A good approach for doing this is to create the playbook play header and list all tasks that need to be accomplished by providing a name as well as the name of the task that you want to run.
2. Enable SELinux and set to the enforcing state.
3. Install the web server, start and enable it, create the /web directory, and create the index.html file in the /web directory.
4. Use the <strong>lineinfile</strong> module to change the httpd.conf contents. Two different lines need to be changed.
5. Configure the SELinux-specific settings.
6. Run the playbook and verify its output.
8. Verify that the web service is accessible by using <code>curl http://ansible1</code>. In this case, it should not work. Try to analyze why.</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yml" data-lang="yml"><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span>- <span style="color:#ff6ac1">name</span>: Managing web server SELinux properties
</span></span><span style="display:flex;"><span>  <span style="color:#ff6ac1">hosts</span>: ansible1
</span></span><span style="display:flex;"><span>  <span style="color:#ff6ac1">tasks</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ff6ac1">name</span>: ensure SELinux is enabled and enforcing
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">selinux</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">policy</span>: targeted
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">state</span>: enforcing
</span></span><span style="display:flex;"><span>  - <span style="color:#ff6ac1">name</span>: install the webserver
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">yum</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">name</span>: httpd
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">state</span>: latest
</span></span><span style="display:flex;"><span>  - <span style="color:#ff6ac1">name</span>: start and enable the webserver
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">service</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">name</span>: httpd
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">state</span>: started
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">enabled</span>: <span style="color:#ff6ac1">yes</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#ff6ac1">name</span>: open the firewall service
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">firewalld</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">service</span>: http
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">state</span>: enabled
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">immediate</span>: <span style="color:#ff6ac1">yes</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#ff6ac1">name</span>: create the /web directory
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">file</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">name</span>: /web
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">state</span>: directory
</span></span><span style="display:flex;"><span>  - <span style="color:#ff6ac1">name</span>: create the index.html file in /web
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">copy</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">content</span>: â€™welcome to the exercise82 web serverâ€™
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">dest</span>: /web/index.html
</span></span><span style="display:flex;"><span>  - <span style="color:#ff6ac1">name</span>: use lineinfile to change webserver configuration
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">lineinfile</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">path</span>: /etc/httpd/conf/httpd.conf
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">regexp</span>: â€™^DocumentRoot &#34;/var/www/html&#34;â€™
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">line</span>: DocumentRoot &#34;/web&#34;
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">notify</span>: restart httpd
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  - <span style="color:#ff6ac1">name</span>: use lineinfile to change webserver security
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">lineinfile</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">path</span>: /etc/httpd/conf/httpd.conf
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">regexp</span>: â€™^&lt;Directory &#34;/var/www&#34;&gt;â€™
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">line</span>: â€™&lt;Directory &#34;/web&#34;&gt;â€™
</span></span><span style="display:flex;"><span>  - <span style="color:#ff6ac1">name</span>: use sefcontext to set context on new documentroot
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">sefcontext</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">target</span>: â€™/web(/.*)?â€™
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">setype</span>: httpd_sys_content_t
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">state</span>: present
</span></span><span style="display:flex;"><span>  - <span style="color:#ff6ac1">name</span>: run the restorecon command
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">command</span>: restorecon -Rv /web
</span></span><span style="display:flex;"><span>  - <span style="color:#ff6ac1">name</span>: allow the web server to run user content
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">seboolean</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">name</span>: httpd_read_user_content
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">state</span>: <span style="color:#ff6ac1">yes</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">persistent</span>: <span style="color:#ff6ac1">yes</span>
</span></span><span style="display:flex;"><span>      
</span></span><span style="display:flex;"><span>  <span style="color:#ff6ac1">handlers</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#ff6ac1">name</span>: restart httpd
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">service</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">name</span>: httpd
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">state</span>: restarted</span></span></code></pre></div>

  <footer class="footline">
  </footer>
</article>
          </section>
<article class="default">
  <header class="headline">
  </header>

<h1 id="deploying-files">Deploying Files</h1>

<div class="children children-type-card children-sort-"><ul class="card-container">
<li>
  <article class="card card-popout" aria-labelledby="R-card-b9a868726f77d99808e27926ffb2b9e0">
    <div class="card-content">
      <div class="card-title" id="R-card-b9a868726f77d99808e27926ffb2b9e0">
        <a href="/ansible/deploying-systems/building-an-ansible-lab-with-ansible/">
        Building an Ansible lab with Ansible
        </a>
      </div>
      <div class="card-content-text">
          <!-- raw HTML omitted -->

      </div>
    </div>
  </article>
</li>
</ul>
</div>

  <footer class="footline">
  </footer>
</article>
          <section>
            <h1 class="a11y-only">Subsections of Deploying Files</h1>
<article class="default">
  <header class="headline">
  </header>

<h1 id="building-an-ansible-lab-with-ansible">Building an Ansible lab with Ansible</h1>

<p>When I started studying for RHCE, the study guide had me manually set up virtual machines for the Ansible lab environment. I thought.. Why not start my automation journey right, and automate them using Vagrant.</p>
<p>I use Libvirt to manage KVM/QEMU Virtual Machines and the Virt-Manager app to set them up. I figured I could use Vagrant to automatically build this lab from a file. And I got part of the way. I ended up with this Vagrant file:</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>Vagrant.configure<span style="color:#ff6ac1">(</span><span style="color:#5af78e">&#34;2&#34;</span><span style="color:#ff6ac1">)</span> <span style="color:#ff6ac1">do</span> |config|
</span></span><span style="display:flex;"><span>  config.vm.box <span style="color:#ff6ac1">=</span> <span style="color:#5af78e">&#34;almalinux/9&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  config.vm.provider :libvirt <span style="color:#ff6ac1">do</span> |libvirt|
</span></span><span style="display:flex;"><span>    libvirt.uri <span style="color:#ff6ac1">=</span> <span style="color:#5af78e">&#34;qemu:///system&#34;</span>
</span></span><span style="display:flex;"><span>    libvirt.cpus <span style="color:#ff6ac1">=</span> <span style="color:#ff9f43">2</span>
</span></span><span style="display:flex;"><span>    libvirt.memory <span style="color:#ff6ac1">=</span> <span style="color:#ff9f43">2048</span>
</span></span><span style="display:flex;"><span>  end
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>   config.vm.define <span style="color:#5af78e">&#34;control&#34;</span> <span style="color:#ff6ac1">do</span> |control|
</span></span><span style="display:flex;"><span>    control.vm.network <span style="color:#5af78e">&#34;private_network&#34;</span>, ip: <span style="color:#5af78e">&#34;192.168.124.200&#34;</span>
</span></span><span style="display:flex;"><span>    control.vm.hostname <span style="color:#ff6ac1">=</span> <span style="color:#5af78e">&#34;control.example.com&#34;</span>
</span></span><span style="display:flex;"><span>  end
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  config.vm.define <span style="color:#5af78e">&#34;ansible1&#34;</span> <span style="color:#ff6ac1">do</span> |ansible1|
</span></span><span style="display:flex;"><span>    ansible1.vm.network <span style="color:#5af78e">&#34;private_network&#34;</span>, ip: <span style="color:#5af78e">&#34;192.168.124.201&#34;</span>
</span></span><span style="display:flex;"><span>    ansible1.vm.hostname <span style="color:#ff6ac1">=</span> <span style="color:#5af78e">&#34;ansible1.example.com&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  end
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  config.vm.define <span style="color:#5af78e">&#34;ansible2&#34;</span> <span style="color:#ff6ac1">do</span> |ansible2|
</span></span><span style="display:flex;"><span>    ansible2.vm.network <span style="color:#5af78e">&#34;private_network&#34;</span>, ip: <span style="color:#5af78e">&#34;192.168.124.202&#34;</span>
</span></span><span style="display:flex;"><span>    ansible2.vm.hostname <span style="color:#ff6ac1">=</span> <span style="color:#5af78e">&#34;ansible2.example.com&#34;</span>
</span></span><span style="display:flex;"><span>  end
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>end</span></span></code></pre></div>
<p>I could run this Vagrant file and Build and destroy the lab in seconds. But there was a problem. The Libvirt plugin, or Vagrant itself, I&rsquo;m not sure which, kept me from doing a couple important things.</p>
<p>First, I could not specify the initial disk creation size. I could add additional disks of varying sizes but, if I wanted to change the size of the first disk, I would have to go back in after the fact and expand it manually&hellip;</p>
<p>Second, the Libvirt plugin networking settings were a bit confusing. When you add the private network option as seen in the Vagrant file, it would add this as a secondary connection, and route everything through a different public connection.</p>
<p>Now I couldn&rsquo;t get the VMs to run using the public connection for whatever reason, and it seems the only workaround was to make DHCP reservations for the guests Mac addresses which gave me even more problems to solve. But I won&rsquo;t go there..</p>
<p>So why not get my feet wet and learn how to deploy VMs with Ansible? This way, I would get the granularity and control that Ansible gives me, some extra practice with Ansible, and not having to use software that has just enough abstraction to get in the way.</p>
<p>The guide I followed to set this up can be found on Redhat&rsquo;s blog <a href="https://www.redhat.com/en/blog/build-VM-fast-ansible" rel="external" target="_blank">here.</a> And it was pretty easy to set up all things considered.</p>
<p>I&rsquo;ll rehash the steps here:</p>
<ol>
<li>Download a cloud image</li>
<li>Customize the image</li>
<li>Install and start a VM</li>
<li>Access the VM</li>
</ol>
<h3 id="creating-the-role">Creating the role</h3>
<p>Move to roles directory
<code>cd roles</code></p>
<p>Initialize the role
<code>ansible-galaxy role init kvm_provision</code></p>
<p>Switch into the role directory
<code>cd kvm_provision/</code></p>
<p>Remove unused directories
<code>rm -r files handlers vars</code></p>
<h3 id="define-variables">Define variables</h3>
<p>Add default variables to main.yml
<code>cd defaults/ &amp;&amp; vim main.yml</code></p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span><span style="color:#78787e"># defaults file for kvm_provision</span>
</span></span><span style="display:flex;"><span><span style="color:#ff6ac1">base_image_name</span>: AlmaLinux-9-GenericCloud-9.5-20241120.x86_64.qcow2
</span></span><span style="display:flex;"><span><span style="color:#ff6ac1">base_image_url</span>: https://repo.almalinux.org/almalinux/9/cloud/x86_64/images/{{ base_image_name }}
</span></span><span style="display:flex;"><span><span style="color:#ff6ac1">base_image_sha</span>: abddf01589d46c841f718cec239392924a03b34c4fe84929af5d543c50e37e37
</span></span><span style="display:flex;"><span><span style="color:#ff6ac1">libvirt_pool_dir</span>: <span style="color:#5af78e">&#34;/var/lib/libvirt/images&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff6ac1">vm_name</span>: f34-dev
</span></span><span style="display:flex;"><span><span style="color:#ff6ac1">vm_vcpus</span>: <span style="color:#ff9f43">2</span>
</span></span><span style="display:flex;"><span><span style="color:#ff6ac1">vm_ram_mb</span>: <span style="color:#ff9f43">2048</span>
</span></span><span style="display:flex;"><span><span style="color:#ff6ac1">vm_net</span>: default
</span></span><span style="display:flex;"><span><span style="color:#ff6ac1">vm_root_pass</span>: test123
</span></span><span style="display:flex;"><span><span style="color:#ff6ac1">cleanup_tmp</span>: <span style="color:#ff6ac1">no</span>
</span></span><span style="display:flex;"><span><span style="color:#ff6ac1">ssh_key</span>: /root/.ssh/id_rsa.pub
</span></span><span style="display:flex;"><span><span style="color:#78787e"># Added option to configure ip address</span>
</span></span><span style="display:flex;"><span><span style="color:#ff6ac1">ip_addr</span>: <span style="color:#ff9f43">192.168.124.250</span>
</span></span><span style="display:flex;"><span><span style="color:#ff6ac1">gw_addr</span>: <span style="color:#ff9f43">192.168.124.1</span>
</span></span><span style="display:flex;"><span><span style="color:#78787e"># Added option to configure disk size</span>
</span></span><span style="display:flex;"><span><span style="color:#ff6ac1">vm_disksize</span>: <span style="color:#ff9f43">20</span></span></span></code></pre></div>
<h3 id="defining-a-vm-template">Defining a VM template</h3>
<p>The community.libvirt.virt module is used to provision a KVM VM. This module uses a VM definition in XML format with libvirt syntax. You can dump a VM definition of a current VM and then convert it to a template from there. Or you can just use this:</p>
<p><code>cd templates/ &amp;&amp; vim vm-template.xml.j2</code></p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="color:#ff6ac1">&lt;domain</span> <span style="color:#57c7ff">type=</span><span style="color:#5af78e">&#39;kvm&#39;</span><span style="color:#ff6ac1">&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff6ac1">&lt;name&gt;</span>{{ vm_name }}<span style="color:#ff6ac1">&lt;/name&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff6ac1">&lt;memory</span> <span style="color:#57c7ff">unit=</span><span style="color:#5af78e">&#39;MiB&#39;</span><span style="color:#ff6ac1">&gt;</span>{{ vm_ram_mb }}<span style="color:#ff6ac1">&lt;/memory&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff6ac1">&lt;vcpu</span> <span style="color:#57c7ff">placement=</span><span style="color:#5af78e">&#39;static&#39;</span><span style="color:#ff6ac1">&gt;</span>{{ vm_vcpus }}<span style="color:#ff6ac1">&lt;/vcpu&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff6ac1">&lt;os&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">&lt;type</span> <span style="color:#57c7ff">arch=</span><span style="color:#5af78e">&#39;x86_64&#39;</span> <span style="color:#57c7ff">machine=</span><span style="color:#5af78e">&#39;pc-q35-5.2&#39;</span><span style="color:#ff6ac1">&gt;</span>hvm<span style="color:#ff6ac1">&lt;/type&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">&lt;boot</span> <span style="color:#57c7ff">dev=</span><span style="color:#5af78e">&#39;hd&#39;</span><span style="color:#ff6ac1">/&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff6ac1">&lt;/os&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff6ac1">&lt;cpu</span> <span style="color:#57c7ff">mode=</span><span style="color:#5af78e">&#39;host-model&#39;</span> <span style="color:#57c7ff">check=</span><span style="color:#5af78e">&#39;none&#39;</span><span style="color:#ff6ac1">/&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff6ac1">&lt;devices&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">&lt;emulator&gt;</span>/usr/bin/qemu-system-x86_64<span style="color:#ff6ac1">&lt;/emulator&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">&lt;disk</span> <span style="color:#57c7ff">type=</span><span style="color:#5af78e">&#39;file&#39;</span> <span style="color:#57c7ff">device=</span><span style="color:#5af78e">&#39;disk&#39;</span><span style="color:#ff6ac1">&gt;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">&lt;driver</span> <span style="color:#57c7ff">name=</span><span style="color:#5af78e">&#39;qemu&#39;</span> <span style="color:#57c7ff">type=</span><span style="color:#5af78e">&#39;qcow2&#39;</span><span style="color:#ff6ac1">/&gt;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">&lt;source</span> <span style="color:#57c7ff">file=</span><span style="color:#5af78e">&#39;{{ libvirt_pool_dir }}/{{ vm_name }}.qcow2&#39;</span><span style="color:#ff6ac1">/&gt;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">&lt;target</span> <span style="color:#57c7ff">dev=</span><span style="color:#5af78e">&#39;vda&#39;</span> <span style="color:#57c7ff">bus=</span><span style="color:#5af78e">&#39;virtio&#39;</span><span style="color:#ff6ac1">/&gt;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">&lt;address</span> <span style="color:#57c7ff">type=</span><span style="color:#5af78e">&#39;pci&#39;</span> <span style="color:#57c7ff">domain=</span><span style="color:#5af78e">&#39;0x0000&#39;</span> <span style="color:#57c7ff">bus=</span><span style="color:#5af78e">&#39;0x05&#39;</span> <span style="color:#57c7ff">slot=</span><span style="color:#5af78e">&#39;0x00&#39;</span> <span style="color:#57c7ff">function=</span><span style="color:#5af78e">&#39;0x0&#39;</span><span style="color:#ff6ac1">/&gt;</span>
</span></span><span style="display:flex;"><span>       <span style="color:#78787e">&lt;!-- Added: Specify the disk size using a variable --&gt;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">&lt;size</span> <span style="color:#57c7ff">unit=</span><span style="color:#5af78e">&#39;GiB&#39;</span><span style="color:#ff6ac1">&gt;</span>{{ disk_size }}<span style="color:#ff6ac1">&lt;/size&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">&lt;/disk&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">&lt;interface</span> <span style="color:#57c7ff">type=</span><span style="color:#5af78e">&#39;network&#39;</span><span style="color:#ff6ac1">&gt;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">&lt;source</span> <span style="color:#57c7ff">network=</span><span style="color:#5af78e">&#39;{{ vm_net }}&#39;</span><span style="color:#ff6ac1">/&gt;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">&lt;model</span> <span style="color:#57c7ff">type=</span><span style="color:#5af78e">&#39;virtio&#39;</span><span style="color:#ff6ac1">/&gt;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">&lt;address</span> <span style="color:#57c7ff">type=</span><span style="color:#5af78e">&#39;pci&#39;</span> <span style="color:#57c7ff">domain=</span><span style="color:#5af78e">&#39;0x0000&#39;</span> <span style="color:#57c7ff">bus=</span><span style="color:#5af78e">&#39;0x01&#39;</span> <span style="color:#57c7ff">slot=</span><span style="color:#5af78e">&#39;0x00&#39;</span> <span style="color:#57c7ff">function=</span><span style="color:#5af78e">&#39;0x0&#39;</span><span style="color:#ff6ac1">/&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">&lt;/interface&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">&lt;channel</span> <span style="color:#57c7ff">type=</span><span style="color:#5af78e">&#39;unix&#39;</span><span style="color:#ff6ac1">&gt;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">&lt;target</span> <span style="color:#57c7ff">type=</span><span style="color:#5af78e">&#39;virtio&#39;</span> <span style="color:#57c7ff">name=</span><span style="color:#5af78e">&#39;org.qemu.guest_agent.0&#39;</span><span style="color:#ff6ac1">/&gt;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">&lt;address</span> <span style="color:#57c7ff">type=</span><span style="color:#5af78e">&#39;virtio-serial&#39;</span> <span style="color:#57c7ff">controller=</span><span style="color:#5af78e">&#39;0&#39;</span> <span style="color:#57c7ff">bus=</span><span style="color:#5af78e">&#39;0&#39;</span> <span style="color:#57c7ff">port=</span><span style="color:#5af78e">&#39;1&#39;</span><span style="color:#ff6ac1">/&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">&lt;/channel&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">&lt;channel</span> <span style="color:#57c7ff">type=</span><span style="color:#5af78e">&#39;spicevmc&#39;</span><span style="color:#ff6ac1">&gt;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">&lt;target</span> <span style="color:#57c7ff">type=</span><span style="color:#5af78e">&#39;virtio&#39;</span> <span style="color:#57c7ff">name=</span><span style="color:#5af78e">&#39;com.redhat.spice.0&#39;</span><span style="color:#ff6ac1">/&gt;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">&lt;address</span> <span style="color:#57c7ff">type=</span><span style="color:#5af78e">&#39;virtio-serial&#39;</span> <span style="color:#57c7ff">controller=</span><span style="color:#5af78e">&#39;0&#39;</span> <span style="color:#57c7ff">bus=</span><span style="color:#5af78e">&#39;0&#39;</span> <span style="color:#57c7ff">port=</span><span style="color:#5af78e">&#39;2&#39;</span><span style="color:#ff6ac1">/&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">&lt;/channel&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">&lt;input</span> <span style="color:#57c7ff">type=</span><span style="color:#5af78e">&#39;tablet&#39;</span> <span style="color:#57c7ff">bus=</span><span style="color:#5af78e">&#39;usb&#39;</span><span style="color:#ff6ac1">&gt;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">&lt;address</span> <span style="color:#57c7ff">type=</span><span style="color:#5af78e">&#39;usb&#39;</span> <span style="color:#57c7ff">bus=</span><span style="color:#5af78e">&#39;0&#39;</span> <span style="color:#57c7ff">port=</span><span style="color:#5af78e">&#39;1&#39;</span><span style="color:#ff6ac1">/&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">&lt;/input&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">&lt;input</span> <span style="color:#57c7ff">type=</span><span style="color:#5af78e">&#39;mouse&#39;</span> <span style="color:#57c7ff">bus=</span><span style="color:#5af78e">&#39;ps2&#39;</span><span style="color:#ff6ac1">/&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">&lt;input</span> <span style="color:#57c7ff">type=</span><span style="color:#5af78e">&#39;keyboard&#39;</span> <span style="color:#57c7ff">bus=</span><span style="color:#5af78e">&#39;ps2&#39;</span><span style="color:#ff6ac1">/&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">&lt;graphics</span> <span style="color:#57c7ff">type=</span><span style="color:#5af78e">&#39;spice&#39;</span> <span style="color:#57c7ff">autoport=</span><span style="color:#5af78e">&#39;yes&#39;</span><span style="color:#ff6ac1">&gt;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">&lt;listen</span> <span style="color:#57c7ff">type=</span><span style="color:#5af78e">&#39;address&#39;</span><span style="color:#ff6ac1">/&gt;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">&lt;image</span> <span style="color:#57c7ff">compression=</span><span style="color:#5af78e">&#39;off&#39;</span><span style="color:#ff6ac1">/&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">&lt;/graphics&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">&lt;video&gt;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">&lt;model</span> <span style="color:#57c7ff">type=</span><span style="color:#5af78e">&#39;qxl&#39;</span> <span style="color:#57c7ff">ram=</span><span style="color:#5af78e">&#39;65536&#39;</span> <span style="color:#57c7ff">vram=</span><span style="color:#5af78e">&#39;65536&#39;</span> <span style="color:#57c7ff">vgamem=</span><span style="color:#5af78e">&#39;16384&#39;</span> <span style="color:#57c7ff">heads=</span><span style="color:#5af78e">&#39;1&#39;</span> <span style="color:#57c7ff">primary=</span><span style="color:#5af78e">&#39;yes&#39;</span><span style="color:#ff6ac1">/&gt;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">&lt;address</span> <span style="color:#57c7ff">type=</span><span style="color:#5af78e">&#39;pci&#39;</span> <span style="color:#57c7ff">domain=</span><span style="color:#5af78e">&#39;0x0000&#39;</span> <span style="color:#57c7ff">bus=</span><span style="color:#5af78e">&#39;0x00&#39;</span> <span style="color:#57c7ff">slot=</span><span style="color:#5af78e">&#39;0x01&#39;</span> <span style="color:#57c7ff">function=</span><span style="color:#5af78e">&#39;0x0&#39;</span><span style="color:#ff6ac1">/&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">&lt;/video&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">&lt;memballoon</span> <span style="color:#57c7ff">model=</span><span style="color:#5af78e">&#39;virtio&#39;</span><span style="color:#ff6ac1">&gt;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">&lt;address</span> <span style="color:#57c7ff">type=</span><span style="color:#5af78e">&#39;pci&#39;</span> <span style="color:#57c7ff">domain=</span><span style="color:#5af78e">&#39;0x0000&#39;</span> <span style="color:#57c7ff">bus=</span><span style="color:#5af78e">&#39;0x06&#39;</span> <span style="color:#57c7ff">slot=</span><span style="color:#5af78e">&#39;0x00&#39;</span> <span style="color:#57c7ff">function=</span><span style="color:#5af78e">&#39;0x0&#39;</span><span style="color:#ff6ac1">/&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">&lt;/memballoon&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">&lt;rng</span> <span style="color:#57c7ff">model=</span><span style="color:#5af78e">&#39;virtio&#39;</span><span style="color:#ff6ac1">&gt;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">&lt;backend</span> <span style="color:#57c7ff">model=</span><span style="color:#5af78e">&#39;random&#39;</span><span style="color:#ff6ac1">&gt;</span>/dev/urandom<span style="color:#ff6ac1">&lt;/backend&gt;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">&lt;address</span> <span style="color:#57c7ff">type=</span><span style="color:#5af78e">&#39;pci&#39;</span> <span style="color:#57c7ff">domain=</span><span style="color:#5af78e">&#39;0x0000&#39;</span> <span style="color:#57c7ff">bus=</span><span style="color:#5af78e">&#39;0x07&#39;</span> <span style="color:#57c7ff">slot=</span><span style="color:#5af78e">&#39;0x00&#39;</span> <span style="color:#57c7ff">function=</span><span style="color:#5af78e">&#39;0x0&#39;</span><span style="color:#ff6ac1">/&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">&lt;/rng&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff6ac1">&lt;/devices&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff6ac1">&lt;/domain&gt;</span></span></span></code></pre></div>
<p>The template uses some of the variables from earlier. This allows flexibility to changes things by just changing the variables.</p>
<h2 id="define-tasks-for-the-role-to-perform">Define tasks for the role to perform</h2>
<p><code>cd ../tasks/ &amp;&amp; vim main.yml</code></p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span><span style="color:#78787e"># tasks file for kvm_provision</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#78787e">#Â ensure the required package dependenciesÂ `guestfs-tools`Â andÂ `python3-libvirt`Â are installed. This role requires these packages to connect toÂ `libvirt`Â and to customize the virtual image in a later step. These package names work on Fedora Linux. If you&#39;re using RHEL 8 or CentOS, useÂ `libguestfs-tools`Â instead ofÂ `guestfs-tools`. For other distributions, adjust accordingly.</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>- <span style="color:#ff6ac1">name</span>: Ensure requirements in place
</span></span><span style="display:flex;"><span>  <span style="color:#ff6ac1">package</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">name</span>:
</span></span><span style="display:flex;"><span>      - guestfs-tools
</span></span><span style="display:flex;"><span>      - python3-libvirt
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">state</span>: present
</span></span><span style="display:flex;"><span>  <span style="color:#ff6ac1">become</span>: <span style="color:#ff6ac1">yes</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#78787e"># obtain a list of existing VMs so that you don&#39;t overwrite an existing VM on accident. uses theÂ `virt`Â module from the collectionÂ `community.libvirt`, which interacts with a running instance of KVM withÂ `libvirt`. It obtains the list of VMs by specifying the parameterÂ `command: list_vms`Â and saves the results in a variableÂ `existing_vms`. `changed_when: no`Â for this task to ensure that it&#39;s not marked as changed in the playbook results. This task doesn&#39;t make any change in the machine; it only checks the existing VMs. This is a good practice when developing Ansible automation to prevent false reports of changes.</span>
</span></span><span style="display:flex;"><span>- <span style="color:#ff6ac1">name</span>: Get VMs list
</span></span><span style="display:flex;"><span>  <span style="color:#ff6ac1">community.libvirt.virt</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">command</span>: list_vms
</span></span><span style="display:flex;"><span>  <span style="color:#ff6ac1">register</span>: existing_vms
</span></span><span style="display:flex;"><span>  <span style="color:#ff6ac1">changed_when</span>: <span style="color:#ff6ac1">no</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#78787e">#execute only when the VM name the user provides doesn&#39;t exist. And uses the moduleÂ `get_url`Â to download the base cloud image into theÂ `/tmp`Â directory</span>
</span></span><span style="display:flex;"><span>- <span style="color:#ff6ac1">name</span>: Create VM if not exists
</span></span><span style="display:flex;"><span>  <span style="color:#ff6ac1">block</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ff6ac1">name</span>: Download base image
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">get_url</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">url</span>: <span style="color:#5af78e">&#34;{{ base_image_url }}&#34;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">dest</span>: <span style="color:#5af78e">&#34;/tmp/{{ base_image_name }}&#34;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">checksum</span>: <span style="color:#5af78e">&#34;sha256:{{ base_image_sha }}&#34;</span>
</span></span><span style="display:flex;"><span>      
</span></span><span style="display:flex;"><span><span style="color:#78787e"># copy the file to libvirt&#39;s pool directory so we don&#39;t edit the original, which can be used to provision other VMS later</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#ff6ac1">name</span>: Copy base image to libvirt directory
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">copy</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">dest</span>: <span style="color:#5af78e">&#34;{{ libvirt_pool_dir }}/{{ vm_name }}.qcow2&#34;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">src</span>: <span style="color:#5af78e">&#34;/tmp/{{ base_image_name }}&#34;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">force</span>: <span style="color:#ff6ac1">no</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">remote_src</span>: <span style="color:#ff6ac1">yes</span> 
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">mode</span>: <span style="color:#ff9f43">0660</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">register</span>: copy_results
</span></span><span style="display:flex;"><span>  - 
</span></span><span style="display:flex;"><span><span style="color:#78787e"># Resize the VM disk</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#ff6ac1">name</span>: Resize VM disk
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">command</span>: qemu-img resize &#34;{{ libvirt_pool_dir }}/{{ vm_name }}.qcow2&#34; &#34;{{ disk_size }}G&#34;
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">when</span>: copy_results is changed
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#78787e"># uses command module to run virt-customize to customize the image</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#ff6ac1">name</span>: Configure the image
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">command</span>: |<span style="color:#5af78e">
</span></span></span><span style="display:flex;"><span><span style="color:#5af78e">      virt-customize -a {{ libvirt_pool_dir }}/{{ vm_name }}.qcow2 \
</span></span></span><span style="display:flex;"><span><span style="color:#5af78e">      --hostname {{ vm_name }} \
</span></span></span><span style="display:flex;"><span><span style="color:#5af78e">      --root-password password:{{ vm_root_pass }} \
</span></span></span><span style="display:flex;"><span><span style="color:#5af78e">      --ssh-inject &#39;root:file:{{ ssh_key }}&#39; \
</span></span></span><span style="display:flex;"><span><span style="color:#5af78e">      --uninstall cloud-init --selinux-relabel</span>
</span></span><span style="display:flex;"><span><span style="color:#78787e"># Added option to configure an IP address</span>
</span></span><span style="display:flex;"><span>      --firstboot-command &#34;nmcli c m eth0 con-name eth0 ip4 {{ ip_addr }}/24 gw4 {{ gw_addr }} ipv4.method manual &amp;&amp; nmcli c d eth0 &amp;&amp; nmcli c u eth0&#34;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">when</span>: copy_results is changed
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  - <span style="color:#ff6ac1">name</span>: Define vm
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">community.libvirt.virt</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">command</span>: define
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">xml</span>: <span style="color:#5af78e">&#34;{{ lookup(&#39;template&#39;, &#39;vm-template.xml.j2&#39;) }}&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">when</span>: <span style="color:#5af78e">&#34;vm_name not in existing_vms.list_vms&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>- <span style="color:#ff6ac1">name</span>: Ensure VM is started
</span></span><span style="display:flex;"><span>  <span style="color:#ff6ac1">community.libvirt.virt</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">name</span>: <span style="color:#5af78e">&#34;{{ vm_name }}&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">state</span>: running
</span></span><span style="display:flex;"><span>  <span style="color:#ff6ac1">register</span>: vm_start_results
</span></span><span style="display:flex;"><span>  <span style="color:#ff6ac1">until</span>: <span style="color:#5af78e">&#34;vm_start_results is success&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff6ac1">retries</span>: <span style="color:#ff9f43">15</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff6ac1">delay</span>: <span style="color:#ff9f43">2</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>- <span style="color:#ff6ac1">name</span>: Ensure temporary file is deleted
</span></span><span style="display:flex;"><span>  <span style="color:#ff6ac1">file</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">path</span>: <span style="color:#5af78e">&#34;/tmp/{{ base_image_name }}&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">state</span>: absent
</span></span><span style="display:flex;"><span>  <span style="color:#ff6ac1">when</span>: cleanup_tmp | bool</span></span></code></pre></div>
<p>Changed my user to own the libvirt directory:
<code>chown -R david:david /var/lib/libvirt/images</code></p>
<p>Create playbook <code>kvm_provision.yaml</code></p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yml" data-lang="yml"><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span>- <span style="color:#ff6ac1">name</span>: Deploys VM based on cloud image
</span></span><span style="display:flex;"><span>  <span style="color:#ff6ac1">hosts</span>: localhost
</span></span><span style="display:flex;"><span>  <span style="color:#ff6ac1">gather_facts</span>: <span style="color:#ff6ac1">yes</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff6ac1">become</span>: <span style="color:#ff6ac1">yes</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff6ac1">vars</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">pool_dir</span>: <span style="color:#5af78e">&#34;/var/lib/libvirt/images&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">vm</span>: control
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">vcpus</span>: <span style="color:#ff9f43">2</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">ram_mb</span>: <span style="color:#ff9f43">2048</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">cleanup</span>: <span style="color:#ff6ac1">no</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">net</span>: default
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">ssh_pub_key</span>: <span style="color:#5af78e">&#34;/home/davidt/.ssh/id_ed25519.pub&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">disksize</span>: <span style="color:#ff9f43">20</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff6ac1">tasks</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#ff6ac1">name</span>: KVM Provision role
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">include_role</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">name</span>: kvm_provision
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">vars</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">libvirt_pool_dir</span>: <span style="color:#5af78e">&#34;{{ pool_dir }}&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">vm_name</span>: <span style="color:#5af78e">&#34;{{ vm }}&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">vm_vcpus</span>: <span style="color:#5af78e">&#34;{{ vcpus }}&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">vm_ram_mb</span>: <span style="color:#5af78e">&#34;{{ ram_mb }}&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">vm_net</span>: <span style="color:#5af78e">&#34;{{ net }}&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">cleanup_tmp</span>: <span style="color:#5af78e">&#34;{{ cleanup }}&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">ssh_key</span>: <span style="color:#5af78e">&#34;{{ ssh_pub_key }}&#34;</span></span></span></code></pre></div>
<p>Add the libvirt collection
<code>ansible-galaxy collection install community.libvirt</code></p>
<p>Create a VM with a new name
<code>ansible-playbook -K kvm_provision.yaml -e vm=ansible1</code></p>
<p>&ndash;run-command &rsquo;nmcli c a type Ethernet ifname eth0 con-name eth0 ip4 192.168.124.200 gw4 192.168.124.1'</p>
<p>parted /dev/vda resizepargit t 4 100%
Warning: Partition /dev/vda4 is being used. Are you sure you want to continue?
Yes/No? y                                                              <br>
Information: You may need to update /etc/fstab.</p>
<p>lsblk
NAME   MAJ:MIN RM  SIZE RO TYPE MOUNTPOINTS
vda    252:0    0   20G  0 disk
â”œâ”€vda2 252:2    0  200M  0 part /boot/efi
â”œâ”€vda3 252:3    0    1G  0 part /boot
â””â”€vda4 252:4    0  8.8G  0 part /</p>
<p>variables
{{ ansible_user }}
{{ ansible_password }}
{{ gw_addr }}
{{ ip_addr }}</p>
<p>; useradd -m -p {{ ansible_user }} ; chage -d 0 {{ ansible_user }} ; cat {{ ansible_password }} &gt; passwd {{ ansible_user }} &ndash;stdin&quot; \</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0"><code>  - name: Configure the image
    command: |
      virt-customize -a {{ libvirt_pool_dir }}/{{ vm_name }}.qcow2 \
      --hostname {{ vm_name }} \
      --root-password password:{{ vm_root_pass }} \
      --uninstall cloud-init --selinux-relabel \
      --firstboot-command &#34;nmcli c m eth0 con-name eth0 ip4 \
                           {{ ip_addr }}/24 gw4 {{ gw_addr }} \
                           ipv4.method manual &amp;&amp; nmcli c d eth0 \
                           &amp;&amp; nmcli c u eth0 &amp;&amp; adduser \
                           {{ ansible_user }} &amp;&amp; echo \
                           &#34;{{ ansible_password }}&#34; | passwd \
                           --stdin {{ ansible_user }}&#34;
    when: copy_results is changed

  - name: Add ssh keys
    command: |
      virt-customize -a {{ libvirt_pool_dir }}/{{ vm_name }}.qcow2 \
      --ssh-inject &#39;{{ ansible_user }}:file:{{ ssh_key }}&#39;</code></pre></div>

  <footer class="footline">
  </footer>
</article>
          </section>
<article class="default">
  <header class="headline">
  </header>

<h1 id="execution-environments">Execution Environments</h1>

<div class="children children-type-card children-sort-"><ul class="card-container">
<li>
  <article class="card card-popout" aria-labelledby="R-card-596b2691315dafe7b7088aa503fa2e71">
    <div class="card-content">
      <div class="card-title" id="R-card-596b2691315dafe7b7088aa503fa2e71">
        <a href="/ansible/execution-environments/ansible-builder/">
        Ansible Builder
        </a>
      </div>
      <div class="card-content-text">
          <!-- raw HTML omitted -->

      </div>
    </div>
  </article>
</li>
<li>
  <article class="card card-popout" aria-labelledby="R-card-cfe2d229469758bb1d07c009de11f2ed">
    <div class="card-content">
      <div class="card-title" id="R-card-cfe2d229469758bb1d07c009de11f2ed">
        <a href="/ansible/execution-environments/execution-environments/">
        Execution Environments
        </a>
      </div>
      <div class="card-content-text">
          <!-- raw HTML omitted -->

      </div>
    </div>
  </article>
</li>
</ul>
</div>

  <footer class="footline">
  </footer>
</article>
          <section>
            <h1 class="a11y-only">Subsections of Execution Environments</h1>
<article class="default">
  <header class="headline">
  </header>

<h1 id="ansible-builder">Ansible Builder</h1>

<p>Build portable control nodes packaged as containers. (Execution environments)</p>
<ul>
<li>Works with AWX and Ansible Navigator for playbook development and testing.</li>
<li>Able to choose specific Python and Ansible-core version</li>
<li>Also package with Python packages, system packages, and Ansible collections.</li>
</ul>
<p>Steps needed:</p>
<ol>
<li>Install <code>ansible-builder</code></li>
<li>Make sure podman is installed</li>
<li>Make an execution-environment.yml file that includes:
<ol>
<li>Base container image</li>
<li>Python version</li>
<li>Ansible-core version</li>
<li>ansible-runner version</li>
<li>collections with version restrictions</li>
<li>system packages with version restrictions</li>
<li>Python packages with version restrictions</li>
<li>other items to download, intsall, or configure</li>
</ol>
</li>
</ol>
<ul>
<li>If base image includes Python you omit that.</li>
</ul>
<p>Ansible builder execute&rsquo;s two steps:</p>
<ol>
<li>create containerfile for podman or Dockerfile for docker based on the definition file</li>
<li>run containerization tool to build an image based on the build instruction file and build context</li>
</ol>
<p><code>ansible-builder build</code></p>
<ul>
<li>runs both steps</li>
</ul>
<p><code>ansible-builder create</code></p>
<ul>
<li>runs first step only</li>
</ul>
<h4 id="building-images-with-ansible-builder">Building images with <code>ansible-builder</code></h4>
<p>Four stages to build a container image:</p>
<ol>
<li>Base: pull the base image, installPython version, pip, ansible-runner, and ansible-core</li>
<li>Galaxy: download collections and store them locally as files</li>
<li>Builder: download python/system packages and store them locally as files</li>
<li>Final: install downloaded files on the output of the base stage and generating a new image that includes all the content.</li>
</ol>
<p>Ansible Builder injects hooks at each stage of the container build process so you can add custom steps before and after every build stage.</p>
<p>You may need to install certain packages or utilities before the Galaxy and Builder stages. For example, if you need to install a collection from GitHub, you must install git after the Base stage to make it available during the Galaxy stage.</p>
<p>To add custom build steps, add anÂ <code>additional_build_steps</code>Â section to your execution environment definition.</p>
<p>Install:
<code> pip3 install ansible-builder</code></p>

  <footer class="footline">
  </footer>
</article>
<article class="default">
  <header class="headline">
  </header>

<h1 id="execution-environments">Execution Environments</h1>

<p>Why use EEs?</p>
<ul>
<li>Portable Ansible environments
<ul>
<li>includes Ansible core version</li>
<li>All desired collections</li>
<li>Python dependencies</li>
<li>Bindep dependencies</li>
<li>Anything you need to run a playbook</li>
</ul>
</li>
</ul>
<p>A container that has a specific version of Ansible. Can test execution in a specific Ansible environment to make sure it will work with that version.</p>
<p>EEs are built leveraging ansible-bulder
They can be pushed to a private automation hub or any container registry
Run EEs from the cli using ansible-navigator
Or run in your production environment using automation controller as part of the Ansible Automation Platform
If you want them to automatically occur, schedule them as a job inside AAP</p>

  <footer class="footline">
  </footer>
</article>
          </section>
<article class="default">
  <header class="headline">
  </header>

<h1 id="inventory">Inventory</h1>

<div class="children children-type-card children-sort-"><ul class="card-container">
<li>
  <article class="card card-popout" aria-labelledby="R-card-72889b43719a430a43c347168ec73fe7">
    <div class="card-content">
      <div class="card-title" id="R-card-72889b43719a430a43c347168ec73fe7">
        <a href="/ansible/inventory/ansible-inventory/">
        Ansible Inventory and Ansible.cfg
        </a>
      </div>
      <div class="card-content-text">
          <!-- raw HTML omitted -->

      </div>
    </div>
  </article>
</li>
<li>
  <article class="card card-popout" aria-labelledby="R-card-021e680f232c947f1fdf76d5d358e489">
    <div class="card-content">
      <div class="card-title" id="R-card-021e680f232c947f1fdf76d5d358e489">
        <a href="/ansible/inventory/ansible-inventory-command/">
        Ansible-inventory command
        </a>
      </div>
      <div class="card-content-text">
          <!-- raw HTML omitted -->

      </div>
    </div>
  </article>
</li>
<li>
  <article class="card card-popout" aria-labelledby="R-card-a103efd81b2544fbd2eac3c8c1c9e79e">
    <div class="card-content">
      <div class="card-title" id="R-card-a103efd81b2544fbd2eac3c8c1c9e79e">
        <a href="/ansible/inventory/dynamic-inventory/">
        Dynamic Inventory
        </a>
      </div>
      <div class="card-content-text">
          <!-- raw HTML omitted -->

      </div>
    </div>
  </article>
</li>
<li>
  <article class="card card-popout" aria-labelledby="R-card-6637492a0d4c19c1ebe0d9ebd379c2cb">
    <div class="card-content">
      <div class="card-title" id="R-card-6637492a0d4c19c1ebe0d9ebd379c2cb">
        <a href="/ansible/inventory/host-name-patterns/">
        Host Name Patterns
        </a>
      </div>
      <div class="card-content-text">
          <!-- raw HTML omitted -->

      </div>
    </div>
  </article>
</li>
<li>
  <article class="card card-popout" aria-labelledby="R-card-f9c3e159de9dc46328377dfd4e0a8249">
    <div class="card-content">
      <div class="card-title" id="R-card-f9c3e159de9dc46328377dfd4e0a8249">
        <a href="/ansible/inventory/using-multiple-inventories/">
        Using Multiple Inventories
        </a>
      </div>
      <div class="card-content-text">
          <!-- raw HTML omitted -->

      </div>
    </div>
  </article>
</li>
</ul>
</div>

  <footer class="footline">
  </footer>
</article>
          <section>
            <h1 class="a11y-only">Subsections of Inventory</h1>
<article class="default">
  <header class="headline">
  </header>

<h1 id="ansible-inventory-and-ansiblecfg">Ansible Inventory and Ansible.cfg</h1>

<h2 id="ansible-projects">Ansible projects</h2>
<p>For small companies, you can use a single Ansible configuration. But for larger ones, it&rsquo;s a good idea to use different project directories. A project directory contains everything you need to work on a single project. Including:</p>
<ul>
<li>playbooks</li>
<li>variable files</li>
<li>task files</li>
<li>inventory files</li>
<li>ansible.cfg</li>
</ul>
<p><em>playbook</em>
An Ansible script written in YAML that enforce the desired configuration on manage hosts.</p>
<h2 id="inventory">Inventory</h2>
<p>A file that Identifies hosts that Ansible has to manage. You can also use this to list and group hosts and specify host variables. Each project should have it&rsquo;s own inventory file.</p>
<p>/etc/ansible/hosts</p>
<ul>
<li>can be used for system wide inventory.</li>
<li>default if no inventory file is specified.</li>
<li>has some basic inventory formatting info if you forget)</li>
<li>Ansible will also target localhosts if no hosts are found in the inventory file.</li>
<li>It&rsquo;s a good idea to store inventory files in large environments in their own project folders.</li>
</ul>
<p>localhost is not defined in inventory. It is an implicit host that is usable and refers to the Ansible control machine. Using localhost can be a good way to verify the accessibility of services on managed hosts.</p>
<h3 id="listing-hosts">Listing hosts</h3>
<p>List hosts by IP address or hostname. You can list a range of hosts in an inventory file as well such as <code>web-server[1:10].example.com</code></p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>ansible1:2222 &lt; specify ssh port if the host is not using the default port 22
</span></span><span style="display:flex;"><span>ansible2
</span></span><span style="display:flex;"><span><span style="color:#ff9f43">10.0.10.55</span>
</span></span><span style="display:flex;"><span>web-server[1:10].example.com</span></span></code></pre></div>
<h3 id="listing-groups">Listing groups</h3>
<p>You can list groups and groups of groups. See the groups web and db are included in the group &ldquo;servers:children&rdquo;</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>ansible1
</span></span><span style="display:flex;"><span>ansible2
</span></span><span style="display:flex;"><span><span style="color:#ff9f43">10.0.10.55</span>
</span></span><span style="display:flex;"><span>web-server[1:10].example.com
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>[web]
</span></span><span style="display:flex;"><span>web-server[1:10].example.com
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>[db]
</span></span><span style="display:flex;"><span>db1
</span></span><span style="display:flex;"><span>db2
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>[servers:children] &lt;-- servers is the group of groups and children is the parameter that specifies child groups
</span></span><span style="display:flex;"><span>web
</span></span><span style="display:flex;"><span>db</span></span></code></pre></div>
<p>There are 3 general approaches to using groups:</p>
<p><strong>Functional groups</strong>
Address a specific group of hosts according to use. Such as web servers or database servers.</p>
<p><strong>Regional host groups</strong>
Used when working with region oriented infrastructure. Such as USA, Canada.</p>
<p><strong>Staging host groups</strong>
Used to address different hosts according to the staging phase that the current environment is in. Such as testing, development, production.</p>
<p>Undefined host groups are called implicit host groups. These are <strong>all</strong>, <strong>ungrouped</strong>, and <strong>localhost</strong>. Names making the meaning obvious.</p>
<h3 id="host-variables">Host variables</h3>
<p>In older versions of Ansible you could define variables for hosts. This is no longer used. Example:</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>[groupname:vars]
</span></span><span style="display:flex;"><span>ansible=ansible_user</span></span></code></pre></div>
<p>Variables are now set using <strong>host_vars</strong> and <strong>group_vars</strong> directories instead.</p>
<h3 id="multiple-inventory-files">Multiple inventory files</h3>
<p>Put all inventory files in a directory and specify the directory as the inventory to be used. For dynamic directories you also need to set the execution bit on the inventory file.</p>

  <footer class="footline">
  </footer>
</article>
<article class="default">
  <header class="headline">
  </header>

<h1 id="ansible-inventory-command">Ansible-inventory command</h1>

<h3 id="inventory-commands">Inventory commands:</h3>
<p>To view the inventory, specify the inventory file such as ~/base/inventory in the command line. You can name the inventory file anything you want. You can also set the default in the ansible.cfg file.</p>
<p>View the current inventory:
<code>ansible -i inventory &lt;pattern&gt; --list-hosts</code></p>
<p>List inventory hosts in JSON format:
<code>ansible-inventory -i inventory --list</code></p>
<p>Display overview of hosts as a graph:
<code>ansible-inventory -i inventory --graph</code></p>
<p>In our lab example:</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#ff6ac1">[</span>ansible@control base<span style="color:#ff6ac1">]</span>$ <span style="color:#ff5c57">pwd</span>
</span></span><span style="display:flex;"><span>/home/ansible/base
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff6ac1">[</span>ansible@control base<span style="color:#ff6ac1">]</span>$ ls
</span></span><span style="display:flex;"><span>inventory
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff6ac1">[</span>ansible@control base<span style="color:#ff6ac1">]</span>$ cat inventory
</span></span><span style="display:flex;"><span>ansible1
</span></span><span style="display:flex;"><span>ansible2
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff6ac1">[</span>web<span style="color:#ff6ac1">]</span>
</span></span><span style="display:flex;"><span>web1
</span></span><span style="display:flex;"><span>web2
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff6ac1">[</span>ansible@control base<span style="color:#ff6ac1">]</span>$ ansible-inventory -i inventory --graph
</span></span><span style="display:flex;"><span>@all:
</span></span><span style="display:flex;"><span>  |--@ungrouped:
</span></span><span style="display:flex;"><span>  |  |--ansible1
</span></span><span style="display:flex;"><span>  |  |--ansible2
</span></span><span style="display:flex;"><span>  |--@web:
</span></span><span style="display:flex;"><span>  |  |--web1
</span></span><span style="display:flex;"><span>  |  |--web2
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff6ac1">[</span>ansible@control base<span style="color:#ff6ac1">]</span>$ ansible-inventory -i inventory --list
</span></span><span style="display:flex;"><span><span style="color:#ff6ac1">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#5af78e">&#34;_meta&#34;</span>: <span style="color:#ff6ac1">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#5af78e">&#34;hostvars&#34;</span>: <span style="color:#ff6ac1">{}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">}</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#5af78e">&#34;all&#34;</span>: <span style="color:#ff6ac1">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#5af78e">&#34;children&#34;</span>: <span style="color:#ff6ac1">[</span>
</span></span><span style="display:flex;"><span>            <span style="color:#5af78e">&#34;ungrouped&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#5af78e">&#34;web&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">}</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#5af78e">&#34;ungrouped&#34;</span>: <span style="color:#ff6ac1">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#5af78e">&#34;hosts&#34;</span>: <span style="color:#ff6ac1">[</span>
</span></span><span style="display:flex;"><span>            <span style="color:#5af78e">&#34;ansible1&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#5af78e">&#34;ansible2&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">}</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#5af78e">&#34;web&#34;</span>: <span style="color:#ff6ac1">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#5af78e">&#34;hosts&#34;</span>: <span style="color:#ff6ac1">[</span>
</span></span><span style="display:flex;"><span>            <span style="color:#5af78e">&#34;web1&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#5af78e">&#34;web2&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">}</span>
</span></span><span style="display:flex;"><span><span style="color:#ff6ac1">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff6ac1">[</span>ansible@control base<span style="color:#ff6ac1">]</span>$ ansible -i inventory all --list-hosts
</span></span><span style="display:flex;"><span>  hosts <span style="color:#ff6ac1">(</span>4<span style="color:#ff6ac1">)</span>:
</span></span><span style="display:flex;"><span>    ansible1
</span></span><span style="display:flex;"><span>    ansible2
</span></span><span style="display:flex;"><span>    web1
</span></span><span style="display:flex;"><span>    web2
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span><span style="color:#ff6ac1">[</span>ansible@control base<span style="color:#ff6ac1">]</span>$ ansible -i inventory ungrouped --list-hosts
</span></span><span style="display:flex;"><span>  hosts <span style="color:#ff6ac1">(</span>2<span style="color:#ff6ac1">)</span>:
</span></span><span style="display:flex;"><span>    ansible1
</span></span><span style="display:flex;"><span>    ansible2</span></span></code></pre></div>
<h4 id="using-the-ansible-inventory-command">Using the ansible-inventory Command</h4>
<ul>
<li>default output of a dynamic inventory script is unformatted.</li>
<li>To show formatted JSON output of the scripts, you can use the <code>ansible-inventory</code> command.</li>
<li>Apart from the <code>--list</code> and <code>--host</code> options, this command also uses the <code>--graph</code> option to show a list of hosts, including the host groups they are a member of.</li>
</ul>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>    <span style="color:#ff6ac1">[</span>ansible@control rhce8-book<span style="color:#ff6ac1">]</span>$ ansible-inventory -i listing101.py --graph
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">[</span>WARNING<span style="color:#ff6ac1">]</span>: A duplicate localhost-like entry was found <span style="color:#ff6ac1">(</span>localhost<span style="color:#ff6ac1">)</span>. First found
</span></span><span style="display:flex;"><span>    localhost was 127.0.0.1
</span></span><span style="display:flex;"><span>    @all:
</span></span><span style="display:flex;"><span>      |--@ungrouped:
</span></span><span style="display:flex;"><span>      |  |--127.0.0.1
</span></span><span style="display:flex;"><span>      |  |--192.168.4.200
</span></span><span style="display:flex;"><span>      |  |--192.168.4.201
</span></span><span style="display:flex;"><span>      |  |--192.168.4.202
</span></span><span style="display:flex;"><span>      |  |--ansible1
</span></span><span style="display:flex;"><span>      |  |--ansible1.example.com
</span></span><span style="display:flex;"><span>      |  |--ansible2
</span></span><span style="display:flex;"><span>      |  |--ansible2.example.com
</span></span><span style="display:flex;"><span>      |  |--control
</span></span><span style="display:flex;"><span>      |  |--control.example.com
</span></span><span style="display:flex;"><span>      |  |--localhost
</span></span><span style="display:flex;"><span>      |  |--localhost.localdomain
</span></span><span style="display:flex;"><span>      |  |--localhost4
</span></span><span style="display:flex;"><span>      |  |--localhost4.localdomain4
</span></span><span style="display:flex;"><span>      |  |--localhost6
</span></span><span style="display:flex;"><span>      |  |--localhost6.localdomain6</span></span></code></pre></div>

  <footer class="footline">
  </footer>
</article>
<article class="default">
  <header class="headline">
  </header>

<h1 id="dynamic-inventory">Dynamic Inventory</h1>

<h3 id="dynamic-inventory-scripts">Dynamic inventory scripts</h3>
<p>A script is used to detect inventory hosts so that you do not have to manually enter them. This is good for larger environments. You can find community provided dynamic inventory scripts that come with an .ini file that provides information on how to connect to a resource.</p>
<p>Inventory scripts must include &ndash;list and &ndash;host options and output must be JSON formatted. Here is an example from <a href="https://github.com/sandervanvugt/rhce8-book/blob/master/listing33.py" rel="external" target="_blank">sandervanvught</a> that generates an inventory script using /etc/hosts:</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>[ansible<span style="color:#ff9f43">@control</span> base]<span style="color:#ff5c57">$</span> cat inventory<span style="color:#ff6ac1">-</span>helper<span style="color:#ff6ac1">.</span>py
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#78787e">#!/usr/bin/python</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff6ac1">from</span> subprocess <span style="color:#ff6ac1">import</span> Popen,PIPE
</span></span><span style="display:flex;"><span><span style="color:#ff6ac1">import</span> sys
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff6ac1">try</span>:
</span></span><span style="display:flex;"><span>     <span style="color:#ff6ac1">import</span> json
</span></span><span style="display:flex;"><span><span style="color:#ff6ac1">except</span> ImportError:
</span></span><span style="display:flex;"><span>     <span style="color:#ff6ac1">import</span> simplejson <span style="color:#ff6ac1">as</span> json
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>result <span style="color:#ff6ac1">=</span> {}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>result[<span style="color:#5af78e">&#39;all&#39;</span>] <span style="color:#ff6ac1">=</span> {}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>pipe <span style="color:#ff6ac1">=</span> Popen([<span style="color:#5af78e">&#39;getent&#39;</span>, <span style="color:#5af78e">&#39;hosts&#39;</span>], stdout<span style="color:#ff6ac1">=</span>PIPE, universal_newlines<span style="color:#ff6ac1">=</span><span style="color:#ff6ac1">True</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>result[<span style="color:#5af78e">&#39;all&#39;</span>][<span style="color:#5af78e">&#39;hosts&#39;</span>] <span style="color:#ff6ac1">=</span> []
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff6ac1">for</span> line <span style="color:#ff6ac1">in</span> pipe<span style="color:#ff6ac1">.</span>stdout<span style="color:#ff6ac1">.</span>readlines():
</span></span><span style="display:flex;"><span>    s <span style="color:#ff6ac1">=</span> line<span style="color:#ff6ac1">.</span>split()
</span></span><span style="display:flex;"><span>    result[<span style="color:#5af78e">&#39;all&#39;</span>][<span style="color:#5af78e">&#39;hosts&#39;</span>]<span style="color:#ff6ac1">=</span>result[<span style="color:#5af78e">&#39;all&#39;</span>][<span style="color:#5af78e">&#39;hosts&#39;</span>]<span style="color:#ff6ac1">+</span>s
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>result[<span style="color:#5af78e">&#39;all&#39;</span>][<span style="color:#5af78e">&#39;vars&#39;</span>] <span style="color:#ff6ac1">=</span> {}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff6ac1">if</span> <span style="color:#ff5c57">len</span>(sys<span style="color:#ff6ac1">.</span>argv) <span style="color:#ff6ac1">==</span> <span style="color:#ff9f43">2</span> <span style="color:#ff6ac1">and</span> sys<span style="color:#ff6ac1">.</span>argv[<span style="color:#ff9f43">1</span>] <span style="color:#ff6ac1">==</span> <span style="color:#5af78e">&#39;--list&#39;</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ff5c57">print</span>(json<span style="color:#ff6ac1">.</span>dumps(result))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff6ac1">elif</span> <span style="color:#ff5c57">len</span>(sys<span style="color:#ff6ac1">.</span>argv) <span style="color:#ff6ac1">==</span> <span style="color:#ff9f43">3</span> <span style="color:#ff6ac1">and</span> sys<span style="color:#ff6ac1">.</span>argv[<span style="color:#ff9f43">1</span>] <span style="color:#ff6ac1">==</span> <span style="color:#5af78e">&#39;--host&#39;</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ff5c57">print</span>(json<span style="color:#ff6ac1">.</span>dumps({}))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff6ac1">else</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ff5c57">print</span>(<span style="color:#5af78e">&#34;Requires an argument, please use --list or --host &lt;host&gt;&#34;</span>)</span></span></code></pre></div>
<p>When ran on our sample lab:</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#ff6ac1">[</span>ansible@control base<span style="color:#ff6ac1">]</span><span style="color:#ff5c57">$sudo</span> python3 ./inventory-helper.py
</span></span><span style="display:flex;"><span>Requires an argument, please use --list or --host &lt;host&gt;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff6ac1">[</span>ansible@control base<span style="color:#ff6ac1">]</span>$ sudo python3 ./inventory-helper.py --list
</span></span><span style="display:flex;"><span><span style="color:#ff6ac1">{</span><span style="color:#5af78e">&#34;all&#34;</span>: <span style="color:#ff6ac1">{</span><span style="color:#5af78e">&#34;hosts&#34;</span>: <span style="color:#ff6ac1">[</span><span style="color:#5af78e">&#34;127.0.0.1&#34;</span>, <span style="color:#5af78e">&#34;localhost&#34;</span>, <span style="color:#5af78e">&#34;localhost.localdomain&#34;</span>, <span style="color:#5af78e">&#34;localhost4&#34;</span>, <span style="color:#5af78e">&#34;localhost4.localdomain4&#34;</span>, <span style="color:#5af78e">&#34;127.0.0.1&#34;</span>, <span style="color:#5af78e">&#34;localhost&#34;</span>, <span style="color:#5af78e">&#34;localhost.localdomain&#34;</span>, <span style="color:#5af78e">&#34;localhost6&#34;</span>, <span style="color:#5af78e">&#34;localhost6.localdomain6&#34;</span>, <span style="color:#5af78e">&#34;192.168.124.201&#34;</span>, <span style="color:#5af78e">&#34;ansible1&#34;</span>, <span style="color:#5af78e">&#34;192.168.124.202&#34;</span>, <span style="color:#5af78e">&#34;ansible2&#34;</span><span style="color:#ff6ac1">]</span>, <span style="color:#5af78e">&#34;vars&#34;</span>: <span style="color:#ff6ac1">{}}}</span></span></span></code></pre></div>
<p>To use a dynamic inventory script:</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#ff6ac1">[</span>ansible@control base<span style="color:#ff6ac1">]</span>$ chmod u+x inventory-helper.py 
</span></span><span style="display:flex;"><span><span style="color:#ff6ac1">[</span>ansible@control base<span style="color:#ff6ac1">]</span>$ sudo ansible -i inventory-helper.py all --list-hosts
</span></span><span style="display:flex;"><span><span style="color:#ff6ac1">[</span>WARNING<span style="color:#ff6ac1">]</span>: A duplicate localhost-like entry was found <span style="color:#ff6ac1">(</span>localhost<span style="color:#ff6ac1">)</span>. First found localhost was 127.0.0.1
</span></span><span style="display:flex;"><span>  hosts <span style="color:#ff6ac1">(</span>11<span style="color:#ff6ac1">)</span>:
</span></span><span style="display:flex;"><span>    127.0.0.1
</span></span><span style="display:flex;"><span>    localhost
</span></span><span style="display:flex;"><span>    localhost.localdomain
</span></span><span style="display:flex;"><span>    localhost4
</span></span><span style="display:flex;"><span>    localhost4.localdomain4
</span></span><span style="display:flex;"><span>    localhost6
</span></span><span style="display:flex;"><span>    localhost6.localdomain6
</span></span><span style="display:flex;"><span>    192.168.124.201
</span></span><span style="display:flex;"><span>    ansible1
</span></span><span style="display:flex;"><span>    192.168.124.202
</span></span><span style="display:flex;"><span>    ansible2</span></span></code></pre></div>
<h4 id="configuring-dynamic-inventory">Configuring Dynamic Inventory</h4>
<p>dynamic inventory</p>
<ul>
<li>
<p>script that can be used to detect whether new hosts have been added to the managed environment.</p>
</li>
<li>
<p>Dynamic inventory scripts are provided by the community and exist for many different environments.</p>
</li>
<li>
<p>easy to write your own dynamic inventory script.</p>
</li>
<li>
<p>The main requirement is that the dynamic inventory script works with a <strong>--list</strong> and a <strong>--host &lt;hostname&gt;</strong> option and produces its output in JSON format.</p>
</li>
<li>
<p>Script must have the Linux execute permission set.</p>
</li>
<li>
<p>Many dynamic inventory scripts are written in Python, but this is not a requirement.</p>
</li>
<li>
<p>Writing dynamic inventory scripts is not an exam requirement</p>
</li>
</ul>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#78787e">#!/usr/bin/python</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span><span style="color:#ff6ac1">from</span> subprocess <span style="color:#ff6ac1">import</span> Popen,PIPE
</span></span><span style="display:flex;"><span><span style="color:#ff6ac1">import</span> sys
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span><span style="color:#ff6ac1">try</span>:
</span></span><span style="display:flex;"><span>     <span style="color:#ff6ac1">import</span> json
</span></span><span style="display:flex;"><span><span style="color:#ff6ac1">except</span> ImportError:
</span></span><span style="display:flex;"><span>     <span style="color:#ff6ac1">import</span> simplejson <span style="color:#ff6ac1">as</span> json
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>result <span style="color:#ff6ac1">=</span> {}
</span></span><span style="display:flex;"><span>result[<span style="color:#5af78e">&#39;all&#39;</span>] <span style="color:#ff6ac1">=</span> {}
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>pipe <span style="color:#ff6ac1">=</span> Popen([<span style="color:#5af78e">&#39;getent&#39;</span>, <span style="color:#5af78e">&#39;hosts&#39;</span>], stdout<span style="color:#ff6ac1">=</span>PIPE, universal_newlines<span style="color:#ff6ac1">=</span><span style="color:#ff6ac1">True</span>)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>result[<span style="color:#5af78e">&#39;all&#39;</span>][<span style="color:#5af78e">&#39;hosts&#39;</span>] <span style="color:#ff6ac1">=</span> []
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span><span style="color:#ff6ac1">for</span> line <span style="color:#ff6ac1">in</span> pipe<span style="color:#ff6ac1">.</span>stdout<span style="color:#ff6ac1">.</span>readlines():
</span></span><span style="display:flex;"><span>    s <span style="color:#ff6ac1">=</span> line<span style="color:#ff6ac1">.</span>split()
</span></span><span style="display:flex;"><span>    result[<span style="color:#5af78e">&#39;all&#39;</span>][<span style="color:#5af78e">&#39;hosts&#39;</span>]<span style="color:#ff6ac1">=</span>result[<span style="color:#5af78e">&#39;all&#39;</span>][<span style="color:#5af78e">&#39;hosts&#39;</span>]<span style="color:#ff6ac1">+</span>s
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>result[<span style="color:#5af78e">&#39;all&#39;</span>][<span style="color:#5af78e">&#39;vars&#39;</span>] <span style="color:#ff6ac1">=</span> {}
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span><span style="color:#ff6ac1">if</span> <span style="color:#ff5c57">len</span>(sys<span style="color:#ff6ac1">.</span>argv) <span style="color:#ff6ac1">==</span> <span style="color:#ff9f43">2</span> <span style="color:#ff6ac1">and</span> sys<span style="color:#ff6ac1">.</span>argv[<span style="color:#ff9f43">1</span>] <span style="color:#ff6ac1">==</span> <span style="color:#5af78e">&#39;--list&#39;</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ff5c57">print</span>(json<span style="color:#ff6ac1">.</span>dumps(result))
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span><span style="color:#ff6ac1">elif</span> <span style="color:#ff5c57">len</span>(sys<span style="color:#ff6ac1">.</span>argv) <span style="color:#ff6ac1">==</span> <span style="color:#ff9f43">3</span> <span style="color:#ff6ac1">and</span> sys<span style="color:#ff6ac1">.</span>argv[<span style="color:#ff9f43">1</span>] <span style="color:#ff6ac1">==</span> <span style="color:#5af78e">&#39;--host&#39;</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ff5c57">print</span>(json<span style="color:#ff6ac1">.</span>dumps({}))
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span><span style="color:#ff6ac1">else</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ff5c57">print</span>(<span style="color:#5af78e">&#34;Requires an argument, please use --list or --host &lt;host&gt;&#34;</span>)</span></span></code></pre></div>
<p><code>pipe = Popen(\['getent', 'hosts'\], stdout=PIPE, universal_newline=True)</code></p>
<ul>
<li>gets a list of hosts using the <code>getent</code> function.</li>
<li>This queries all hosts in /etc/hosts and other mechanisms where host name resolving is enabled.</li>
<li>To show the resulting host list, you can use the <code>\--list</code> command</li>
<li>To show details for a specific host, you can use the option <code>\--host hostname</code>.</li>
</ul>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>    <span style="color:#ff6ac1">[</span>ansible@control rhce8-book<span style="color:#ff6ac1">]</span>$ ./listing101.py --list
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">{</span><span style="color:#5af78e">&#34;all&#34;</span>: <span style="color:#ff6ac1">{</span><span style="color:#5af78e">&#34;hosts&#34;</span>: <span style="color:#ff6ac1">[</span><span style="color:#5af78e">&#34;127.0.0.1&#34;</span>, <span style="color:#5af78e">&#34;localhost&#34;</span>, <span style="color:#5af78e">&#34;localhost.localdomain&#34;</span>, <span style="color:#5af78e">&#34;localhost4&#34;</span>, <span style="color:#5af78e">&#34;localhost4.localdomain4&#34;</span>, <span style="color:#5af78e">&#34;127.0.0.1&#34;</span>, <span style="color:#5af78e">&#34;localhost&#34;</span>, <span style="color:#5af78e">&#34;localhost.localdomain&#34;</span>, <span style="color:#5af78e">&#34;localhost6&#34;</span>, <span style="color:#5af78e">&#34;localhost6.localdomain6&#34;</span>, <span style="color:#5af78e">&#34;192.168.4.200&#34;</span>, <span style="color:#5af78e">&#34;control.example.com&#34;</span>, <span style="color:#5af78e">&#34;control&#34;</span>, <span style="color:#5af78e">&#34;192.168.4.201&#34;</span>, <span style="color:#5af78e">&#34;ansible1.example.com&#34;</span>, <span style="color:#5af78e">&#34;ansible1&#34;</span>, <span style="color:#5af78e">&#34;192.168.4.202&#34;</span>, <span style="color:#5af78e">&#34;ansible2.example.com&#34;</span>, <span style="color:#5af78e">&#34;ansible2&#34;</span><span style="color:#ff6ac1">]</span>, <span style="color:#5af78e">&#34;vars&#34;</span>: <span style="color:#ff6ac1">{}}}</span></span></span></code></pre></div>
<ul>
<li>Dynamic inventory scripts are activated in the same way as regular inventory scripts: you use the <code>-i</code> option to either the <code>ansible</code> or the <code>ansible-playbook</code> command to pass the name of the inventory script as an argument.</li>
</ul>
<p>External directory service can be based on a wide range of solutions:</p>
<ul>
<li>
<p>FreeIPA</p>
</li>
<li>
<p>Active Directory</p>
</li>
<li>
<p>Red Hat Satellite</p>
</li>
<li>
<p>etc.</p>
</li>
<li>
<p>Also are available for virtual machine-based infrastructures such as VMware of Red Hat Enterprise Virtualization, where virtual machines can be discovered dynamically.</p>
</li>
<li>
<p>Can be found in cloud environments, where scripts are available for many solutions, including AWS, GCE, Azure, and OpenStack.</p>
</li>
</ul>
<p>When you are working with dynamic inventory, additional parameters are normally required:</p>
<ul>
<li>To get an inventory from an EC2 cloud environment, you need to enter your web keys.</li>
<li>To pass these parameters, many inventory scripts come with an additional configuration file that is formatted in .ini style.</li>
<li>The community-provided ec2.py script, for instance, comes with an ec2.ini parameter file.</li>
</ul>
<p>Another feature that is seen in many inventory scripts is cache management:</p>
<ul>
<li>Can use a cache to store names and parameters of recently discovered hosts.</li>
<li>If a cache is provided, options exist to manage the cache, allowing you, for instance, to make sure that the inventory information really is recently discovered.</li>
</ul>

  <footer class="footline">
  </footer>
</article>
<article class="default">
  <header class="headline">
  </header>

<h1 id="host-name-patterns">Host Name Patterns</h1>

<p>Working with host name patterns</p>
<h4 id="working-with-host-name-patterns">Working with Host Name Patterns</h4>
<ul>
<li>
<p>If you want to use an IP address in a playbook, the IP address must be specified as such in the inventory.</p>
</li>
<li>
<p>You cannot use IP addresses that are based only on DNS name resolving.</p>
</li>
<li>
<p>So specifying an IP address in the playbook but not in the inventory file&mdash;assuming DNS name resolution is going to take care of the IP address resolving&mdash;doesn&rsquo;t work.</p>
</li>
<li>
<p>apart from the specified groups, there are the implicit host groups all and ungrouped.</p>
</li>
<li>
<p>host name wildcards may be used.</p>
<ul>
<li><code>ansible -m ping 'ansible\*'</code>
<ul>
<li>match all hosts that have a name starting with ansible.</li>
<li>Must put the pattern between single quotes or it will fail with a no matching hosts error.</li>
</ul>
</li>
<li>Can be used at any place in the host name.
<ul>
<li><code>ansible -m ping '\*ble1'</code></li>
</ul>
</li>
</ul>
</li>
<li>
<p>When you use wildcards to match host names, Ansible doesn&rsquo;t distinguish between IP addresses, host names, or hosts; it just matches anything.</p>
<ul>
<li><code>'web\*'</code>
<ul>
<li>Matches all servers that are members of the group &lsquo;webservers&rsquo;, but also hosts &lsquo;web1&rsquo; and &lsquo;web2&rsquo;.</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>To address multiple hosts:</p>
<ul>
<li>You specify a comma-separated list of targets to address multiple hosts:
<ul>
<li><code>ansible -m ping ansible1,192.168.4.202</code></li>
<li>Can be a mix of host names, IP addresses, and host group names.</li>
</ul>
</li>
</ul>
<p>Operators:</p>
<ul>
<li>Can specify a logical AND condition by including an ampersand (&amp;), and a logical NOT by using an exclamation point (!).
<ul>
<li><code>web,&amp;file</code> applies to hosts only if they are members of the web and file groups</li>
<li><code>web,!webserver1</code> applies to all hosts in the web group, except host webserver1.</li>
<li>When you use the logical AND operator, the position of the ampersand doesn&rsquo;t matter.
<ul>
<li><code>web,&amp;file</code> as <code>&amp;web,file</code> also.</li>
</ul>
</li>
<li>You can use a colon (:) instead of a comma (,), but using a comma is better to avoid confusion when using IPv6 addresses.</li>
</ul>
</li>
</ul>

  <footer class="footline">
  </footer>
</article>
<article class="default">
  <header class="headline">
  </header>

<h1 id="using-multiple-inventories">Using Multiple Inventories</h1>

<h4 id="working-with-multiple-inventory-files">Working with Multiple Inventory Files</h4>
<ul>
<li>Ansible supports working with multiple inventory files.</li>
<li>One way of using multiple inventory files is to enter multiple <code>-i</code> parameters with the <code>ansible</code> or <code>ansible-playbook</code> commands to specify the name of the files to be used.</li>
<li><code>ansible-inventory -i inventory -i listing101.py --list</code>
<ul>
<li>Would produce an output list based on the static inventory in the inventory file, as well as the dynamic inventory that is generated by the listing101.py Python script.</li>
</ul>
</li>
<li>You can also  specify the name of a directory using the <code>-i</code> option.
<ul>
<li>Uses all files in the directory as inventory files.</li>
<li>When using an inventory directory, dynamic inventory files still must be executable for this approach to work.</li>
</ul>
</li>
</ul>
<h3 id="lab-using-multiple-inventories">Lab: Using Multiple Inventories</h3>
<ul>
<li>Open a shell as the ansible user and create a directory with the name inventories.</li>
<li>Copy the file listing101.py to the directory inventories.</li>
<li>Also copy the inventory file to the directory inventories.</li>
<li>To make sure both inventories have some unique contents, add the following lines to the file inventories/inventory:</li>
</ul>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0"><code class="language-pre1" data-lang="pre1">webserver1
webserver2</code></pre></div>
<ul>
<li>Add the following lines to the Linux /etc/hosts file:</li>
</ul>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0"><code class="language-pre1" data-lang="pre1">192.168.4.203    ansible3.example.com    ansible3
192.168.4.204    ansible4.example.com    ansible4</code></pre></div>
<ul>
<li>Use the command <code>ansible-inventory -i inventories --list</code>.</li>
</ul>

  <footer class="footline">
  </footer>
</article>
          </section>
<article class="default">
  <header class="headline">
  </header>

<h1 id="managing-processes-and-tasks">Managing Processes and Tasks</h1>

<div class="children children-type-card children-sort-"><ul class="card-container">
<li>
  <article class="card card-popout" aria-labelledby="R-card-1c40c2c3e00d2690b07ae917931be5a0">
    <div class="card-content">
      <div class="card-title" id="R-card-1c40c2c3e00d2690b07ae917931be5a0">
        <a href="/ansible/managing-processes-and-tasks/boot-process/">
        Boot Process
        </a>
      </div>
      <div class="card-content-text">
          <!-- raw HTML omitted -->

      </div>
    </div>
  </article>
</li>
<li>
  <article class="card card-popout" aria-labelledby="R-card-9d5e5b5b2cb650e9425d5202a307b429">
    <div class="card-content">
      <div class="card-title" id="R-card-9d5e5b5b2cb650e9425d5202a307b429">
        <a href="/ansible/managing-processes-and-tasks/managing-services/">
        Managing Services
        </a>
      </div>
      <div class="card-content-text">
          <!-- raw HTML omitted -->

      </div>
    </div>
  </article>
</li>
</ul>
</div>

  <footer class="footline">
  </footer>
</article>
          <section>
            <h1 class="a11y-only">Subsections of Managing Processes and Tasks</h1>
<article class="default">
  <header class="headline">
  </header>

<h1 id="boot-process">Boot Process</h1>

<h3 id="managing-the-boot-process">Managing the Boot Process</h3>
<p>Managing the boot process with Ansible is a bit disappointing because
Ansible offers no specific modules to do so. As a result, you must use
generic modules instead, like the file module to manage the systemd boot
targets or the lineinfile module to manage the GRUB configuration. What
Ansible does offer, however, is the reboot module, which enables you to
reboot a host and pick up after the reboot at the exact same location.
The next two sections describe how to do this.</p>
<h4 class="h4" id="managing-systemd-targets">Managing Systemd Targets</h4>
<p>Managing the default target that a host should start in is a common task
on Ansible. However, the systemd module has no options to manage this
setting, and no other option to manage it is available. For that reason,
you must fall back to a generic option instead.</p>
<p>If you need to manage the default systemd target, a file with the name
/etc/systemd/system/default.target has to exist as a symbolic link to
the desired default target. See, for instance, <a href="/ansible/managing-processes-and-tasks/boot-process/#ch14.xhtml#list14_5">Listing
14-5</a>, where the output of the Linux <strong>ls -l</strong>
command is used to show the current configuration.</p>
<p><strong>Listing 14-5</strong> Showing the Default Systemd Target</p>
<p>::: pre_1
[ansible@control rhce8-book]$ ls -l /etc/systemd/system/default.target
lrwxrwxrwx. 1 root root 37 Mar 23 05:33 /etc/systemd/system/default.target -&gt; /lib/systemd/system/multi-user.target
:::</p>
<p>Because Ansible itself doesn&rsquo;t have any module to specifically set the
default.target, you must use a generic module. In theory, you could use
either the command module or the file module, but because the file
module is a more specific module to generate the symbolic link, you
should use the file module. <a href="/ansible/managing-processes-and-tasks/boot-process/#ch14.xhtml#list14_6">Listing 14-6</a> shows
how to manage the boot target.</p>
<p><strong>Listing 14-6</strong> Managing the Default Boot Target</p>
<p>::: pre_1
&mdash;
- name: set default boot target
hosts: ansible2
tasks:
- name: set boot target to graphical
file:
src: /usr/lib/systemd/system/graphical.target
dest: /etc/systemd/system/default.target
state: link
:::</p>
<h4 class="h4" id="rebooting-managed-hosts">Rebooting Managed Hosts</h4>
<p>In some cases, a managed host needs to be rebooted while running a
playbook. To do so, you can use the reboot module. This module uses
several arguments to restart managed nodes. To verify the renewed
availability of the managed hosts, you need to specify the
<strong>test_command</strong> argument. This argument specifies an arbitrary command
that Ansible should run successfully on the managed hosts after the
reboot. The success of this command indicates that the rebooted host is
available again.</p>
<p>Equally useful while using the reboot module are the arguments that
relate to timeouts. The reboot module uses no fewer than four of them:</p>
<p>â€¢ <strong>connect_timeout:</strong> The maximum seconds to wait for a successful
connection before trying again</p>
<p>â€¢ <strong>post_reboot_delay:</strong> The number of seconds to wait after the
<strong>reboot</strong> command before trying to validate the managed host is
available again</p>
<p>â€¢ <strong>pre_reboot_delay:</strong> The number of seconds to wait before actually
issuing the reboot</p>
<p>â€¢ <strong>reboot_timeout:</strong> The maximum seconds to wait for the rebooted
machine to respond to the <strong>test</strong> command</p>
<p>When the rebooted host is back, the current playbook continues its
tasks. This scenario is shown in the example in <a href="/ansible/managing-processes-and-tasks/boot-process/#ch14.xhtml#list14_7">Listing
14-7</a>, where first all managed hosts are rebooted,
and after a successful reboot is issued, the message &ldquo;successfully
rebooted&rdquo; is shown. <a href="/ansible/managing-processes-and-tasks/boot-process/#ch14.xhtml#list14_8">Listing 14-8</a> shows the
result of running this playbook. In <a href="/ansible/managing-processes-and-tasks/boot-process/#ch14.xhtml#exe14_2">Exercise 14-2</a>
you can practice rebooting hosts using the reboot module.</p>
<p><strong>Listing 14-7</strong> Rebooting Managed Hosts</p>
<p>::: pre_1
&mdash;
- name: reboot all hosts
hosts: all
gather_facts: no
tasks:
- name: reboot hosts
reboot:
msg: reboot initiated by Ansible
test_command: whoami
- name: print message to show host is back
debug:
msg: successfully rebooted
:::</p>
<p><strong>Listing 14-8</strong> Verifying the Success of the reboot Module</p>
<p>::: pre_1
[ansible@control rhce8-book]$ ansible-playbook listing147.yaml</p>
<pre><code>PLAY [reboot all hosts] *************************************************************************************************

TASK [reboot hosts] *****************************************************************************************************
changed: [ansible2]
changed: [ansible1]
changed: [ansible3]
changed: [ansible4]
changed: [ansible5]

TASK [print message to show host is back] *******************************************************************************
ok: [ansible1] =&gt; {
    &quot;msg&quot;: &quot;successfully rebooted&quot;
}
ok: [ansible2] =&gt; {
    &quot;msg&quot;: &quot;successfully rebooted&quot;
}
ok: [ansible3] =&gt; {
    &quot;msg&quot;: &quot;successfully rebooted&quot;
}
ok: [ansible4] =&gt; {
    &quot;msg&quot;: &quot;successfully rebooted&quot;
}
ok: [ansible5] =&gt; {
    &quot;msg&quot;: &quot;successfully rebooted&quot;
}

PLAY RECAP **************************************************************************************************************
ansible1                   : ok=2    changed=1    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0
ansible2                   : ok=2    changed=1    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0
ansible3                   : ok=2    changed=1    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0
ansible4                   : ok=2    changed=1    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0
ansible5                   : ok=2    changed=1    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0
</code></pre>
<p>:::</p>
<p>::: box
<strong>Exercise 14-2 Managing Boot State</strong></p>
<p>1. As a preparation for this playbook, so that it actually changes the
default boot target on the managed host, use <strong>ansible ansible2 -m file
-a &ldquo;state=link src=/usr/lib/systemd/system/graphical.target
dest=/etc/systemd/system/default.target&rdquo;</strong>.</p>
<p>2. Use your editor to create the file exercise142.yaml and write the
following playbook header:</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0"><code class="language-pre1" data-lang="pre1">---
- name: set default boot target and reboot
  hosts: ansible2
  tasks:</code></pre></div>
<p>3. Now you set the default boot target to multi-user.target. Add the
following task to do so:</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0"><code class="language-pre1" data-lang="pre1">- name: set default boot target
  file:
    src: /usr/lib/systemd/system/multi-user.target
    dest: /etc/systemd/system/default.target
    state: link</code></pre></div>
<p>4. Complete the playbook to reboot the managed hosts by including the
following tasks:</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0"><code class="language-pre1" data-lang="pre1">- name: reboot hosts
  reboot:
    msg: reboot initiated by Ansible
    test_command: whoami
- name: print message to show host is back
  debug:
    msg: successfully rebooted</code></pre></div>
<p>5. Run the playbook by using <strong>ansible-playbook exercise142.yaml</strong>.</p>
<p>6. Test that the reboot was issued successfully by using <strong>ansible
ansible2 -a &ldquo;systemctl get-default&rdquo;</strong>.
:::</p>

  <footer class="footline">
  </footer>
</article>
<article class="default">
  <header class="headline">
  </header>

<h1 id="managing-services">Managing Services</h1>

<h3 id="managing-services">Managing Services</h3>
<p>Services can be managed in many ways. You can manage systemd services,
but Ansible also allows for management of tasks using Linux cron and at.
Apart from that, you can use Ansible to manage the desired systemd
target that a managed system should be started in, and it can reboot
running machines. <a href="/ansible/managing-processes-and-tasks/managing-services/#ch14.xhtml#tab14_2">Table 14-2</a> gives an overview of
the most significant modules for managing services.</p>
<p><strong>Table 14-2</strong> Modules Related to Service Management</p>
<p><a href="#R-image-6eff2791572a059d6248512416d26ce0" class="lightbox-link"><img alt="Image" class="lazy lightbox figure-image" loading="lazy" src="/Images/14tab02.jpg" style="height: auto;width: auto;"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-6eff2791572a059d6248512416d26ce0"><img alt="Image" class="lazy lightbox lightbox-image" loading="lazy" src="/Images/14tab02.jpg"></a></p>
<h4 id="managing-systemd-services">Managing Systemd Services</h4>
<p>Throughout this book you have used the service module a lot. This module
enables you to manage services, regardless of the init system that is
used, so it works with System-V init, with Upstart, as well as systemd.
In many cases, you can use the service module for any service-related
task.</p>
<p>If systemd specifics need to be addressed, you must use the systemd
module instead of the service module. Such systemd-specific features
include <strong>daemon_reload</strong> and <strong>mask</strong>. The <strong>daemon_reload</strong> feature
forces the systemd daemon to reread its configuration files, which is
useful after applying changes (or after editing the service files
directory, without using the Linux <strong>systemctl</strong> command). The <strong>mask</strong>
feature marks a systemd service in such a way that it cannot be started,
not even by accident. <a href="/ansible/managing-processes-and-tasks/managing-services/#ch14.xhtml#list14_1">Listing 14-1</a> shows an
example where the systemd module is used to manage services.</p>
<p><strong>Listing 14-1</strong> Using systemd Module Features</p>
<p>::: pre_1
&mdash;
- name: using systemd module to manage services
hosts: ansible2
tasks:
- name: enable service httpd and ensure it is not masked
systemd:
name: httpd
enabled: yes
masked: no
daemon_reload: yes
:::</p>
<p>Given the large amount of functionality that is available in systemd,
the functions that are offered by the systemd services are a bit
limited, and for many specific features, you must use generic modules
such as file and command instead. An example is setting the default
target, which is done by creating a symbolic link using the file module.</p>
<h4 id="managing-cron-jobs">Managing cron Jobs</h4>
<p>The cron module can be used to manage cron jobs. A Linux cron job is one
that is periodically executed by the Linux crond daemon at a specific
time. The cron module can manage jobs in different ways:</p>
<p>â€¢ Write the job directly to a user&rsquo;s crontab</p>
<p>â€¢ Write the job to /etc/crontab or under the /etc/cron.d directory</p>
<p>â€¢ Pass the job to anacron so that it will be run once an hour, day,
week, month, or year without specifically defining when exactly</p>
<p>If you are familiar with Linux cron, using the Ansible cron module is
straightforward. <a href="/ansible/managing-processes-and-tasks/managing-services/#ch14.xhtml#list14_2">Listing 14-2</a> shows an example
that runs the <strong>fstrim</strong> command every day at 4:05 and at 19:05.</p>
<p><strong>Listing 14-2</strong> Running a cron Job</p>
<pre><code>---
- name: run a cron job
  hosts: ansible2
  tasks:
  - name: run a periodic job
    cron:
      name: &quot;run fstrim&quot;
      minute: &quot;5&quot;
      hour: &quot;4,19&quot;
      job: &quot;fstrim&quot;
</code></pre>
<p>As a result of this playbook, a crontab file is created for user root.
To create a crontab file for another user, you can use the <strong>user</strong>
attribute. Notice that while managing cron jobs using the cron module, a
<strong>name</strong> attribute is specified. This attribute is required for Ansible
to manage the cron jobs and has no meaning for Linux crontab itself. If,
for instance, you later want to remove a cron job, you must use the name
of the job as an identifier.</p>
<p><a href="/ansible/managing-processes-and-tasks/managing-services/#ch14.xhtml#list14_3">Listing 14-3</a> shows a sample playbook that
removes the job that was created in <a href="/ansible/managing-processes-and-tasks/managing-services/#ch14.xhtml#list14_2">Listing
14-2</a>. Notice that it just specifies <strong>state:
absent</strong> as well as the name of the job that was previously created; no
other parameters are required.</p>
<p><strong>Listing 14-3</strong> Removing a cron Job Using the <strong>name</strong> Attribute</p>
<p>::: pre_1
&mdash;
- name: run a cron job
hosts: ansible2
tasks:
- name: run a periodic job
cron:
name: &ldquo;run fstrim&rdquo;
state: absent
:::</p>
<h4 class="h4" id="managing-at-jobs">Managing at Jobs</h4>
<p>Whereas you use Linux cron to schedule tasks at a regular interval, you
use Linux at to manage tasks that need to run once only. To interface
with Linux at, the Ansible at module is provided. <a href="/ansible/managing-processes-and-tasks/managing-services/#ch14.xhtml#tab14_3">Table
14-3</a> gives an overview of the arguments it takes
to specify how the task should be executed.</p>
<p>::: group
<strong>Table 14-3</strong> at Module Arguments Overview</p>
<p><a href="#R-image-65ea6fa0dba669139f1f2ae7266fe157" class="lightbox-link"><img alt="Image" class="lazy lightbox figure-image" loading="lazy" src="/Images/14tab03.jpg" style="height: auto;width: auto;"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-65ea6fa0dba669139f1f2ae7266fe157"><img alt="Image" class="lazy lightbox lightbox-image" loading="lazy" src="/Images/14tab03.jpg"></a></p>
<p>The most important point to understand when working with at is that it
is used to defined how far from now a task has to be executed. This is
done using <strong>count</strong> and <strong>units</strong>. If, for example, you want to run a
task five minutes from now, you specify the job with the arguments
<strong>count: 5</strong> and <strong>units: minutes</strong>. Also notice the use of the
<strong>unique</strong> argument. If set to yes, the task is ignored if a similar job
is scheduled to run already. <a href="/ansible/managing-processes-and-tasks/managing-services/#ch14.xhtml#list14_4">Listing 14-4</a> shows
an example.</p>
<p><strong>Listing 14-4</strong> Running Commands in the Future with at</p>
<p>::: pre_1
&mdash;
- name: run an at task
hosts: ansible2
tasks:
- name: run command and write output to file
at:
command: &ldquo;date &gt; /tmp/my-at-file&rdquo;
count: 5
units: minutes
unique: yes
state: present
:::</p>
<p>In <a href="/ansible/managing-processes-and-tasks/managing-services/#ch14.xhtml#exe14_1">Exercise 14-1</a> you practice your skills working
with the cron module.</p>
<p>::: box
<strong>Exercise 14-1 Managing cron Jobs</strong></p>
<p>1. Use your editor to create the playbook exercise141-1.yaml and give
it the following contents:</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0"><code class="language-pre1" data-lang="pre1">---
- name: run a cron job
  hosts: ansible2
  tasks:
  - name: run a periodic job
    cron:
      name: &#34;run logger&#34;
      minute: &#34;0&#34;
      hour: &#34;5&#34;
      job: &#34;logger IT IS 5 AM&#34;</code></pre></div>
<p>2. Use <strong>ansible-playbook exercise141-1.yaml</strong> to run the job.</p>
<p>3. Use the command <strong>ansible ansible2 -a &ldquo;crontab -l&rdquo;</strong> to verify the
cron job has been added. The output should look as follows:</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0"><code class="language-pre1" data-lang="pre1">ansible2 | CHANGED | rc=0 &gt;&gt;
#Ansible: run logger
0 5 * * * logger IT IS 5 AM</code></pre></div>
<p>4. Create a new playbook with the name exercise141-2 that runs a new
cron job but uses the same name:</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0"><code class="language-pre1" data-lang="pre1">---
- name: run a cron job
  hosts: ansible2
  tasks:
  - name: run a periodic job
    cron:
      name: &#34;run logger&#34;
      minute: &#34;0&#34;
      hour: &#34;6&#34;
      job: &#34;logger IT IS 6 AM&#34;</code></pre></div>
<p>5. Run this new playbook by using <strong>ansible-playbook
exercise141-2.yaml</strong>. Notice that the job runs with a <strong>changed</strong>
status.</p>
<p>6. Repeat the command <strong>ansible ansible2 -a &ldquo;crontab -l&rdquo;</strong>. This shows
you that the new cron job has overwritten the old job because it was
using the same name. Here is something important to remember: all cron
jobs should have a unique name!</p>
<p>7. Write the playbook exercise141-3.yaml to remove the cron job that
you just created:</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0"><code class="language-pre1" data-lang="pre1">---
- name: run a cron job
  hosts: ansible2
  tasks:
  - name: run logger
    cron:
      name: &#34;run logger&#34;
      state: absent</code></pre></div>
<p>8. Use <strong>ansible-playbook exercise141-3.yaml</strong> to run the last
playbook. Next, use <strong>ansible ansible2 -a &ldquo;crontab -l&rdquo;</strong> to verify that
the cron job was indeed removed.</p>

  <footer class="footline">
  </footer>
</article>
          </section>
<article class="default">
  <header class="headline">
  </header>

<h1 id="managing-software">Managing Software</h1>

<div class="children children-type-card children-sort-"><ul class="card-container">
<li>
  <article class="card card-popout" aria-labelledby="R-card-47b3941bcdf0e0a344819e2ff03f10c5">
    <div class="card-content">
      <div class="card-title" id="R-card-47b3941bcdf0e0a344819e2ff03f10c5">
        <a href="/ansible/managing-software/managing-packages/">
        Managing Packages
        </a>
      </div>
      <div class="card-content-text">
          <!-- raw HTML omitted -->

      </div>
    </div>
  </article>
</li>
<li>
  <article class="card card-popout" aria-labelledby="R-card-da1dba3b219ace48c12d0779f4c6578e">
    <div class="card-content">
      <div class="card-title" id="R-card-da1dba3b219ace48c12d0779f4c6578e">
        <a href="/ansible/managing-software/repositories-and-subscriptions/">
        Repositories and subscriptions
        </a>
      </div>
      <div class="card-content-text">
          <!-- raw HTML omitted -->

      </div>
    </div>
  </article>
</li>
</ul>
</div>

  <footer class="footline">
  </footer>
</article>
          <section>
            <h1 class="a11y-only">Subsections of Managing Software</h1>
<article class="default">
  <header class="headline">
  </header>

<h1 id="managing-packages">Managing Packages</h1>

<h3 id="using-modules-to-manage-packages">Using Modules to Manage Packages</h3>
<p>Managing software packages on managed nodes is one of the firstrequirements when working with Ansible. Different modules are available.
<a href="/ansible/managing-software/managing-packages/#ch12.xhtml#tab12_2">Table 12-2</a> provides an overview.</p>
<p><strong>Table 12-2</strong> Software Management Modules Overview</p>
<p><a href="#R-image-ec9d13d3092dc1272af93702270edc5f" class="lightbox-link"><img alt="Image" class="lazy lightbox figure-image" loading="lazy" src="/Images/12tab02.jpg" style="height: auto;width: auto;"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-ec9d13d3092dc1272af93702270edc5f"><img alt="Image" class="lazy lightbox lightbox-image" loading="lazy" src="/Images/12tab02.jpg"></a>{width=&ldquo;941&rdquo; height=&ldquo;295&rdquo;}
:::</p>
<h4 id="configuring-repository-access">Configuring Repository Access</h4>
<p>Before you can manage any software packages, you need to set up access
to a repository. To do so, the yum_repository module is provided. If you
have worked with yum repository files in the /etc/yum.repos.d/
directory, using the yum_repository module is not difficult because it
uses the same information.</p>
<p><a href="/ansible/managing-software/managing-packages/#ch12.xhtml#list12_1">Listing 12-1</a> shows an example of a playbook that
sets up access to a yum repository. Notice that this is an example only,
and it doesn&rsquo;t work yet because the repository has not been set up yet.</p>
<p><strong>Listing 12-1</strong> Configuring Repository Access</p>
<p>::: pre_1
&mdash;
- name: setting up repository access
hosts: all
tasks:
- name: connect to example repo
yum_repository:
name: example repo
description: RHCE8 example repo
file: examplerepo
baseurl: <a href="ftp://control.example.com/repo/" rel="external" target="_blank">ftp://control.example.com/repo/</a>
gpgcheck: no
:::</p>
<p>While setting up repository access, you should use a few arguments. You
can see an example of them in <a href="/ansible/managing-software/managing-packages/#ch12.xhtml#list12_1">Listing 12-1</a>.
<a href="/ansible/managing-software/managing-packages/#ch12.xhtml#tab12_3">Table 12-3</a> provides an overview.</p>
<p>::: group
<strong>Table 12-3</strong> yum_repository Key Arguments</p>
<p><a href="#R-image-00e4f72952834fbc6ee0ed7ca75d71f1" class="lightbox-link"><img alt="Image" class="lazy lightbox figure-image" loading="lazy" src="/Images/12tab03.jpg" style="height: auto;width: auto;"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-00e4f72952834fbc6ee0ed7ca75d71f1"><img alt="Image" class="lazy lightbox lightbox-image" loading="lazy" src="/Images/12tab03.jpg"></a>{width=&ldquo;941&rdquo; height=&ldquo;275&rdquo;}
:::</p>
<p>Notice that use of the <strong>gpgcheck</strong> argument is recommended but not
mandatory. Most repositories are provided with a GPG key to verify that
packages in the repository have not been tampered with. However, if no
GPG key is set up for the repository, the <strong>gpgcheck</strong> parameter can be
set to no to skip checking the GPG key.</p>
<h4 class="h4" id="managing-software-with-yum">Managing Software with yum</h4>
<p>The yum module can be used to manage software packages. You use it to
install and remove packages or to update packages. This can be done for
individual packages, as well as package groups and modules. Let&rsquo;s look
at some examples that go beyond the mere installation or removal of
packages, which was covered sufficiently in earlier chapters.</p>
<p><a href="/ansible/managing-software/managing-packages/#ch12.xhtml#list12_2">Listing 12-2</a> shows a module that will update all
packages on this system.</p>
<p><strong>Listing 12-2</strong> Using yum to Perform a System Update</p>
<p>::: pre_1
&mdash;
- name: updating all packages
hosts: ansible2
tasks:
- name: system update
yum:
name: â€™*â€™
state: latest
:::</p>
<p>Notice the use of the <strong>name</strong> argument to the yum module. It has
<strong>&rsquo;*&rsquo;</strong> as its argument. To prevent the wildcard from being interpreted
by the shell, you must make sure it is placed between single quotes.</p>
<p><a href="/ansible/managing-software/managing-packages/#ch12.xhtml#list12_3">Listing 12-3</a> shows an example where yum package
groups are used to install the Virtualization Host package group.</p>
<p><strong>Listing 12-3</strong> Installing Package Groups</p>
<p>::: pre_1
&mdash;
- name: install or update a package group
hosts: ansible2
tasks:
- name: install or update a package group
yum:
name: â€™@Virtualization Hostâ€™
state: latest
:::</p>
<p>When a yum package group instead of an individual package needs to be
installed, the name of the package group needs to start with an at sign
(@), and the entire package group name needs to be put between single
quotes. Also notice the use of <strong>state: latest</strong> in <a href="/ansible/managing-software/managing-packages/#ch12.xhtml#list12_3">Listing
12-3</a>. This line ensures that the packages in the
package group are installed if they have not been installed yet. If they
have already been installed, they are updated to the latest version.</p>
<p>A new feature in RHEL 8 is the yum AppStream module. Modules as listed
by the Linux <strong>yum modules list</strong> command can be managed with the
Ansible yum module also. Working with yum modules is similar to working
with yum package groups. In the example in <a href="/ansible/managing-software/managing-packages/#ch12.xhtml#list12_4">Listing
12-4</a>, the main difference is that a version
number and the installation profile are included in the module name.</p>
<p><strong>Listing 12-4</strong> Installing AppStream Modules with the yum Module</p>
<p>::: pre_1
&mdash;
- name: installing an AppStream module
hosts: ansible2
tasks:
- name: install or update an AppStream module
yum:
name: â€™@php:7.3/develâ€™
state: present
:::</p>
<p>::: note</p>
<hr>
<p><strong>Note</strong></p>
<p>When using the yum module to install multiple packages, you can provide
the <strong>name</strong> argument with a list of multiple packages. Alternatively,
you can provide multiple packages in a loop. Of these solutions, using a
list of multiple packages as the argument to <strong>name</strong> is always
preferred. If multiple package names are provided in a loop, the module
must execute a task for every single package. If multiple package names
are provided as the argument to <strong>name</strong>, yum can install all these
packages in one single task.</p>
<hr>
<p>:::</p>
<h4 class="h4" id="managing-package-facts">Managing Package Facts</h4>
<p>When Ansible is gathering facts, package facts are not included. To
include package facts as well, you need to run a separate task; that is,
you need to use the package_facts module. Facts that have been gathered
about packages are stored to the ansible_facts.packages variable. The
sample playbook in <a href="/ansible/managing-software/managing-packages/#ch12.xhtml#list12_5">Listing 12-5</a> shows how to use
the package_facts module.</p>
<p><strong>Listing 12-5</strong> Using the package_facts Module to Show Package Details</p>
<p>::: pre_1
&mdash;
- name: using package facts
hosts: ansible2
vars:
my_package: nmap
tasks:
- name: install package
yum:
name: &ldquo;{{ my_package }}&rdquo;
state: present
- name: update package facts
package_facts:
manager: auto
- name: show package facts for {{ my_package }}
debug:
var: ansible_facts.packages[my_package]
when: my_package in ansible_facts.packages
:::</p>
<p>As you can see, the package_facts module does not need much to do its
work. The only argument used here is the <strong>manager</strong> argument, which
specifies which package manager to communicate to. Its default value of
<strong>auto</strong> automatically detects the appropriate package manager and uses
that. If you want, you can specify the package manager manually, using
any package manager such as yum or dnf. <a href="/ansible/managing-software/managing-packages/#ch12.xhtml#list12_6">Listing
12-6</a> shows the output of running the <a href="/ansible/managing-software/managing-packages/#ch12.xhtml#list12_5">Listing
12-5</a> playbook, where you can see details that are
collected by the package_facts module.</p>
<p><strong>Listing 12-6</strong> Running <strong>ansible-playbook listing125.yaml</strong> Results</p>
<p>::: pre_1
[ansible@control rhce8-book]$ ansible-playbook listing125.yaml</p>
<pre><code>PLAY [using package facts] **************************************************************

TASK [Gathering Facts] ******************************************************************
ok: [ansible2]

TASK [install package] ******************************************************************
ok: [ansible2]

TASK [update package facts] *************************************************************
ok: [ansible2]

TASK [show package facts for my_package] ************************************************
ok: [ansible2] =&gt; {
    &quot;ansible_facts.packages[my_package]&quot;: [
        {
            &quot;arch&quot;: &quot;x86_64&quot;,
            &quot;epoch&quot;: 2,
            &quot;name&quot;: &quot;nmap&quot;,
            &quot;release&quot;: &quot;5.el8&quot;,
            &quot;source&quot;: &quot;rpm&quot;,
            &quot;version&quot;: &quot;7.70&quot;
        }
    ]
}

PLAY RECAP ******************************************************************************
ansible2                   : ok=4    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0
</code></pre>
<p>:::</p>
<p>In <a href="/ansible/managing-software/managing-packages/#ch12.xhtml#exe12_1">Exercise 12-1</a> you can practice working with
the different tools Ansible provides for module management.</p>
<p>::: box
<strong>Exercise 12-1 Managing Software Packages</strong></p>
<p>1. Use your editor to create a new file with the name exercise121.yaml.</p>
<p>2. Write a play header that defines the variable <strong>my_package</strong> and
sets its value to <strong>virt-manager</strong>:</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0"><code class="language-pre1" data-lang="pre1">---
- name: exercise121
  hosts: ansible2
  vars:
    my_package: virt-manager
  tasks:</code></pre></div>
<p>3. Add a task that installs the package based on the name of the
variable that was provided:</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0"><code class="language-pre1" data-lang="pre1">- name: install package
  yum:
    name: &#34;{{ my_package }}&#34;
    state: present</code></pre></div>
<p>4. Add a task that gathers facts about installed packages:</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0"><code class="language-pre1" data-lang="pre1">- name: update package facts
  package_facts:
    manager: auto</code></pre></div>
<p>5. As the last part of this exercise, add a task that shows facts about
the package that you have just installed:</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0"><code class="language-pre1" data-lang="pre1">- name: show package facts for {{ my_package }}
  debug:
    var: ansible_facts.packages[my_package]
  when: my_package in ansible_facts.packages</code></pre></div>
<p>6. Run the playbook using <strong>ansible-playbook exercise121.yaml</strong> and
verify its output.
:::</p>

  <footer class="footline">
  </footer>
</article>
<article class="default">
  <header class="headline">
  </header>

<h1 id="repositories-and-subscriptions">Repositories and subscriptions</h1>

<h3 id="using-modules-to-manage-repositories-and-subscriptions">Using Modules to Manage Repositories and Subscriptions</h3>
<p>To work with software packages, you need to make sure that repositories
are accessible and subscriptions are available. In the previous section
you learned how to write a playbook that enables you to access an
existing repository. In this section you learn how to set up the server
part of a repository if that still needs to be done. Also, you learn how
to manage RHEL subscriptions using Ansible.</p>
<h4 class="h4" id="setting-up-repositories">Setting Up Repositories</h4>
<p>Most managed systems access the default distributions that are provided
while installing the operating system. In some cases external
repositories might not be accessible. If that happens, you need to set
up a repository yourself. Before you can do that, however, it&rsquo;s
important to know what a repository is. A repository is a directory that
contains RPM files, as well as the repository metadata, which is an
index that allows the repository client to figure out which packages are
available in the repository.</p>
<p>Ansible does not provide a specific module to set up a repository. You
must use a number of modules instead. Exactly which modules are involved
depends on how you want to set up the repository. For instance, if you
want to set up an FTP-based repository on the Ansible control host, you
need to accomplish the following tasks:</p>
<p>â€¢ Install the FTP package.</p>
<p>â€¢ Start and enable the FTP server.</p>
<p>â€¢ Open the firewall for FTP traffic.</p>
<p>â€¢ Make sure the FTP shared repository directory is available.</p>
<p>â€¢ Download packages to the repository directory.</p>
<p>â€¢ Use the Linux <strong>createrepo</strong> command to generate the index that is
required in each repository.</p>
<p>The playbook in <a href="/ansible/managing-software/repositories-and-subscriptions/#ch12.xhtml#list12_7">Listing 12-7</a> provides an example
of how this can be done.</p>
<p><strong>Listing 12-7</strong> Setting Up an FTP-based Repository</p>
<p>::: pre_1
- name: install FTP to export repo
hosts: localhost
tasks:
- name: install FTP server
yum:
name:
- vsftpd
- createrepo_c
state: latest
- name: start FTP server
service:
name: vsftpd
state: started
enabled: yes
- name: open firewall for FTP
firewalld:
service: ftp
state: enabled
permanent: yes</p>
<pre><code>- name: setup the repo directory
  hosts: localhost
  tasks:
  - name: make directory
    file:
      path: /var/ftp/repo
      state: directory
  - name: download packages
    yum:
      name: nmap
      download_only: yes
      download_dir: /var/ftp/repo
  - name: createrepo
    command: createrepo /var/ftp/repo
</code></pre>
<p>:::</p>
<p>The most significant tasks in setting up the repository are the
<strong>download packages</strong> and <strong>createrepo</strong> tasks. In the <strong>download
packages</strong> task, the yum module is used to download a single package. To
do so, the <strong>download_only</strong> argument is used to ensure that the package
is not installed but downloaded to a directory. When you use the
<strong>download_only</strong> argument, you also must specify where the package
needs to be installed. To do this, the task uses the <strong>download_dir</strong>
argument.</p>
<p>There is one disadvantage in using this approach to download the
package, though: it requires repository access. If repository access is
not available, the fetch module can be used instead to download a file
from a specific URL.</p>
<h4 class="h4" id="managing-gpg-keys">Managing GPG Keys</h4>
<p>To guarantee the integrity of packages, most repositories are set up
with a GPG key. This enables the client to verify that packages have not
been tampered with while transmitted between the repository server and
client. For that reason, if packages are installed from a repository
server on the Internet, you should always make sure that <strong>gpgcheck:
yes</strong> is set while using the yum_repository module.</p>
<p>However, if you want to make sure that a GPG check is performed, you
need to make sure the client knows where to fetch the repository key. To
help with that, you can use the rpm_key module. You can see how to do
this in <a href="/ansible/managing-software/repositories-and-subscriptions/#ch12.xhtml#list12_8">Listing 12-8</a>. Notice that the playbook
in this listing doesn&rsquo;t work because no GPG-protected repository is
available. Setting up GPG-protected repositories is complex and outside
the scope of the EX294 objectives, and for that reason is not covered
here.</p>
<p><strong>Listing 12-8</strong> Using rpm_key to Fetch an RPM Key</p>
<p>::: pre_1
- name: use rpm_key in repository access
hosts: all
tasks:
- name: get the GPG public key
rpm_key:
key: <a href="ftp://control.example.com/repo/RPM-GPG-KEY" rel="external" target="_blank">ftp://control.example.com/repo/RPM-GPG-KEY</a>
state: present
- name: set up the repository client
yum_repository:
file: myrepo
name: myrepo
description: example repo
baseurl: <a href="ftp://control.example.com/repo" rel="external" target="_blank">ftp://control.example.com/repo</a>
enabled: yes
gpgcheck: yes
state: present
:::</p>
<h4 class="h4" id="managing-rhel-subscriptions">Managing RHEL Subscriptions</h4>
<p>When you work with Red Hat Enterprise Linux, configuring repository
access using the method described before is not enough. Red Hat
Enterprise Linux works with subscriptions, and to be able to access
software that is provided through your subscription entitlement, you
need to set up managed systems to access these subscriptions.</p>
<p>::: note</p>
<hr>
<p><strong>Tip</strong></p>
<p>Free developer subscriptions are available for RHEL as well as Ansible.
Register yourself at <a href="https://developers.redhat.com" rel="external" target="_blank">https://developers.redhat.com</a> and sign up for a
free subscription if you want to test the topics described in this
section on RHEL and you don&rsquo;t have a valid subscription yet.</p>
<hr>
<p>:::</p>
<p>To understand how to use the Ansible modules to register a RHEL system,
you need to understand how to use the Linux command-line utilities. When
you are managing subscriptions from the Linux command line, multiple
steps are involved.</p>
<p>1. First, you use the <strong>subscription-manager register</strong> command to
provide your RHEL credentials. Use, for instance, <strong>subscription-manager
register --username=yourname --password=yourpassword</strong>.</p>
<p>2. Next, you need to find out which pools are available in your
account. A pool is a collection of software channels available to your
account. Use <strong>subscription-manager list --available</strong> for an overview.</p>
<p>3. Now you can connect to a specific pool using <strong>subscription-manager
attach --pool=<em>poolID</em></strong>. Note that if only one subscription pool is
available in your account, you don&rsquo;t have to provide the <strong>--pool</strong>
argument.</p>
<p>4. Next, you need to find out which additional repositories are
available to your account by using <strong>subscription-manager repos
--list</strong>.</p>
<p>5. To register to use additional repositories, you use
<strong>subscription-manager repos --enable &ldquo;repos name&rdquo;</strong>. Your system then
has full access to its subscription and related repositories.</p>
<p>Two significant modules are provided by Ansible:</p>
<p>â€¢ <strong>redhat_subscription:</strong> This module enables you to perform
subscription and registration in one task.</p>
<p>â€¢ <strong>rhsm_repository:</strong> This module enables you to add subscription
manager repositories.</p>
<p><a href="/ansible/managing-software/repositories-and-subscriptions/#ch12.xhtml#list12_9">Listing 12-9</a> shows an example of a playbook that
uses these modules to fully register a new RHEL 8 machine and add a new
repository to the managed machine. Notice that this playbook is not
runnable as such because important additional information needs to be
provided. <a href="/ansible/managing-software/repositories-and-subscriptions/#ch12.xhtml#exe12_3">Exercise 12-3</a>, later in the section
titled &ldquo;Implementing a Playbook to Manage Software,&rdquo; will guide you to a
scenario that shows how to use this code in production.</p>
<p><strong>Listing 12-9</strong> Using Subscription Manager to Set Up Ansible</p>
<p>::: pre_1
&mdash;
- name: use subscription manager to register and set up repos
hosts: ansible5
tasks:
- name: register and subscribe ansible5
redhat_subscription:
username: <a href="mailto:bob@example.com" rel="external" target="_blank">bob@example.com</a>
password: verysecretpassword
state: present
- name: configure additional repo access
rhsm_repository:
name:
- rh-gluster-3-client-for-rhel-8-x86_64-rpms
- rhel-8-for-x86_64-appstream-debug-rpms
state: present
:::</p>
<p>In the sample playbook in <a href="/ansible/managing-software/repositories-and-subscriptions/#ch12.xhtml#list12_9">Listing 12-9</a>, you can
see how the redhat_subscription and rhsm_repository modules are used.
Notice that redhat_subscription requires a password. In <a href="/ansible/managing-software/repositories-and-subscriptions/#ch12.xhtml#list12_9">Listing
12-9</a> the username and password are provided as
clear-text values in the playbook. From a security perspective, this is
very bad practice. You should use Ansible Vault instead. <a href="/ansible/managing-software/repositories-and-subscriptions/#ch12.xhtml#exe12_3">Exercise
12-3</a> will guide you through a setup where this is
done.</p>
<p>In <a href="/ansible/managing-software/repositories-and-subscriptions/#ch12.xhtml#exe12_2">Exercise 12-2</a> you are guided through the
procedure of setting up your own repository and using it. This procedure
consists of two distinct parts. In the first part you set up a
repository server that is based on FTP. Because in Ansible you often
need to configure topics that don&rsquo;t have your primary attention, you set
up the FTP server and also change its configuration. Next, you write a
second playbook that configures the clients with appropriate repository
access, and after doing so, install a package.</p>
<p>::: box
<strong>Exercise 12-2 Setting Up a Repository</strong></p>
<p>1. Use your editor to create the file exercise122-server.yaml.</p>
<p>2. Define the play that sets up the basic FTP configuration. Because
all its tasks should be familiar to you at this point, you can enter all
the tasks at once:</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0"><code class="language-pre1" data-lang="pre1">---
- name: install, configure, start and enable FTP
  hosts: localhost
  tasks:
  - name: install FTP server
    yum:
      name: vsftpd
      state: latest
  - name: allow anonymous access to FTP
    lineinfile:
      path: /etc/vsftpd/vsftpd.conf
      regexp: â€™^anonymous_enable=NOâ€™
      line: anonymous_enable=YES
  - name: start FTP server
    service:
      name: vsftpd
      state: started
      enabled: yes
  - name: open firewall for FTP
    firewalld:
      service: ftp
      state: enabled
      immediate: yes
      permanent: yes</code></pre></div>
<p>3. Set up a repository directory. Add the following play to the
playbook. Notice the use of the download packages task, which uses the
yum module to download a package without installing it. Also notice the
createrepo task, which creates the repository metadata that converts the
/var/ftp/repo directory into a repository.</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0"><code class="language-pre1" data-lang="pre1">- name: setup the repo directory
  hosts: localhost
  tasks:
  - name: make directory
    file:
      path: /var/ftp/repo
      state: directory
  - name: download packages
    yum:
      name: nmap
      download_only: yes
      download_dir: /var/ftp/repo
  - name: install createrepo package
    yum:
      name: createrepo_c
      state: latest
  - name: createrepo
    command: createrepo /var/ftp/repo
    notify:
    - restart_ftp
  handlers:
  - name: restart_ftp
    service:
      name: vsftpd
      state: restarted</code></pre></div>
<p>4. Use the command <strong>ansible-playbook exercise122-server.yaml</strong> to set
up the FTP server on control.example.com. If you haven&rsquo;t made any typos,
you shouldn&rsquo;t encounter any errors.</p>
<p>5. Now that the repository server has been installed, it&rsquo;s time to set
up the repository client. Use your editor to create the file
exercise122-client.yaml and write the play header as follows:</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0"><code class="language-pre1" data-lang="pre1">---
- name: configure repository
  hosts: all
  vars:
    my_package: nmap
  tasks:</code></pre></div>
<p>6. Add a task that uses the yum_repository module to configure access
to the new repository:</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0"><code class="language-pre1" data-lang="pre1">- name: connect to example repo
  yum_repository:
    name: exercise122
    description: RHCE8 exercise 122 repo
    file: exercise122
    baseurl: ftp://control.example.com/repo/
    gpgcheck: no</code></pre></div>
<p>7. After setting up the repository client, you also need to make sure
that the clients know how to reach the repository server by addressing
its name. Add the next task that writes a new line to /etc/hosts to make
sure host name resolving on the clients is set up correctly:</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0"><code class="language-pre1" data-lang="pre1">- name: ensure control is resolvable
  lineinfile:
    path: /etc/hosts
    line: 192.168.4.200  control.example.com  control

- name: install package
  yum:
    name: &#34;{{ my_package }}&#34;
    state: present</code></pre></div>
<p>8. If you are using the package_facts module, you need to remember to
update it after installing new packages. Add the following task to get
this done:</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0"><code class="language-pre1" data-lang="pre1">- name: update package facts
  package_facts:
    manager: auto</code></pre></div>
<p>9. As the last task, just because it&rsquo;s fun, use the debug module
together with the package facts to get information about the newly
installed package:</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0"><code class="language-pre1" data-lang="pre1">- name: show package facts for {{ my_package }}
  debug:
    var: ansible_facts.packages[my_package]
  when: my_package in ansible_facts.packages</code></pre></div>
<p>10. Use the command <strong>ansible-playbook exercise122-client.yaml -e
my_package=redis</strong>. That&rsquo;s right; this command overwrites the my_package
variable that was set in the playbook&mdash;just to remind you a bit about
variable precedence.
:::</p>

  <footer class="footline">
  </footer>
</article>
          </section>
<article class="default">
  <header class="headline">
  </header>

<h1 id="managing-users">Managing Users</h1>

<div class="children children-type-card children-sort-"><ul class="card-container">
<li>
  <article class="card card-popout" aria-labelledby="R-card-d89fdaedf3c24cf0e5cfcdd8b145e4f8">
    <div class="card-content">
      <div class="card-title" id="R-card-d89fdaedf3c24cf0e5cfcdd8b145e4f8">
        <a href="/ansible/managing-users/encrypted-passwords/">
        Encrypted passwords
        </a>
      </div>
      <div class="card-content-text">
          <!-- raw HTML omitted -->

      </div>
    </div>
  </article>
</li>
<li>
  <article class="card card-popout" aria-labelledby="R-card-143cc7c5a81d3de120e25a6c8204eb86">
    <div class="card-content">
      <div class="card-title" id="R-card-143cc7c5a81d3de120e25a6c8204eb86">
        <a href="/ansible/managing-users/ssh-connections/">
        SSH Connections
        </a>
      </div>
      <div class="card-content-text">
          <!-- raw HTML omitted -->

      </div>
    </div>
  </article>
</li>
<li>
  <article class="card card-popout" aria-labelledby="R-card-224be7ea5884d14d13d5432a204c1e7f">
    <div class="card-content">
      <div class="card-title" id="R-card-224be7ea5884d14d13d5432a204c1e7f">
        <a href="/ansible/managing-users/users-and-groups/">
        Users and Groups
        </a>
      </div>
      <div class="card-content-text">
          <!-- raw HTML omitted -->

      </div>
    </div>
  </article>
</li>
</ul>
</div>

  <footer class="footline">
  </footer>
</article>
          <section>
            <h1 class="a11y-only">Subsections of Managing Users</h1>
<article class="default">
  <header class="headline">
  </header>

<h1 id="encrypted-passwords">Encrypted passwords</h1>

<h3 id="managing-encrypted-passwords">Managing Encrypted Passwords</h3>
<p>When managing users in Ansible, you probably want to set user passwords
as well. The challenge is that you cannot just enter a password as the
value to the <strong>password:</strong> argument in the user module because the user
module expects you to use an encrypted string.</p>
<h4 id="understanding-encrypted-passwords">Understanding Encrypted Passwords</h4>
<p>When a user creates a password, it is encrypted. The hash of the
encrypted password is stored in the /etc/shadow file, a file that is
strictly secured and accessible only with root privileges. The string
looks like $6$237687687/$9809erhb8oyw48oih290u09. In this string are
three elements, which are separated by $ signs:</p>
<p>â€¢ The hashing algorithm that was used</p>
<p>â€¢ The random salt that was used to encrypt the password</p>
<p>â€¢ The encrypted hash of the user password</p>
<p>When a user sets a password, a random salt is used to prevent two users
who have identical passwords from having identical entries in
/etc/shadow. The salt and the unencrypted password are combined and
encrypted, which generates the encrypted hash that is stored in
/etc/shadow. Based on this string, the password that the user enters can
be verified against the password field in /etc/shadow, and if it
matches, the user is authenticated.</p>
<h4 class="h4" id="generating-encrypted-passwords">Generating Encrypted Passwords</h4>
<p>When you&rsquo;re creating users with the Ansible user module, there is a
password option. This option is not capable of generating an encrypted
password. It expects an encrypted password string as its input. That
means an external utility must be used to generate an encrypted string.
This encrypted string must be stored in a variable to create the
password. Because the variable is basically the user password, the
variable should be stored securely in, for example, an Ansible Vault
secured file.</p>
<p>To generate the encrypted variable, you can choose to create the
variable before creating the user account. Alternatively, you can run
the command to create the variable in the playbook, use <strong>register</strong> to
write the result to a variable, and use that to create the encrypted
user. If you want to generate the variable beforehand, you can use the
following ad hoc command:</p>
<pre><code>ansible localhost -m debug -a &quot;msg={{ â€˜passwordâ€™ | password_hash(â€˜sha512â€™,â€™myrandomsaltâ€™) }}&quot;
</code></pre>
<p>This command generates the encrypted string as shown in <a href="/ansible/managing-users/encrypted-passwords/#ch13.xhtml#list13_11">Listing
13-11</a>, and this string can next be used in a
playbook. An example of such a playbook is shown in <a href="/ansible/managing-users/encrypted-passwords/#ch13.xhtml#list13_12">Listing
13-12</a>.</p>
<p><strong>Listing 13-11</strong> Generating the Encrypted Password String</p>
<p>::: pre_1
[ansible@control ~]$ ansible localhost -m debug -a &ldquo;msg={{ â€˜passwordâ€™ | password_hash(â€˜sha512â€™,â€™myrandomsaltâ€™) }}&rdquo;
localhost | SUCCESS =&gt; {
&ldquo;msg&rdquo;: &ldquo;$6$myrandomsalt$McEB.xAVUWe0./6XqZ8n/7k9VV/Gxndy9nIMLyQAiPnhyBoToMWbxX2vA4f.Uv9PKnPRaYUUc76AjLWVAX6U10&rdquo;
}
:::</p>
<p><strong>Listing 13-12</strong> Sample Playbook That Creates an Encrypted User
Password</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yml" data-lang="yml"><span style="display:flex;"><span>    ---
</span></span><span style="display:flex;"><span>    - <span style="color:#ff6ac1">name</span>: create user with encrypted pass
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">hosts</span>: ansible2.example.com
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">vars</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">password</span>: <span style="color:#5af78e">&#34;$6$myrandomsalt$McEB.xAVUWe0./6XqZ8n/7k9VV/Gxndy9nIMLyQAiPnhyBoToMWbxX2vA4f.Uv9PKnPRaYUUc76AjLWVAX6U10&#34;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">tasks</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#ff6ac1">name</span>: create the user
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">user</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#ff6ac1">name</span>: anna
</span></span><span style="display:flex;"><span>          <span style="color:#ff6ac1">password</span>: <span style="color:#5af78e">&#34;{{ password }}&#34;</span></span></span></code></pre></div>
<p>The method that is used here works but is not elegant. First, you need
to generate the encrypted password manually beforehand. Also, the
encrypted password string is used in a readable way in the playbook. By
seeing the encrypted password and salt, it&rsquo;s possible to get to the
original password, which is why the password should not be visible in
the playbook in a secure environment.</p>
<p>In <a href="/ansible/managing-users/encrypted-passwords/#ch13.xhtml#exe13_3">Exercise 13-3</a> you create a playbook that
prompts for the user password and that uses the debug module, which was
used in <a href="/ansible/managing-users/encrypted-passwords/#ch13.xhtml#list13_11">Listing 13-11</a> inside the playbook,
together with register, so that the password no longer is readable in
clear text. Before looking at <a href="/ansible/managing-users/encrypted-passwords/#ch13.xhtml#exe13_3">Exercise 13-3</a>,
though, let&rsquo;s first look at an alternative approach that also works.</p>
<p>The procedure to use encrypted passwords while creating user accounts is
documented in the Frequently Asked Questions from the Ansible
documentation. Because the documentation is available on the exam, make
sure you know where to find this information! Search for the item &ldquo;How
do I generate encrypted passwords for the user module?&rdquo;</p>
<h4 id="using-an-alternative-approach">Using an Alternative Approach</h4>
<p>As has been mentioned on multiple occasions, in Ansible often different
solutions exist for the same problem. And sometimes, apart from the most
elegant solution, there&rsquo;s also a quick-and-dirty solution, and that
counts for setting a user-encrypted password as well. Instead of using
the solution described in the previous section, &ldquo;Generating Encrypted
Passwords,&rdquo; you can use the Linux command <strong>echo password | passwd
--stdin</strong> to set the user password. <a href="/ansible/managing-users/encrypted-passwords/#ch13.xhtml#list13_13">Listing
13-13</a> shows how to do this. Notice this example
focuses on how to do it, not on security. If you want to make the
playbook more secure, it would be nice to store the password in Ansible
Vault.</p>
<p><strong>Listing 13-13</strong> Setting the User Password: Alternative Solution</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yml" data-lang="yml"><span style="display:flex;"><span>    ---
</span></span><span style="display:flex;"><span>    - <span style="color:#ff6ac1">name</span>: create user with encrypted password
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">hosts</span>: ansible3
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">vars</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">password</span>: mypassword
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">user</span>: anna
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">tasks</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#ff6ac1">name</span>: configure user {{ user }}
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">user</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#ff6ac1">name</span>: <span style="color:#5af78e">&#34;{{ user }}&#34;</span>
</span></span><span style="display:flex;"><span>          <span style="color:#ff6ac1">groups</span>: wheel
</span></span><span style="display:flex;"><span>          <span style="color:#ff6ac1">append</span>: <span style="color:#ff6ac1">yes</span>
</span></span><span style="display:flex;"><span>          <span style="color:#ff6ac1">state</span>: present
</span></span><span style="display:flex;"><span>      - <span style="color:#ff6ac1">name</span>: set a password for {{ user }}
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">shell</span>: â€˜echo {{ password }} | passwd --stdin {{ user }}â€™</span></span></code></pre></div>
<p>::: box
<strong>Exercise 13-3 Creating Users with Encrypted Passwords</strong></p>
<p>1. Use your editor to create the file exercise133.yaml.</p>
<p>2. Write the play header as follows:</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0"><code class="language-pre1" data-lang="pre1">---
- name: create user with encrypted password
  hosts: ansible3
  vars_prompt:
  - name: passw
    prompt: which password do you want to use
  vars:
    user: sharon
  tasks:</code></pre></div>
<p>3. Add the first task that uses the debug module to generate the
encrypted password string and register to store the string in the
variable <strong>mypass</strong>:</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0"><code class="language-pre1" data-lang="pre1">- debug:
    msg: &#34;{{ â€˜{{ passw }}â€™| password_hash(â€˜sha512â€™,â€™myrandomsaltâ€™) }}&#34;
  register: mypass</code></pre></div>
<p>4. Add a debug module to analyze the exact format of the registered
variable:</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0"><code class="language-pre1" data-lang="pre1">- debug:
    var: mypass</code></pre></div>
<p>5. Use <strong>ansible-playbook exercise133.yaml</strong> to run the playbook the
first time so that you can see the exact name of the variable that you
have to use. This code shows that the <strong>mypass.msg</strong> variable contains
the encrypted password string (see <a href="/ansible/managing-users/encrypted-passwords/#ch13.xhtml#list13_14">Listing
13-14</a>).</p>
<p><strong>Listing 13-14</strong> Finding the Variable Name Using debug</p>
<p>::: pre_1</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0"><code class="language-pre1" data-lang="pre1">TASK [debug] *******************************************************************
ok: [ansible2] =&gt; {
    &#34;mypass&#34;: {
        &#34;changed&#34;: false,
        &#34;failed&#34;: false,
        &#34;msg&#34;: &#34;$6$myrandomsalt$Jesm4QGoCGAny9ebP85apmh0/uUXrj0louYb03leLoOWSDy/imjVGmcODhrpIJZt0rz.GBp9pZYpfm0SU2/PO.&#34;
    }
}</code></pre></div>
<p>:::</p>
<p>6. Based on the output that you saw with the previous command, you can
now use the user module to refer to the password in the right way. Add
the following task to do so:</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0"><code class="language-pre1" data-lang="pre1">- name: create the user
  user:
    name: &#34;{{ user }}&#34;
    password: &#34;{{ mypass.msg }}&#34;</code></pre></div>
<p>7. Use <strong>ansible-playbook exercise133.yaml</strong> to run the playbook and
verify its output.
:::</p>

  <footer class="footline">
  </footer>
</article>
<article class="default">
  <header class="headline">
  </header>

<h1 id="ssh-connections">SSH Connections</h1>

<h3 id="managing-ssh-connections">Managing SSH Connections</h3>
<ul>
<li>How to provide for SSH keys for new users in such a way that users are provided with SSH keys without having to set them up themselves.</li>
<li>To do this, you use the authorized_key module together with theÂ <strong>generate_ssh_key</strong>Â argument to the user module.</li>
</ul>
<h4 id="understanding-ssh-connection-management-requirements">Understanding SSH Connection Management Requirements</h4>
<p>How SSH keys are used in the communication process between a user and an SSH server:</p>
<ol>
<li>The user initiates a session with an SSH server.</li>
<li>The server sends back an identification token that is encrypted with the server private key to the user.</li>
<li>The user uses the serverâ€™s public key fingerprint, which is stored in the ~/.ssh/known_hosts file to verify the identification token.</li>
<li>If no public key fingerprint was stored yet in the ~/.ssh/known_hosts file, the user is prompted to store the remote server identity in the ~/.ssh/known_hosts file. At this point there is no good way to verify whether the user is indeed communicating with the intended server.</li>
<li>After establishing the identity of the remote server, the user can either send over a password or generate an authentication token that is based on the userâ€™s private key.</li>
<li>If an authentication token that was based on the userâ€™s private key is sent over, this token is received by the server, which tries to match it against the userâ€™s public key that is stored in the ~/.ssh/authorized_keys file.</li>
<li>After the incoming authentication token to the stored user public key in the authorized_keys file is matched, the user is authenticated. If this authentication fails and password authentication is allowed, password authentication is attempted next.</li>
</ol>
<p>In the authentication procedure, two key pairs play an important role. First, there is the serverâ€™s public/private key pair, which is used to establish a secure connection.
To manage the host public key, you can use the Ansible known_hosts module. Next, there is the userâ€™s public/private key pair, which the user uses to authenticate. To manage the public key in this key pair, you can use the Ansible authorized_key module.</p>
<h4 id="lookup-plug-in">Lookup Plug-in</h4>
<ul>
<li>Enables Ansible to access data from outside sources.</li>
<li>Read the file system or contact external datastores and services.</li>
<li>Ran on the Ansible control host.</li>
<li>Results are usually stored in variables or templates.</li>
</ul>
<p>Set the value of a variable to the contents of a file:</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yml" data-lang="yml"><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span>- <span style="color:#ff6ac1">name</span>: simple demo with the lookup plugin
</span></span><span style="display:flex;"><span>  <span style="color:#ff6ac1">hosts</span>: localhost
</span></span><span style="display:flex;"><span>  <span style="color:#ff6ac1">vars</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">file_contents</span>: <span style="color:#5af78e">&#34;{{lookup(â€˜fileâ€™, â€˜/etc/hostsâ€™)}}&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff6ac1">tasks</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ff6ac1">debug</span>:
</span></span><span style="display:flex;"><span>                <span style="color:#ff6ac1">var</span>: file_contents</span></span></code></pre></div>
<h4 id="setting-up-ssh-user-keys">Setting Up SSH User Keys</h4>
<ul>
<li>To use SSH to connect to a user account on a managed host you can copy over the local user public key to the remote user ~/.ssh/authorized_keys file.</li>
<li>If the target authorized_keys file just has to contain one single key, you could use the copy module to copy it over.</li>
<li>To manage multiple keys in the remote user authorized_keys file, youâ€™re better off using the authorized_key module.</li>
</ul>
<p>authorized_key module</p>
<ul>
<li>Copy the authorized_key for a user</li>
<li>/home/ansible/.ssh/id_rsa.pub is used as the source.</li>
<li>lookup plug-in is used to refer to the file contents that should be used:</li>
</ul>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yml" data-lang="yml"><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span>- <span style="color:#ff6ac1">name</span>: authorized_key simple demo
</span></span><span style="display:flex;"><span>  <span style="color:#ff6ac1">hosts</span>: ansible2
</span></span><span style="display:flex;"><span>  <span style="color:#ff6ac1">tasks</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ff6ac1">name</span>: copy authorized key for ansible user
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">authorized_key</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">user</span>: ansible
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">state</span>: present
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">key</span>: <span style="color:#5af78e">&#34;{{ lookup(â€˜fileâ€™, â€˜/home/ansible/.ssh/id_rsa.pubâ€™) }}&#34;</span></span></span></code></pre></div>
<p>Do the same for multiple users:
vars/users</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yml" data-lang="yml"><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span><span style="color:#ff6ac1">users</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ff6ac1">username</span>: linda
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">groups</span>: sales
</span></span><span style="display:flex;"><span>  - <span style="color:#ff6ac1">username</span>: lori
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">groups</span>: sales
</span></span><span style="display:flex;"><span>  - <span style="color:#ff6ac1">username</span>: lisa
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">groups</span>: account
</span></span><span style="display:flex;"><span>  - <span style="color:#ff6ac1">username</span>: lucy
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">groups</span>: account</span></span></code></pre></div>
<p>vars/groups</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yml" data-lang="yml"><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span><span style="color:#ff6ac1">usergroups</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ff6ac1">groupname</span>: sales
</span></span><span style="display:flex;"><span>  - <span style="color:#ff6ac1">groupname</span>: account</span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yml" data-lang="yml"><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span>- <span style="color:#ff6ac1">name</span>: configure users with SSH keys
</span></span><span style="display:flex;"><span>  <span style="color:#ff6ac1">hosts</span>: ansible2
</span></span><span style="display:flex;"><span>  <span style="color:#ff6ac1">vars_files</span>:
</span></span><span style="display:flex;"><span>    - vars/users
</span></span><span style="display:flex;"><span>    - vars/groups
</span></span><span style="display:flex;"><span>  <span style="color:#ff6ac1">tasks</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ff6ac1">name</span>: add groups
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">group</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">name</span>: <span style="color:#5af78e">&#34;{{ item.groupname }}&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">loop</span>: <span style="color:#5af78e">&#34;{{ usergroups }}&#34;</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#ff6ac1">name</span>: add users
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">user</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">name</span>: <span style="color:#5af78e">&#34;{{ item.username }}&#34;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">groups</span>: <span style="color:#5af78e">&#34;{{ item.groups }}&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">loop</span>: <span style="color:#5af78e">&#34;{{ users }}&#34;</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#ff6ac1">name</span>: add SSH public keys
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">authorized_key</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">user</span>: <span style="color:#5af78e">&#34;{{ item.username }}&#34;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">key</span>: <span style="color:#5af78e">&#34;{{ lookup(â€˜fileâ€™, â€˜files/â€™+ item.username + â€˜/id_rsa.pubâ€™) }}&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">loop</span>: <span style="color:#5af78e">&#34;{{ users }}&#34;</span></span></span></code></pre></div>
<ul>
<li>
<p>authorized_key module is set up to work onÂ <strong>item.username</strong>, using aÂ <strong>loop</strong>Â on theÂ <strong>users</strong>Â variable.</p>
</li>
<li>
<p>The id_rsa.pub files that have to be copied over are expected to exist in the files directory, which exists in the current project directory.</p>
</li>
<li>
<p>Copying over the user public keys to the project directory is a solution because the authorized_keys module cannot read files from a hidden directory.</p>
</li>
<li>
<p>It would be much nicer to useÂ <strong>key: â€œ{{ lookup(â€˜fileâ€™, â€˜/home/â€™+ item.username + â€˜.ssh/id_rsa.pubâ€™) }}â€</strong>, but that doesnâ€™t work.</p>
</li>
<li>
<p>In the first task you create a local user, including an SSH key.</p>
</li>
<li>
<p>Because an SSH key should include the name of the user and host that it applies to, you need to use theÂ <strong>generate_ssh_key</strong>Â argument, as well as theÂ <strong>ssh_key_comment</strong>Â argument to write the correct comment into the public key.</p>
</li>
<li>
<p>Without this content, the key will have generic content and not be considered a valid key.</p>
</li>
</ul>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yml" data-lang="yml"><span style="display:flex;"><span>- <span style="color:#ff6ac1">name</span>: create the local user, including SSH key
</span></span><span style="display:flex;"><span>  <span style="color:#ff6ac1">user</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">name</span>: <span style="color:#5af78e">&#34;{{ username }}&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">generate_ssh_key</span>: <span style="color:#ff6ac1">true</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">ssh_key_comment</span>: <span style="color:#5af78e">&#34;{{ username }}@{{ ansible_fqdn }}&#34;</span></span></span></code></pre></div>
<ul>
<li>After creating the SSH keys this way, you arenâ€™t able to fetch the key directly from the user home directory.</li>
<li>To fix that problem, you create a directory with the name of the user in the project directory and copy the user public key from there by using the shell module:</li>
</ul>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yml" data-lang="yml"><span style="display:flex;"><span>- <span style="color:#ff6ac1">name</span>: create a directory to store the file
</span></span><span style="display:flex;"><span>  <span style="color:#ff6ac1">file</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">name</span>: <span style="color:#5af78e">&#34;{{ username }}&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">state</span>: directory
</span></span><span style="display:flex;"><span>- <span style="color:#ff6ac1">name</span>: copy the local user ssh key to temporary {{ username }} key
</span></span><span style="display:flex;"><span>  <span style="color:#ff6ac1">shell</span>: â€˜cat /home/{{ username }}/.ssh/id_rsa.pub &gt; {{ username }}/id_rsa.pubâ€™
</span></span><span style="display:flex;"><span>- <span style="color:#ff6ac1">name</span>: verify that file exists
</span></span><span style="display:flex;"><span>  <span style="color:#ff6ac1">command</span>: ls -l {{ username }}/</span></span></code></pre></div>
<ul>
<li>Next, in the second play you create the remote user and use the authorized_key module to copy the key from the temporary directory to the new user home directory.</li>
</ul>
<p><strong>Exercise 13-2 Managing Users with SSH Keys</strong>
Steps</p>
<ol>
<li>Create a user on localhost.</li>
<li>Use the appropriate arguments to create the SSH public/private key pair according to the required format.</li>
<li>Make sure the public key is copied to a directory where it can be accessed.</li>
<li>Uses the user module to create the user, as well as the authorized_key module to fetch the key from localhost and copy it to the .ssh/authorized_keys file in the remote user home directory.</li>
<li>Use the commandÂ <strong>ansible-playbook exercise132.yaml -e username=radha</strong>Â to create the user radha with the appropriate SSH keys.</li>
<li>To verify it has worked, useÂ <strong>sudo su - radha</strong>Â on the control host, and type the commandÂ <strong>ssh ansible1</strong>. You should able to log in without entering a password.</li>
</ol>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yml" data-lang="yml"><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span>- <span style="color:#ff6ac1">name</span>: prepare localhost
</span></span><span style="display:flex;"><span>  <span style="color:#ff6ac1">hosts</span>: localhost
</span></span><span style="display:flex;"><span>  <span style="color:#ff6ac1">tasks</span>:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  - <span style="color:#ff6ac1">name</span>: create the local user, including SSH key
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">user</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">name</span>: <span style="color:#5af78e">&#34;{{ username }}&#34;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">generate_ssh_key</span>: <span style="color:#ff6ac1">true</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">ssh_key_comment</span>: <span style="color:#5af78e">&#34;{{ username }}@{{ ansible_fqdn }}&#34;</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>  - <span style="color:#ff6ac1">name</span>: create a directory to store the file
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">file</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">name</span>: <span style="color:#5af78e">&#34;{{ username }}&#34;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">state</span>: directory
</span></span><span style="display:flex;"><span>      
</span></span><span style="display:flex;"><span>  - <span style="color:#ff6ac1">name</span>: copy the local user ssh key to temporary {{ username }} key
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">shell</span>: â€˜cat /home/{{ username }}/.ssh/id_rsa.pub &gt; {{ username }}/id_rsa.pubâ€™
</span></span><span style="display:flex;"><span>  - <span style="color:#ff6ac1">name</span>: verify that file exists
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">command</span>: ls -l {{ username }}/
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>- <span style="color:#ff6ac1">name</span>: setup remote host
</span></span><span style="display:flex;"><span>  <span style="color:#ff6ac1">hosts</span>: ansible1
</span></span><span style="display:flex;"><span>  <span style="color:#ff6ac1">tasks</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ff6ac1">name</span>: create remote user, no need for SSH key
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">user</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">name</span>: <span style="color:#5af78e">&#34;{{ username }}&#34;</span>
</span></span><span style="display:flex;"><span>      
</span></span><span style="display:flex;"><span>  - <span style="color:#ff6ac1">name</span>: use authorized_key to set the password
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">authorized_key</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">user</span>: <span style="color:#5af78e">&#34;{{ username }}&#34;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">key</span>: <span style="color:#5af78e">&#34;{{ lookup(â€˜fileâ€™, â€˜./â€™+ username +â€™/id_rsa.pubâ€™) }}&#34;</span></span></span></code></pre></div>

  <footer class="footline">
  </footer>
</article>
<article class="default">
  <header class="headline">
  </header>

<h1 id="users-and-groups">Users and Groups</h1>

<h3 id="using-ansible-modules-to-manage-users-and-groups">Using Ansible Modules to Manage Users and Groups</h3>
<ul>
<li>management of the user and group accounts and their direct properties.</li>
<li>management of sudo privilege escalation</li>
<li>Setting up SSH connections and setting user passwords</li>
</ul>
<h4 id="modules">Modules</h4>
<p>user</p>
<ul>
<li>manage users and their base properties</li>
</ul>
<p>group</p>
<ul>
<li>Manage groups and their properties</li>
</ul>
<p>pamd</p>
<ul>
<li>Manage advanced authentication configuration through linux pluggable authentication modules (PAM)</li>
</ul>
<p>known_hosts</p>
<ul>
<li>manage ssh known hosts</li>
</ul>
<p>authorized_key</p>
<ul>
<li>copy authorized key to a managed host</li>
</ul>
<p>lineinfile</p>
<ul>
<li>modify config file</li>
</ul>
<h4 id="managing-users-and-groups">Managing Users and Groups</h4>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>    ---
</span></span><span style="display:flex;"><span>    - <span style="color:#ff6ac1">name</span>: creating a user and group
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">hosts</span>: ansible2
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">tasks</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#ff6ac1">name</span>: setup the group account
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">group</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#ff6ac1">name</span>: students
</span></span><span style="display:flex;"><span>          <span style="color:#ff6ac1">state</span>: present
</span></span><span style="display:flex;"><span>      - <span style="color:#ff6ac1">name</span>: setup the user account
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">user</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#ff6ac1">name</span>: anna
</span></span><span style="display:flex;"><span>          <span style="color:#ff6ac1">create_home</span>: <span style="color:#ff6ac1">yes</span>
</span></span><span style="display:flex;"><span>          <span style="color:#ff6ac1">groups</span>: wheel,students
</span></span><span style="display:flex;"><span>          <span style="color:#ff6ac1">append</span>: <span style="color:#ff6ac1">yes</span>
</span></span><span style="display:flex;"><span>          <span style="color:#ff6ac1">generate_ssh_key</span>: <span style="color:#ff6ac1">yes</span>
</span></span><span style="display:flex;"><span>          <span style="color:#ff6ac1">ssh_key_bits</span>: <span style="color:#ff9f43">2048</span>
</span></span><span style="display:flex;"><span>          <span style="color:#ff6ac1">ssh_key_file</span>: .ssh/id_rsa</span></span></code></pre></div>
<p><strong>group</strong> argument is</p>
<ul>
<li>used to specify the primary group of the user.</li>
</ul>
<p><strong>groups</strong> argument is</p>
<ul>
<li>
<p>used to make the user a member of additional groups.</p>
</li>
<li>
<p>While using the <strong>groups</strong> argument for existing users, make sure to include the <strong>append</strong> argument as well.</p>
</li>
<li>
<p>Without <strong>append</strong>, all current secondary group assignments are overwritten.</p>
</li>
</ul>
<p>Also notice that the user module has some options that cannot normally be managed with the Linux <strong>useradd</strong> command. The module can also be used to generate an SSH key and specify its properties.</p>
<h4 id="managing-sudo">Managing sudo</h4>
<p>No Ansible module specifically targets managing a sudo configuration</p>
<p>two options:</p>
<ol>
<li>You can use the template module to create a sudo configuration file in the directory /etc/sudoers.d.
<ul>
<li>Using such a file is recommended because the file is managed independently, and as such, there is no risk it will be overwritten by an RPM update.</li>
</ul>
</li>
<li>The alternative is to use the lineinfile module to manage the /etc/sudoers main configuration file directly.</li>
</ol>
<p>Users are created and added to a sudo file that is generated from a template:</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yml" data-lang="yml"><span style="display:flex;"><span>    [ansible@control rhce8-book]$ cat vars/sudo
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">sudo_groups</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#ff6ac1">name</span>: developers
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">groupid</span>: <span style="color:#ff9f43">5000</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">sudo</span>: <span style="color:#ff6ac1">false</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#ff6ac1">name</span>: admins
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">groupid</span>: <span style="color:#ff9f43">5001</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">sudo</span>: <span style="color:#ff6ac1">true</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#ff6ac1">name</span>: dbas
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">groupid</span>: <span style="color:#ff9f43">5002</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">sudo</span>: <span style="color:#ff6ac1">false</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#ff6ac1">name</span>: sales
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">groupid</span>: <span style="color:#ff9f43">5003</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">sudo</span>: <span style="color:#ff6ac1">true</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#ff6ac1">name</span>: account
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">groupid</span>: <span style="color:#ff9f43">5004</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">sudo</span>: <span style="color:#ff6ac1">false</span>
</span></span><span style="display:flex;"><span>    [ansible@control rhce8-book]$ cat vars/users
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">users</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#ff6ac1">username</span>: linda
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">groups</span>: sales
</span></span><span style="display:flex;"><span>      - <span style="color:#ff6ac1">username</span>: lori
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">groups</span>: sales
</span></span><span style="display:flex;"><span>      - <span style="color:#ff6ac1">username</span>: lisa
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">groups</span>: account
</span></span><span style="display:flex;"><span>      - <span style="color:#ff6ac1">username</span>: lucy
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">groups</span>: account</span></span></code></pre></div>
<ul>
<li>vars/users file defines users and the groups they should be a member of.</li>
<li>vars/sudo file defines new groups and, for each of these groups, sets a sudo parameter, which will be used in the template file:</li>
</ul>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yml" data-lang="yml"><span style="display:flex;"><span>{% for item in sudo_groups %}
</span></span><span style="display:flex;"><span>{% if item.sudo %}
</span></span><span style="display:flex;"><span>%{{ item.name}} ALL=(ALL:ALL) NOPASSWD:ALL
</span></span><span style="display:flex;"><span>{% endif %}
</span></span><span style="display:flex;"><span>{% endfor %}</span></span></code></pre></div>
<ul>
<li>a <strong>for</strong> loop is used to walk through all items that have been defined in the <strong>sudo_groups</strong> variable in the vars/sudo file.</li>
<li>for each of these groups an <strong>if</strong> statement is used to check the value of the Boolean variable sudo. If this variable is set to the Boolean value true, the group is added as a sudo group to the /etc/sudoers.d/sudogroups file.</li>
</ul>
<p><strong>Listing 13-4</strong> Managing sudo</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yml" data-lang="yml"><span style="display:flex;"><span>    ---
</span></span><span style="display:flex;"><span>    - <span style="color:#ff6ac1">name</span>: configure sudo
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">hosts</span>: ansible2
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">vars_files</span>:
</span></span><span style="display:flex;"><span>        - vars/sudo
</span></span><span style="display:flex;"><span>        - vars/users
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">tasks</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#ff6ac1">name</span>: add groups
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">group</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#ff6ac1">name</span>: <span style="color:#5af78e">&#34;{{ item.name }}&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">loop</span>: <span style="color:#5af78e">&#34;{{ sudo_groups }}&#34;</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#ff6ac1">name</span>: add users
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">user</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#ff6ac1">name</span>: <span style="color:#5af78e">&#34;{{ item.username }}&#34;</span>
</span></span><span style="display:flex;"><span>          <span style="color:#ff6ac1">groups</span>: <span style="color:#5af78e">&#34;{{ item.groups }}&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">loop</span>: <span style="color:#5af78e">&#34;{{ users }}&#34;</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#ff6ac1">name</span>: allow group members in sudo
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">template</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#ff6ac1">src</span>: listing133.j2
</span></span><span style="display:flex;"><span>          <span style="color:#ff6ac1">dest</span>: /etc/sudoers.d/sudogroups
</span></span><span style="display:flex;"><span>          <span style="color:#ff6ac1">validate</span>: â€˜visudo -cf %sâ€™
</span></span><span style="display:flex;"><span>          <span style="color:#ff6ac1">mode</span>: <span style="color:#ff9f43">0440</span></span></span></code></pre></div>

  <footer class="footline">
  </footer>
</article>
          </section>
<article class="default">
  <header class="headline">
  </header>

<h1 id="modules">Modules</h1>

<div class="children children-type-card children-sort-"><ul class="card-container">
<li>
  <article class="card card-popout" aria-labelledby="R-card-863940ba4dd37c968d029d89247f25ee">
    <div class="card-content">
      <div class="card-title" id="R-card-863940ba4dd37c968d029d89247f25ee">
        <a href="/ansible/modules/common-modules-with-examples/">
        Common modules with examples
        </a>
      </div>
      <div class="card-content-text">
          <!-- raw HTML omitted -->

      </div>
    </div>
  </article>
</li>
</ul>
</div>

  <footer class="footline">
  </footer>
</article>
          <section>
            <h1 class="a11y-only">Subsections of Modules</h1>
<article class="default">
  <header class="headline">
  </header>

<h1 id="common-modules-with-examples">Common modules with examples</h1>

<p><strong>uri:</strong>
Interacts with basic http and https web services. (Verify connectivity to a web server
+9)</p>
<p>Test httpd accessibility:</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#ff6ac1">uri</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#ff6ac1">url</span>: http://ansible1</span></span></code></pre></div>
<p>Show result of the command while running the playbook:</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#ff6ac1">uri</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#ff6ac1">url</span>: http://ansible1
</span></span><span style="display:flex;"><span>  <span style="color:#ff6ac1">return_content</span>: <span style="color:#ff6ac1">yes</span></span></span></code></pre></div>
<p>Show the status code that signifies the success of the request:</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#ff6ac1">uri</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#ff6ac1">url</span>: http://ansible1
</span></span><span style="display:flex;"><span>  <span style="color:#ff6ac1">status_code</span>: <span style="color:#ff9f43">200</span></span></span></code></pre></div>
<p><strong>debug:</strong>
Prints statements during execution. Used for debugging variables or expressions without stopping a playbook.</p>
<p>Print out the value of the ansible_facts variable:</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#ff6ac1">debug</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#ff6ac1">var</span>: ansible_facts</span></span></code></pre></div>

  <footer class="footline">
  </footer>
</article>
          </section>
<article class="default">
  <header class="headline">
  </header>

<h1 id="networking">Networking</h1>

<div class="children children-type-card children-sort-"><ul class="card-container">
<li>
  <article class="card card-popout" aria-labelledby="R-card-b413c04d9055e9ef1aaf8ff5cdc078bc">
    <div class="card-content">
      <div class="card-title" id="R-card-b413c04d9055e9ef1aaf8ff5cdc078bc">
        <a href="/ansible/networking/networking-with-ansible/">
        Networking with Ansible
        </a>
      </div>
      <div class="card-content-text">
          <!-- raw HTML omitted -->

      </div>
    </div>
  </article>
</li>
</ul>
</div>

  <footer class="footline">
  </footer>
</article>
          <section>
            <h1 class="a11y-only">Subsections of Networking</h1>
<article class="default">
  <header class="headline">
  </header>

<h1 id="networking-with-ansible">Networking with Ansible</h1>

<p>3 modules for managing the networking on nodes:</p>
<ul>
<li>service</li>
<li>daemon</li>
<li>system settings</li>
</ul>

  <footer class="footline">
  </footer>
</article>
          </section>
<article class="default">
  <header class="headline">
  </header>

<h1 id="playbooks">Playbooks</h1>

<div class="children children-type-card children-sort-"><ul class="card-container">
<li>
  <article class="card card-popout" aria-labelledby="R-card-1fdf11e5be29414b60968c92ebaaf4cd">
    <div class="card-content">
      <div class="card-title" id="R-card-1fdf11e5be29414b60968c92ebaaf4cd">
        <a href="/ansible/playbooks/ansible-playbooks/">
        Ansible Playbooks
        </a>
      </div>
      <div class="card-content-text">
          <!-- raw HTML omitted -->

      </div>
    </div>
  </article>
</li>
<li>
  <article class="card card-popout" aria-labelledby="R-card-eac43ad28fde2b0c6e52c85276ce4fd5">
    <div class="card-content">
      <div class="card-title" id="R-card-eac43ad28fde2b0c6e52c85276ce4fd5">
        <a href="/ansible/playbooks/including-and-importing-files/">
        Including and importing Files
        </a>
      </div>
      <div class="card-content-text">
          <!-- raw HTML omitted -->

      </div>
    </div>
  </article>
</li>
</ul>
</div>

  <footer class="footline">
  </footer>
</article>
          <section>
            <h1 class="a11y-only">Subsections of Playbooks</h1>
<article class="default">
  <header class="headline">
  </header>

<h1 id="ansible-playbooks">Ansible Playbooks</h1>

<ul>
<li>Exploring playbooks</li>
<li>YAML</li>
<li>Managing Multiplay Playbooks</li>
</ul>
<p>Lets create our first playbook:</p>
<p><code>[ansible@control base]$ vim playbook.yaml</code></p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span>- <span style="color:#ff6ac1">name</span>: install start and enable httpd &lt;-- play is at the highest level
</span></span><span style="display:flex;"><span>  <span style="color:#ff6ac1">hosts</span>: all
</span></span><span style="display:flex;"><span>  <span style="color:#ff6ac1">tasks</span>: &lt;-- play has a list of tasks
</span></span><span style="display:flex;"><span>  - <span style="color:#ff6ac1">name</span>: install package &lt;-- name of task 1
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">yum</span>: &lt;-- module
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">name</span>: httpd &lt;-- argument 1
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">state</span>: installed &lt;-- argument 2
</span></span><span style="display:flex;"><span>  - <span style="color:#ff6ac1">name</span>: start and enable service &lt;-- task 2
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">service</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">name</span>: httpd
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">state</span>: started
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">enabled</span>: <span style="color:#ff6ac1">yes</span></span></span></code></pre></div>
<p>There are thee dashes at the top of the playbook. And sometimes you&rsquo;ll find three dots at the end of a playbook. These make it easy to isolate the playbook and embed the playbook code into other projects.</p>
<p>Playbooks are written in YAML format and saved as either .yml or .yaml. YAML specifies objects as key-value pairs (dictionaries). Key value pairs can be listed in either key: value (preferred) or key=value. And dashes specify lists of embedded objects.</p>
<p>There is a collection of one or more plays in a playbook. Each play targets specific hosts and lists tasks to perform on those hosts. There is one play here with the name &ldquo;install start and enable httpd&rdquo;. You target the host names to target at the top of the play, not in the individual tasks performed.</p>
<p>Each task is identified by &ldquo;- name&rdquo; (not required but recommended for troubleshooting and identifying tasks). Then the module is listed with arguments and their values under that.</p>
<p>Indentation is important here. It identifies the relationships between different elements. Data elements at the same level must have the same indentation. And items that are children or properties of another element must be indented more than their parent elements.</p>
<p>Indentation is created using spaces. Usually two spaces is used, but not required. You cannot use tabs for indentation.</p>
<p>You can also edit your .vimrc file to help with indentation when it detects that you are working with a YAML file:
<code>vim ~/.vimrc</code></p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0"><code>autocmd FileType yaml setlocal ai ts=2 sw=2 et</code></pre></div>
<p>Required elements:</p>
<ul>
<li>hosts - name of host(s) to perform play on</li>
<li>name - name of the play</li>
<li>tasks - one or more tasks to execute for this play</li>
</ul>
<p>To run a playbook:</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#ff6ac1">[</span>ansible@control base<span style="color:#ff6ac1">]</span>$ ansible-playbook playbook.yaml 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#78787e"># Name of the play</span>
</span></span><span style="display:flex;"><span>PLAY <span style="color:#ff6ac1">[</span>install start and <span style="color:#ff5c57">enable</span> http+userd<span style="color:#ff6ac1">]</span> ***********************************************
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#78787e"># Overview of tasks and the hosts it was successful on</span>
</span></span><span style="display:flex;"><span>TASK <span style="color:#ff6ac1">[</span>Gathering Facts<span style="color:#ff6ac1">]</span> **************************************************************
</span></span><span style="display:flex;"><span>fatal: <span style="color:#ff6ac1">[</span>web1<span style="color:#ff6ac1">]</span>: UNREACHABLE! <span style="color:#ff6ac1">=</span>&gt; <span style="color:#ff6ac1">{</span><span style="color:#5af78e">&#34;changed&#34;</span>: false, <span style="color:#5af78e">&#34;msg&#34;</span>: <span style="color:#5af78e">&#34;Failed to connect to the host via ssh: ssh: Could not resolve hostname web1: Name or service not known&#34;</span>, <span style="color:#5af78e">&#34;unreachable&#34;</span>: true<span style="color:#ff6ac1">}</span>
</span></span><span style="display:flex;"><span>fatal: <span style="color:#ff6ac1">[</span>web2<span style="color:#ff6ac1">]</span>: UNREACHABLE! <span style="color:#ff6ac1">=</span>&gt; <span style="color:#ff6ac1">{</span><span style="color:#5af78e">&#34;changed&#34;</span>: false, <span style="color:#5af78e">&#34;msg&#34;</span>: <span style="color:#5af78e">&#34;Failed to connect to the host via ssh: ssh: Could not resolve hostname web2: Name or service not known&#34;</span>, <span style="color:#5af78e">&#34;unreachable&#34;</span>: true<span style="color:#ff6ac1">}</span>
</span></span><span style="display:flex;"><span>ok: <span style="color:#ff6ac1">[</span>ansible1<span style="color:#ff6ac1">]</span>
</span></span><span style="display:flex;"><span>ok: <span style="color:#ff6ac1">[</span>ansible2<span style="color:#ff6ac1">]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>TASK <span style="color:#ff6ac1">[</span>install package<span style="color:#ff6ac1">]</span> **************************************************************
</span></span><span style="display:flex;"><span>ok: <span style="color:#ff6ac1">[</span>ansible1<span style="color:#ff6ac1">]</span>
</span></span><span style="display:flex;"><span>ok: <span style="color:#ff6ac1">[</span>ansible2<span style="color:#ff6ac1">]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>TASK <span style="color:#ff6ac1">[</span>start and <span style="color:#ff5c57">enable</span> service<span style="color:#ff6ac1">]</span> *****************************************************
</span></span><span style="display:flex;"><span>ok: <span style="color:#ff6ac1">[</span>ansible2<span style="color:#ff6ac1">]</span>
</span></span><span style="display:flex;"><span>ok: <span style="color:#ff6ac1">[</span>ansible1<span style="color:#ff6ac1">]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#78787e"># overview of the status of each task</span>
</span></span><span style="display:flex;"><span>PLAY RECAP **************************************************************************
</span></span><span style="display:flex;"><span>ansible1                   : <span style="color:#ff5c57">ok</span><span style="color:#ff6ac1">=</span><span style="color:#ff9f43">3</span> <span style="color:#ff6ac1">(</span>no changes required<span style="color:#ff6ac1">)</span>    <span style="color:#ff5c57">changed</span><span style="color:#ff6ac1">=</span><span style="color:#ff9f43">0</span> <span style="color:#ff6ac1">(</span>indicates the task was successful and target node was modified.<span style="color:#ff6ac1">)</span>   <span style="color:#ff5c57">unreachable</span><span style="color:#ff6ac1">=</span><span style="color:#ff9f43">0</span>    <span style="color:#ff5c57">failed</span><span style="color:#ff6ac1">=</span><span style="color:#ff9f43">0</span>    <span style="color:#ff5c57">skipped</span><span style="color:#ff6ac1">=</span><span style="color:#ff9f43">0</span>    <span style="color:#ff5c57">rescued</span><span style="color:#ff6ac1">=</span><span style="color:#ff9f43">0</span>    <span style="color:#ff5c57">ignored</span><span style="color:#ff6ac1">=</span><span style="color:#ff9f43">0</span>   
</span></span><span style="display:flex;"><span>ansible2                   : <span style="color:#ff5c57">ok</span><span style="color:#ff6ac1">=</span><span style="color:#ff9f43">3</span>    <span style="color:#ff5c57">changed</span><span style="color:#ff6ac1">=</span><span style="color:#ff9f43">0</span>    <span style="color:#ff5c57">unreachable</span><span style="color:#ff6ac1">=</span><span style="color:#ff9f43">0</span>    <span style="color:#ff5c57">failed</span><span style="color:#ff6ac1">=</span><span style="color:#ff9f43">0</span>    <span style="color:#ff5c57">skipped</span><span style="color:#ff6ac1">=</span><span style="color:#ff9f43">0</span>    <span style="color:#ff5c57">rescued</span><span style="color:#ff6ac1">=</span><span style="color:#ff9f43">0</span>    <span style="color:#ff5c57">ignored</span><span style="color:#ff6ac1">=</span><span style="color:#ff9f43">0</span>   
</span></span><span style="display:flex;"><span>web1                       : <span style="color:#ff5c57">ok</span><span style="color:#ff6ac1">=</span><span style="color:#ff9f43">0</span>    <span style="color:#ff5c57">changed</span><span style="color:#ff6ac1">=</span><span style="color:#ff9f43">0</span>    <span style="color:#ff5c57">unreachable</span><span style="color:#ff6ac1">=</span><span style="color:#ff9f43">1</span>    <span style="color:#ff5c57">failed</span><span style="color:#ff6ac1">=</span><span style="color:#ff9f43">0</span>    <span style="color:#ff5c57">skipped</span><span style="color:#ff6ac1">=</span><span style="color:#ff9f43">0</span>    <span style="color:#ff5c57">rescued</span><span style="color:#ff6ac1">=</span><span style="color:#ff9f43">0</span>    <span style="color:#ff5c57">ignored</span><span style="color:#ff6ac1">=</span><span style="color:#ff9f43">0</span>   
</span></span><span style="display:flex;"><span>web2                       : <span style="color:#ff5c57">ok</span><span style="color:#ff6ac1">=</span><span style="color:#ff9f43">0</span>    <span style="color:#ff5c57">changed</span><span style="color:#ff6ac1">=</span><span style="color:#ff9f43">0</span>    <span style="color:#ff5c57">unreachable</span><span style="color:#ff6ac1">=</span><span style="color:#ff9f43">1</span>    <span style="color:#ff5c57">failed</span><span style="color:#ff6ac1">=</span><span style="color:#ff9f43">0</span>    <span style="color:#ff5c57">skipped</span><span style="color:#ff6ac1">=</span><span style="color:#ff9f43">0</span>    <span style="color:#ff5c57">rescued</span><span style="color:#ff6ac1">=</span><span style="color:#ff9f43">0</span>    <span style="color:#ff5c57">ignored</span><span style="color:#ff6ac1">=</span><span style="color:#ff9f43">0</span>   </span></span></code></pre></div>
<p>Before running tasks, the <code>ansible-playbook</code> command gathers facts (current configuration and settings) about managed nodes.</p>
<h3 id="how-to-undo-playbook-modifications">How to undo playbook modifications</h3>
<p>Ansible does not have a built in feature to undo a playbook that you ran. So to undo changes, you need to make another playbook that defines the new desired state of the host.</p>
<h3 id="working-with-yaml">Working with YAML</h3>
<p>Key value pairs can also be listed as:</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#ff6ac1">tasks</span>:
</span></span><span style="display:flex;"><span> - <span style="color:#ff6ac1">name</span>: install vsftpd
</span></span><span style="display:flex;"><span>   <span style="color:#ff6ac1">yum</span>: name=vsftpd
</span></span><span style="display:flex;"><span> - <span style="color:#ff6ac1">name</span>: enable vsftpd
</span></span><span style="display:flex;"><span>   <span style="color:#ff6ac1">service</span>: name=vsftpd enabled=true
</span></span><span style="display:flex;"><span> - <span style="color:#ff6ac1">name</span>: create readme file</span></span></code></pre></div>
<p>But better to list them as such for better readability:</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>    <span style="color:#ff6ac1">copy</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">content</span>: <span style="color:#5af78e">&#34;welcome to the FTP server\n&#34;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">dest</span>: /var/ftp/pub/README
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">force</span>: <span style="color:#ff6ac1">no</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">mode</span>: <span style="color:#ff9f43">0444</span></span></span></code></pre></div>
<p>Some modules support multiple values for a single key:</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span>- <span style="color:#ff6ac1">name</span>: install multiple packages
</span></span><span style="display:flex;"><span>  <span style="color:#ff6ac1">hosts</span>: all
</span></span><span style="display:flex;"><span>  <span style="color:#ff6ac1">tasks</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ff6ac1">name</span>: install packages
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">yum</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">name</span>: &lt;-- key with multiple values
</span></span><span style="display:flex;"><span>      - nmap 
</span></span><span style="display:flex;"><span>      - httpd
</span></span><span style="display:flex;"><span>      - vsftpd
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">state</span>: latest &lt;-- will install and/or update to latest version</span></span></code></pre></div>
<h3 id="yaml-strings">YAML Strings</h3>
<p>Valid fomats for a string in YAML:</p>
<ul>
<li><code>super string</code></li>
<li><code>&quot;super string&quot;</code></li>
<li><code>'super string'</code></li>
</ul>
<p>When inserting text into a file, you may have to deal with spacing. You can either preserve newline characters with a pipe <code>|</code> such as:</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>    - <span style="color:#ff6ac1">name</span>: Using | to preserve newlines
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">copy</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">dest</span>: /tmp/rendezvous-with-death.txt
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">content</span>: |<span style="color:#5af78e">
</span></span></span><span style="display:flex;"><span><span style="color:#5af78e">          I have a rendezvous with Death
</span></span></span><span style="display:flex;"><span><span style="color:#5af78e">          At some disputed barricade,
</span></span></span><span style="display:flex;"><span><span style="color:#5af78e">          When Spring comes back with rustling shade
</span></span></span><span style="display:flex;"><span><span style="color:#5af78e">          And apple-blossoms fill the airâ€”</span></span></span></code></pre></div>
<p>Output:</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>I have a rendezvous with Death
</span></span><span style="display:flex;"><span>At some disputed barricade,
</span></span><span style="display:flex;"><span>When Spring comes back with rustling shade
</span></span><span style="display:flex;"><span>And apple-blossoms fill the airâ€”</span></span></code></pre></div>
<p>Or chose not to with a carrot &gt;</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span> - <span style="color:#ff6ac1">name</span>: Using &gt; to fold lines into one
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">copy</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">dest</span>: /tmp/rendezvous-with-death.txt
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">content</span>: &gt;<span style="color:#5af78e">
</span></span></span><span style="display:flex;"><span><span style="color:#5af78e">          I have a rendezvous with Death
</span></span></span><span style="display:flex;"><span><span style="color:#5af78e">          At some disputed barricade,
</span></span></span><span style="display:flex;"><span><span style="color:#5af78e">          When Spring comes back with rustling shade
</span></span></span><span style="display:flex;"><span><span style="color:#5af78e">          And apple-blossoms fill the airâ€”</span></span></span></code></pre></div>
<p>Output:</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>I have a rendezvous with Death At some disputed barricade, When Spring comes back with rustling shade And apple-blossoms fill the airâ€”</span></span></code></pre></div>
<h3 id="checking-syntax-with---syntax-check">Checking syntax with <code>--syntax-check</code></h3>
<p>You can use the <code>--syntax-check</code> flag to check a playbook for errors. The <code>ansible-playbook</code> command does check syntax by default though, and will throw the same error messages. The syntax check stops after detecting a single error. So you will need to fix the first errors in order to see errors further in the file. I&rsquo;ve added a tab in front of the host key to demonstrate:</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>[ansible@control base]$ cat playbook.yaml 
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span>- <span style="color:#ff6ac1">name</span>: install start and enable httpd
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">hosts</span>: all
</span></span><span style="display:flex;"><span>  <span style="color:#ff6ac1">tasks</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ff6ac1">name</span>: install package
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">yum</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">name</span>: httpd
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">state</span>: installed
</span></span><span style="display:flex;"><span>  - <span style="color:#ff6ac1">name</span>: start and enable service
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">service</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">name</span>: httpd
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">state</span>: started
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">enabled</span>: <span style="color:#ff6ac1">yes</span>
</span></span><span style="display:flex;"><span>      
</span></span><span style="display:flex;"><span>[ansible@control base]$ ansible-playbook --syntax-check playbook.yaml 
</span></span><span style="display:flex;"><span><span style="color:#ff6ac1">ERROR! We were unable to read either as JSON nor YAML, these are the errors we got from each</span>:
</span></span><span style="display:flex;"><span><span style="color:#ff6ac1">JSON: Expecting value</span>: line 1 column 1 (char 0)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Syntax Error while loading YAML.
</span></span><span style="display:flex;"><span>  mapping values are not allowed in this context
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff6ac1">The error appears to be in &#39;/home/ansible/base/playbook.yaml&#39;</span>: line 3, column 10, but may
</span></span><span style="display:flex;"><span>be elsewhere in the file depending on the exact syntax problem.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff6ac1">The offending line appears to be</span>:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>- <span style="color:#ff6ac1">name</span>: install start and enable httpd
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">hosts</span>: all
</span></span><span style="display:flex;"><span>         ^ here</span></span></code></pre></div>
<p>And here it is again, after fixing the syntax error:</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>[ansible@control base]$ vim playbook.yaml 
</span></span><span style="display:flex;"><span>[ansible@control base]$ cat playbook.yaml 
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span>- <span style="color:#ff6ac1">name</span>: install start and enable httpd
</span></span><span style="display:flex;"><span>  <span style="color:#ff6ac1">hosts</span>: all
</span></span><span style="display:flex;"><span>  <span style="color:#ff6ac1">tasks</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ff6ac1">name</span>: install package
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">yum</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">name</span>: httpd
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">state</span>: installed
</span></span><span style="display:flex;"><span>  - <span style="color:#ff6ac1">name</span>: start and enable service
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">service</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">name</span>: httpd
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">state</span>: started
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">enabled</span>: <span style="color:#ff6ac1">yes</span>
</span></span><span style="display:flex;"><span>[ansible@control base]$ ansible-playbook --syntax-check playbook.yaml 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff6ac1">playbook</span>: playbook.yaml</span></span></code></pre></div>
<h3 id="doing-a-dry-run">Doing a dry run</h3>
<p>Use the -C flag to perform a dry run. This will check the success status of all of the tasks without actually making any changes.
<code>ansible-playbook -C playbook.yaml</code></p>
<h2 id="multiple-play-playbooks">Multiple play playbooks</h2>
<p>Using multiple plays in a playbook lets you set up one group of servers with one configuration and another group with a different configuration. Each play has it&rsquo;s own list of hosts to address.</p>
<p>You can also specify different parameters in each play such as <strong>become:</strong> or the <strong>remote_user:</strong> parameters.</p>
<p>Try to keep playbooks small. As bigger playbooks will be harder to troubleshoot. You can use <em>include:</em> to include other playbooks. Other than troubleshooting, using smaller playbooks lets you use your playbooks in a flexible way to perform a wider range of tasks.</p>
<p>Here is an example of a playbook with two plays:</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span>- <span style="color:#ff6ac1">name</span>: install start and enable httpd   &lt;--- play 1
</span></span><span style="display:flex;"><span>  <span style="color:#ff6ac1">hosts</span>: all
</span></span><span style="display:flex;"><span>  <span style="color:#ff6ac1">tasks</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ff6ac1">name</span>: install package
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">yum</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">name</span>: httpd
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">state</span>: installed
</span></span><span style="display:flex;"><span>  - <span style="color:#ff6ac1">name</span>: start and enable service
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">service</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">name</span>: httpd
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">state</span>: started
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">enabled</span>: <span style="color:#ff6ac1">yes</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>- <span style="color:#ff6ac1">name</span>: test httpd accessibility &lt;-- play 2
</span></span><span style="display:flex;"><span>  <span style="color:#ff6ac1">hosts</span>: localhost
</span></span><span style="display:flex;"><span>  <span style="color:#ff6ac1">tasks</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ff6ac1">name</span>: test httpd access
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">uri</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">url</span>: http://ansible1</span></span></code></pre></div>
<h3 id="verbose-output-options">Verbose output options</h3>
<p>You can increase the output of verbosity to an amount hitherto undreamt of. This can be useful for troubleshooting.</p>
<p>Verbose output of the playbook above showing task results:
<code>[ansible@control base]$ ansible-playbook -v playbook.yaml </code></p>
<p>Verbose output of the playbook above showing task results and task configuration:
<code>[ansible@control base]$ ansible-playbook -vv playbook.yaml </code></p>
<p>Verbose output of the playbook above showing task results, task configuration, and info about connections to managed hosts:
<code>[ansible@control base]$ ansible-playbook -vvv playbook.yaml </code></p>
<p>Verbose output of the playbook above showing task results, task configuration, and info about connections to managed hosts, plug-ins, user accounts, and executed scripts:
<code>[ansible@control base]$ ansible-playbook -vvvv playbook.yaml </code></p>
<h3 id="lab-playbook">Lab playbook</h3>
<p>Now we know enough to create and enable a simple webserver. Here is a playbook example. Just make sure to download the posix collection or you won&rsquo;t be able to use the firewalld module:
<code>[ansible@control base]$ ansible-galaxy collection install ansible.posix</code></p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>[ansible@control base]$ cat playbook.yaml 
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span>- <span style="color:#ff6ac1">name</span>: Enable web server 
</span></span><span style="display:flex;"><span>  <span style="color:#ff6ac1">hosts</span>: ansible1
</span></span><span style="display:flex;"><span>  <span style="color:#ff6ac1">tasks</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ff6ac1">name</span>: install package
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">yum</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">name</span>: 
</span></span><span style="display:flex;"><span>        - httpd
</span></span><span style="display:flex;"><span>        - firewalld
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">state</span>: installed
</span></span><span style="display:flex;"><span>  - <span style="color:#ff6ac1">name</span>: Create welcome page
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">copy</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">content</span>: <span style="color:#5af78e">&#34;Welcome to the webserver!\n&#34;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">dest</span>: /var/www/html/index.html
</span></span><span style="display:flex;"><span>  - <span style="color:#ff6ac1">name</span>: start and enable service
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">service</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">name</span>: httpd
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">state</span>: started
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">enabled</span>: <span style="color:#ff6ac1">yes</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#ff6ac1">name</span>: enable firewall
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">service</span>: 
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">name</span>: firewalld
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">state</span>: started
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">enabled</span>: <span style="color:#ff6ac1">true</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#ff6ac1">name</span>: Open service in firewall
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">firewalld</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">service</span>: http
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">permanent</span>: <span style="color:#ff6ac1">true</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">state</span>: enabled
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">immediate</span>: <span style="color:#ff6ac1">yes</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>- <span style="color:#ff6ac1">name</span>: test webserver accessibility
</span></span><span style="display:flex;"><span>  <span style="color:#ff6ac1">hosts</span>: localhost
</span></span><span style="display:flex;"><span>  <span style="color:#ff6ac1">become</span>: <span style="color:#ff6ac1">no</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff6ac1">tasks</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ff6ac1">name</span>: test webserver access
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">uri</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">url</span>: http://ansible1
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">return_content</span>: <span style="color:#ff6ac1">yes</span> &lt;-- Return the body of the response as a content key in the dictionary result
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">status_code</span>: <span style="color:#ff9f43">200</span> &lt;--</span></span></code></pre></div>
<p>After running this playbook, you should be able to reach the webserver at http://ansible1</p>
<p>With return content and status code</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0"><code>ok: [localhost] =&gt; {&#34;accept_ranges&#34;: &#34;bytes&#34;, &#34;changed&#34;: false, &#34;connection&#34;: &#34;close&#34;, &#34;content&#34;: &#34;Welcome to the webserver!\n&#34;, &#34;content_length&#34;: &#34;26&#34;, &#34;content_type&#34;: &#34;text/html; charset=UTF-8&#34;, &#34;cookies&#34;: {}, &#34;cookies_string&#34;: &#34;&#34;, &#34;date&#34;: &#34;Thu, 10 Apr 2025 12:12:37 GMT&#34;, &#34;elapsed&#34;: 0, &#34;etag&#34;: &#34;\&#34;1a-6326b4cfb4042\&#34;&#34;, &#34;last_modified&#34;: &#34;Thu, 10 Apr 2025 11:58:14 GMT&#34;, &#34;msg&#34;: &#34;OK (26 bytes)&#34;, &#34;redirected&#34;: false, &#34;server&#34;: &#34;Apache/2.4.62 (Red Hat Enterprise Linux)&#34;, &#34;status&#34;: 200, &#34;url&#34;: &#34;http://ansible1&#34;}</code></pre></div>
<p>Adds this: <code>&quot;content&quot;: &quot;Welcome to the webserver!\n&quot;</code> and this: <code>&quot;status&quot;: 200, &quot;url&quot;: &quot;http://ansible1&quot;}</code> to verbose output for that task.</p>

  <footer class="footline">
  </footer>
</article>
<article class="default">
  <header class="headline">
  </header>

<h1 id="including-and-importing-files">Including and importing Files</h1>

<p>When content is included, it is dynamically processed at the moment that Ansible reaches that content.</p>
<ul>
<li>If content is imported, Ansible performs the import operation before starting to work on the tasks in the playbook.</li>
</ul>
<p>Files can be included and imported at different levels:</p>
<p>â€¢ <strong>Roles:</strong> Roles are typically used to process a complete set of
instructions provided by the role. Roles have a specific structure as
well.</p>
<p>â€¢ <strong>Playbooks:</strong> Playbooks can be imported as a complete playbook. You
cannot do this from within a play. Playbooks can be imported only at the
top level of the playbook.</p>
<p>â€¢ <strong>Tasks:</strong> A task file is just a list of tasks and can be imported or
included in another task.</p>
<p>â€¢ <strong>Variables:</strong> As discussed in <a href="/ansible/playbooks/including-and-importing-files/#ch06.xhtml#ch06">Chapter 6</a>,
&ldquo;<a href="/ansible/playbooks/including-and-importing-files/#ch06.xhtml#ch06">Working with Variables and Facts</a>,&rdquo; variables can be
maintained in external files and included in a playbook. This makes
managing generic multipurpose variables easier.</p>
<h4 class="h4" id="importing-playbooks">Importing Playbooks</h4>
<p>Importing playbooks is common in a setup where one master playbook is
used, from which different additional playbooks are included. According
to the Ansible Best Practices Guide (which is a part of the Ansible
documentation), the master playbook could have the name site.yaml, and
it can be used to include playbooks for each specific set of servers,
for instance. When a playbook is imported, this replaces the entire
play. So, you cannot import a playbook at a task level; it needs to
happen at a play level. <a href="/ansible/playbooks/including-and-importing-files/#ch10.xhtml#list10_4">Listing 10-4</a> gives an
example of the playbook imported in <a href="/ansible/playbooks/including-and-importing-files/#ch10.xhtml#list10_5">Listing
10-5</a>. In <a href="/ansible/playbooks/including-and-importing-files/#ch10.xhtml#list10_6">Listing 10-6</a>,
you can see the result of running the <strong>ansible-playbook
listing105.yaml</strong> command.</p>
<p><strong>Listing 10-4</strong> Sample Playbook to Be Imported</p>
<p>::: pre_1
- hosts: all
tasks:
- debug:
msg: running the imported play
:::</p>
<p><strong>Listing 10-5</strong> Importing a Playbook</p>
<p>::: pre_1
&mdash;
- name: run a task
hosts: all
tasks:
- debug:
msg: running task1</p>
<pre><code>- name: importing a playbook
  import_playbook: listing104.yaml
</code></pre>
<p>:::</p>
<p><strong>Listing 10-6</strong> Running <strong>ansible-playbook listing105.yaml</strong> Result</p>
<p>::: pre_1
[ansible@control rhce8-book]$ ansible-playbook listing105.yaml</p>
<pre><code>PLAY [run a task] **************************************************************

TASK [Gathering Facts] *********************************************************
ok: [ansible2]
ok: [ansible1]
ok: [ansible3]
ok: [ansible4]

TASK [debug] *******************************************************************
ok: [ansible1] =&gt; {
    &quot;msg&quot;: &quot;running task1&quot;
}
ok: [ansible2] =&gt; {
    &quot;msg&quot;: &quot;running task1&quot;
}
ok: [ansible3] =&gt; {
    &quot;msg&quot;: &quot;running task1&quot;
}
ok: [ansible4] =&gt; {
    &quot;msg&quot;: &quot;running task1&quot;
}

PLAY [all] *********************************************************************

TASK [Gathering Facts] *********************************************************
ok: [ansible2]
ok: [ansible1]
ok: [ansible3]
ok: [ansible4]

TASK [debug] *******************************************************************
ok: [ansible1] =&gt; {
    &quot;msg&quot;: &quot;running the imported play&quot;
}
ok: [ansible2] =&gt; {
    &quot;msg&quot;: &quot;running the imported play&quot;
}
ok: [ansible3] =&gt; {
    &quot;msg&quot;: &quot;running the imported play&quot;
}
ok: [ansible4] =&gt; {
    &quot;msg&quot;: &quot;running the imported play&quot;
}

PLAY RECAP *********************************************************************
ansible1                   : ok=4    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0
ansible2                   : ok=4    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0
ansible3                   : ok=4    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0
ansible4                   : ok=4    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0
</code></pre>
<p>:::</p>
<h4 class="h4" id="importing-and-including-task-files">Importing and Including Task Files</h4>
<p>Instead of importing complete playbooks, you may include task files.
When you use <strong>import_tasks</strong>, the tasks are statically imported while
executing the playbook. When you use <strong>include_tasks</strong>, the tasks are
dynamically included at the moment they are needed. Dynamically
including task files is recommended when the task file is used in a
conditional statement. If task files are mainly used to make development
easier by working with separate task files, they can be statically
imported.</p>
<p>There are a few considerations when working with <strong>import_tasks</strong> to
statically import tasks:</p>
<p>â€¢ Loops cannot be used with <strong>import_tasks</strong>.</p>
<p>â€¢ If a variable is used to specify the name of the file to import, this
cannot be a host or group inventory variable.</p>
<p>â€¢ When you use a <strong>when</strong> statement on the entire <strong>import_tasks</strong> file,
the conditional statements are applied to each task that is involved.</p>
<p>As an alternative, <strong>include_tasks</strong> can be used to dynamically include
a task file. This approach also comes with some considerations:</p>
<p>â€¢ When you use the <strong>ansible-playbook --list-tasks</strong> command, tasks
that are in the included tasks are not displayed.</p>
<p>â€¢ You cannot use <strong>ansible-playbook --start-at-task</strong> to start a
playbook on a task that comes from an included task file.</p>
<p>â€¢ You cannot use a <strong>notify</strong> statement in the main playbook to trigger
a handler that is in the included tasks file.</p>
<p>::: note</p>
<hr>
<p><strong>Tip</strong></p>
<p>When you use includes and imports to work with task files, the
recommendation is to store the task files in a separate directory. Doing
so makes it easier to delegate task management to specific users.</p>
<hr>
<p>:::</p>
<h4 class="h4" id="using-variables-when-importing-and-including-files">Using Variables When Importing and Including Files</h4>
<p>The main goal to work with imported and included files is to make
working with reusable code easy. To make sure you reach this goal, the
imported and included files should be as generic as possible. That means
it&rsquo;s a bad idea to include names of specific items that may change when
used in a different context. Think, for instance, of the names of
packages, users, services, and more.</p>
<p>To deal with include files in a flexible way, you should define specific
items as variables. Within the <strong>include_tasks</strong> file, for instance, you
refer to {{ package }}, and in the main playbook from which the include
files are called, you can define the variables. Obviously, you can use
this approach with a straight variable definition or by using host
variable or group variable include files.</p>
<p>::: note</p>
<hr>
<p><strong>Exam tip</strong></p>
<p>It&rsquo;s always possible to configure items in a way that is brilliant but
quite complex. On the exam it&rsquo;s not a smart idea to go for complex. Just
keep your solution as easy as possible. The only requirement on the exam
is to get things working, and it doesn&rsquo;t matter exactly how you do that.</p>
<hr>
<p>:::</p>
<p>In <a href="/ansible/playbooks/including-and-importing-files/#ch10.xhtml#list10_7">Listings 10-7</a> through
<a href="/ansible/playbooks/including-and-importing-files/#ch10.xhtml#list10_10">10-10</a>, you can see how include and import files
are used to work on one project. The main playbook, shown in <a href="/ansible/playbooks/including-and-importing-files/#ch10.xhtml#list10_9">Listing
10-9</a>, defines the variables to be used, as well
as the names of the include and import files. Listings 10-7 and 10-8
show the code from the include files, which use the variables that are
defined in <a href="/ansible/playbooks/including-and-importing-files/#ch10.xhtml#list10_9">Listing 10-9</a>. The result of running
the playbook in <a href="/ansible/playbooks/including-and-importing-files/#ch10.xhtml#list10_9">Listing 10-9</a> can be seen in
<a href="/ansible/playbooks/including-and-importing-files/#ch10.xhtml#list10_10">Listing 10-10</a>.</p>
<p><strong>Listing 10-7</strong> The Include Tasks File tasks/service.yaml Used for
Services Definition</p>
<p>::: pre_1
- name: install {{ package }}
yum:
name: &ldquo;{{ package }}&rdquo;
state: latest
- name: start {{ service }}
service:
name: &ldquo;{{ service }}&rdquo;
enabled: true
state: started
:::</p>
<p>The sample tasks file in <a href="/ansible/playbooks/including-and-importing-files/#ch10.xhtml#list10_7">Listing 10-7</a> is
straightforward; it uses the yum module to install a package and the
service module to start and enable the package. The variables this file
refers to are defined in the main playbook in <a href="/ansible/playbooks/including-and-importing-files/#ch10.xhtml#list10_9">Listing
10-9</a>.</p>
<p><strong>Listing 10-8</strong> The Import Tasks File tasks/firewall.yaml Used for
Firewall Definition</p>
<p>::: pre_1
- name: install the firewall
package:
name: &ldquo;{{ firewall_package }}&rdquo;
state: latest
- name: start the firewall
service:
name: &ldquo;{{ firewall_service }}&rdquo;
enabled: true
state: started
- name: open the port for the service
firewalld:
service: &ldquo;{{ item }}&rdquo;
immediate: true
permanent: true
state: enabled
loop: &ldquo;{{ firewall_rules }}&rdquo;
:::</p>
<p>In the sample firewall file in <a href="/ansible/playbooks/including-and-importing-files/#ch10.xhtml#list10_8">Listing 10-8</a>, the
firewall service is installed, defined, and configured. In the
configuration of the firewalld service, a loop is used on the variable
firewall_rules. This variable obviously is defined in <a href="/ansible/playbooks/including-and-importing-files/#ch10.xhtml#list10_9">Listing
10-9</a>, which is the file where site-specific
contents such as variables are defined.</p>
<p><strong>Listing 10-9</strong> Main Playbook Example</p>
<p>::: pre_1
&mdash;
- name: setup a service
hosts: ansible2
tasks:
- name: include the services task file
include_tasks: tasks/service.yaml
vars:
package: httpd
service: httpd
when: ansible_facts[â€™os_familyâ€™] == â€™RedHatâ€™
- name: import the firewall file
import_tasks: tasks/firewall.yaml
vars:
firewall_package: firewalld
firewall_service: firewalld
firewall_rules:
- http
- https
:::</p>
<p>The main playbook in <a href="/ansible/playbooks/including-and-importing-files/#ch10.xhtml#list10_9">Listing 10-9</a> shows the
site-specific configuration. It performs two main tasks: it defines
variables, and it calls an include file and an import file. The
variables that are defined are used by the include and import files. The
<strong>include_tasks</strong> statement is executed in a <strong>when</strong> statement. Notice
that the <strong>firewall_rules</strong> variable contains a list as its value, which
is used by the loop that is defined in the import file.</p>
<p><strong>Listing 10-10</strong> Running <strong>ansible-playbook listing109.yaml</strong></p>
<p>::: pre_1
[ansible@control rhce8-book]$ ansible-playbook listing109.yaml</p>
<pre><code>PLAY [setup a service] *********************************************************

TASK [Gathering Facts] *********************************************************
ok: [ansible2]

TASK [include the services task file] ******************************************
included: /home/ansible/rhce8-book/tasks/service.yaml for ansible2

TASK [install httpd] ***********************************************************
ok: [ansible2]

TASK [start httpd] *************************************************************
changed: [ansible2]

TASK [install the firewall] ****************************************************
changed: [ansible2]

TASK [start the firewall] ******************************************************
ok: [ansible2]

TASK [open the port for the service] *******************************************
changed: [ansible2] =&gt; (item=http)
changed: [ansible2] =&gt; (item=https)

PLAY RECAP *********************************************************************
ansible2                   : ok=7    changed=3    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0
</code></pre>
<p>:::</p>
<p>The interesting thing in the <a href="/ansible/playbooks/including-and-importing-files/#ch10.xhtml#list10_10">Listing 10-10</a>
output is that the include file is dynamically included while running
the playbook. This is not the case for the statically imported file. In
<a href="/ansible/playbooks/including-and-importing-files/#ch10.xhtml#exe10_3">Exercise 10-3</a> you practice working with include
files.</p>
<p>::: box
<strong>Exercise 10-3 Using Includes and Imports</strong></p>
<p>In this exercise you create a simple master playbook that installs a
service. The name of the service is defined in a variable file, and the
specific tasks are included through task files.</p>
<p>1. Open the file exercise103-vars.yaml and define three variables as
follows:</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0"><code class="language-pre1" data-lang="pre1">packagename: vsftpd
servicename: vsftpd
firewalld_servicename: ftp</code></pre></div>
<p>2. Create the exercise103-ftp.yaml file and give it the following
contents to install, enable, and start the vsftpd service and also to
make it accessible in the firewall:</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0"><code class="language-pre1" data-lang="pre1">- name: install {{ packagename }}
  yum:
    name: &#34;{{ packagename }}&#34;
    state: latest
- name: enable and start {{ servicename }}
  service:
    name: &#34;{{ servicename }}&#34;
    state: started
    enabled: true
- name: open the service in the firewall
  firewalld:
    service: &#34;{{ firewalld_servicename }}&#34;
    permanent: yes
    state: enabled</code></pre></div>
<p>3. Create the exercise103-copy.yaml file that manages the
/var/ftp/pub/README file and make sure it has the following contents:</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0"><code class="language-pre1" data-lang="pre1">- name: copy a file
  copy:
    content: &#34;welcome to this server&#34;
    dest: /var/ftp/pub/README</code></pre></div>
<p>4. Create the master playbook exercise103.yaml that includes all of
them and give it the following contents:</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0"><code class="language-pre1" data-lang="pre1">---
- name: install vsftpd on ansible2
  vars_files: exercise103-vars.yaml
  hosts: ansible2
  tasks:
  - name: install and enable vsftpd
    import_tasks: exercise103-ftp.yaml
  - name: copy the README file
    import_tasks: exercise103-copy.yaml</code></pre></div>
<p>5. Run the playbook and verify its output</p>
<p>6. Run an ad hoc command to verify the /var/ftp/pub/README file has
been created: <strong>ansible ansible2 -a &ldquo;cat /var/ftp/pub/README&rdquo;</strong>.</p>
<h3 id="end-of-chapter-lab">End-of-Chapter Lab</h3>
<p>In the end-of-chapter lab with this chapter, you reorganize a playbook
to work with several different files instead of one big file. Do this
according to the instructions in Lab 10-1.</p>
<h3 id="lab-10-1">Lab 10-1</h3>
<p>The lab82.yaml file, which you can find in the GitHub repository that
goes with this course, is an optimal candidate for optimization.
Optimize this playbook according to the following requirements:</p>
<p>â€¢ Use includes and import to make this a modular playbook where
different files are used to distinguish between the different tasks.</p>
<p>â€¢ Optimize this playbook such that it will run on no more than two hosts
at the same time and completes the entire playbook on these two hosts
before continuing with the next host.</p>

  <footer class="footline">
  </footer>
</article>
          </section>
<article class="default">
  <header class="headline">
  </header>

<h1 id="roles">Roles</h1>

<div class="children children-type-card children-sort-"><ul class="card-container">
<li>
  <article class="card card-popout" aria-labelledby="R-card-372749c138562637304ba0534c57a09c">
    <div class="card-content">
      <div class="card-title" id="R-card-372749c138562637304ba0534c57a09c">
        <a href="/ansible/roles/ansible-galaxy-roles/">
        Ansible Galaxy Roles
        </a>
      </div>
      <div class="card-content-text">
          <!-- raw HTML omitted -->

      </div>
    </div>
  </article>
</li>
<li>
  <article class="card card-popout" aria-labelledby="R-card-b5f5ecfba72a4b2a9170c483b1c49e79">
    <div class="card-content">
      <div class="card-title" id="R-card-b5f5ecfba72a4b2a9170c483b1c49e79">
        <a href="/ansible/roles/using-ansible-roles/">
        Ansible Roles
        </a>
      </div>
      <div class="card-content-text">
          <!-- raw HTML omitted -->

      </div>
    </div>
  </article>
</li>
<li>
  <article class="card card-popout" aria-labelledby="R-card-cdbc9a2d2b2f5e933dd2f915086e5e3a">
    <div class="card-content">
      <div class="card-title" id="R-card-cdbc9a2d2b2f5e933dd2f915086e5e3a">
        <a href="/ansible/roles/using-rhel-system-roles/">
        Using RHEL System roles
        </a>
      </div>
      <div class="card-content-text">
          <!-- raw HTML omitted -->

      </div>
    </div>
  </article>
</li>
</ul>
</div>

  <footer class="footline">
  </footer>
</article>
          <section>
            <h1 class="a11y-only">Subsections of Roles</h1>
<article class="default">
  <header class="headline">
  </header>

<h1 id="ansible-galaxy-roles">Ansible Galaxy Roles</h1>

<h3 id="using-ansible-galaxy-roles">Using Ansible Galaxy Roles</h3>
<ul>
<li>Ansible Galaxy is a public library of Ansible content and contains thousands of roles that have been provided by community members.</li>
</ul>
<h4 id="working-with-galaxy">Working with Galaxy</h4>
<p>The easiest way to work with Ansible Galaxy is to use the website at <a href="https://galaxy.ansible.com" rel="external" target="_blank">https://galaxy.ansible.com</a>:</p>
<p><a href="#R-image-4d0350672d529906d553bcf7033e503b" class="lightbox-link"><img alt="Image" class="lazy lightbox figure-image" loading="lazy" src="/Images/2436_09fig01.jpg" style="height: auto;width: auto;"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-4d0350672d529906d553bcf7033e503b"><img alt="Image" class="lazy lightbox lightbox-image" loading="lazy" src="/Images/2436_09fig01.jpg"></a></p>
<p><a href="#R-image-c34ce505d4da991e92f8f9f3480c45da" class="lightbox-link"><img alt="Image" class="lazy lightbox figure-image" loading="lazy" src="/Images/2436_09fig02.jpg" style="height: auto;width: auto;"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-c34ce505d4da991e92f8f9f3480c45da"><img alt="Image" class="lazy lightbox lightbox-image" loading="lazy" src="/Images/2436_09fig02.jpg"></a></p>
<ul>
<li>
<p>Use the Search Feature to Search for Specific Packages</p>
</li>
<li>
<p>In the result of any Search action, you see a list of collections as well as a list of roles.</p>
</li>
<li>
<p>An Ansible Galaxy collection is a distribution format for Ansible content.</p>
</li>
<li>
<p>It can contain roles, but also playbooks, modules, and plug-ins.</p>
</li>
<li>
<p>In most cases you just need the roles, not the collection: roles contain all that you include in the playbooks you&rsquo;re working with.</p>
</li>
<li>
<p>Some important indicators are the number of times the role has been downloaded and the score of the role.</p>
</li>
<li>
<p>This information enables you to easily distinguish between commonly used roles and roles that are not used that often.</p>
</li>
<li>
<p>Also, you can use tags to make identifying Galaxy roles easier.</p>
</li>
<li>
<p>These tags provide more information about a role and make it  possible to search for roles in a more efficient way.</p>
</li>
</ul>
<p><a href="#R-image-8fa21a09bf4b8d20aac2b259aeed3ef8" class="lightbox-link"><img alt="Image" class="lazy lightbox figure-image" loading="lazy" src="/Images/2436_09fig03.jpg" style="height: auto;width: auto;"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-8fa21a09bf4b8d20aac2b259aeed3ef8"><img alt="Image" class="lazy lightbox lightbox-image" loading="lazy" src="/Images/2436_09fig03.jpg"></a></p>
<ul>
<li>You can download roles directly from the Ansible Galaxy website</li>
<li>You can also use the <code>ansible-galaxy</code> command</li>
</ul>
<h4 id="using-the-ansible-galaxy-command">Using the <code>ansible-galaxy</code> Command</h4>
<p><code>ansible-galaxy search</code></p>
<ul>
<li>Find roles based on many different keywords and manage them.</li>
<li>Must provide a string as an argument.</li>
<li>Ansible searches for this string in the name and description of the roles.</li>
</ul>
<p>Useful Command-Line Options:
<strong>&ndash;platforms</strong></p>
<ul>
<li>Operating system platform to search for
<strong>&ndash;author</strong></li>
<li>GitHub username of the author
<strong>&ndash;galaxy-tags</strong></li>
<li>Additional tags to filter by</li>
</ul>
<p>`ansible-galaxy info</p>
<ul>
<li>Get more information about a role.</li>
</ul>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#ff6ac1">[</span>ansible@control ansible-lab<span style="color:#ff6ac1">]</span>$ ansible-galaxy info geerlingguy.docker
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Role: geerlingguy.docker
</span></span><span style="display:flex;"><span>        description: Docker <span style="color:#ff6ac1">for</span> Linux.
</span></span><span style="display:flex;"><span>        commit: 9115e969c1e57a1639160d9af3477f09734c94ac
</span></span><span style="display:flex;"><span>        commit_message: Merge pull request <span style="color:#78787e">#501 from adamus1red/adamus1red/alpine-compose</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>add compose package to Alpine specific variables
</span></span><span style="display:flex;"><span>        created: 2023-05-08T20:49:45.679874Z
</span></span><span style="display:flex;"><span>        download_count: <span style="color:#ff9f43">23592264</span>
</span></span><span style="display:flex;"><span>        github_branch: master
</span></span><span style="display:flex;"><span>        github_repo: ansible-role-docker
</span></span><span style="display:flex;"><span>        github_user: geerlingguy
</span></span><span style="display:flex;"><span>        id: <span style="color:#ff9f43">10923</span>
</span></span><span style="display:flex;"><span>        imported: 2025-03-24T00:01:45.901567
</span></span><span style="display:flex;"><span>        modified: 2025-03-24T00:01:47.840887Z
</span></span><span style="display:flex;"><span>        path: <span style="color:#ff6ac1">(</span><span style="color:#5af78e">&#39;/home/ansible/.ansible/roles&#39;</span>, <span style="color:#5af78e">&#39;/usr/share/ansible/roles&#39;</span>, <span style="color:#5af78e">&#39;/etc/ansible/roles&#39;</span><span style="color:#ff6ac1">)</span>
</span></span><span style="display:flex;"><span>        upstream_id: None
</span></span><span style="display:flex;"><span>        username: geerlingguy</span></span></code></pre></div>
<h4 id="managing-ansible-galaxy-roles">Managing Ansible Galaxy Roles</h4>
<p><code>ansible-galaxy install</code></p>
<ul>
<li>Install a role</li>
<li>normally installs the role into the ~/.ansible/roles directory because this role is specified in the <strong>role_path</strong> setting in ansible.cfg.</li>
<li>If you want roles to be installed in another directory, consider changing this parameter.
<code>-p</code></li>
<li>option to install the role to a different role path directory.</li>
</ul>
<p><strong>requirements</strong> file.</p>
<ul>
<li>YAML file that you can include when using the <code>ansible-roles</code> command.</li>
</ul>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yml" data-lang="yml"><span style="display:flex;"><span>    - <span style="color:#ff6ac1">src</span>: geerlingguy.nginx
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">version</span>: <span style="color:#5af78e">&#34;2.7.0&#34;</span></span></span></code></pre></div>
<ul>
<li>possible to add roles from sources other than Ansible Galaxy, such as a Git repository or a tarball.</li>
<li>In that case, you must specify the exact URL to the role using the <code>src</code> option.</li>
<li>When you are installing roles from a Git repository, the <code>scm</code> keyword is also required and must be set to <code>git</code>.</li>
</ul>
<p>To install a role using the requirements file, you can use the <code>-r</code> option with the <code>ansible-galaxy install</code> command:
<code>ansible-galaxy install -r roles/requirements.yml</code></p>
<p><code>ansible-galaxy list</code></p>
<ul>
<li>Get a list of currently installed roles</li>
</ul>
<p><code>ansible-galaxy remove</code></p>
<ul>
<li>Remove roles from your system.</li>
</ul>
<h3 id="lab-using-ansible-galaxy-to-manage-roles">LAB: Using <code>ansible-galaxy</code> to Manage Roles</h3>
<ul>
<li>Type <code>ansible-galaxy search --author geerlingguy --platforms EL</code> to see a list of roles that geerlingguy has created.</li>
<li>Make the command more specific and type <code>ansible-galaxy search nginx --author geerlingguy --platforms EL</code> to find the <strong>geerlingguy.nginx</strong> role.</li>
<li>Request more information about this role by using <code>ansible-galaxy info geerlingguy.nginx</code>.</li>
<li>Create a requirements file with the name <strong>listing96.yaml</strong> and give this file the following contents:</li>
</ul>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yml" data-lang="yml"><span style="display:flex;"><span>- <span style="color:#ff6ac1">src</span>: geerlingguy.nginx
</span></span><span style="display:flex;"><span>  <span style="color:#ff6ac1">version</span>: <span style="color:#5af78e">&#34;2.7.0&#34;</span></span></span></code></pre></div>
<ul>
<li>
<p>Add the line <code>roles_path = /home/ansible/roles</code> to the ansible.cfg file.</p>
</li>
<li>
<p>Use the command <code>ansible-galaxy install -r listing96.yaml</code> to install the role from the requirements file. It is possible that by the time you run this exercise, the specified version 2.7.0 is no longer available. If that is the case, use <code>ansible-galaxy info</code> again to find a version that still is available, and change the requirements file accordingly.</p>
</li>
<li>
<p>Type <code>ansible-galaxy list</code> to verify that the new role was successfully installed on your system.</p>
</li>
<li>
<p>Write a playbook with the name exercise92.yaml that uses the role and has the following contents:</p>
</li>
</ul>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yml" data-lang="yml"><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span>- <span style="color:#ff6ac1">name</span>: install nginx using Galaxy role
</span></span><span style="display:flex;"><span>  <span style="color:#ff6ac1">hosts</span>: ansible2
</span></span><span style="display:flex;"><span>  <span style="color:#ff6ac1">roles</span>:
</span></span><span style="display:flex;"><span>  - geerlingguy.nginx</span></span></code></pre></div>
<ul>
<li>Run the playbook using <code>ansible-playbook exercise92.yaml</code> and observe that the new role is installed from the custom roles path.</li>
</ul>

  <footer class="footline">
  </footer>
</article>
<article class="default">
  <header class="headline">
  </header>

<h1 id="ansible-roles">Ansible Roles</h1>

<p>Work with roles and Create roles</p>
<h3 id="using-ansible-roles">Using Ansible Roles</h3>
<ul>
<li>Ready-to-use playbook-based Ansible solutions that you can easily include in your own playbooks.</li>
<li>Community roles are provided through Ansible Galaxy</li>
<li>Also possible to create your own roles.</li>
<li>Red Hat provides RHEL System Roles.</li>
<li>Roles make it possible to provide Ansible code in a reusable way.</li>
<li>You can easily define a specific task in a role, and after defining it in a role, you can easily redistribute that and ensure that tasks are handled the same way, no matter where they are executed.</li>
<li>Roles can be custom-made for specific environments, or default roles provided from Ansible Galaxy can be used.</li>
</ul>
<h4 id="understanding-ansible-roles">Understanding Ansible Roles</h4>
<ul>
<li>work with include files.</li>
<li>All the different components that you may use in a playbook are used in roles and stored in separate directories.</li>
<li>While defining the role, you don&rsquo;t need to tell the role that it should look in some of these specific directories; it does that automatically.</li>
<li>The only thing you need to do is tell your Ansible playbook that it should include a role.</li>
<li>Different components of the role are stored in different subdirectories.</li>
</ul>
<p>Roles Sample Directory Structure:</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0"><code>    [ansible@control roles]$ tree testrole/
    testrole/
    |-- defaults
    |   `-- main.yml
    |-- files
    |-- handlers
    |   `-- main.yml
    |-- meta
    |   `-- main.yml
    |-- README.md
    |-- tasks
    |   `-- main.yml
    |-- templates
    |-- tests
    |   |-- inventory
    |   `-- test.yml
    `-- vars
        `-- main.yml</code></pre></div>
<p>Role Directory Structure
<strong>defaults</strong></p>
<ul>
<li>
<p>Default variables that may be overwritten by other variables
<strong>files</strong></p>
</li>
<li>
<p>Static files that are needed by role tasks
<strong>handlers</strong></p>
</li>
<li>
<p>Handlers for use in this role
<strong>meta</strong></p>
</li>
<li>
<p>metadata, such as dependencies, plus license and maintainer information
<strong>tasks</strong></p>
</li>
<li>
<p>Role task definitions
<strong>templates</strong></p>
</li>
<li>
<p>Jinja2 templates
<strong>tests</strong></p>
</li>
<li>
<p>Optional inventory and a test.yml file to test the role
<strong>vars</strong></p>
</li>
<li>
<p>Variables that are not meant to be overwritten</p>
</li>
<li>
<p>Most of the role directories have a main.yml file.</p>
</li>
<li>
<p>This is the entry-point YAML file that is used to define components in the role.</p>
</li>
</ul>
<h4 id="understanding-role-location">Understanding Role Location</h4>
<p>Roles can be stored in different locations:</p>
<p><strong>./roles</strong></p>
<ul>
<li>store roles in the current project directory.</li>
<li>highest precedence.</li>
</ul>
<p><strong>~/.ansible/roles</strong></p>
<ul>
<li>exists in the current user home directory and makes the role available to the current user only.</li>
<li>second-highest precedence.</li>
</ul>
<p><strong>/etc/ansible/roles</strong></p>
<ul>
<li>Where roles are stored to make them accessible to any user.</li>
</ul>
<p><strong>/usr/share/ansible/roles</strong></p>
<ul>
<li>Where roles are stored after they are installed from RPM files.</li>
<li>lowest precedence</li>
<li>should not be used for storing custom-made roles.</li>
</ul>
<p><code>ansible-galaxy init { newrolename }</code></p>
<ul>
<li>create a custom role</li>
<li>creates the default role directory structure with a main.yml file</li>
<li>includes sample files</li>
</ul>
<h4 id="using-roles-from-playbooks">Using Roles from Playbooks</h4>
<ul>
<li>Call roles in a playbook the same way you call a task</li>
<li>Roles are included as a list.</li>
</ul>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yml" data-lang="yml"><span style="display:flex;"><span>    ---
</span></span><span style="display:flex;"><span>    - <span style="color:#ff6ac1">name</span>: include some roles
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">roles</span>:
</span></span><span style="display:flex;"><span>      - role1
</span></span><span style="display:flex;"><span>      - role2</span></span></code></pre></div>
<ul>
<li>Roles are executed before the tasks.</li>
<li>In specific cases you might have to execute tasks before the roles. To do so, you can specify these tasks in a <strong>pre_tasks</strong> section.</li>
<li>Also, it&rsquo;s possible to use the <strong>post_tasks</strong> section to include tasks that will be executed after the roles, but also after tasks specified in the playbook as well as the handlers they call.</li>
</ul>
<h4 id="creating-custom-roles">Creating Custom Roles</h4>
<ul>
<li>Use <code>mkdir roles</code> to create a roles subdirectory in the current directory, and use <code>cd roles</code> to get into that subdirectory.</li>
<li>Use <code>ansible-galaxy init motd</code> to create the motd role structure.</li>
<li>Add contents to <strong>motd/tasks/main.yml</strong></li>
<li>Add contents to motd/templates/motd.j2</li>
<li>Add contents to <strong>motd/defaults/main.yml</strong></li>
<li>Add contents to <strong>motd/meta/main.yml</strong></li>
<li>Create the playbook <strong>exercise91.yaml</strong> to run the role</li>
<li>Run the playbook by using <code>ansible-playbook exercise91.yaml</code></li>
<li>Verify that modifications have been applied correctly by using the ad hoc command <code>ansible ansible2 -a &quot;cat /etc/motd&quot;</code></li>
</ul>
<p>Sample role all under <strong>roles/motd/</strong>:</p>
<p><strong>defaults/main.yml</strong></p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yml" data-lang="yml"><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span><span style="color:#78787e"># defaults file for motd</span>
</span></span><span style="display:flex;"><span><span style="color:#ff6ac1">system_manager</span>: anna@example.com</span></span></code></pre></div>
<p><strong>meta/main.yml</strong></p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yml" data-lang="yml"><span style="display:flex;"><span><span style="color:#ff6ac1">galaxy_info</span>:
</span></span><span style="display:flex;"><span><span style="color:#ff6ac1">author</span>: Sander van V
</span></span><span style="display:flex;"><span><span style="color:#ff6ac1">description</span>: your description
</span></span><span style="display:flex;"><span><span style="color:#ff6ac1">company</span>: your company (optional)
</span></span><span style="display:flex;"><span><span style="color:#ff6ac1">license</span>: license (GPLv2, CC-BY, etc)
</span></span><span style="display:flex;"><span><span style="color:#ff6ac1">min_ansible_version</span>: <span style="color:#ff9f43">2.5</span></span></span></code></pre></div>
<p><strong>tasks/main.yml</strong></p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yml" data-lang="yml"><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span>tasks file for motd
</span></span><span style="display:flex;"><span>- <span style="color:#ff6ac1">name</span>: copy motd file
</span></span><span style="display:flex;"><span>  <span style="color:#ff6ac1">template</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">src</span>: templates/motd.j2
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">dest</span>: /etc/motd
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">owner</span>: root
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">group</span>: root
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">mode</span>: <span style="color:#ff9f43">0444</span></span></span></code></pre></div>
<p><strong>templates/motd.j2</strong></p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0"><code>Welcome to {{ ansible_hostname }}
    
This file was created on {{ ansible_date_time.date }}
Disconnect if you have no business being here
    
Contact {{ system_manager }} if anything is wrong</code></pre></div>
<p>Playbook <strong>motd.yml</strong>:</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yml" data-lang="yml"><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span>- <span style="color:#ff6ac1">name</span>: use the motd role playbook
</span></span><span style="display:flex;"><span>  <span style="color:#ff6ac1">hosts</span>: ansible2
</span></span><span style="display:flex;"><span>  <span style="color:#ff6ac1">roles</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ff6ac1">role</span>: motd
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">system_manager</span>: bob@example.com</span></span></code></pre></div>
<p>handlers/main.yml example:</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yml" data-lang="yml"><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span><span style="color:#78787e"># handlers file for base-config</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#ff6ac1">name</span>: source profile
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">command</span>: source /etc/profile
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  - <span style="color:#ff6ac1">name</span>: source bash
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">command</span>: source /etc/bash.bashrc                               </span></span></code></pre></div>
<h4 id="managing-role-dependencies">Managing Role Dependencies</h4>
<ul>
<li>Roles may use other roles as a dependency.</li>
<li>You can put role dependencies in meta/main.yml</li>
<li>Dependent roles are always executed before the roles that depend on them.</li>
<li>Dependent roles are executed once.</li>
<li>When two roles that are used in a playbook call the same dependency, the dependent role is executed once only.</li>
<li>When calling dependent roles, it is possible to pass variables to the dependent role.</li>
<li>You can define a <strong>when</strong> statement to ensure that the dependent role is executed only in specific situations.</li>
</ul>
<p>Defining dependencies in <strong>meta/main.yml</strong></p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yml" data-lang="yml"><span style="display:flex;"><span>    <span style="color:#ff6ac1">dependencies</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#ff6ac1">role</span>: apache
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">port</span>: <span style="color:#ff9f43">8080</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#ff6ac1">role</span>: mariabd
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">when</span>: environment == â€™productionâ€™</span></span></code></pre></div>
<h4 id="understanding-file-organization-best-practices">Understanding File Organization Best Practices</h4>
<ul>
<li>
<p>Working with roles splits the contents of the role off the tasks that are run through the playbook.</p>
</li>
<li>
<p>Splitting files to store them in a location that makes sense is common in Ansible</p>
</li>
<li>
<p>When you&rsquo;re working with Ansible, it&rsquo;s a good idea to work with project directories in bigger environments.</p>
</li>
<li>
<p>Working with project directories makes it easier to delegate tasks and have the right people responsible for the right things.</p>
</li>
<li>
<p>Each project directory may have its own ansible.cfg file, inventory file, and playbooks.</p>
</li>
<li>
<p>If the project grows bigger, variable files and other include files may be used, and they are normally stored in subdirectories.</p>
</li>
<li>
<p>At the top-level directory, create the main playbook from which other playbooks are included. The suggested name for the main playbook is <strong>site.yml</strong>.</p>
</li>
<li>
<p>Use <strong>group_vars/</strong> and <strong>host_vars/</strong> to set host-related variables and do not define them in inventory.</p>
</li>
<li>
<p>Consider using different inventory files to differentiate between production and staging phases.</p>
</li>
<li>
<p>Use roles to standardize common tasks.</p>
</li>
</ul>
<p>When you are working with roles, some additional recommendations apply:</p>
<ul>
<li>
<p>Use a version control repository to maintain roles in a consistent way. Git is commonly used for this purpose.</p>
</li>
<li>
<p>Sensitive information should never be included in roles. Use Ansible Vault to store sensitive information in an encrypted way.</p>
</li>
<li>
<p>Use <code>ansible-galaxy init</code> to create the role base structure. Remove files and directories you don&rsquo;t use.</p>
</li>
<li>
<p>Don&rsquo;t forget to provide additional information in the role&rsquo;s <strong>README.md</strong> and <strong>meta/main.yml</strong> files.</p>
</li>
<li>
<p>Keep roles focused on a specific function. It is better to use multiple roles to perform multiple tasks.</p>
</li>
<li>
<p>Try to develop roles in a generic way, such that they can be used for multiple purposes.</p>
</li>
</ul>
<h3 id="lab-9-1">Lab 9-1</h3>
<p>Create a playbook that starts the Nginx web server on ansible1, according to the following requirements:
â€¢ A requirements file must be used to install the Nginx web server. Do NOT use the latest version of the Galaxy role, but instead use the version before that.
â€¢ The same requirements file must also be used to install the latest version of postgresql.
â€¢ The playbook needs to ensure that neither httpd nor mysql is currently installed.</p>
<h3 id="lab-9-2">Lab 9-2</h3>
<p>Use the RHEL SELinux System Role to manage SELinux properties according
to the following requirements:</p>
<p>â€¢ A Boolean is set to allow SELinux relabeling to be automated using
cron.
â€¢ The directory /var/ftp/uploads is created, permissions are set to 777,
and the context label is set to public_content_rw_t.
â€¢ SELinux should allow web servers to use port 82 instead of port 80.
â€¢ SELinux is in enforcing state.
Subjects:
<code>ansible-playbook timesync.yaml</code> to run the playbook. Observe its output. Notice that some messages in red are shown, but these can safely be ignored.</p>
<p>5. Use <code>ansible ansible2 -a &quot;timedatectl show&quot;</code> and notice that the <strong>timezone</strong> variable is set to UTC.</p>
<h3 id="lab-9-1-1">Lab 9-1</h3>
<p>Create a playbook that starts the Nginx web server on ansible1, according to the following requirements:
â€¢ A requirements file must be used to install the Nginx web server. Do NOT use the latest version of the Galaxy role, but instead use the version before that.
â€¢ The same requirements file must also be used to install the latest version of postgresql.
<code>ansible-galaxy install -r roles/requirements.yml</code></p>
<p><code>cat roles/requirements.yml</code></p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yml" data-lang="yml"><span style="display:flex;"><span>- <span style="color:#ff6ac1">src</span>: geerlingguy.nginx
</span></span><span style="display:flex;"><span>  <span style="color:#ff6ac1">version</span>: <span style="color:#5af78e">&#34;3.1.4&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>- <span style="color:#ff6ac1">src</span>: geerlingguy.postgresql</span></span></code></pre></div>
<p>â€¢ The playbook needs to ensure that neither httpd nor mysql is currently installed.</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yml" data-lang="yml"><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span>- <span style="color:#ff6ac1">name</span>: ensure conflicting packages are not installed
</span></span><span style="display:flex;"><span>  <span style="color:#ff6ac1">hosts</span>: web1
</span></span><span style="display:flex;"><span>  <span style="color:#ff6ac1">tasks</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ff6ac1">name</span>: remove packages
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">yum</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">name</span>: 
</span></span><span style="display:flex;"><span>      - mysql
</span></span><span style="display:flex;"><span>      - httpd
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">state</span>: absent
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>- <span style="color:#ff6ac1">name</span>: nginx web server
</span></span><span style="display:flex;"><span>  <span style="color:#ff6ac1">hosts</span>: web1
</span></span><span style="display:flex;"><span>  <span style="color:#ff6ac1">roles</span>: 
</span></span><span style="display:flex;"><span>  - geerlingguy.nginx
</span></span><span style="display:flex;"><span>  - geerlingguy.postgresql</span></span></code></pre></div>
<p>(Had to add a variable file for redhat 10 into the role. )</p>
<h3 id="lab-9-2-1">Lab 9-2</h3>
<p>Use the RHEL SELinux System Role to manage SELinux properties according to the following requirements:</p>
<p>â€¢ A Boolean is set to allow SELinux relabeling to be automated using
cron.
â€¢ The directory /var/ftp/uploads is created, permissions are set to 777,
and the context label is set to public_content_rw_t.
â€¢ SELinux should allow web servers to use port 82 instead of port 80.
â€¢ SELinux is in enforcing state.</p>
<p><code>vim lab92.yml</code></p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yml" data-lang="yml"><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span>- <span style="color:#ff6ac1">name</span>: manage ftp selinux properties
</span></span><span style="display:flex;"><span>  <span style="color:#ff6ac1">hosts</span>: ftp1
</span></span><span style="display:flex;"><span>  <span style="color:#ff6ac1">vars</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">selinux_booleans</span>: 
</span></span><span style="display:flex;"><span>      - <span style="color:#ff6ac1">name</span>: cron_can_relabel
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">state</span>: <span style="color:#ff6ac1">true</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">persistent</span>: <span style="color:#ff6ac1">true</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">selinux_state</span>: enforcing
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">selinux_ports</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#ff6ac1">ports</span>: <span style="color:#ff9f43">82</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">proto</span>: tcp
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">setype</span>: http_port_t
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">state</span>: present
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">local</span>: <span style="color:#ff6ac1">true</span>
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>  <span style="color:#ff6ac1">tasks</span>:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  - <span style="color:#ff6ac1">name</span>: create /var/ftp/uploads/
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">file</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">path</span>: /var/ftp/uploads
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">state</span>: directory
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">mode</span>: <span style="color:#ff9f43">777</span>
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  - <span style="color:#ff6ac1">name</span>: set selinux context
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">sefcontext</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">target</span>: <span style="color:#5af78e">&#39;/var/ftp/uploads(/.*)?&#39;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">setype</span>: public_content_rw_t
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">ftype</span>: d
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">state</span>: present
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">notify</span>: run restorecon
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  - <span style="color:#ff6ac1">name</span>: Execute the role and reboot in a rescue block
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">block</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#ff6ac1">name</span>: Include selinux role
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">include_role</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#ff6ac1">name</span>: rhel-system-roles.selinux
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">rescue</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#ff6ac1">name</span>: &gt;-<span style="color:#5af78e">
</span></span></span><span style="display:flex;"><span><span style="color:#5af78e">          Fail if failed for a different reason than selinux_reboot_required</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">fail</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#ff6ac1">msg</span>: <span style="color:#5af78e">&#34;role failed&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">when</span>: not selinux_reboot_required
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      - <span style="color:#ff6ac1">name</span>: Restart managed host
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">reboot</span>:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      - <span style="color:#ff6ac1">name</span>: Wait for managed host to come back
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">wait_for_connection</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#ff6ac1">delay</span>: <span style="color:#ff9f43">10</span>
</span></span><span style="display:flex;"><span>          <span style="color:#ff6ac1">timeout</span>: <span style="color:#ff9f43">300</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      - <span style="color:#ff6ac1">name</span>: Reapply the role
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">include_role</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#ff6ac1">name</span>: rhel-system-roles.selinux
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#ff6ac1">handlers</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#ff6ac1">name</span>:  run restorecon
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">command</span>: restorecon -v /var/ftp/uploads</span></span></code></pre></div>

  <footer class="footline">
  </footer>
</article>
<article class="default">
  <header class="headline">
  </header>

<h1 id="using-rhel-system-roles">Using RHEL System roles</h1>

<h3 id="using-rhel-system-roles">Using RHEL System Roles</h3>
<ul>
<li>Allows for a uniform approach while managing multiple RHEL versions</li>
<li>Red Hat provides RHEL System Roles.</li>
<li>RHEL System Roles make managing different parts of the operating system easy.</li>
</ul>
<p>RHEL System Roles:</p>
<p><strong>rhel-system-roles.kdump</strong></p>
<ul>
<li>Configures the kdump crash recovery service
<strong>rhel system-roles.network</strong></li>
<li>Configures network interfaces
<strong>rhel system-roles.postfix</strong></li>
<li>Configures hosts as a Mail Transfer Agent using Postfix
<strong>rhel system-roles.selinux</strong></li>
<li>Manages SELinux settings
<strong>rhel system-roles.storage</strong></li>
<li>Configures storage
<strong>rhel system-roles.timesync</strong></li>
<li>Configures time synchronization</li>
</ul>
<h4 id="understanding-rhel-system-roles">Understanding RHEL System Roles</h4>
<ul>
<li>RHEL System Roles are based on the community Linux System Roles</li>
<li>Provide a uniform interface to make configuration tasks easier where significant differences may exist between versions of the managed operating system.</li>
<li>RHEL System Roles can be used to manage Red Hat Enterprise Linux 6.10 and later, as well as RHEL 7.4 and later, and all versions of RHEL 8.</li>
<li>Linux System Roles are not supported by RHEL technical support.</li>
</ul>
<h4 id="installing-rhel-system-roles">Installing RHEL System Roles</h4>
<ul>
<li>
<p>To use RHEL System Roles, you need to install the <strong>rhel-system-roles</strong> package on the control node by using <code>sudo yum install rhel-system-roles</code>.</p>
</li>
<li>
<p>This package can be found in the RHEL 8 AppStream repository.</p>
</li>
<li>
<p>After installation, the roles are copied to the <strong>/usr/share/ansible/roles</strong> directory, a directory that is a default part of the Ansible <strong>roles_path</strong> setting.</p>
</li>
<li>
<p>If a modification to the <strong>roles_path</strong> setting has been made in ansible.cfg, the roles are applied to the first directory listed in the <strong>roles_path</strong>.</p>
</li>
<li>
<p>With the roles, some very useful documentation is installed also; you can find it in the <strong>/usr/share/doc/rhel-system-roles</strong> directory.</p>
</li>
<li>
<p>To pass configuration to the RHEL System Roles, variables are important.</p>
</li>
<li>
<p>In the documentation directory, you can find information about variables that are required and used by the role.</p>
</li>
<li>
<p>Some roles also contain a sample playbook that can be used as a blueprint when defining your own role.</p>
</li>
<li>
<p>It&rsquo;s a good idea to use these as the basis for your own RHEL System Roles&ndash;based configuration.</p>
</li>
<li>
<p>The next two sections describe the SELinux and the TimeSync System Roles, which provide nice and easy-to-implement examples of how you can use the RHEL System Roles.</p>
</li>
</ul>
<h4 id="using-the-rhel-selinux-system-role">Using the RHEL SELinux System Role</h4>
<ul>
<li>
<p>You learned earlier how to manage SELinux settings using task definitions in your own playbooks.</p>
</li>
<li>
<p>Using the RHEL SELinux System Role provides an easy-to-use alternative.</p>
</li>
<li>
<p>To use this role, start by looking at the documentation, which is in the /usr/share/doc/rhel-system-roles/selinux directory.</p>
</li>
<li>
<p>A good file to start with is the README.md file, which provides lists of all the ingredients that can be used.</p>
</li>
<li>
<p>The SELinux System Role also comes with a sample playbook file.</p>
</li>
<li>
<p>The most important part of this file is the <strong>vars:</strong> section, which defines the variables that should be applied by SELinux.</p>
</li>
</ul>
<p>Variable Definition in the SELinux System Role:</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yml" data-lang="yml"><span style="display:flex;"><span>    ---
</span></span><span style="display:flex;"><span>    - <span style="color:#ff6ac1">hosts</span>: all
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">become</span>: <span style="color:#ff6ac1">true</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">become_method</span>: sudo
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">become_user</span>: root
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">vars</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">selinux_policy</span>: targeted
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">selinux_state</span>: enforcing
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">selinux_booleans</span>:
</span></span><span style="display:flex;"><span>          - { <span style="color:#ff6ac1">name: â€™samba_enable_home_dirsâ€™, state</span>: â€™onâ€™ }
</span></span><span style="display:flex;"><span>          - { <span style="color:#ff6ac1">name: â€™ssh_sysadm_loginâ€™, state: â€™onâ€™, persistent</span>: â€™yesâ€™ }
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">selinux_fcontexts</span>:
</span></span><span style="display:flex;"><span>          - { <span style="color:#ff6ac1">target: â€™/tmp/test_dir(/.*)?â€™, setype: â€™user_home_dir_tâ€™, ftype</span>: â€™dâ€™ }
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">selinux_restore_dirs</span>:
</span></span><span style="display:flex;"><span>          - /tmp/test_dir
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">selinux_ports</span>:
</span></span><span style="display:flex;"><span>          - { <span style="color:#ff6ac1">ports: â€™22100â€™, proto: â€™tcpâ€™, setype: â€™ssh_port_tâ€™, state</span>: â€™presentâ€™ }
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">selinux_logins</span>:
</span></span><span style="display:flex;"><span>          - { <span style="color:#ff6ac1">login: â€™sar-userâ€™, seuser: â€™staff_uâ€™, serange: â€™s0-s0:c0.c1023â€™, state</span>: â€™presentâ€™ }</span></span></code></pre></div>
<p>SELinux Variables Overview</p>
<p><strong>selinux_policy</strong></p>
<ul>
<li>
<p>Policy to use, usually set to targeted
<strong>selinux_state</strong></p>
</li>
<li>
<p>SELinux state, as managed with setenforce
<strong>selinux_booleans</strong></p>
</li>
<li>
<p>List of Booleans that need to be set
<strong>selinux_fcontext</strong></p>
</li>
<li>
<p>List of file contexts that need to be set, including the target file or directory to which they should be applied.
<strong>selinux_restore_dir</strong></p>
</li>
<li>
<p>List of directories at which the Linux restorecon command needs to be executed to apply new context.
<strong>selinux_ports</strong></p>
</li>
<li>
<p>List of ports and SELinux port types
<strong>selinux_logins</strong></p>
</li>
<li>
<p>A list of SELinux user and roles that can be created</p>
</li>
<li>
<p>Most of the time while configuring SELinux, you need to apply the correct state as well as file context.</p>
</li>
<li>
<p>To set the appropriate file context, you first need to define the <strong>selinux_fcontext</strong> variable.</p>
</li>
<li>
<p>Next, you have to define <strong>selinux_restore_dirs</strong> also to ensure that the desired context is applied correctly.</p>
</li>
</ul>
<h3 id="lab-sets-the-httpd_-context-type-to-the-web-directory">Lab: Sets the <strong>httpd_sys_content_t</strong> context type to the <strong>/web</strong> directory.</h3>
<ul>
<li>Sample doc is used and unnecessary lines are removed and the values of two variables have been set</li>
<li>When you use the RHEL SELinux System Role, some changes require the managed host to be rebooted.</li>
<li>To take care of this, a block structure is used, where the System Role runs in the block.</li>
<li>When a change that requires a reboot is applied, the SELinux System Role sets the variable <strong>selinux_reboot_required</strong> and fails.</li>
<li>As a result, the rescue section in the playbook is executed.</li>
<li>This rescue section first makes sure that the playbook fails because of the <strong>selinux_reboot_required</strong> variable being set to true.</li>
<li>If that is the case, the reboot module is called to reboot the managed host.</li>
<li>While rebooting, playbook execution waits for the rebooted host to reappear, and when that happens, the RHEL SELinux System Role is called again to complete its work.</li>
</ul>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yml" data-lang="yml"><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span>- <span style="color:#ff6ac1">hosts</span>: ansible2
</span></span><span style="display:flex;"><span>  <span style="color:#ff6ac1">vars</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">selinux_policy</span>: targeted
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">selinux_state</span>: enforcing
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">selinux_fcontexts</span>:
</span></span><span style="display:flex;"><span>      - { <span style="color:#ff6ac1">target: â€™/web(/.*)?â€™, setype: â€™httpd_sys_content_tâ€™, ftype</span>: â€™dâ€™ }
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">selinux_restore_dirs</span>:
</span></span><span style="display:flex;"><span>      - /web
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span><span style="color:#78787e"># prepare prerequisites which are used in this playbook</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff6ac1">tasks</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#ff6ac1">name</span>: Creates directory
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">file</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">path</span>: /web
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">state</span>: directory
</span></span><span style="display:flex;"><span>    - <span style="color:#ff6ac1">name</span>: execute the role and catch errors
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">block</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#ff6ac1">include_role</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#ff6ac1">name</span>: rhel-system-roles.selinux
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">rescue</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#78787e"># Fail if failed for a different reason than selinux_reboot_required.</span>
</span></span><span style="display:flex;"><span>            - <span style="color:#ff6ac1">name</span>: handle errors
</span></span><span style="display:flex;"><span>              <span style="color:#ff6ac1">fail</span>:
</span></span><span style="display:flex;"><span>                <span style="color:#ff6ac1">msg</span>: <span style="color:#5af78e">&#34;role failed&#34;</span>
</span></span><span style="display:flex;"><span>              <span style="color:#ff6ac1">when</span>: not selinux_reboot_required
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>            - <span style="color:#ff6ac1">name</span>: restart managed host
</span></span><span style="display:flex;"><span>              <span style="color:#ff6ac1">shell</span>: sleep 2 &amp;&amp; shutdown -r now &#34;Ansible updates triggered&#34;
</span></span><span style="display:flex;"><span>              <span style="color:#ff6ac1">async</span>: <span style="color:#ff9f43">1</span>
</span></span><span style="display:flex;"><span>              <span style="color:#ff6ac1">poll</span>: <span style="color:#ff9f43">0</span>
</span></span><span style="display:flex;"><span>              <span style="color:#ff6ac1">ignore_errors</span>: <span style="color:#ff6ac1">true</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>            - <span style="color:#ff6ac1">name</span>: wait for managed host to come back
</span></span><span style="display:flex;"><span>              <span style="color:#ff6ac1">wait_for_connection</span>:
</span></span><span style="display:flex;"><span>                <span style="color:#ff6ac1">delay</span>: <span style="color:#ff9f43">10</span>
</span></span><span style="display:flex;"><span>                <span style="color:#ff6ac1">timeout</span>: <span style="color:#ff9f43">300</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>            - <span style="color:#ff6ac1">name</span>: reapply the role
</span></span><span style="display:flex;"><span>              <span style="color:#ff6ac1">include_role</span>:
</span></span><span style="display:flex;"><span>                <span style="color:#ff6ac1">name</span>: rhel-system-roles.selinux</span></span></code></pre></div>
<h4 id="using-the-rhel-timesync-system-role">Using the RHEL TimeSync System Role</h4>
<p><strong>timesync_ntp_servers</strong> variable</p>
<ul>
<li>
<p>most important setting</p>
</li>
<li>
<p>specifies attributes to indicate which time servers should be used.</p>
</li>
<li>
<p>The <strong>hostname</strong> attribute identifies the name of IP address of the time server.</p>
</li>
<li>
<p>The <strong>iburst</strong> option is used to enable or disable fast initial time synchronization using the <strong>timesync_ntp_servers</strong> variable.</p>
</li>
<li>
<p>The System Role finds out which version of RHEL is used, and according to the currently used version, it either configures NTP or Chronyd.</p>
</li>
</ul>
<h3 id="lab-using-an-rhel-system-role-to-manage-time-synchronization">Lab: Using an RHEL System Role to Manage Time Synchronization</h3>
<p>1. Copy the sample timesync playbook to the current directory:
<code>cp /usr/share/doc/rhel-system-roles/timesync/example-single-pool-playbook.yml timesync.yaml</code></p>
<p>2. Add the target host, NTP hostname pool.ntp.org, and remove pool true in the file timesync.yaml:</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span>- <span style="color:#ff6ac1">name</span>: Configure NTP
</span></span><span style="display:flex;"><span>  <span style="color:#ff6ac1">hosts</span>: <span style="color:#5af78e">&#34;{{ host }}&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff6ac1">vars</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">timesync_ntp_servers</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#ff6ac1">hostname</span>: pool.ntp.org
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">iburst</span>: <span style="color:#ff6ac1">true</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff6ac1">roles</span>:
</span></span><span style="display:flex;"><span>    - rhel-system-roles.timesync</span></span></code></pre></div>
<p>3. Add the timezone module and the <strong>timezone</strong> variable to the playbook to set the timezone as well. The complete playbook should look like the following:</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yml" data-lang="yml"><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span>- <span style="color:#ff6ac1">hosts</span>: ansible2
</span></span><span style="display:flex;"><span>  <span style="color:#ff6ac1">vars</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">timesync_ntp_servers</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#ff6ac1">hostname</span>: pool.ntp.org
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">iburst</span>: <span style="color:#ff6ac1">yes</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">timezone</span>: UTC
</span></span><span style="display:flex;"><span>  <span style="color:#ff6ac1">roles</span>:
</span></span><span style="display:flex;"><span>  - rhel-system-roles.timesync
</span></span><span style="display:flex;"><span>  <span style="color:#ff6ac1">tasks</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ff6ac1">name</span>: set timezone
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">timezone</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">name</span>: <span style="color:#5af78e">&#34;{{ timezone }}&#34;</span></span></span></code></pre></div>
<p>4. Use <code>ansible-playbook timesync.yaml</code> to run the playbook. Observe its output. Notice that some messages in red are shown, but these can safely be ignored.</p>
<p>5. Use <code>ansible ansible2 -a &quot;timedatectl show&quot;</code> and notice that the <strong>timezone</strong> variable is set to UTC.</p>

  <footer class="footline">
  </footer>
</article>
          </section>
<article class="default">
  <header class="headline">
  </header>

<h1 id="storage">Storage</h1>

<div class="children children-type-card children-sort-"><ul class="card-container">
<li>
  <article class="card card-popout" aria-labelledby="R-card-d13c51518915b53ebe0de34724fa202c">
    <div class="card-content">
      <div class="card-title" id="R-card-d13c51518915b53ebe0de34724fa202c">
        <a href="/ansible/storage/configuring-storage-advanced-exercise/">
        Configuring Storage Advanced Exercise
        </a>
      </div>
      <div class="card-content-text">
          <!-- raw HTML omitted -->

      </div>
    </div>
  </article>
</li>
<li>
  <article class="card card-popout" aria-labelledby="R-card-bfa03f180ddc6d9800338159481ea0d2">
    <div class="card-content">
      <div class="card-title" id="R-card-bfa03f180ddc6d9800338159481ea0d2">
        <a href="/ansible/storage/discovering-storage-related-facts/">
        Discovering storage related facts
        </a>
      </div>
      <div class="card-content-text">
          <!-- raw HTML omitted -->

      </div>
    </div>
  </article>
</li>
<li>
  <article class="card card-popout" aria-labelledby="R-card-65a5c52b45d73f711e23bdc68ff33ba5">
    <div class="card-content">
      <div class="card-title" id="R-card-65a5c52b45d73f711e23bdc68ff33ba5">
        <a href="/ansible/storage/managing-partitions-and-lvm/">
        Managing Partitions and LVM
        </a>
      </div>
      <div class="card-content-text">
          <!-- raw HTML omitted -->

      </div>
    </div>
  </article>
</li>
<li>
  <article class="card card-popout" aria-labelledby="R-card-353dd4376db37870191dc176994936d5">
    <div class="card-content">
      <div class="card-title" id="R-card-353dd4376db37870191dc176994936d5">
        <a href="/ansible/storage/nfs-setup/">
        NFS Setup
        </a>
      </div>
      <div class="card-content-text">
          <!-- raw HTML omitted -->

      </div>
    </div>
  </article>
</li>
</ul>
</div>

  <footer class="footline">
  </footer>
</article>
          <section>
            <h1 class="a11y-only">Subsections of Storage</h1>
<article class="default">
  <header class="headline">
  </header>

<h1 id="configuring-storage-advanced-exercise">Configuring Storage Advanced Exercise</h1>

<h3 id="configuring-storage-advanced-exercise">Configuring Storage Advanced Exercise</h3>
<p>To work on this exercise, you need managed machines with an additional disk device: add
a 10 GB second disk to host ansible2 and a 5 GB second disk to host ansible3. The exercise assumes the name of the second disk is /dev/sdb; if a different disk name is used in your configuration, change this according to your specifications.</p>
<p><strong>Exercise 15-3 Setting Up an Advanced Storage Solution</strong></p>
<p>In this exercise you need to set up a storage solution that meets the
following requirements:</p>
<p>â€¢ Tasks in this playbook should be executed only on hosts where the device /dev/sdb exists.</p>
<p>â€¢ If no device /dev/sdb exists, the playbook should print &ldquo;device sdb not present&rdquo; and stop executing tasks on that host.</p>
<p>â€¢ Configure the device with one partition that includes all available disk space.</p>
<p>â€¢ Create an LVM volume group with the name vgfiles.</p>
<p>â€¢ If the volume group is bigger than 5 GB, create an LVM logical volume with the name lvfiles and a size of 6 GB. Note that you must check the LVM volume group size and not the /dev/sdb1 size because in theory you could have multiple block devices in a volume group.</p>
<p>â€¢ If the volume group is equal to or smaller than 5 GB, create an LVM logical volume with the name lvfiles and a size of 3 GB.</p>
<p>â€¢ Format the volume with the XFS file system.</p>
<p>â€¢ Mount it on the /files directory.</p>
<p>1. Check the size of the volume group. You can, however, write a test that works on a default volume group, and that is what you&rsquo;re going to do first, using the name of the default volume group on CentOS 8, which is &ldquo;cl&rdquo;. The purpose is to test the constructions, which is why it doesn&rsquo;t really matter that the two tasks have overlapping <strong>when</strong> statements. So create a file with the name exercise153-dev1.yaml and give it the following contents:</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0"><code class="language-pre1" data-lang="pre1">---
- name: get vg sizes
  hosts: all
  tasks:
  - name: find small vgroup sizes
    debug:
      msg: volume group smaller than or equal to 20G
    when:
    - ansible_facts[â€™lvmâ€™][â€™vgsâ€™][â€™clâ€™] is defined
    - ansible_facts[â€™lvmâ€™][â€™vgsâ€™][â€™clâ€™][â€™size_gâ€™] &lt;= 20.00
  - name: find large vgroup size
    debug:
      msg: volume group larger than or equal to 19G
    when:
    - ansible_facts[â€™lvmâ€™][â€™vgsâ€™][â€™clâ€™] is defined
    - ansible_facts[â€™lvmâ€™][â€™vgsâ€™][â€™clâ€™][â€™size_gâ€™] &gt;= 19.00</code></pre></div>
<p>2. Run the playbook by using <strong>ansible-playbook
exercise153-dev1.yaml</strong>. You&rsquo;ll notice that it fails with the error
shown in <a href="/ansible/storage/configuring-storage-advanced-exercise/#ch15.xhtml#list15_12">Listing 15-12</a>.</p>
<p><strong>Listing 15-12 exercise153-dev1.yaml</strong> Failure Message</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0"><code>TASK [find small vgroups sizes] ***************************************************
fatal: [ansible1]: FAILED! =&gt; \{\&#34;msg&#34;: &#34;The conditional check â€™ansible_facts[â€™lvmâ€™][â€™vgsâ€™][â€™clâ€™][â€™size_gâ€™] \\&lt;= 20.00â€™ failed. The error was: Unexpected templating type error occurred on ({% if ansible_facts[â€™lvmâ€™][â€™vgsâ€™][â€™clâ€™][â€™size_gâ€™] &lt;= 20.00 %} True {% else %} False {% endif %}): â€™&lt;=â€™ not supported between instances of â€™AnsibleUnsafeTextâ€™ and â€™floatâ€™\n\nThe error appears to be in â€™/home/ansible/rhce8-book/exercise153-dev1.yamlâ€™: line 5, column 5, but may\nbe elsewhere in the file depending on the exact syntax problem.\n\nThe offending line appears to be:\n\n  tasks:\n  - name: find small vgroups sizes\n    ^ here\n&#34;}
fatal: [ansible2]: FAILED! =&gt; {&#34;msg&#34;: &#34;The conditional check â€™ansible_facts[â€™lvmâ€™][â€™vgsâ€™][â€™clâ€™][â€™size_gâ€™] &lt;= 20.00â€™ failed. The error was: Unexpected templating type error occurred on ({% if ansible_facts[â€™lvmâ€™][â€™vgsâ€™][â€™clâ€™][â€™size_gâ€™] &lt;= 20.00 %} True {% else %} False {% endif %}): â€™&lt;=â€™ not supported between instances of â€™AnsibleUnsafeTextâ€™ and â€™floatâ€™\n\nThe error appears to be in â€™/home/ansible/rhce8-book/exercise153-dev1.yamlâ€™: line 5, column 5, but may\nbe elsewhere in the file depending on the exact syntax problem.\n\nThe offending line appears to be:\n\n  tasks:\n  - name: find small vgroups sizes\n    ^ here\n&#34;}
fatal: [ansible3]: FAILED! =&gt; {&#34;msg&#34;: &#34;The conditional check â€™ansible_facts[â€™lvmâ€™][â€™vgsâ€™][â€™clâ€™][â€™size_gâ€™] &lt;= 20.00â€™ failed. The error was: Unexpected templating type error occurred on ({% if ansible_facts[â€™lvmâ€™][â€™vgsâ€™][â€™clâ€™][â€™size_gâ€™] &lt;= 20.00 %} True {% else %} False {% endif %}): â€™&lt;=â€™ not supported between instances of â€™AnsibleUnsafeTextâ€™ and â€™floatâ€™\n\nThe error appears to be in â€™/home/ansible/rhce8-book/exercise153-dev1.yamlâ€™: line 5, column 5, but may\nbe elsewhere in the file depending on the exact syntax problem.\n\nThe offending line appears to be:\n\n  tasks:\n  - name: find small vgroups sizes\n    ^ here\n&#34;}
fatal: [ansible4]: FAILED! =&gt; {&#34;msg&#34;: &#34;The conditional check â€™ansible_facts[â€™lvmâ€™][â€™vgsâ€™][â€™clâ€™][â€™size_gâ€™] &lt;= 20.00â€™ failed. The error was: Unexpected templating type error occurred on ({% if ansible_facts[â€™lvmâ€™][â€™vgsâ€™][â€™clâ€™][â€™size_gâ€™] &lt;= 20.00 %} True {% else %} False {% endif %}): â€™&lt;=â€™ not supported between instances of â€™AnsibleUnsafeTextâ€™ and â€™floatâ€™\n\nThe error appears to be in â€™/home/ansible/rhce8-book/exercise153-dev1.yamlâ€™: line 5, column 5, but may\nbe elsewhere in the file depending on the exact syntax problem.\n\nThe offending line appears to be:\n\n  tasks:\n  - name: find small vgroups sizes\n    ^ here\n&#34;}
skipping: [ansible5]
skipping: [ansible6]

TASK [find large vgroups sizes] ***************************************************
skipping: [ansible5]
skipping: [ansible6]</code></pre></div>
<p>:::</p>
<p>3. As you can see in the errors in <a href="/ansible/storage/configuring-storage-advanced-exercise/#ch15.xhtml#list15_12">Listing
15-12</a>, there are two problems in the playbook.
The first problem is that there is no <strong>ignore_errors</strong> in the failing
play, which means that only hosts that haven&rsquo;t failed will reach the
next task. The second error is the &ldquo;Unexpected templating error&rdquo;. The
playbook in its current form is trying to perform a logical test to
compare the value of two variables that have an incompatible variable
type. The Ansible fact has the type &ldquo;AnsibleUnsafeText&rdquo;, and the value
of 20.00 is a float, not an integer. To make this test work, you must
force the type of both variables to be set to an integer. Now write
<strong>exercise153-dev2.yaml</strong> where this is happening; notice the use of the
filter <strong>int</strong>, which is essential for the success of this playbook:</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0"><code class="language-pre1" data-lang="pre1">---
- name: get vg sizes
  ignore_errors: yes
  hosts: all
  tasks:
  - name: set vgroup sizes in variables
    set_fact:
      vgsize: &#34;{{ ansible_facts[â€™lvmâ€™][â€™vgsâ€™][â€™clâ€™][â€™size_gâ€™] | int }}&#34;
  - name: debug this
    debug:
      msg: the value of vgsize is {{ vgsize }}
  - name: testing big vgsize value
    debug:
      msg: the value of vgsize is bigger than 5
    when: vgsize | int &gt; 5
  - name: testing small vgsize value
    debug:
      msg: the value of vgsize is smaller than 5
    when: vgsize | int &lt;= 5</code></pre></div>
<p>4. Run this playbook. You&rsquo;ll notice it skips and ignores some tasks but
doesn&rsquo;t fail anywhere, which means that this playbook&mdash;although
absolutely not perfect&mdash;is usable as an example to test the size of the
vgfiles volume group later in this exercise.</p>
<p>5. Now that you&rsquo;ve tested the most complex part of the assignment, you
can start writing the rest of the playbook. Do this in a new file with
the name exercise153.yaml. Because this playbook has quite a few tasks
to accomplish, it might be smart to define the rough structure and
ensure that all elements that are needed later are at least documented
so that you can later work out the details. So let&rsquo;s start with the
first part, where the play header is defined, as well as the rough
structure. This is the part where you still have the global overview of
all the tasks in this requirement, so you need to make sure you won&rsquo;t
forget about them later, which is a real risk if you&rsquo;ve been into the
details too much for too long.</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0"><code class="language-pre1" data-lang="pre1">---
- name: set up hosts that have an sdb device
  hosts: all
  tasks:
  - name: getting out with a nice failure message if there is no second disk
    # fail:
    debug:
      msg: write a nice failure message and a when test here
    # when: something
  - name: create a partition
    #parted
    debug:
      msg: creating the partition
  - name: create a volume group
    #lvg:
    debug:
      msg: creating the volume group
  - name: get the vg size and store it in a variable
    #set_fact:
    debug:
      msg: storing variable as an integer
  - name: create an LVM on big volume groups
    #lvol:
    debug:
      msg: use when statement to create 6g lvol if vsize &gt; 5
  - name: create an LVM on small volume groups
    #lvol:
    debug:
      msg: use when statement to create 3g lvol if vsize &lt;= 5
  - name: formatting the XFS filesystem
    # filesystem
    debug:
      msg: creating the filesystem
  - name: mounting /dev/vgfiles/lvfiles
    # mount:
    debug:
      msg: mounting the volume</code></pre></div>
<p>6. The advantage of a generic structure like the one you just defined
is that you can run a test at any moment. Now it&rsquo;s time to fill it in.
Start with the play header and then check whether /dev/sdb is present on
the managed system:</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0"><code class="language-pre1" data-lang="pre1">---
- name: setup up hosts that have an sdb device
  hosts: all
  tasks:
  - name: getting out with a nice failure message if there is no second disk
    fail:
      msg: there is no second disk
    when: ansible_facts[â€™devicesâ€™][â€™sdbâ€™] is not defined</code></pre></div>
<p>7. At this point I recommend you run a test to see that the playbook
really does skip all hosts that don&rsquo;t have a second disk device. Use
<strong>ansible-playbook exercise153.yaml</strong> to do so and observe that you see
a lot of skipping messages in the output.</p>
<p>8. If all is well so far, you can continue to create the partition and
create the logical volume group as well. Here are the tasks you need to
enter. Notice that no size is specified at any point, which means that
the partition and the volume group will be allowed to grow up to the
maximum size.</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0"><code class="language-pre1" data-lang="pre1">- name: create a partition
  parted:
    device: /dev/sdb
    number: 1
    state: present
- name: create a volume group
  lvg:
    pvs: /dev/sdb1
    vg: vgfiles</code></pre></div>
<p>9. At this point you can insert the part where you save the volume
group size into a variable, which can be used in the <strong>when</strong> statement
that will occur in one of the next tasks. Also, because it&rsquo;s good to
check a lot while you are writing a complex playbook, use the debug
module to verify the results.</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0"><code class="language-pre1" data-lang="pre1">- name: get vg size and convert to integer in new variable
  set_fact:
    vgsize: &#34;{{ ansible_facts[â€™lvmâ€™][â€™vgsâ€™][â€™vgfilesâ€™][â€™size_gâ€™] | int }}&#34;
- name: show vgsize value
  debug:
    var: &#34;{{ vgsize }}&#34;</code></pre></div>
<p>10. After this important step, it&rsquo;s time to run a test. If you need it,
you can find a sample playbook of the state so far named
exercise153-step9.yaml in the GitHub repository at
<a href="https://github.com/sandervanvugt/rhce8-book" rel="external" target="_blank">https://github.com/sandervanvugt/rhce8-book</a>, but it&rsquo;s obviously much
better and recommended to run your own code! So use <strong>ansible-playbook
exercise153.yaml</strong> to verify what you&rsquo;ve got so far. Notice that you
<em>must</em> make sure to run it on hosts that don&rsquo;t have any configuration
yet. If a configuration already exists, that will most likely give you
false positives! If you want to make sure all is clean, use <strong>ansible
all -a &ldquo;dd if=/dev/zero of=/dev/sdb bs=1M count=10&rdquo;</strong> to wipe the
/dev/sdb devices on your managed hosts, followed by <strong>ansible all -m
reboot</strong> to reboot all of them before you test. The purpose of all this
is that at this point you see the error message shown in <a href="/ansible/storage/configuring-storage-advanced-exercise/#ch15.xhtml#list15_13">Listing
15-13</a>. Before moving on to the next step, try to
understand what is going wrong.</p>
<p><strong>Listing 15-13</strong> Error Message After <a href="/ansible/storage/configuring-storage-advanced-exercise/#ch15.xhtml#exe15_3">Exercise
15-3</a> Step 10</p>
<p>::: pre_1</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0"><code class="language-pre1" data-lang="pre1">TASK [get vg size and convert to integer in new variable] ******************************
fatal: [ansible2]: FAILED! =&gt; {&#34;msg&#34;: &#34;The task includes an option with an undefined variable. The error was: â€™dict objectâ€™ has no attribute â€™vgfilesâ€™\n\nThe error appears to be in â€™/home/ansible/rhce8-book/exercise153-step9.yamlâ€™: line 18, column 5, but may\nbe elsewhere in the file depending on the exact syntax problem.\n\nThe offending line appears to be:\n\n      vg: vgfiles\n  - name: get vg size and convert to integer in new variable\n    ^ here\n&#34;}
fatal: [ansible3]: FAILED! =&gt; {&#34;msg&#34;: &#34;The task includes an option with an undefined variable. The error was: â€™dict objectâ€™ has no attribute â€™vgfilesâ€™\n\nThe error appears to be in â€™/home/ansible/rhce8-book/exercise153-step9.yamlâ€™: line 18, column 5, but may\nbe elsewhere in the file depending on the exact syntax problem.\n\nThe offending line appears to be:\n\n      vg: vgfiles\n  - name: get vg size and convert to integer in new variable\n    ^ here\n&#34;}</code></pre></div>
<p>:::</p>
<p>11. As you can see, the variable that you are trying to use has no
value yet. And that is for the simple reason that fact gathering is
required to set the variable, and fact gathering is happening at the
beginning of the playbook. At this point, you need to add a task that
runs the setup module right after creating the volume group, and then
you can try again. In the output you have to look at the [show vgsize
value] task, which should look all right now, and everything after that
can be ignored. See exercise153-step11.yaml in the GitHub repository if
you need the complete example.</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0"><code class="language-pre1" data-lang="pre1"># skipping first part of the playbook in this listing
- name: create a volume group
  lvg:
    pvs: /dev/sdb1
    vg: vgfiles
- name: run the setup module so that we can use updated facts
  setup:
- name: get vg size and convert to integer in new variable
  set_fact:
    vgsize: &#34;{{ ansible_facts[â€™lvmâ€™][â€™vgsâ€™][â€™vgfilesâ€™][â€™size_gâ€™] | int }}&#34;
- name: show vgsize value
  debug:
    var: &#34;{{ vgsize }}&#34;</code></pre></div>
<p>12. Assuming that all went well, you can now add the two conditional
tests, where according to the <strong>vgsize</strong> value, the lvol module is used
to create the logical volumes:</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0"><code class="language-pre1" data-lang="pre1">- name: create an LVM on big volume groups
  lvol:
    vg: vgfiles
    lv: lvfiles
    size: 6g
  when: vgsize | int &gt; 5
- name: create an LVM on small volume groups
  lvol:
    vg: vgfiles
    lv: lvfiles
    size: 3g
  when: vgsize | int &lt;= 5</code></pre></div>
<p>13. Add the tasks to format the volumes with the XFS file system and
mount them:</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0"><code class="language-pre1" data-lang="pre1">- name: formatting the XFS filesystem
  filesystem:
    dev: /dev/vgfiles/lvfiles
    fstype: xfs
- name: mounting /dev/vgfile/lvfiles
  mount:
    path: /file
    state: mounted
    src: /dev/vgfiles/lvfiles
    fstype: xfs</code></pre></div>
<p>14. That&rsquo;s all! The playbook is now ready for use. Run it by using
<strong>ansible-playbook exercise153.yaml</strong> and verify its output.</p>
<p>15. Use the ad hoc command <strong>ansible ansible2,ansible3 -a &ldquo;lvs&rdquo;</strong> to
show LVM logical volume sizes on the machines with the additional hard
drive. You should see that all has worked out well and you are done!
:::</p>

  <footer class="footline">
  </footer>
</article>
<article class="default">
  <header class="headline">
  </header>

<h1 id="discovering-storage-related-facts">Discovering storage related facts</h1>

<p><strong>Table 15-2</strong> Modules for Managing Storage</p>
<p><a href="#R-image-b43666dc1444e2eb2d6f5254a0b4c28b" class="lightbox-link"><img alt="Image" class="lazy lightbox figure-image" loading="lazy" src="/Images/15tab02.jpg" style="height: auto;width: auto;"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-b43666dc1444e2eb2d6f5254a0b4c28b"><img alt="Image" class="lazy lightbox lightbox-image" loading="lazy" src="/Images/15tab02.jpg"></a></p>
<p>To make sure that your playbook is applied to the right devices, you first need to find which devices are available on your managed system.</p>
<p>After you find them, you can use conditionals to make sure that tasks are executed on the right devices.</p>
<h4 id="using-storage-related-facts">Using Storage-Related Facts</h4>
<p>Ansible_facts related to storage</p>
<p>ansible_devices</p>
<ul>
<li>Available storage and device info
ansible_device_links</li>
<li>info on how to access storage and other device info
ansible_mounts</li>
<li>Mount point info</li>
</ul>
<p><code>ansible ansible1 -m setup -a 'filter=ansible_devices'</code></p>
<ul>
<li>
<p>Find generic information about storage devices.</p>
</li>
<li>
<p>The <strong>filter</strong> argument to the setup module uses a shell-style wildcard to search for matching items and for that reason can search in the highest level facts, such as <strong>ansible_devices</strong>, but it is incapable of further specifying what is searched for. For that reason, in the <strong>filter</strong> argument to the setup module, you cannot use a construction like <code>ansible ansible1 -m setup -a &quot;filter=ansible_devices.sda&quot;</code> which is common when looking up the variable in conditional statements.</p>
</li>
</ul>
<h4 id="using-storage-related-facts-in-conditional-statements">Using Storage-Related Facts in Conditional Statements</h4>
<p>Assert module</p>
<ul>
<li>show an error message if a device does not exist and to perform a task if the device exists.</li>
<li>For an easier solution, you can also use a <strong>when</strong> statement to look for the existence of a device.</li>
<li>The advantage of using the assert module is that an error message can be printed if the condition is not met.</li>
</ul>
<p><strong>Listing 15-2</strong> Using assert to Run a Task Only If a Device Exists</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yml" data-lang="yml"><span style="display:flex;"><span>    ---
</span></span><span style="display:flex;"><span>    - <span style="color:#ff6ac1">name</span>: search for /dev/sdb continue only if it is found
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">hosts</span>: all
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">vars</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">disk_name</span>: sdb
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">tasks</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#ff6ac1">name</span>: abort if second disk does not exist
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">assert</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#ff6ac1">that</span>:
</span></span><span style="display:flex;"><span>            - <span style="color:#5af78e">&#34;ansible_facts[&#39;devices&#39;][&#39;{{ disk_name }}&#39;] is defined&#34;</span>
</span></span><span style="display:flex;"><span>          <span style="color:#ff6ac1">fail_msg</span>: second hard disk not found
</span></span><span style="display:flex;"><span>      - <span style="color:#ff6ac1">debug</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#ff6ac1">msg</span>: <span style="color:#5af78e">&#34;{{ disk_name }} was found, lets continue&#34;</span></span></span></code></pre></div>
<p>Write a playbook that finds out the name of the disk device and puts that in a variable that you can work with further on in the playbook.</p>
<p>The <strong>set_fact</strong> argument comes in handy to do so.</p>
<p>You can use it in combination with a <strong>when</strong> conditional statement to store a detected device name in a variable.</p>
<p>Storing the Detected Disk Device Name in a Variable</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>    ---
</span></span><span style="display:flex;"><span>    - <span style="color:#ff6ac1">name</span>: define variable according to diskname detected
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">hosts</span>: all
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">tasks</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#ff6ac1">ignore_errors</span>: <span style="color:#ff6ac1">yes</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">set_fact</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#ff6ac1">disk2name</span>: sdb
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">when</span>: ansible_facts[â€™devicesâ€™][â€™sdbâ€™]</span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>  - <span style="color:#ff6ac1">name</span>: Detect secondary disk name
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">ignore_errors</span>: <span style="color:#ff6ac1">yes</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">set_fact</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">disk2name</span>: vda
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">when</span>: ansible_facts[&#39;devices&#39;][&#39;vda&#39;] is defined
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  - <span style="color:#ff6ac1">name</span>: Search for second disk, continue only if it is found
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">assert</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">that</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#5af78e">&#34;ansible_facts[&#39;devices&#39;][disk2name] is defined&#34;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">fail_msg</span>: second hard disk not found
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  - <span style="color:#ff6ac1">name</span>: Debug detected disk
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">debug</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">msg</span>: <span style="color:#5af78e">&#34;{{ disk2name }} was found. Moving forward.&#34;</span>
</span></span><span style="display:flex;"><span>~                                                      </span></span></code></pre></div>
<p>Next, see <a href="/ansible/storage/managing-partitions-and-lvm/">Managing Partitions and LVM</a></p>

  <footer class="footline">
  </footer>
</article>
<article class="default">
  <header class="headline">
  </header>

<h1 id="managing-partitions-and-lvm">Managing Partitions and LVM</h1>

<h3 id="managing-partitions-and-lvm">Managing Partitions and LVM</h3>
<p>After detecting the disk device that needs to be used, you can move on and start creating partitions and logical volumes.</p>
<ul>
<li>partition a disk using the parted module,</li>
<li>work with the lvg and lvol modules to manage LVM logical volumes,</li>
<li>create file systems using the filesystem module and mount them using the mount module</li>
<li>manage swap storage.</li>
</ul>
<h4 id="creating-partitions">Creating Partitions</h4>
<p><strong>Parted Module</strong>
name:</p>
<ul>
<li>Assign unique name, required for GPT partitions
label:</li>
<li>type of partition table, msdos is default, gpt for gpt
device:</li>
<li>Device where you are creating partition
number:</li>
<li>partition number
state:</li>
<li>present or absent to add/remove</li>
</ul>
<p>part_start:</p>
<ul>
<li>Starting position expressed as an offset from the beginning of the disk
part_end:</li>
<li>Where to end the partition
If these arguments are not used, the partition starts at 0% and ends at 100% of
the available disk space.</li>
</ul>
<p>flags:</p>
<ul>
<li>Set specific partition properties such as LVM partition type.</li>
<li>Required for LVM partition type</li>
</ul>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>      - <span style="color:#ff6ac1">name</span>: create new partition
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">parted</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#ff6ac1">name</span>: files
</span></span><span style="display:flex;"><span>          <span style="color:#ff6ac1">label</span>: gpt
</span></span><span style="display:flex;"><span>          <span style="color:#ff6ac1">device</span>: /dev/sdb
</span></span><span style="display:flex;"><span>          <span style="color:#ff6ac1">number</span>: <span style="color:#ff9f43">1</span>
</span></span><span style="display:flex;"><span>          <span style="color:#ff6ac1">state</span>: present
</span></span><span style="display:flex;"><span>          <span style="color:#ff6ac1">part_start</span>: 1MiB
</span></span><span style="display:flex;"><span>          <span style="color:#ff6ac1">part_end</span>: 2GiB
</span></span><span style="display:flex;"><span>      - <span style="color:#ff6ac1">name</span>: create another new partition
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">parted</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#ff6ac1">name</span>: swap
</span></span><span style="display:flex;"><span>          <span style="color:#ff6ac1">label</span>: gpt
</span></span><span style="display:flex;"><span>          <span style="color:#ff6ac1">device</span>: /dev/sdb
</span></span><span style="display:flex;"><span>          <span style="color:#ff6ac1">number</span>: <span style="color:#ff9f43">2</span>
</span></span><span style="display:flex;"><span>          <span style="color:#ff6ac1">state</span>: present
</span></span><span style="display:flex;"><span>          <span style="color:#ff6ac1">part_start</span>: 2GiB
</span></span><span style="display:flex;"><span>          <span style="color:#ff6ac1">part_end</span>: 4GiB
</span></span><span style="display:flex;"><span>          <span style="color:#ff6ac1">flags</span>: [ lvm ]</span></span></code></pre></div>
<h4 id="managing-volume-groups-and-lvm-logical-volumes">Managing Volume Groups and LVM Logical Volumes</h4>
<p><strong>lvg</strong> module</p>
<ul>
<li>manage LVM logical volumes</li>
<li>managing LVM volume groups</li>
</ul>
<p><strong>lvol</strong> module</p>
<ul>
<li>managing LVM logical volumes.</li>
</ul>
<p>Creating an LVM volume group</p>
<ul>
<li><strong>vg</strong> argument to set the name of the volume group</li>
<li><strong>pvs</strong> argument to identify the physical volume (which is often a partition or a disk device) on which the volume group needs to be created.</li>
<li>May need to specify the <strong>pesize</strong> to refer to the size of the physical extents.</li>
</ul>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>- <span style="color:#ff6ac1">name</span>: create a volume group
</span></span><span style="display:flex;"><span>  <span style="color:#ff6ac1">lvg</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">vg</span>: vgdata
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">pesize</span>: <span style="color:#5af78e">&#34;8&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">pvs</span>: /dev/sdb1</span></span></code></pre></div>
<p>After you create an LVM volume group, you can create LVM logical volumes.</p>
<p><strong>lvol</strong> Common Options:
lv</p>
<ul>
<li>Name of the LV
pvs</li>
<li>comma separated list of pvs, if it is a partition then it should have the lvm option set
resizefs</li>
<li>Indicates whether to resize filesystem when the lv is expanded
size</li>
<li>size of the lv
snapshot</li>
<li>specify name if this lv is a snapshot
vg</li>
<li>VG is which the lv should be created</li>
</ul>
<p>Creating an LVM Logical Volume</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>- <span style="color:#ff6ac1">name</span>: create a logical volume
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">lvol</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">lv</span>: lvdata
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">size</span>: <span style="color:#ff9f43">100</span>%FREE
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">vg</span>: vgdata</span></span></code></pre></div>
<h4 id="creating-and-mounting-file-systems">Creating and Mounting File Systems</h4>
<p><strong>filesystem</strong> module</p>
<ul>
<li>Supports creating as well as resizing file systems.</li>
</ul>
<p>Options:
dev</p>
<ul>
<li>block device name
fstype</li>
<li>filesystem type
opts</li>
<li>options passed to mkfs command
resizefs</li>
<li>Extends the filesystem if set to yes. Extended to the current block size</li>
</ul>
<p>Creating an XFS File System</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>- <span style="color:#ff6ac1">name</span>: create an XFS filesystem
</span></span><span style="display:flex;"><span>  <span style="color:#ff6ac1">filesystem</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">dev</span>: /dev/vgdata/lvdata
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">fstype</span>: xfs</span></span></code></pre></div>
<h3 id="mounting-a-filesystem">Mounting a filesystem</h3>
<p><strong>mount</strong> module.</p>
<ul>
<li>Used to mount a filesystem</li>
</ul>
<p>Options:
fstype</p>
<ul>
<li>Filesystem type is not automatically dedected.</li>
<li>Used to specify filesystem type
path</li>
<li>directory to mount the filesystem to
src</li>
<li>device to be mounted
state</li>
<li>Current mount state</li>
<li>mounted to mount device now</li>
<li>present to set in /etc/fstab but not mount it now</li>
</ul>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>      - <span style="color:#ff6ac1">name</span>: mount the filesystem
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">mount</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#ff6ac1">src</span>: /dev/vgdata/lvdata
</span></span><span style="display:flex;"><span>          <span style="color:#ff6ac1">fstype</span>: xfs
</span></span><span style="display:flex;"><span>          <span style="color:#ff6ac1">state</span>: mounted
</span></span><span style="display:flex;"><span>          <span style="color:#ff6ac1">path</span>: /mydir</span></span></code></pre></div>
<h4 id="configuring-swap-space">Configuring Swap Space</h4>
<ul>
<li>
<p>To set up swap space, you first must format a device as swap space and next mount the swap space.</p>
</li>
<li>
<p>To format a device as swap space, you use the filesystem module.</p>
</li>
<li>
<p>There is no specific Ansible module to activate theswap space, so you use the command module to run the Linux <strong>swapon</strong> command.</p>
</li>
<li>
<p>Because adding swap space is not always required, it can be done in a conditional statement.</p>
</li>
<li>
<p>In the statement, use the <strong>ansible_swaptotal_mb</strong> fact to discover how much swap is actually available.</p>
</li>
<li>
<p>If that amount falls below a specific threshold, the swap space can be created and activated.</p>
</li>
</ul>
<p>A conditional check is performed, and additional swap space is configured if the current
amount of swap space is lower than 256 MiB.</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>    ---
</span></span><span style="display:flex;"><span>    - <span style="color:#ff6ac1">name</span>: configure swap storage
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">hosts</span>: ansible2
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">tasks</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#ff6ac1">name</span>: setup swap
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">block</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#ff6ac1">name</span>: make the swap filesystem
</span></span><span style="display:flex;"><span>          <span style="color:#ff6ac1">filesystem</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#ff6ac1">fstype</span>: swap
</span></span><span style="display:flex;"><span>            <span style="color:#ff6ac1">dev</span>: /dev/sdb1
</span></span><span style="display:flex;"><span>        - <span style="color:#ff6ac1">name</span>: activate swap space
</span></span><span style="display:flex;"><span>          <span style="color:#ff6ac1">command</span>: swapon /dev/sdb1
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">when</span>: ansible_swaptotal_mb &lt; 256</span></span></code></pre></div>
<p>Run an ad hoc command to ensure that /dev/sdb on the target host is empty:</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>ansible ansible2 -a <span style="color:#5af78e">&#34;dd if=/dev/zero of=/dev/sdb bs=1M count=10&#34;</span></span></span></code></pre></div>
<p>To make sure that you don&rsquo;t get any errors about partitions that are in use, also reboot the target host:</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0"><code class="language-pre1" data-lang="pre1">ansible ansible2 -m reboot</code></pre></div>
<ul>
<li>Lack of idempotency if the size is specified as 100%FREE, which is a relative value, not an absolute value.</li>
<li>This value works the first time you run the playbook, but it does not the second time you run the playbook.</li>
<li>Because no free space is available, the LVM layer interprets the task as if you wanted to create a logical volume with a size of 0 MiB and will complain about that. To ensure that plays are written in an idempotent way, make sure that you use absolute values, not relative values.</li>
</ul>

  <footer class="footline">
  </footer>
</article>
<article class="default">
  <header class="headline">
  </header>

<h1 id="nfs-setup">NFS Setup</h1>

<p>Server hosting the storage:</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>--- 
</span></span><span style="display:flex;"><span>  - <span style="color:#ff6ac1">name</span>: Install Packages
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">package</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">name</span>:
</span></span><span style="display:flex;"><span>        - nfs-utils
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">state</span>: present
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  - <span style="color:#ff6ac1">name</span>: Ensure directories to export exist
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">file</span>:  <span style="color:#78787e"># noqa 208</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">path</span>: <span style="color:#5af78e">&#34;{{ item }}&#34;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">state</span>: directory
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">with_items</span>: <span style="color:#5af78e">&#34;{{ nfs_exports | map(&#39;split&#39;) | map(&#39;first&#39;) | unique }}&#34;</span>
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  - <span style="color:#ff6ac1">name</span>: Copy exports file
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">template</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">src</span>: exports.j2
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">dest</span>: /etc/exports
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">owner</span>: root
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">group</span>: root
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">mode</span>: <span style="color:#ff9f43">0644</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">notify</span>: reload nfs
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  - <span style="color:#ff6ac1">name</span>: Add firewall rule to enable NFS service
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">ansible.posix.firewalld</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">immediate</span>: <span style="color:#ff6ac1">true</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">state</span>: enabled
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">permanent</span>: <span style="color:#ff6ac1">true</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">service</span>: nfs
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">notify</span>: reload firewalld
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  - <span style="color:#ff6ac1">name</span>: Start and enable NFS service
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">service</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">name</span>: nfs-server
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">state</span>: started
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">enabled</span>: <span style="color:#ff6ac1">yes</span>
</span></span><span style="display:flex;"><span>     <span style="color:#ff6ac1">when</span>: nfs_exports|length &gt; 0
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  - <span style="color:#ff6ac1">name</span>: Set SELinux boolean for NFS
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">ansible.posix.seboolean</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">name</span>: nfs_export_all_rw
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">state</span>: <span style="color:#ff6ac1">yes</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">persistent</span>: <span style="color:#ff6ac1">yes</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  - <span style="color:#ff6ac1">name</span>: install required package for sefcontext module
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">yum</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">name</span>: policycoreutils-python-utils
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">state</span>: present
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  - <span style="color:#ff6ac1">name</span>: Set proper SELinux context on export dir
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">sefcontext</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">target</span>: /{{ item }}(/.*)?
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">setype</span>: nfs_t
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">state</span>: present
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">notify</span>: run restorecon
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">with_items</span>: <span style="color:#5af78e">&#34;{{ nfs_exports | map(&#39;split&#39;) | map(&#39;first&#39;) | unique }}&#34;</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0"><code class="language-j2" data-lang="j2">{% for host in nfs_hosts %}
/data {{ host }} (rw,wdelay,root_squash,no_subtree_check,sec=sys,rw,root_squash,no_all_squash)
{% endfor %}</code></pre></div>
<p>Variables:
nfs_exports:</p>
<ul>
<li>/data server(rw,wdelay,root_squash,no_subtree_check,sec=sys,rw,root_squash,no_all_squash)</li>
</ul>
<p>Handlers</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span>- <span style="color:#ff6ac1">name</span>: reload nfs
</span></span><span style="display:flex;"><span>  <span style="color:#ff6ac1">command</span>: <span style="color:#5af78e">&#39;exportfs -ra&#39;</span>
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>- <span style="color:#ff6ac1">name</span>: reload firewalld
</span></span><span style="display:flex;"><span>  <span style="color:#ff6ac1">command</span>: firewall-cmd --reload
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>- <span style="color:#ff6ac1">name</span>: run restorecon
</span></span><span style="display:flex;"><span>  <span style="color:#ff6ac1">command</span>: restorecon -Rv /codata</span></span></code></pre></div>
<p>storage:</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span> <span style="color:#ff6ac1">name</span>: Detect secondary disk name
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">ignore_errors</span>: <span style="color:#ff6ac1">yes</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">set_fact</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">disk2name</span>: vda
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">when</span>: ansible_facts[&#39;devices&#39;][&#39;vda&#39;] is defined
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  - <span style="color:#ff6ac1">name</span>: Search for second disk, continue only if it is found
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">assert</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">that</span>:
</span></span><span style="display:flex;"><span>        - disk2name is defined
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">fail_msg</span>: second hard disk not found
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  - <span style="color:#ff6ac1">name</span>: Debug detected disk
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">debug</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">msg</span>: <span style="color:#5af78e">&#34;{{ disk2name }} was found. Moving forward.&#34;</span>  
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  - <span style="color:#ff6ac1">name</span>: Create LVM and partitions
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">block</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#ff6ac1">name</span>: Create LVM Partition on second disk
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">parted</span>: 
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">name</span>: data
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">label</span>: gpt
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">device</span>: /dev/{{ disk2name }}
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">number</span>: <span style="color:#ff9f43">1</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">state</span>: present
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">flags</span>: [ lvm ]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    - <span style="color:#ff6ac1">name</span>: Create an LVM volume group
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">lvg</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">vg</span>: vgcodata
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">pvs</span>: /dev/{{ disk2name }}1
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    - <span style="color:#ff6ac1">name</span>: Create lv
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">lvol</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">lv</span>: lvdata
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">size</span>: <span style="color:#ff9f43">100</span>%FREE
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">vg</span>: vgdata
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    - <span style="color:#ff6ac1">name</span>: create filesystem
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">filesystem</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">dev</span>: /dev/vgdata/lvdata
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">fstype</span>: xfs
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">when</span>: ansible_facts[&#39;devices&#39;][&#39;vda&#39;][&#39;partitions&#39;] is not defined
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>  - <span style="color:#ff6ac1">name</span>: Create data directory
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">file</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">dest</span>: /data
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">mode</span>: <span style="color:#ff9f43">777</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">state</span>: directory
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>  - <span style="color:#ff6ac1">name</span>: Mount the filesystem
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">mount</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">src</span>: /dev/vgdata/lvdata
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">fstype</span>: xfs
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">state</span>: present
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">path</span>: /data
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  - <span style="color:#ff6ac1">name</span>: Set permissions on mounted filesystem
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">file</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">path</span>: /data
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">state</span>: directory
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">mode</span>: <span style="color:#5af78e">&#39;0777&#39;</span>
</span></span><span style="display:flex;"><span>    ```</span></span></code></pre></div>

  <footer class="footline">
  </footer>
</article>
          </section>
<article class="default">
  <header class="headline">
  </header>

<h1 id="task-control">Task Control</h1>

<div class="children children-type-card children-sort-"><ul class="card-container">
<li>
  <article class="card card-popout" aria-labelledby="R-card-47d59296e198328d05f6f1dbc4bc9f3d">
    <div class="card-content">
      <div class="card-title" id="R-card-47d59296e198328d05f6f1dbc4bc9f3d">
        <a href="/ansible/task-control/handlers/">
        Handlers
        </a>
      </div>
      <div class="card-content-text">
          <!-- raw HTML omitted -->

      </div>
    </div>
  </article>
</li>
<li>
  <article class="card card-popout" aria-labelledby="R-card-e5913e3293c0bd25b8000c9c797c4339">
    <div class="card-content">
      <div class="card-title" id="R-card-e5913e3293c0bd25b8000c9c797c4339">
        <a href="/ansible/task-control/using-loops-and-items/">
        Using Loops and Items
        </a>
      </div>
      <div class="card-content-text">
          <!-- raw HTML omitted -->

      </div>
    </div>
  </article>
</li>
<li>
  <article class="card card-popout" aria-labelledby="R-card-eacb763a0bda804eb957ffe4a32e2ea4">
    <div class="card-content">
      <div class="card-title" id="R-card-eacb763a0bda804eb957ffe4a32e2ea4">
        <a href="/ansible/task-control/using-when-to-run-tasks-conditionally/">
        Using when to Run Tasks Conditionally
        </a>
      </div>
      <div class="card-content-text">
          <!-- raw HTML omitted -->

      </div>
    </div>
  </article>
</li>
</ul>
</div>

  <footer class="footline">
  </footer>
</article>
          <section>
            <h1 class="a11y-only">Subsections of Task Control</h1>
<article class="default">
  <header class="headline">
  </header>

<h1 id="handlers">Handlers</h1>

<h2 id="using-handlers">Using Handlers</h2>
<ul>
<li>A task that is triggered and is executed by a successful task.</li>
</ul>
<h4 id="working-with-handlers">Working with Handlers</h4>
<ul>
<li>Define a <strong>notify</strong> statement at the level where the task is defined.</li>
<li>The <strong>notify</strong> statement should list the name of the handler that is to be executed</li>
<li>Handlers are listed at the end of the play.</li>
<li>Make sure the name of the handler matches the name of the item that is called in the <strong>notify</strong> statement, because that is what the handler is looking for.</li>
<li>Handlers can be specified as a list, so one task can call multiple handlers.</li>
</ul>
<h3 id="lab">Lab</h3>
<ul>
<li>Define the file index.html on localhost. Use this file in the second play to set up the web server.</li>
<li>The handler is triggered from the task where the copy module is used to copy the index.html file.</li>
<li>If this task is successful, the <strong>notify</strong> statement calls the handler.</li>
<li>A second task is defined, which is intended to fail.</li>
</ul>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yml" data-lang="yml"><span style="display:flex;"><span>    ---
</span></span><span style="display:flex;"><span>    - <span style="color:#ff6ac1">name</span>: create file on localhost
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">hosts</span>: localhost
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">tasks</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#ff6ac1">name</span>: create index.html on localhost
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">copy</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#ff6ac1">content</span>: <span style="color:#5af78e">&#34;welcome to the webserver&#34;</span>
</span></span><span style="display:flex;"><span>          <span style="color:#ff6ac1">dest</span>: /tmp/index.html
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    - <span style="color:#ff6ac1">name</span>: set up web server
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">hosts</span>: all
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">tasks</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#ff6ac1">name</span>: install httpd
</span></span><span style="display:flex;"><span>          <span style="color:#ff6ac1">yum</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#ff6ac1">name</span>: httpd
</span></span><span style="display:flex;"><span>            <span style="color:#ff6ac1">state</span>: latest
</span></span><span style="display:flex;"><span>        - <span style="color:#ff6ac1">name</span>: copy index.html
</span></span><span style="display:flex;"><span>          <span style="color:#ff6ac1">copy</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#ff6ac1">src</span>: /tmp/index.html
</span></span><span style="display:flex;"><span>            <span style="color:#ff6ac1">dest</span>: /var/www/html/index.html
</span></span><span style="display:flex;"><span>          <span style="color:#ff6ac1">notify</span>:
</span></span><span style="display:flex;"><span>            - restart_web
</span></span><span style="display:flex;"><span>        - <span style="color:#ff6ac1">name</span>: copy nothing - intended to fail
</span></span><span style="display:flex;"><span>          <span style="color:#ff6ac1">copy</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#ff6ac1">src</span>: /tmp/nothing
</span></span><span style="display:flex;"><span>            <span style="color:#ff6ac1">dest</span>: /var/www/html/nothing.html
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">handlers</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#ff6ac1">name</span>: restart_web
</span></span><span style="display:flex;"><span>          <span style="color:#ff6ac1">service</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#ff6ac1">name</span>: httpd
</span></span><span style="display:flex;"><span>            <span style="color:#ff6ac1">state</span>: restarted</span></span></code></pre></div>
<ul>
<li>
<p>All tasks up to <strong>copy index.html</strong> run successfully. However, the task <strong>copy nothing</strong> fails, which is why the handler does not run. The solution seems easy: the handler doesn&rsquo;t run because the task that copies the file /tmp/nothing fails as the source file doesn&rsquo;t exist.</p>
</li>
<li>
<p>Create the source file using <code>touch /tmp/nothing</code> on the control host and run the task again.</p>
</li>
<li>
<p>After creating the source file and running the playbook again, the handler still doesn&rsquo;t run.</p>
</li>
<li>
<p>Handlers run only if the task that triggers them gives a <strong>changed</strong> status.</p>
</li>
</ul>
<p>Run an ad hoc command to remove the /var/www/html/index.html file on the managed hosts and run the playbook again:
<code>ansible ansible2 -m file -a &quot;name=/var/www/html/index.html state=absent&quot;</code></p>
<p>Run the playbook again and you&rsquo;ll see the handler runs.</p>
<h4 id="understanding-handler-execution-and-exceptions">Understanding Handler Execution and Exceptions</h4>
<p>When a task fails, none of the following tasks run. How does that make handlers different? A handler runs only on the success of a task, but the next task in the list also runs only if the previous task was successful. What, then, is so special about handlers?</p>
<p>The difference is in the nature of the handler.</p>
<ul>
<li>Handlers are meant to perform an extra action when a task makes a change to a host.</li>
<li>Handler should be considered an extension to the regular task.</li>
<li>A conditional task that runs only upon the success of a previous task.</li>
</ul>
<p>Two methods to get Handlers to run even if a subsequent task fails:</p>
<p><strong>force_handlers: true</strong> (More specific and preferred)</p>
<ul>
<li>Used in the play header to ensure that the handler will run even if a task fails.</li>
</ul>
<p><strong>ignore_errors: true</strong></p>
<ul>
<li>Used in the play header to accomplish the same thing.</li>
</ul>
<p>â€¢ Handlers are specified in a handlers section at the end of the play.
â€¢ Handlers run in the order they occur in the handlers section and not in the order as triggered.
â€¢ Handlers run only if the task calling them generates a changed status.
â€¢ Handlers by default will not run if any task in the same play fails, unless <strong>force_handlers</strong> or <strong>ignore_errors</strong> are used.
â€¢ Handlers run only after <em>all</em> tasks in the play where the handler is activated have been processed. You might want to define multiple plays to avoid this behavior.</p>
<h3 id="lab-working-with-handlers">Lab: Working with Handlers</h3>
<p>1. Open a playbook with the name exercise73.yaml.</p>
<p>2. Define the play header:</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yml" data-lang="yml"><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span>- <span style="color:#ff6ac1">name</span>: update the kernel
</span></span><span style="display:flex;"><span>  <span style="color:#ff6ac1">hosts</span>: all
</span></span><span style="display:flex;"><span>  <span style="color:#ff6ac1">force_handlers</span>: <span style="color:#ff6ac1">true</span>
</span></span><span style="display:flex;"><span>  tasks:</span></span></code></pre></div>
<p>3. Add a task that updates the current kernel:</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yml" data-lang="yml"><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span>- <span style="color:#ff6ac1">name</span>: update the kernel
</span></span><span style="display:flex;"><span>  <span style="color:#ff6ac1">hosts</span>: all
</span></span><span style="display:flex;"><span>  <span style="color:#ff6ac1">force_handlers</span>: <span style="color:#ff6ac1">true</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff6ac1">tasks</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ff6ac1">name</span>: update kernel
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">yum</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">name</span>: kernel
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">state</span>: latest
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">notify</span>: reboot_server</span></span></code></pre></div>
<p>4. Add a handler that reboots the server in case the kernel was successfully updated:</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yml" data-lang="yml"><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span>- <span style="color:#ff6ac1">name</span>: update the kernel
</span></span><span style="display:flex;"><span>  <span style="color:#ff6ac1">hosts</span>: all
</span></span><span style="display:flex;"><span>  <span style="color:#ff6ac1">force_handlers</span>: <span style="color:#ff6ac1">true</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff6ac1">tasks</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ff6ac1">name</span>: update kernel
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">yum</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">name</span>: kernel
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">state</span>: latest
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">notify</span>: reboot_server
</span></span><span style="display:flex;"><span>  <span style="color:#ff6ac1">handlers</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ff6ac1">name</span>: reboot_server
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">command</span>: reboot</span></span></code></pre></div>
<p>5. Run the playbook using <strong>ansible-playbook exercise73.yaml</strong> andobserve its result. Notice that the handler runs only if the kernel was updated. If the kernel already was at the latest version, nothing has changed and the handler does not run. Also notice that it wasn&rsquo;t really necessary to use <strong>force_handlers</strong> in the play header, but by using it anyway, at least you now know where to use it.</p>
<h3 id="dealing-with-failures">Dealing with Failures</h3>
<h4 id="understanding-task-execution">Understanding Task Execution</h4>
<ul>
<li>Tasks in Ansible playbooks are executed in the order they are specified.</li>
<li>If a task in the playbook fails to execute on a host, the task generates an error and the play does not further execute on that specific host.</li>
<li>This also goes for handlers: if any task that follows the task that triggers a handler fails, the handlers do not run.</li>
<li>In both of these cases, it is important to know that the tasks that have run successfully still generate their result. Because this can give an unexpected result, it is important to always restore the original situation if that happens.</li>
</ul>
<p><strong>any_errors_fatal</strong></p>
<ul>
<li>Used in the play header or on a block.</li>
<li>Stop executing on all hosts when a failing task is encountered</li>
</ul>
<h4 id="managing-task-errors">Managing Task Errors</h4>
<p>Generically, tasks can generate three different types of results.
ok</p>
<ul>
<li>The tasks has run successfully but no changes were applied
changed</li>
<li>The task has run successfully and changes have been applied
failed</li>
<li>While running the task, a failure condition was encountered</li>
</ul>
<p><strong>ignore_errors: yes</strong></p>
<ul>
<li>Keep running the playbook even if a task fails</li>
</ul>
<p><strong>force_handlers</strong>. If</p>
<ul>
<li>can be used to ensure that handlers will be executed, even if a failing task
was encountered.</li>
</ul>
<h3 id="lab-ignore_">Lab: <strong>ignore_errors</strong></h3>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yml" data-lang="yml"><span style="display:flex;"><span>    ---
</span></span><span style="display:flex;"><span>    - <span style="color:#ff6ac1">name</span>: restart sshd only if crond is running
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">hosts</span>: all
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">tasks</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#ff6ac1">name</span>: get the crond server status
</span></span><span style="display:flex;"><span>          <span style="color:#ff6ac1">command</span>: /usr/bin/systemctl is-active crond
</span></span><span style="display:flex;"><span>          <span style="color:#ff6ac1">ignore_errors</span>: <span style="color:#ff6ac1">yes</span>
</span></span><span style="display:flex;"><span>          <span style="color:#ff6ac1">register</span>: result
</span></span><span style="display:flex;"><span>        - <span style="color:#ff6ac1">name</span>: restart sshd based on crond status
</span></span><span style="display:flex;"><span>          <span style="color:#ff6ac1">service</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#ff6ac1">name</span>: sshd
</span></span><span style="display:flex;"><span>            <span style="color:#ff6ac1">state</span>: restarted
</span></span><span style="display:flex;"><span>          <span style="color:#ff6ac1">when</span>: result.rc == 0</span></span></code></pre></div>
<h3 id="lab-forcing-handlers-to-run">Lab: Forcing Handlers to Run</h3>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>    ---
</span></span><span style="display:flex;"><span>    - <span style="color:#ff6ac1">name</span>: create file on localhost
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">hosts</span>: localhost
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">tasks</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#ff6ac1">name</span>: create index.html on localhost
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">copy</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#ff6ac1">content</span>: <span style="color:#5af78e">&#34;welcome to the webserver&#34;</span>
</span></span><span style="display:flex;"><span>          <span style="color:#ff6ac1">dest</span>: /tmp/index.html
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    - <span style="color:#ff6ac1">name</span>: set up web server
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">hosts</span>: all
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">force_handlers</span>: <span style="color:#ff6ac1">yes</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">tasks</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#ff6ac1">name</span>: install httpd
</span></span><span style="display:flex;"><span>          <span style="color:#ff6ac1">yum</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#ff6ac1">name</span>: httpd
</span></span><span style="display:flex;"><span>            <span style="color:#ff6ac1">state</span>: latest
</span></span><span style="display:flex;"><span>        - <span style="color:#ff6ac1">name</span>: copy index.html
</span></span><span style="display:flex;"><span>          <span style="color:#ff6ac1">copy</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#ff6ac1">src</span>: /tmp/index.html
</span></span><span style="display:flex;"><span>            <span style="color:#ff6ac1">dest</span>: /var/www/html/index.html
</span></span><span style="display:flex;"><span>          <span style="color:#ff6ac1">notify</span>:
</span></span><span style="display:flex;"><span>            - restart_web
</span></span><span style="display:flex;"><span>        - <span style="color:#ff6ac1">name</span>: copy nothing - intended to fail
</span></span><span style="display:flex;"><span>          <span style="color:#ff6ac1">copy</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#ff6ac1">src</span>: /tmp/nothing
</span></span><span style="display:flex;"><span>            <span style="color:#ff6ac1">dest</span>: /var/www/html/nothing.html
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">handlers</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#ff6ac1">name</span>: restart_web
</span></span><span style="display:flex;"><span>          <span style="color:#ff6ac1">service</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#ff6ac1">name</span>: httpd
</span></span><span style="display:flex;"><span>            <span style="color:#ff6ac1">state</span>: restarted</span></span></code></pre></div>
<h4 id="specifying-task-failure-conditions">Specifying Task Failure Conditions</h4>
<p><strong>failed_when</strong></p>
<ul>
<li>conditional used to evaluate some expression.</li>
<li>Set a failure condition on a task</li>
</ul>
<h3 id="lab-failed_when">Lab: failed_when</h3>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yml" data-lang="yml"><span style="display:flex;"><span>    ---
</span></span><span style="display:flex;"><span>    - <span style="color:#ff6ac1">name</span>: demonstrating failed_when
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">hosts</span>: all
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">tasks</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#ff6ac1">name</span>: run a script
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">command</span>: echo hello world
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">ignore_errors</span>: <span style="color:#ff6ac1">yes</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">register</span>: command_result
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">failed_when</span>: <span style="color:#5af78e">&#34;â€™worldâ€™ in command_result.stdout&#34;</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#ff6ac1">name</span>: see if we get here
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">debug</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#ff6ac1">msg</span>: second task executed</span></span></code></pre></div>
<p><strong>fail</strong> module</p>
<ul>
<li>specify when a task fails.</li>
<li>Using this module makes sense only if <strong>when</strong> is used to define the exact condition when a failure should occur.</li>
</ul>
<h3 id="lab-using-the-fail-module">Lab: Using the fail Module</h3>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>    ---
</span></span><span style="display:flex;"><span>    - <span style="color:#ff6ac1">name</span>: demonstrating the fail module
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">hosts</span>: all
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">ignore_errors</span>: <span style="color:#ff6ac1">yes</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">tasks</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#ff6ac1">name</span>: run a script
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">command</span>: echo hello world
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">register</span>: command_result
</span></span><span style="display:flex;"><span>      - <span style="color:#ff6ac1">name</span>: report a failure
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">fail</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#ff6ac1">msg</span>: the command has failed
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">when</span>: <span style="color:#5af78e">&#34;â€™worldâ€™ in command_result.stdout&#34;</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#ff6ac1">name</span>: see if we get here
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">debug</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#ff6ac1">msg</span>: second task executed</span></span></code></pre></div>
<ul>
<li>The <strong>ignore_errors</strong> statement has movedfrom the task definition to the play  header.</li>
<li>Without this move, the message &ldquo;second task executed&rdquo; would never be  shown because the fail module always generates a failure message.</li>
<li>The main advantage of using the fail module instead of using <strong>failed_when</strong> is that the fail module can easily be used to set a clear failure message, which is not possible when using <strong>failed_when</strong>.</li>
</ul>
<h4 id="managing-changed-status">Managing Changed Status</h4>
<p>In Ansible, there are commands that change something and commands that don&rsquo;t. Some commands, however, are not very obvious in reporting their
status.</p>
<h3 id="lab--change-status">Lab:  Change status</h3>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yml" data-lang="yml"><span style="display:flex;"><span>    ---
</span></span><span style="display:flex;"><span>    - <span style="color:#ff6ac1">name</span>: demonstrate changed status
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">hosts</span>: all
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">tasks</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#ff6ac1">name</span>: check local time
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">command</span>: date
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">register</span>: command_result
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>      - <span style="color:#ff6ac1">name</span>: print local time
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">debug</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#ff6ac1">var</span>: command_result.stdout</span></span></code></pre></div>
<ul>
<li>
<p>Reports a changed status, even if nothing really was changed!</p>
</li>
<li>
<p>Managing the changed status can be useful in avoiding unexpected results while running a playbook.</p>
</li>
</ul>
<p><strong>changed_when</strong></p>
<ul>
<li>If you set <strong>changed_when</strong> to false, the playbook reports only an ok or failed status and never reports a changed status.</li>
</ul>
<h3 id="lab-using-changed_">Lab: Using <strong>changed_when</strong></h3>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yml" data-lang="yml"><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span>- <span style="color:#ff6ac1">name</span>: demonstrate changed status
</span></span><span style="display:flex;"><span>  <span style="color:#ff6ac1">hosts</span>: all
</span></span><span style="display:flex;"><span>  <span style="color:#ff6ac1">tasks</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ff6ac1">name</span>: check local time
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">command</span>: date
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">register</span>: command_result
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">changed_when</span>: <span style="color:#ff6ac1">false</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>  - <span style="color:#ff6ac1">name</span>: print local time
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">debug</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">var</span>: command_result.stdout</span></span></code></pre></div>
<h4 id="using-blocks">Using Blocks</h4>
<ul>
<li>Useful when working with conditional statements.</li>
<li>A group of tasks to which a <strong>when</strong> statement can be applied.</li>
<li>As a result, if a single condition is true, multiple tasks can be executed.</li>
<li>To do so, between the <strong>tasks:</strong> statement in the play header and the actual tasks that run the specific modules, you can insert a <strong>block:</strong> statement.</li>
</ul>
<h3 id="lab-using-blocks">Lab: Using Blocks</h3>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yml" data-lang="yml"><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span>- <span style="color:#ff6ac1">name</span>: simple block example
</span></span><span style="display:flex;"><span>  <span style="color:#ff6ac1">hosts</span>: all
</span></span><span style="display:flex;"><span>  <span style="color:#ff6ac1">tasks</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ff6ac1">name</span>: setting up http
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">block</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#ff6ac1">name</span>: installing http
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">yum</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">name</span>: httpd
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">state</span>: present
</span></span><span style="display:flex;"><span>    - <span style="color:#ff6ac1">name</span>: restart httpod
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">service</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">name</span>: httpd
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">state</span>: started
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">when</span>: ansible_distribution == &#34;CentOS&#34;</span></span></code></pre></div>
<ul>
<li>The <strong>when</strong> statement is applied at the same level as the <strong>block</strong> definition.</li>
<li>When you define it this way, the tasks in the block are executed only if the <strong>when</strong> statement is true.</li>
</ul>
<h4 id="using-blocks-with-rescue-and-always-statements">Using Blocks with rescue and always Statements</h4>
<ul>
<li>Blocks can be used for simple error handling as well, in such a way that if any task that is defined in the <strong>block</strong> statement fails, the tasks that are defined in the <strong>rescue</strong> section are executed.</li>
<li>Besides that, an <strong>always</strong> section can be used to define tasks that should always run, regardless of the success or failure of the tasks in the block.</li>
</ul>
<h3 id="lab-using-blocks-rescue-and-always">Lab: Using Blocks, <strong>rescue</strong>, and <strong>always</strong></h3>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yml" data-lang="yml"><span style="display:flex;"><span>- <span style="color:#ff6ac1">name</span>: using blocks
</span></span><span style="display:flex;"><span>  <span style="color:#ff6ac1">hosts</span>: all
</span></span><span style="display:flex;"><span>  <span style="color:#ff6ac1">tasks</span>: 
</span></span><span style="display:flex;"><span>  - <span style="color:#ff6ac1">name</span>: intended to be successful
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">block</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#ff6ac1">name</span>: remove a file
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">shell</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">cmd</span>: rm /var/www/html/index.html
</span></span><span style="display:flex;"><span>    - <span style="color:#ff6ac1">name</span>: printing status
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">debug</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">msg</span>: block task was operated
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">rescue</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#ff6ac1">name</span>: create a file
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">shell</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">cmd</span>: touch /tmp/rescuefile
</span></span><span style="display:flex;"><span>    - <span style="color:#ff6ac1">name</span>: printing rescue status
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">debug</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">msg</span>: rescue task was operated
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">always</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#ff6ac1">name</span>: always write a message to logs
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">shell</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">cmd</span>: logger hello
</span></span><span style="display:flex;"><span>    - <span style="color:#ff6ac1">name</span>: always printing this message
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">debug</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">msg</span>: this message is always printed</span></span></code></pre></div>
<ul>
<li>Run this twice to see the rescue. (The file is already created so a task in the block fails)</li>
</ul>
<p><strong>command_warnings=False</strong></p>
<ul>
<li>
<p>Setting in ansible.cfg to avoid seeing command module warning message.</p>
</li>
<li>
<p>you cannot use a block on a loop.</p>
</li>
<li>
<p>If you need to iterate over a list of values, think of using a different solution.</p>
</li>
</ul>
<p><a href="/ansible/task-control/labs/">Labs</a></p>

  <footer class="footline">
  </footer>
</article>
<article class="default">
  <header class="headline">
  </header>

<h1 id="using-loops-and-items">Using Loops and Items</h1>

<h2 id="using-loops-and-items">Using Loops and Items</h2>
<ul>
<li>Some modules enable you to provide a list that needs to be processed.</li>
<li>Many modules don&rsquo;t, and in these cases, it makes sense to use a loop mechanism to iterate over a list of items.</li>
<li>Take, for instance, the yum module. While specifying the names of packages, you can use a list of packages.</li>
<li>If, however, you want to do something similar for the service module, you find out that this is not possible.</li>
<li>That is where loops come in.</li>
</ul>
<h4 id="working-with-loops">Working with Loops</h4>
<p>Install software packages using the yum module and then ensures that services installed from these packages are started using the service module:</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yml" data-lang="yml"><span style="display:flex;"><span>    ---
</span></span><span style="display:flex;"><span>    - <span style="color:#ff6ac1">name</span>: install and start services
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">hosts</span>: ansible1
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">tasks</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#ff6ac1">name</span>: install packages
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">yum</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#ff6ac1">name</span>:
</span></span><span style="display:flex;"><span>          - vsftpd
</span></span><span style="display:flex;"><span>          - httpd
</span></span><span style="display:flex;"><span>          - samba
</span></span><span style="display:flex;"><span>          <span style="color:#ff6ac1">state</span>: latest
</span></span><span style="display:flex;"><span>      - <span style="color:#ff6ac1">name</span>: start the services
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">service</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#ff6ac1">name</span>: <span style="color:#5af78e">&#34;{{ item }}&#34;</span>
</span></span><span style="display:flex;"><span>          <span style="color:#ff6ac1">state</span>: started
</span></span><span style="display:flex;"><span>          <span style="color:#ff6ac1">enabled</span>: <span style="color:#ff6ac1">yes</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">loop</span>:
</span></span><span style="display:flex;"><span>        - vsftpd
</span></span><span style="display:flex;"><span>        - httpd
</span></span><span style="display:flex;"><span>        - smb</span></span></code></pre></div>
<ul>
<li>
<p>A loop is defined at the same level as the service module.</p>
</li>
<li>
<p>The loop has a list of services in a list (array) statement</p>
</li>
<li>
<p>Items in the loop can be accessed by using the system internal variable <strong>item</strong>.</p>
</li>
<li>
<p>At no place in the playbook is there a definition of the variable <strong>item</strong>; the loop takes care of this.</p>
</li>
<li>
<p>When considering whether to use a loop, you should first investigate whether a module offers support for providing lists as values to the keys that are used.</p>
</li>
<li>
<p>If this is the case, just provide a list, as all items in the list can be considered in one run of the module.</p>
</li>
<li>
<p>If not, define the list using <strong>loop</strong> and provide <strong>&quot;{{ item }}&quot;</strong> as the value to the key.</p>
</li>
<li>
<p>When using <strong>loop</strong>, the module is activated again on each iteration.</p>
</li>
</ul>
<h4 id="using-loops-on-variables">Using Loops on Variables</h4>
<ul>
<li>Although it&rsquo;s possible to define a loop within a task, it&rsquo;s not the most elegant way.</li>
<li>To create a flexible environment where static code is separated from dynamic site-specific parameters, it&rsquo;s a much better idea to define loops outside the static code, in variables.</li>
<li>When you define loops within a variable, all the normal rules for working with variables apply: The variables can be defined in the play header, using an include file, or as host/hostgroup variables.</li>
</ul>
<p>Include the loop from a variable:</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0"><code>    ---
    - name: install and start services
      hosts: ansible1
      vars:
        services:
        - vsftpd
        - httpd
        - smb
      tasks:
      - name: install packages
        yum:
          name:
          - vsftpd
          - httpd
          - samba
          state: latest
      - name: start the services
        service:
          name: &#34;{{ item }}&#34;
          state: started
          enabled: yes
        loop: &#34;{{ services }}&#34;</code></pre></div>
<h4 id="using-loops-on-multivalued-variables">Using Loops on Multivalued Variables</h4>
<p>An item can be a simple list, but it can also be presented as a multivalued variable, as long as the multivalued variable is presented as a list.</p>
<p>Use variables that are imported from the file vars/users-list:</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0"><code>users:
  - username: linda
    homedir: /home/linda
    shell: /bin/bash
    groups: wheel
  - username: lisa
    homedir: /home/lisa
    shell: /bin/bash
    groups: users
  - username: anna
    homedir: /home/anna
    shell: /bin/bash
    groups: users</code></pre></div>
<p>Use the list in a playbook:</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0"><code>    ---
    - name: create users using a loop from a list
      hosts: ansible1
      vars_files: vars/users-list
      tasks:
      - name: create users
        user:
          name: &#34;{{ item.username }}&#34;
          state: present
          groups: &#34;{{ item.groups }}&#34;
          shell: &#34;{{ item.shell }}&#34;
        loop: &#34;{{ users }}&#34;</code></pre></div>
<ul>
<li>Working with multivalued variables is possible, but the variables in that case must be presented as a list; using dictionaries is not supported.</li>
<li>The only way to loop over dictionaries is to use the <strong>dict2items</strong> filter.</li>
<li>Use of filters is not included in the RHCE topics and for that reason is not explained further here.</li>
<li>You can look up &ldquo;Iterating over a dictionary&rdquo; in the Ansible documentation for more information.</li>
</ul>
<h4 id="understanding-with_items">Understanding with_items</h4>
<ul>
<li>Since Ansible 2.5, using <strong>loop</strong> has been the command way to iterate over the values in a list.</li>
<li>In earlier versions of Ansible, the <strong>with_<em>keyword</em></strong> statement was used instead.</li>
<li>In this approach, the <em><strong>keyword</strong></em> is replaced with the name of an Ansible look-up plug-in, but the rest of the syntax is very common.</li>
<li>Will be deprecated in a future version of Ansible.</li>
</ul>
<p><strong>With_keyword</strong> Options Overview
with_items</p>
<ul>
<li>Used like loop to iterate over values in a list
with_file</li>
<li>Used to iterate over a list of filenames on the control node
with_sequence</li>
<li>Used to generate a list of values based on a numeric sequence</li>
</ul>
<p>Loop over a list using with_keyword:</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yml" data-lang="yml"><span style="display:flex;"><span>    ---
</span></span><span style="display:flex;"><span>    - <span style="color:#ff6ac1">name</span>: install and start services
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">hosts</span>: ansible1
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">vars</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">services</span>:
</span></span><span style="display:flex;"><span>        - vsftpd
</span></span><span style="display:flex;"><span>        - httpd
</span></span><span style="display:flex;"><span>        - smb
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">tasks</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#ff6ac1">name</span>: install packages
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">yum</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#ff6ac1">name</span>:
</span></span><span style="display:flex;"><span>          - vsftpd
</span></span><span style="display:flex;"><span>          - httpd
</span></span><span style="display:flex;"><span>          - samba
</span></span><span style="display:flex;"><span>          <span style="color:#ff6ac1">state</span>: latest
</span></span><span style="display:flex;"><span>      - <span style="color:#ff6ac1">name</span>: start the services
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">service</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#ff6ac1">name</span>: <span style="color:#5af78e">&#34;{{ item }}&#34;</span>
</span></span><span style="display:flex;"><span>          <span style="color:#ff6ac1">state</span>: started
</span></span><span style="display:flex;"><span>          <span style="color:#ff6ac1">enabled</span>: <span style="color:#ff6ac1">yes</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">with_items</span>: <span style="color:#5af78e">&#34;{{ services }}&#34;</span></span></span></code></pre></div>
<h3 id="lab--working-with-loop">Lab:  Working with loop</h3>
<p>1. Use your editor to define a variables file with the name vars/packages and the following contents:</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0"><code class="language-pre1" data-lang="pre1">packages:
- name: httpd
  state: absent
- name: vsftpd
  state: installed
- name: mysql-server
  state: latest</code></pre></div>
<p>2. Use your editor to define a playbook with the name exercise71.yaml and create the play header:</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0"><code class="language-pre1" data-lang="pre1">- name: manage packages using a loop from a list
  hosts: ansible1
  vars_files: vars/packages
  tasks:</code></pre></div>
<p>3. Continue the playbook by adding the yum task that will manage the packages, using the <strong>packages</strong> variable as defined in the vars/packages variable include file:</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0"><code class="language-pre1" data-lang="pre1">- name: manage packages using a loop from a list
  hosts: ansible1
  vars_files: vars/packages
  tasks:
  - name: install packages
    yum:
      name: &#34;{{ item.name }}&#34;
      state: &#34;{{ item.state }}&#34;
    loop: &#34;{{ packages }}&#34;</code></pre></div>
<p>4. Run the playbook using <strong>ansible-playbook exercise71.yaml</strong>, and observe the results. In the results you should see which packages it is trying to manage and in which state it is trying to get the packages.</p>

  <footer class="footline">
  </footer>
</article>
<article class="default">
  <header class="headline">
  </header>

<h1 id="using-when-to-run-tasks-conditionally">Using when to Run Tasks Conditionally</h1>

<h2 id="using-when-to-run-tasks-conditionally">Using when to Run Tasks Conditionally</h2>
<ul>
<li>Use a <strong>when</strong> statement to run tasks conditionally.</li>
<li>you can test whether:
<ul>
<li>a variable has a specific value</li>
<li>whether a file exists</li>
<li>whether a minimal amount of memory is available</li>
<li>etc.</li>
</ul>
</li>
</ul>
<h4 id="working-with-when">Working with when</h4>
<p>Install the right software package for the Apache web server, based on the Linux distribution that was found in the Ansible facts. Notice that</p>
<ul>
<li>when used in <strong>when</strong> statements, the variable that is evaluated is not placed between double curly braces.</li>
</ul>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0"><code>    ---
    - name: conditional install
      hosts: all
      tasks:
      - name: install apache on Red Hat and family
        yum:
          name: httpd
          state: latest
        when: ansible_facts[â€™os_familyâ€™] == &#34;RedHat&#34;
      - name: install apache on Ubuntu and family
        apt:
          name: apache2
          state: latest
        when: ansible_facts[â€™os_familyâ€™] == &#34;Debian&#34;</code></pre></div>
<ul>
<li>
<p>not a part of any properties of the modules on which it is used</p>
</li>
<li>
<p>must be indented at the same level as the module itself.</p>
</li>
<li>
<p>For a string test, the string itself must be between double quotes.</p>
</li>
<li>
<p>Without the double quotes, it would be considered an integer test.</p>
</li>
</ul>
<h4 id="using-conditional-test-statements">Using Conditional Test Statements</h4>
<p>Common conditional tests that you can perform with the <strong>when</strong> statement:</p>
<p>Variable exists</p>
<ul>
<li>
<p>variable is defined
Variable does not exist</p>
</li>
<li>
<p>variable is not defined
First variable is present in list mentioned as second</p>
</li>
<li>
<p>ansible_distribution in distributions
Variable is true, 1 or yes</p>
</li>
<li>
<p>variable
Variable is false, 0 or no</p>
</li>
<li>
<p>not variable
Equal (string)</p>
</li>
<li>
<p>key == &ldquo;value&rdquo;
Equal (numeric)</p>
</li>
<li>
<p>key == value
Less than</p>
</li>
<li>
<p>key &lt; value
Less than or equal to</p>
</li>
<li>
<p>key &lt;= value
Greater than</p>
</li>
<li>
<p>key &gt; value
Greater than or equal to</p>
</li>
<li>
<p>key &gt;= value
Not equal to</p>
</li>
<li>
<p>key != value</p>
</li>
<li>
<p>Look for &ldquo;Tests&rdquo; in the Ansible documentation, and use the item that is found in Templating (Jinja2).</p>
</li>
<li>
<p>When referring to variables in <strong>when</strong> statements, you don&rsquo;t have to use curly brackets because items in a <strong>when</strong> statement are considered to be variables by default.</p>
</li>
<li>
<p>So you can write <strong>when: text == &ldquo;hello&rdquo;</strong> instead of <strong>when: &ldquo;{{ text }}&rdquo; == &ldquo;hello&rdquo;</strong>.</p>
</li>
</ul>
<p>There are roughly four types of <strong>when</strong> conditional tests:
â€¢ Checks related to variable existence
â€¢ Boolean checks
â€¢ String comparisons
â€¢ Integer comparisons</p>
<p>The first type of test checks whether a variable exists or is a part of another variable, such as a list.</p>
<p>Checks for the existence of a specific disk device, using <strong>variable is defined</strong> and <strong>variable is not defined</strong>. All failing tests result in the message &ldquo;skipping.&rdquo;</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>    ---
</span></span><span style="display:flex;"><span>    - <span style="color:#ff6ac1">name</span>: check for existence of devices
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">hosts</span>: all
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">tasks</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#ff6ac1">name</span>: check if /dev/sda exists
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">debug</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#ff6ac1">msg</span>: a disk device /dev/sda exists
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">when</span>: ansible_facts[â€™devicesâ€™][â€™sdaâ€™] is defined
</span></span><span style="display:flex;"><span>      - <span style="color:#ff6ac1">name</span>: check if /dev/sdb exists
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">debug</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#ff6ac1">msg</span>: a disk device /dev/sdb exists
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">when</span>: ansible_facts[â€™devicesâ€™][â€™sdbâ€™] is defined
</span></span><span style="display:flex;"><span>      - <span style="color:#ff6ac1">name</span>: dummy test, intended to fail
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">debug</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#ff6ac1">msg</span>: failing
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">when</span>: dummy is defined
</span></span><span style="display:flex;"><span>      - <span style="color:#ff6ac1">name</span>: check if /dev/sdc does not exist
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">debug</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#ff6ac1">msg</span>: there is no /dev/sdc device
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">when</span>: ansible_facts[â€™devicesâ€™][â€™sdcâ€™] is not defined</span></span></code></pre></div>
<h3 id="lab-check-that-finds-whether-the-first-variable-value-is-present-in-the-second-variables-list">Lab: Check that finds whether the first variable value is present in the second variable&rsquo;s list.</h3>
<ul>
<li>executes the <strong>debug</strong> task if the variable <strong>my_answer</strong> is in <strong>supported_packages</strong>.</li>
<li><strong>vars_prompt</strong> is used. This stops the playbook, asks the user for input, and stores the input in a variable with the name my_answer.</li>
</ul>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yml" data-lang="yml"><span style="display:flex;"><span>    ---
</span></span><span style="display:flex;"><span>    - <span style="color:#ff6ac1">name</span>: test if variable is in another variables list
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">hosts</span>: all
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">vars_prompt</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#ff6ac1">name</span>: my_answer
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">prompt</span>: which package do you want to install
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">vars</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">supported_packages</span>:
</span></span><span style="display:flex;"><span>        - httpd
</span></span><span style="display:flex;"><span>        - nginx
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">tasks</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#ff6ac1">name</span>: something
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">debug</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#ff6ac1">msg</span>: you are trying to install a supported package
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">when</span>: my_answer in supported_packages</span></span></code></pre></div>
<p><strong>Boolean check</strong></p>
<ul>
<li>Works on variables that have a Boolean value (not very common) T</li>
<li>Should not be defined with the check for existence.</li>
<li>Used to check whether a variable is defined.</li>
</ul>
<p><strong>string comparisons and integer comparisons</strong></p>
<ul>
<li>Ie: Check if more than 1 GB of disk space is available.</li>
<li>When doing checks on available disk space and available memory, carefully look at the expected value.</li>
<li>Memory is shown in megabytes, by default, whereas disk space is expressed in bytes.</li>
</ul>
<h3 id="lab-integer-check-install-vsftpd-if-more-than-50-mb-of-memory-is-available">Lab: integer check, install vsftpd if more than 50 MB of memory is available.</h3>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yml" data-lang="yml"><span style="display:flex;"><span>    ---
</span></span><span style="display:flex;"><span>    - <span style="color:#ff6ac1">name</span>: conditionals test
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">hosts</span>: all
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">tasks</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#ff6ac1">name</span>: install vsftpd if sufficient memory available
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">package</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#ff6ac1">name</span>: vsftpd
</span></span><span style="display:flex;"><span>          <span style="color:#ff6ac1">state</span>: latest
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">when</span>: ansible_facts[â€™memory_mbâ€™][â€™realâ€™][â€™freeâ€™] &gt; 50</span></span></code></pre></div>
<h4 id="testing-multiple-conditions">Testing Multiple Conditions</h4>
<ul>
<li><strong>when</strong> statements can also be used to evaluate multiple conditions.</li>
<li>To do so, you can group the conditions with parentheses and combine them with <strong>and</strong> and <strong>or</strong> keywords.</li>
<li><strong>and</strong> runs if both conditionals are ture</li>
<li><strong>or</strong> runs if one of the conditions are true</li>
</ul>
<h3 id="lab-and-is-used-and--runs-the-task-only-if-both-conditions-are-true">Lab: <strong>and</strong> is used and  runs the task only if both conditions are true.</h3>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yml" data-lang="yml"><span style="display:flex;"><span>    ---
</span></span><span style="display:flex;"><span>    - <span style="color:#ff6ac1">name</span>: testing multiple conditions
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">hosts</span>: all
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">tasks</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#ff6ac1">name</span>: showing output
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">debug</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#ff6ac1">msg</span>: using CentOS 8.1
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">when</span>: ansible_facts[â€™distribution_versionâ€™] == &#34;8.1&#34; and ansible_facts[â€™distributionâ€™] == &#34;CentOS&#34;</span></span></code></pre></div>
<ul>
<li>You can make more complex statements by grouping conditions together in parentheses.</li>
<li>group the <strong>when</strong> statement starts with a &gt; sign to wrap the statement over the next five lines for readability.</li>
</ul>
<h3 id="lab-combining-complex-statements">Lab: Combining complex statements</h3>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yml" data-lang="yml"><span style="display:flex;"><span>    ---
</span></span><span style="display:flex;"><span>    - <span style="color:#ff6ac1">name</span>: using multiple conditions
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">hosts</span>: all
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">tasks</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#ff6ac1">package</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#ff6ac1">name</span>: httpd
</span></span><span style="display:flex;"><span>          <span style="color:#ff6ac1">state</span>: removed
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">when</span>: &gt;<span style="color:#5af78e">
</span></span></span><span style="display:flex;"><span><span style="color:#5af78e">          ( ansible_facts[â€™distributionâ€™] == &#34;RedHat&#34; and
</span></span></span><span style="display:flex;"><span><span style="color:#5af78e">            ansible_facts[â€™memfree_mbâ€™] &lt; 512 )
</span></span></span><span style="display:flex;"><span><span style="color:#5af78e">          or
</span></span></span><span style="display:flex;"><span><span style="color:#5af78e">          ( ansible_facts[â€™distributionâ€™] == &#34;CentOS&#34; and
</span></span></span><span style="display:flex;"><span><span style="color:#5af78e">            ansible_facts[â€™memfree_mbâ€™] &lt; 256 )</span></span></span></code></pre></div>
<h4 id="combining-loop-and-when">Combining loop and when</h4>
<h3 id="lab-combining-loop-and-when-perform-a-kernel-update-only-if-boot-is-on-a-dedicated-mount-point-and-at-least-200-mbis-available-in-the-mount">Lab: Combining loop and when, Perform a kernel update only if /boot is on a dedicated mount point and at least 200 MBis available in the mount.</h3>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yml" data-lang="yml"><span style="display:flex;"><span>    ---
</span></span><span style="display:flex;"><span>    - <span style="color:#ff6ac1">name</span>: conditionals test
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">hosts</span>: all
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">tasks</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#ff6ac1">name</span>: update the kernel if sufficient space is available in /boot
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">package</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#ff6ac1">name</span>: kernel
</span></span><span style="display:flex;"><span>          <span style="color:#ff6ac1">state</span>: latest
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">loop</span>: <span style="color:#5af78e">&#34;{{ ansible_facts[â€™mountsâ€™] }}&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">when</span>: item.mount == &#34;/boot&#34; and item.size_available &gt; 200000000</span></span></code></pre></div>
<h4 id="combining-loop-and-register">Combining loop and register</h4>
<h3 id="lab-combining-register-and-loop">Lab: Combining <strong>register</strong> and <strong>loop</strong></h3>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yml" data-lang="yml"><span style="display:flex;"><span>    ---
</span></span><span style="display:flex;"><span>    - <span style="color:#ff6ac1">name</span>: test register
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">hosts</span>: all
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">tasks</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#ff6ac1">shell</span>: cat /etc/passwd
</span></span><span style="display:flex;"><span>          <span style="color:#ff6ac1">register</span>: passwd_contents
</span></span><span style="display:flex;"><span>        - <span style="color:#ff6ac1">debug</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#ff6ac1">msg</span>: passwd contains user lisa
</span></span><span style="display:flex;"><span>          <span style="color:#ff6ac1">when</span>: passwd_contents.stdout.find(â€™lisaâ€™) != -1</span></span></code></pre></div>
<p><strong>passwd_contents.stdout.find</strong>,</p>
<ul>
<li><strong>passwd_contents.stdout</strong> does not contain any item with the name <strong>find</strong>.</li>
<li>Construction that is used here is <strong>variable.find</strong>, which enables a task to search a specific string in a variable. (the<strong>find</strong> function in Python is used)</li>
<li>When the Python <strong>find</strong> function does not find a string, it returns a value of âˆ’1.</li>
<li>If the requested string is found, the <strong>find</strong> function returns an integer that returns the position where the string was found.</li>
<li>For instance, if the string lisa is found in /etc/passwd, it returns an unexpected value like 2604, which is the position in the file, expressed as a byte offset from the beginning, where the string is found for the first time.</li>
<li>Because of the behavior of the Python <strong>find</strong> function, <strong>variable.find</strong> needs <em>not</em> to be equal to âˆ’1 to have the task succeed. So don&rsquo;t write <strong>passwd_contents.stdout.find(&rsquo;lisa&rsquo;) = 0</strong> (because it is not a Boolean), but instead write <strong>passwd_contents.stdout.find(&rsquo;lisa&rsquo;) != -1</strong>.</li>
</ul>
<h3 id="lab-practice-working-with-conditionals-using-register">Lab: Practice working with conditionals using <strong>register</strong>.</h3>
<ul>
<li>When using <strong>register</strong>, you might want to define a task that runs a command that will fail, just to capture the return code of that command, after which the playbook should continue. If that is the case, you must ensure that <strong>ignore_errors: yes</strong> is used in the task definition.</li>
</ul>
<p>1. Use your editor to create a new file with the name exercise72.yaml. Start writing the play header as follows:</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0"><code class="language-pre1" data-lang="pre1">---
- name: restart sshd service if httpd is running
  hosts: ansible1
  tasks:</code></pre></div>
<p>2. Add the first task, which checks whether the httpd service is running, using command output that will be registered. Notice the use of <strong>ignore_errors: yes</strong>. This line makes sure that if the service is <em>not</em> running, the play is still executed further.</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0"><code class="language-pre1" data-lang="pre1">---
- name: restart sshd service if httpd is running
  hosts: ansible1
  tasks:
  - name: get httpd service status
    command: systemctl is-active httpd
    ignore_errors: yes
    register: result</code></pre></div>
<p>3. Add a debug task that shows the output of the command so that you can analyze what is currently in the registered variable:</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0"><code class="language-pre1" data-lang="pre1">---
- name: restart sshd service if httpd is running
  hosts: ansible1
  tasks:
  - name: get httpd service status
    command: systemctl is-active httpd
    ignore_errors: yes
    register: result
  - name: show result variable contents
    debug:
      msg: printing contents of the registered variable {{ result }}</code></pre></div>
<p>4. Complete the playbook by including the <strong>service</strong> task, which is started only if the value stored in <strong>result.rc</strong> (which is the return code of the command that was registered) contains a 0. This is the case if the previous command executed successfully.</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0"><code class="language-pre1" data-lang="pre1">---
- name: restart sshd service if httpd is running
  hosts: ansible1
  tasks:
  - name: get httpd service status
    command: systemctl is-active httpd
    ignore_errors: yes
    register: result
  - name: show result variable contents
    debug:
      msg: printing contents of the registered variable {{ result }}
  - name: restart sshd service
    service:
      name: sshd
      state: restarted
    when: result.rc == 0</code></pre></div>
<p>5. Use an ad hoc command to make sure the httpd service is installed: <code>ansible ansible1 -m yum -a &quot;name=httpd state=latest&quot;</code>.</p>
<p>6. Use an ad hoc command to make sure the httpd service is stopped: <code>ansible ansible1 -m service -a &quot;name=httpd state=stopped&quot;</code>.</p>
<p>7. Run the playbook using <code>ansible-playbook exercise72.yaml</code> and analyze the result. You should see that the playbook skips the <strong>service</strong> task.</p>
<p>8. Type <code>ansible ansible1 -m service -a &quot;name=httpd state=started&quot;</code> and run the playbook again, using <code>ansible-playbook exercise72.yaml</code>. Playbook execution at this point should be successful.</p>

  <footer class="footline">
  </footer>
</article>
          </section>
<article class="default">
  <header class="headline">
  </header>

<h1 id="troubleshooting">Troubleshooting</h1>

<div class="children children-type-card children-sort-"><ul class="card-container">
<li>
  <article class="card card-popout" aria-labelledby="R-card-c41f5f33a99e71ba69115267352d2054">
    <div class="card-content">
      <div class="card-title" id="R-card-c41f5f33a99e71ba69115267352d2054">
        <a href="/ansible/troubleshooting/ansible-documentation/">
        Ansible Documentation
        </a>
      </div>
      <div class="card-content-text">
          <!-- raw HTML omitted -->

      </div>
    </div>
  </article>
</li>
<li>
  <article class="card card-popout" aria-labelledby="R-card-634536962e8073c5378cc671ac1bcb45">
    <div class="card-content">
      <div class="card-title" id="R-card-634536962e8073c5378cc671ac1bcb45">
        <a href="/ansible/troubleshooting/managing-ansible-errors-and-logs/">
        Managing Ansible Errors and Logs
        </a>
      </div>
      <div class="card-content-text">
          <!-- raw HTML omitted -->

      </div>
    </div>
  </article>
</li>
<li>
  <article class="card card-popout" aria-labelledby="R-card-3731ff7293335977f042d4dbaf34c6ee">
    <div class="card-content">
      <div class="card-title" id="R-card-3731ff7293335977f042d4dbaf34c6ee">
        <a href="/ansible/troubleshooting/troubleshooting-common-scenarios/">
        Troubleshooting Common Scenarios
        </a>
      </div>
      <div class="card-content-text">
          <!-- raw HTML omitted -->

      </div>
    </div>
  </article>
</li>
<li>
  <article class="card card-popout" aria-labelledby="R-card-b73e5cf9801dc514dee7373cb1985aff">
    <div class="card-content">
      <div class="card-title" id="R-card-b73e5cf9801dc514dee7373cb1985aff">
        <a href="/ansible/troubleshooting/using-modules-for-troubleshooting-and-testing/">
        Using Modules for Troubleshooting and Testing
        </a>
      </div>
      <div class="card-content-text">
          <!-- raw HTML omitted -->

      </div>
    </div>
  </article>
</li>
<li>
  <article class="card card-popout" aria-labelledby="R-card-83dd79bf248fac3cf3830a9aac234897">
    <div class="card-content">
      <div class="card-title" id="R-card-83dd79bf248fac3cf3830a9aac234897">
        <a href="/ansible/troubleshooting/using-tags/">
        Using Tags
        </a>
      </div>
      <div class="card-content-text">
          <!-- raw HTML omitted -->

      </div>
    </div>
  </article>
</li>
</ul>
</div>

  <footer class="footline">
  </footer>
</article>
          <section>
            <h1 class="a11y-only">Subsections of Troubleshooting</h1>
<article class="default">
  <header class="headline">
  </header>

<h1 id="ansible-documentation">Ansible Documentation</h1>

<h2 id="ansible-navigator"><code>ansible-navigator</code></h2>
<p>Was advised to start using this tools for Ansible because it is available during the RHCE exam.
<a href="https://ansible.readthedocs.io/projects/navigator/" rel="external" target="_blank">https://ansible.readthedocs.io/projects/navigator/</a></p>
<h2 id="ansible-docs">Ansible Docs</h2>
<p><a href="https://docs.ansible.com/" rel="external" target="_blank">https://docs.ansible.com/</a></p>
<h2 id="ansible-doc"><code>ansible-doc</code></h2>
<p><a href="https://docs.ansible.com/ansible/latest/cli/ansible-doc.html" rel="external" target="_blank">https://docs.ansible.com/ansible/latest/cli/ansible-doc.html</a></p>

  <footer class="footline">
  </footer>
</article>
<article class="default">
  <header class="headline">
  </header>

<h1 id="managing-ansible-errors-and-logs">Managing Ansible Errors and Logs</h1>

<h3 id="managing-ansible-errors-and-logs">Managing Ansible Errors and Logs</h3>
<h4 id="using-check-mode">Using Check Mode</h4>
<p>Before actually running a playbook in a way that all changes are
implemented, you can start the playbooks in check mode. To do this, you
use the <strong>--check</strong> or <strong>-C</strong> command-line argument to the <strong>ansible</strong>
or <strong>ansible-playbook</strong> command. The effect of using check mode is that
changes that would have been made are shown but not executed. You should
realize, though, that check mode is not supported in all cases. You
will, for instance, have problems with check mode if it is applied to
conditionals, where a specific task can do its work only after a
preceding task has made some changes. Also, to successfully use check
mode, the modules need to support it, but some don&rsquo;t. Modules that don&rsquo;t
support check mode don&rsquo;t show any result while running check mode, but
also they don&rsquo;t make any changes.</p>
<p>Apart from the command-line argument, you can use <strong>check_mode: yes</strong> or
<strong>check_mode: no</strong> with any task in a playbook. If <strong>check_mode: yes</strong>
is used, the task always runs in check mode (and does not implement any
changes), regardless of the use of the <strong>--check</strong> option. If a task
has <strong>check_mode: no</strong> set, it never runs in check mode and just does
its work, even if the <strong>ansible-playbook</strong> command is used with the
<strong>--check</strong> option. Using check mode on individual tasks might be a
good idea if using check mode on the entire playbook gives unpredicted
results: you can enable it on just a couple of tasks to ensure that they
run successfully before proceeding to the next set of tasks. Notice that
using <strong>check_mode: no</strong> for specific tasks can be dangerous; these
tasks will make changes, even if the entire playbook was started with
the <strong>--check</strong> option!</p>
<p>::: note</p>
<hr>
<p><strong>Note</strong></p>
<p>The <strong>check_mode</strong> argument is a replacement for the <strong>always_run</strong>
option that was used in Ansible 2.5 and earlier. In current Ansible
versions, you should not use <strong>always_run</strong> anymore.</p>
<p>Another option that is commonly used with the <strong>--check</strong> option is
<strong>--diff</strong>. This option reports changes to template files without
actually applying them. <a href="/ansible/troubleshooting/managing-ansible-errors-and-logs/#ch11.xhtml#list11_1">Listing 11-1</a> shows a
sample playbook, <a href="/ansible/troubleshooting/managing-ansible-errors-and-logs/#ch11.xhtml#list11_2">Listing 11-2</a> shows the template
that it is processing, and <a href="/ansible/troubleshooting/managing-ansible-errors-and-logs/#ch11.xhtml#list11_3">Listing 11-3</a> shows
the result of running this playbook with the <strong>ansible-playbook
listing111.yaml --check --diff</strong> command.</p>
<hr>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>    ---
</span></span><span style="display:flex;"><span>    - <span style="color:#ff6ac1">name</span>: simple template example
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">hosts</span>: ansible2
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">tasks</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#ff6ac1">template</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#ff6ac1">src</span>: listing112.j2
</span></span><span style="display:flex;"><span>          <span style="color:#ff6ac1">dest</span>: /etc/issue
</span></span><span style="display:flex;"><span><span style="color:#ff6ac1">::</span>:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#78787e">**Listing</span> <span style="color:#ff9f43">11-2</span><span style="color:#78787e">**</span> Sample Template File
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff6ac1">::</span>: pre_1
</span></span><span style="display:flex;"><span>    {<span style="color:#78787e"># /etc/issue #}</span>
</span></span><span style="display:flex;"><span>    Welcome to {{ ansible_facts[â€™hostnameâ€™] }}
</span></span><span style="display:flex;"><span><span style="color:#ff6ac1">::</span>:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#78787e">**Listing</span> <span style="color:#ff9f43">11-3</span><span style="color:#78787e">**</span> Running the listing111.yaml Sample Playbook
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff6ac1">::</span>: pre_1
</span></span><span style="display:flex;"><span>    [ansible@control rhce8-book]$ ansible-playbook listing111.yaml --check --diff
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    PLAY [simple template example] *************************************************
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    TASK [Gathering Facts] *********************************************************
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">ok</span>: [ansible2]
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    TASK [template] ****************************************************************
</span></span><span style="display:flex;"><span>    --- before
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">+++ after</span>: /home/ansible/.ansible/tmp/ansible-local-4493uxbpju1e/tmpm5gn7crg/listing112.j2
</span></span><span style="display:flex;"><span>    @@ -<span style="color:#ff9f43">0</span>,<span style="color:#ff9f43">0</span> +1,3 @@
</span></span><span style="display:flex;"><span>    +Welcome to ansible2
</span></span><span style="display:flex;"><span>    +
</span></span><span style="display:flex;"><span>    +
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">changed</span>: [ansible2]
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    PLAY RECAP *********************************************************************
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">ansible2                   </span>: ok=2    changed=1    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0</span></span></code></pre></div>
<h4 id="understanding-output">Understanding Output</h4>
<p>When you run the <strong>ansible-playbook</strong> command, output is generated.
You&rsquo;ve probably had a glimpse of it before, but let&rsquo;s look at the output
in a more structured way now. <a href="/ansible/troubleshooting/managing-ansible-errors-and-logs/#ch11.xhtml#list11_4">Listing 11-4</a> shows
some typical sample output generated by running the <strong>ansible-playbook</strong>
command.</p>
<p><strong>Listing 11-4 ansible-playbook</strong> Command Output</p>
<p>::: pre_1
[ansible@control rhce8-book]$ ansible-playbook listing52.yaml</p>
<pre><code>PLAY [install start and enable httpd] ******************************************

TASK [Gathering Facts] *********************************************************
ok: [ansible2]
ok: [ansible1]
ok: [ansible3]
ok: [ansible4]

TASK [install package] *********************************************************
changed: [ansible2]
changed: [ansible1]
changed: [ansible3]
changed: [ansible4]

TASK [start and enable service] ************************************************
changed: [ansible2]
changed: [ansible1]
changed: [ansible3]
changed: [ansible4]

PLAY RECAP *********************************************************************
ansible1                   : ok=3    changed=2    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0
ansible2                   : ok=3    changed=2    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0
ansible3                   : ok=3    changed=2    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0
ansible4                   : ok=3    changed=2    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0
</code></pre>
<p>:::</p>
<p>In the output of any <strong>ansible-playbook</strong> command, you can see different
items:</p>
<p><a href="#R-image-e00750931ba0b235d910e05468895f4f" class="lightbox-link"><img alt="Image" class="lazy lightbox figure-image" loading="lazy" src="/Images/key_topic_icon.jpg" style="height: auto;width: auto;"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-e00750931ba0b235d910e05468895f4f"><img alt="Image" class="lazy lightbox lightbox-image" loading="lazy" src="/Images/key_topic_icon.jpg"></a>{width=&ldquo;64&rdquo; height=&ldquo;51&rdquo;}</p>
<p>â€¢ An indicator of the play that is started</p>
<p>â€¢ If not disabled, the Gathering Facts task that is executed for each
play</p>
<p>â€¢ Each individual task, including the task name if that was specified</p>
<p>â€¢ The Play Recap, which summarizes the play results</p>
<p>In the Play Recap, different results can be shown. <a href="/ansible/troubleshooting/managing-ansible-errors-and-logs/#ch11.xhtml#tab11_2">Table
11-2</a> gives an overview.</p>
<p>::: group
<strong>Table 11-2</strong> Playbook Recap Overview</p>
<p><a href="#R-image-54f408ea66b038914d69fb58acdd0b2b" class="lightbox-link"><img alt="Image" class="lazy lightbox figure-image" loading="lazy" src="/Images/11tab02.jpg" style="height: auto;width: auto;"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-54f408ea66b038914d69fb58acdd0b2b"><img alt="Image" class="lazy lightbox lightbox-image" loading="lazy" src="/Images/11tab02.jpg"></a>{width=&ldquo;941&rdquo; height=&ldquo;338&rdquo;}
:::</p>
<p>As discussed before, when you use the <strong>ansible-playbook</strong> command, you
can increase the output verbosity level using one or more <strong>-v</strong>
options. <a href="/ansible/troubleshooting/managing-ansible-errors-and-logs/#ch11.xhtml#tab11_3">Table 11-3</a> lists what these options
accomplish. For generic troubleshooting, you might want to consider
using <strong>-vv</strong>, which shows output as well as input data. In particular
cases using the <strong>-vvv</strong> option can be useful because it adds connection
information as well.</p>
<p>The <strong>-vvvv</strong> option just brings too much information in many cases but
can be useful if you need to analyze which exact scripts are executed or
whether any problems were encountered in privilege escalation. Make sure
to capture the output of any command that runs with <strong>-vvvv</strong> to a text
file, though, so that you can read it in an easy way. Even for a simple
playbook, it can easily generate more than 10 screens of output.</p>
<p>::: group
<strong>Table 11-3</strong> Verbosity Options Overview</p>
<p><a href="#R-image-1e75dc95098461c755f755b0cddbac3d" class="lightbox-link"><img alt="Image" class="lazy lightbox figure-image" loading="lazy" src="/Images/11tab03.jpg" style="height: auto;width: auto;"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-1e75dc95098461c755f755b0cddbac3d"><img alt="Image" class="lazy lightbox lightbox-image" loading="lazy" src="/Images/11tab03.jpg"></a>{width=&ldquo;941&rdquo; height=&ldquo;209&rdquo;}
:::</p>
<p>In <a href="/ansible/troubleshooting/managing-ansible-errors-and-logs/#ch11.xhtml#list11_5">Listing 11-5</a> you can see the output of a
small playbook that runs different tasks on the managed hosts. <a href="/ansible/troubleshooting/managing-ansible-errors-and-logs/#ch11.xhtml#list11_5">Listing
11-5</a> shows details about execution of one task on
host ansible4, and as you can see, it goes deep in the amount of detail
that is shown. One component is worth looking at, and that is the
escalation succeeded that you can see in the output. This means that
privilege escalation was successful and tasks were executed because
<strong>become_user</strong> was defined in ansible.cfg. Failing privilege escalation
is one of the common reasons why playbook execution may go wrong, which
is why it&rsquo;s worth keeping an eye on this indicator.</p>
<p><strong>Listing 11-5</strong> Analyzing Partial <strong>-vvvv</strong> Output</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0"><code>    &lt;ansible4&gt; ESTABLISH SSH CONNECTION FOR USER: ansible
    &lt;ansible4&gt; SSH: EXEC ssh -vvv -C -o ControlMaster=auto -o ControlPersist=60s -o StrictHostKeyChecking=no -o KbdInteractiveAuthentication=no -o PreferredAuthentications=gssapi-with-mic,gssapi-keyex,hostbased,publickey -o PasswordAuthentication=no -o â€™User=&#34;ansible&#34;â€™ -o ConnectTimeout=10 -o ControlPath=/home/ansible/.ansible/cp/859d5267e3 ansible4 â€™/bin/sh -c â€™&#34;â€™&#34;â€™chmod u+x /home/ansible/.ansible/tmp/ansible-tmp-1587544652.4716983-118789810824208/ /home/ansible/.ansible/tmp/ansible-tmp-1587544652.4716983-118789810824208/AnsiballZ_systemd.py &amp;&amp; sleep 0â€™&#34;â€™&#34;â€™â€™
    Escalation succeeded
    &lt;ansible4&gt; (0, bâ€™â€™, b&#34;OpenSSH_8.0p1, OpenSSL 1.1.1c FIPS  28 May 2019\r\ndebug1: Reading configuration data /etc/ssh/ssh_config\r\ndebug3: /etc/ssh/ssh_config line 51: Including file /etc/ssh/ssh_config.d/05-redhat.conf depth 0\r\ndebug1: Reading configuration data /etc/ssh/ssh_config.d/05-redhat.conf\r\ndebug2: checking match for â€™final allâ€™ host ansible4 originally ansible4\r\ndebug3: /etc/ssh/ssh_config.d/05-redhat.conf line 3: not matched â€™finalâ€™\r\ndebug2: match not found\r\ndebug3: /etc/ssh/ssh_config.d/05-redhat.conf line 5: Including file /etc/crypto-policies/back-ends/openssh.config depth 1 (parse only)\r\ndebug1: Reading configuration data /etc/crypto-policies/back-ends/openssh.config\r\ndebug3: gss kex names ok: [gss-gex-sha1-,gss-group14-sha1-]\r\ndebug3: kex names ok: [curve25519-sha256,curve25519-sha256@libssh.org,ecdh-sha2-nistp256,ecdh-sha2-nistp384,ecdh-sha2-nistp521,diffie-hellman-group-exchange-sha256,diffie-hellman-group14-sha256,diffie-hellman-group16-sha512,diffie-hellman-group18-sha512,diffie-hellman-group-exchange-sha1,diffie-hellman-group14-sha1]\r\ndebug1: configuration requests final Match pass\r\ndebug1: re-parsing configuration\r\ndebug1: Reading configuration data /etc/ssh/ssh_config\r\ndebug3: /etc/ssh/ssh_config line 51: Including file /etc/ssh/ssh_config.d/05-redhat.conf depth 0\r\ndebug1: Reading configuration data /etc/ssh/ssh_config.d/05-redhat.conf\r\ndebug2: checking match for â€™final allâ€™ host ansible4 originally ansible4\r\ndebug3: /etc/ssh/ssh_config.d/05-redhat.conf line 3: matched â€™finalâ€™\r\ndebug2: match found\r\ndebug3: /etc/ssh/ssh_config.d/05-redhat.conf line 5: Including file /etc/crypto-policies/back-ends/openssh.config depth 1\r\ndebug1: Reading configuration data /etc/crypto-policies/back-ends/openssh.config\r\ndebug3: gss kex names ok: [gss-gex-sha1-,gss-group14-sha1-]\r\ndebug3: kex names ok: [curve25519-sha256,curve25519-sha256@libssh.org,ecdh-sha2-nistp256,ecdh-sha2-nistp384,ecdh-sha2-nistp521,diffie-hellman-group-exchange-sha256,diffie-hellman-group14-sha256,diffie-hellman-group16-sha512,diffie-hellman-group18-sha512,diffie-hellman-group-exchange-sha1,diffie-hellman-group14-sha1]\r\ndebug1: auto-mux: Trying existing master\r\ndebug2: fd 4 setting O_NONBLOCK\r\ndebug2: mux_client_hello_exchange: master version 4\r\ndebug3: mux_client_forwards: request forwardings: 0 local, 0 remote\r\ndebug3: mux_client_request_session: entering\r\ndebug3: mux_client_request_alive: entering\r\ndebug3: mux_client_request_alive: done pid = 4764\r\ndebug3: mux_client_request_session: session request sent\r\ndebug3: mux_client_read_packet: read header failed: Broken pipe\r\ndebug2: Received exit status from master 0\r\n&#34;)
    &lt;ansible4&gt; ESTABLISH SSH CONNECTION FOR USER: ansible
    &lt;ansible4&gt; SSH: EXEC ssh -vvv -C -o ControlMaster=auto -o ControlPersist=60s -o StrictHostKeyChecking=no -o KbdInteractiveAuthentication=no -o PreferredAuthentications=gssapi-with-mic,gssapi-keyex,hostbased,publickey -o PasswordAuthentication=no -o â€™User=&#34;ansible&#34;â€™ -o ConnectTimeout=10 -o ControlPath=/home/ansible/.ansible/cp/859d5267e3 -tt ansible4 â€™/bin/sh -c â€™&#34;â€™&#34;â€™sudo -H -S -n  -u root /bin/sh -c â€™&#34;â€™&#34;â€™&#34;â€™&#34;â€™&#34;â€™&#34;â€™&#34;â€™&#34;â€™echo BECOME-SUCCESS-muvtpdvqkslnlegyhoibfcrilvlyjcqp ; /usr/libexec/platform-python /home/ansible/.ansible/tmp/ansible-tmp-1587544652.4716983-118789810824208/AnsiballZ_systemd.pyâ€™&#34;â€™&#34;â€™&#34;â€™&#34;â€™&#34;â€™&#34;â€™&#34;â€™&#34;â€™ &amp;&amp; sleep 0â€™&#34;â€™&#34;â€™â€™
    Escalation succeeded</code></pre></div>
<h4 id="optimizing-command-output-error-formatting">Optimizing Command Output Error Formatting</h4>
<p>You might have noticed that the formatting of error messages in Ansible
command output can be a bit hard to read. Fortunately, there&rsquo;s an easy
way to make it a little more readable by including two options in the
ansible.cfg file. These options are <strong>stdout_callback = debug</strong> and
<strong>stdout_callback = error</strong>. After including these options, you&rsquo;ll
notice it&rsquo;s a lot easier to read error output and distinguish between
its different components!</p>
<h4 class="h4" id="logging-to-files">Logging to Files</h4>
<p>By default, Ansible does not write anything to log files. The reason is
that the Ansible commands have all the options that may be useful to
write output to the STDOUT. If so required, it&rsquo;s always possible to use
shell redirection to write the command output to a file.</p>
<p>If you do need Ansible to write log files, you can set the <strong>log_path</strong>
parameter in ansible.cfg. Alternatively, Ansible can log to the filename
that is specified as the argument to the $ANSIBLE_LOG_PATH variable.
Notice that Ansible logs can grow big very fast, so if logging to output
files is enabled, make sure that Linux log rotation is configured to
ensure that files cannot grow beyond a specific maximum size.</p>
<h4 class="h4" id="running-task-by-task">Running Task by Task</h4>
<p>When you analyze playbook behavior, it&rsquo;s possible to run playbook tasks
one by one or to start running a playbook at a specific task. The
<strong>ansible-playbook --step</strong> command runs playbooks task by task and
prompts for confirmation before running the next task. Alternatively,
you can use the <strong>ansible-playbook --start-at-task=&quot;task name&quot;</strong>
command to start playbook execution as a specific task. Before using
this command, you might want to use <strong>ansible-playbook --list-tasks</strong>
for a list of all tasks that have been configured. To use these options
in an efficient way, you must configure each task with its own name. In
<a href="/ansible/troubleshooting/managing-ansible-errors-and-logs/#ch11.xhtml#list11_6">Listing 11-6</a> you can see what running playbooks
this way looks like. This listing first shows how to list tasks in a
playbook and next how the <strong>--start-at-task</strong> and <strong>--step</strong> options
are used.</p>
<p><strong>Listing 11-6</strong> Running Tasks One by One</p>
<p>::: pre_1
[ansible@control rhce8-book]$ ansible-playbook &ndash;list-tasks exercise81.yaml</p>
<pre><code>playbook: exercise81.yaml

  play #1 (ansible1): testing file manipulation skills.    TAGS: []
    tasks:
      create a new file              TAGS: []
      check status of the new file   TAGS: []
      for debugging purposes only    TAGS: []
      change file owner if needed    TAGS: []

  play #2 (ansible1): fetching a remote file.    TAGS: []
    tasks:
      fetch file from remote machine.    TAGS: []

  play #3 (localhost): adding text to the file that is now on localhost TAGS: []
    tasks:
      add a message.    TAGS: []

  play #4 (ansible2): copy the modified file to ansible2.    TAGS: []
    tasks:
      copy motd file.    TAGS: []
[ansible@control rhce8-book]$ ansible-playbook --start-at-task &quot;add a message&quot;  --step exercise81.yaml

PLAY [testing file manipulation skills] ****************************************

PLAY [fetching a remote file] **************************************************

PLAY [adding text to the file that is now on localhost] ************************
Perform task: TASK: Gathering Facts (N)o/(y)es/(c)ontinue:
</code></pre>
<p>:::</p>
<p>In <a href="/ansible/troubleshooting/managing-ansible-errors-and-logs/#ch11.xhtml#exe11_1">Exercise 11-1</a> you learn how to apply check
mode while working with templates.</p>
<p>::: box
<strong>Exercise 11-1 Using Templates in Check Mode</strong></p>
<p>1. Locate the file httpd.conf; you can find it in the rhce8-book
directory, which you can download from the GitHub repository at
<a href="https://github.com/sandervanvugt/rhce8-book" rel="external" target="_blank">https://github.com/sandervanvugt/rhce8-book</a>. Use <strong>mv httpd.conf
exercise111-httpd.j2</strong> to rename it to a Jinja2 template file.</p>
<p>2. Open the exercise111-httpd.j2 file with an editor, and apply
modifications to existing parameters so that they look like the
following:</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0"><code class="language-pre1" data-lang="pre1">ServerRoot &#34;{{ apache_root }}&#34;
User {{ apache_user }}
Group {{ apache_group }}</code></pre></div>
<p>3. Write a playbook that takes care of the complete Apache web server
setup and installation, starts and enables the service, opens a port in
the firewall, and uses the template module to create the
/etc/httpd/conf/httpd.conf file based on the template that you created
in step 2 of this exercise. The complete playbook with the name
exercise111.yaml looks like the following (make sure you have the
<em>exact</em> contents shown below and do <em>not</em> correct any typos):</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0"><code class="language-pre1" data-lang="pre1">---
- name: perform basic apache setup
  hosts: ansible2
  vars:
    apache_root: /etc/httpd
    apache_user: httpd
    apache_group: httpd
  tasks:
  - name: install RPM package
    yum:
      name: httpd
      state: latest
  - name: copy template file
    template:
      src: exercise111-httpd.j2
      dest: /etc/httpd/httpd.conf
  - name: start and enable service
    service:
      name: httpd
      state: started
      enabled: yes
  - name: open port in firewall
    firewalld:
      service: http
      permanent: yes
      state: enabled
      immediate: yes</code></pre></div>
<p>4. Run the command <strong>ansible-playbook --syntax-check
exercise111.yaml</strong>. If no errors are found in the playbook syntax, you
should just see the name of the playbook.</p>
<p>5. Run the command <strong>ansible-playbook --check --diff
exercise111.yaml</strong>. In the output of the command, pay attention to the
task copy template file. After the line that starts with <strong>+++ after</strong>,
you should see the lines in the template that were configured to use a
variable, using the right variables.</p>
<p>6. Run the playbook to perform all its tasks step by step, using the
command <strong>ansible-playbook --step exercise111.yaml</strong>. Press <strong>y</strong> to
confirm the first step. Next, press <strong>c</strong> to automatically continue. The
playbook will fail on the copy template file task because the target
directory does not exist. Notice that the <strong>--syntax-check</strong> and the
<strong>--check</strong> options do not check for any logical errors in the playbook
and for that reason have not detected this problem.</p>
<p>7. Edit the exercise111.yaml file and ensure the <strong>template</strong> task
contains the following corrected line: (replace the old line starting
with <strong>dest:</strong>):</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0"><code class="language-pre1" data-lang="pre1">dest: /etc/httpd/conf/httpd.conf</code></pre></div>
<p>8. Type <strong>ansible-playbook --list-tasks exercise111.yaml</strong> to list all
the tasks in the playbook.</p>
<p>9. To avoid running the entire playbook again, use <strong>ansible-playbook
--start-at-task=&quot;copy template file&quot; exercise111.yaml</strong> to run the
playbook to completion.
:::</p>

  <footer class="footline">
  </footer>
</article>
<article class="default">
  <header class="headline">
  </header>

<h1 id="troubleshooting-common-scenarios">Troubleshooting Common Scenarios</h1>

<h3 id="troubleshooting-common-scenarios">Troubleshooting Common Scenarios</h3>
<p>Apart from the problems that may arise in playbooks, another type of
error relates to connectivity issues. To connect to managed hosts, SSH
must be configured correctly, and also authentication and privilege
escalation must work as expected.</p>
<h4 class="h4" id="analyzing-connectivity-issues">Analyzing Connectivity Issues</h4>
<p>To be able to connect to a managed host, you need to have an IP network
connection. Apart from that, you need to make sure that the host has
been set up correctly:</p>
<p>â€¢ The SSH service needs to be accessible on the remote host.</p>
<p>â€¢ Python must be installed.</p>
<p>â€¢ Privilege escalation needs to be set up.</p>
<p>Apart from these, inventory settings may be specified to indicate how to
connect to a remote host. Normally, the inventory contains a host name
only. If a host resolves to multiple IP addresses, you may want to
specify how exactly the remote host must be connected to. The
<strong>ansible_host</strong> parameter can be configured to do so. In inventory, for
instance, you may include the following line to ensure that your host is
connected in the right way:</p>
<pre><code>ansible5.example.com ansible_host=192.168.4.55
</code></pre>
<p>Notice that this setting makes sense only in an environment where a host
can be reached on multiple different IP addresses.</p>
<p>To test connectivity to remote hosts, you can use the ping module. It
checks for IP connectivity, accessibility of the SSH service, sudo
privilege escalation, and the availability of a Python stack. The ping
module does not take any arguments. <a href="/ansible/troubleshooting/troubleshooting-common-scenarios/#ch11.xhtml#list11_18">Listing
11-18</a> shows the result of running on the ad hoc
command <strong>ansible all -m ping</strong> where hosts that are available send
&ldquo;pong&rdquo; as a reply, and for hosts that are not available, you see why
they are not available.</p>
<p><strong>Listing 11-18</strong> Verifying Connectivity Using the ping Module</p>
<p>::: pre_1
[ansible@control rhce8-book]$ ansible all -m ping
ansible2 | SUCCESS =&gt; {
&ldquo;ansible_facts&rdquo;: {
&ldquo;discovered_interpreter_python&rdquo;: &ldquo;/usr/libexec/platform-python&rdquo;
},
&ldquo;changed&rdquo;: false,
&ldquo;ping&rdquo;: &ldquo;pong&rdquo;
}
ansible1 | SUCCESS =&gt; {
&ldquo;ansible_facts&rdquo;: {
&ldquo;discovered_interpreter_python&rdquo;: &ldquo;/usr/libexec/platform-python&rdquo;
},
&ldquo;changed&rdquo;: false,
&ldquo;ping&rdquo;: &ldquo;pong&rdquo;
}
ansible3 | SUCCESS =&gt; {
&ldquo;ansible_facts&rdquo;: {
&ldquo;discovered_interpreter_python&rdquo;: &ldquo;/usr/libexec/platform-python&rdquo;
},
&ldquo;changed&rdquo;: false,
&ldquo;ping&rdquo;: &ldquo;pong&rdquo;
}
ansible4 | FAILED! =&gt; {
&ldquo;msg&rdquo;: &ldquo;Missing sudo password&rdquo;
}
:::</p>
<h4 class="h4" id="analyzing-authentication-issues">Analyzing Authentication Issues</h4>
<p>A few settings play a role in authentication on the remote host to
execute tasks:</p>
<p><a href="#R-image-adae920a4af4ce3cd83c9415f34fc465" class="lightbox-link"><img alt="Image" class="lazy lightbox figure-image" loading="lazy" src="/Images/key_topic_icon.jpg" style="height: auto;width: auto;"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-adae920a4af4ce3cd83c9415f34fc465"><img alt="Image" class="lazy lightbox lightbox-image" loading="lazy" src="/Images/key_topic_icon.jpg"></a>{width=&ldquo;64&rdquo; height=&ldquo;51&rdquo;}</p>
<p>â€¢ The <strong>remote_user</strong> setting determines which user account to use on
the managed nodes.</p>
<p>â€¢ SSH keys need to be configured for the remote_user to enable smooth
authentication.</p>
<p>â€¢ The <strong>become</strong> parameter needs to be set to true.</p>
<p>â€¢ The <strong>become_user</strong> needs to be set to the root user account.</p>
<p>â€¢ Linux sudo needs to be set up correctly.</p>
<p>In <a href="/ansible/troubleshooting/troubleshooting-common-scenarios/#ch11.xhtml#exe11_4">Exercise 11-4</a> you work on troubleshooting some
common scenarios.</p>
<p>::: box
<strong>Exercise 11-4 Troubleshooting Connectivity Issues</strong></p>
<p>1. Use an editor to create the file exercise114-1.yaml and give it the
following contents:</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0"><code class="language-pre1" data-lang="pre1">---
- name: remove user from wheel group
  hosts: ansible4
  tasks:
  - user:
      name: ansible
      groups: â€™â€™</code></pre></div>
<p>2. Run the playbook using <strong>ansible-playbook exercise114-1.yaml</strong> and
use <strong>ansible ansible4 -m reboot</strong> to reboot node ansible4.</p>
<p>3. Once the reboot is completed, use <strong>ansible all -m ping</strong> to verify
connectivity. Host ansible4 should give a &ldquo;Missing sudo password&rdquo; error.</p>
<p>4. Type <strong>ansible ansible4 -m raw -a &ldquo;usermod -aG wheel ansible&rdquo; -u
root -k</strong> to make user ansible a member of the group wheel again.</p>
<p>5. Repeat the <strong>ansible all -m ping</strong> command. You should now be able
to connect normally to the host ansible4 again.
:::</p>

  <footer class="footline">
  </footer>
</article>
<article class="default">
  <header class="headline">
  </header>

<h1 id="using-modules-for-troubleshooting-and-testing">Using Modules for Troubleshooting and Testing</h1>

<h3 id="using-modules-for-troubleshooting-and-testing">Using Modules for Troubleshooting and Testing</h3>
<p>While working with playbooks, you may use different modules for
troubleshooting. The debug module was used in previous chapters and is
particularly useful for analyzing variable behavior. Some other modules
may prove useful when troubleshooting Ansible. <a href="/ansible/troubleshooting/using-modules-for-troubleshooting-and-testing/#ch11.xhtml#tab11_4">Table
11-4</a> gives an overview.</p>
<p>::: group
<strong>Table 11-4</strong> Troubleshooting Modules Overview</p>
<p><a href="#R-image-8461182c43e562b705d7b89bb0dd378c" class="lightbox-link"><img alt="Image" class="lazy lightbox figure-image" loading="lazy" src="Images/11tab04.jpg" style="height: auto;width: auto;"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-8461182c43e562b705d7b89bb0dd378c"><img alt="Image" class="lazy lightbox lightbox-image" loading="lazy" src="Images/11tab04.jpg"></a> {width=&ldquo;940&rdquo; height=&ldquo;295&rdquo;}
:::</p>
<p>The following sections discuss how these modules can be used.</p>
<h4 class="h4" id="using-the-debug-module">Using the Debug Module</h4>
<p>The debug module is useful to visualize what is happening at a certain
point in a playbook. It works with two arguments: the <strong>msg</strong> argument
can be used to print a message, and the <strong>var</strong> argument can be used to
print the value of a variable. Notice that when you use the <strong>var</strong>
argument, the variable does not have to be referred to using the usual
<strong>{{ varname }}</strong> structure, just use <strong>varname</strong> instead. If variables
are used in the <strong>msg</strong> argument, they must be referred to the normal
way, using the <strong>{{ varname }}</strong> syntax.</p>
<p>Because you have already seen the debug module in action in numerous
examples in Chapters 6, 7, and 8 of this book, no new examples are
included here.</p>
<h4 class="h4" id="using-the-uri-module">Using the uri Module</h4>
<p>The best way to learn how to work with these modules is to look at some
examples. <a href="/ansible/troubleshooting/using-modules-for-troubleshooting-and-testing/#ch11.xhtml#list11_7">Listing 11-7</a> shows an example where
the uri module is used.</p>
<p><strong>Listing 11-7</strong> Using the uri Module</p>
<p>::: pre_1
&mdash;
- name: test webserver access
hosts: localhost
become: no
tasks:
- name: connect to the web server
uri:
url: <a href="http://ansible2.example.com" rel="external" target="_blank">http://ansible2.example.com</a>
return_content: yes
register: this
failed_when: &ldquo;â€™welcomeâ€™ not in this.content&rdquo;
- debug:
var: this.content
:::</p>
<p>The playbook in <a href="/ansible/troubleshooting/using-modules-for-troubleshooting-and-testing/#ch11.xhtml#list11_7">Listing 11-7</a> uses the uri module
to connect to a web server. The <strong>return_content</strong> argument captures the
web server content, which is stored in a variable using <strong>register</strong>.
Next, the <strong>failed_when</strong> statement makes this module fail if the text
&ldquo;welcome&rdquo; is not in the registered variable. For debugging purposes, the
debug module is used to show the contents of the variable.</p>
<p>In <a href="/ansible/troubleshooting/using-modules-for-troubleshooting-and-testing/#ch11.xhtml#list11_8">Listing 11-8</a> you can see the partial result
of running this playbook. Notice that the playbook does not generate a
failure because the default web page that is shown by the Apache web
server contains the text &ldquo;welcome.&rdquo;</p>
<p><strong>Listing 11-8 ansible-playbook listing117.yaml</strong> Command Result</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#ff6ac1">[</span>ansible@control rhce8-book<span style="color:#ff6ac1">]</span>$ ansible-playbook listing117.yaml
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    PLAY <span style="color:#ff6ac1">[</span><span style="color:#ff5c57">test</span> webserver access<span style="color:#ff6ac1">]</span> ***************************************************
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    TASK <span style="color:#ff6ac1">[</span>Gathering Facts<span style="color:#ff6ac1">]</span> *********************************************************
</span></span><span style="display:flex;"><span>    ok: <span style="color:#ff6ac1">[</span>localhost<span style="color:#ff6ac1">]</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    TASK <span style="color:#ff6ac1">[</span>connect to the web server<span style="color:#ff6ac1">]</span> ***********************************************
</span></span><span style="display:flex;"><span>    ok: <span style="color:#ff6ac1">[</span>localhost<span style="color:#ff6ac1">]</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    TASK <span style="color:#ff6ac1">[</span>debug<span style="color:#ff6ac1">]</span> *******************************************************************
</span></span><span style="display:flex;"><span>    ok: <span style="color:#ff6ac1">[</span>localhost<span style="color:#ff6ac1">]</span> <span style="color:#ff6ac1">=</span>&gt; <span style="color:#ff6ac1">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#5af78e">&#34;this.content&#34;</span>: <span style="color:#5af78e">&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#5af78e">    
</span></span></span><span style="display:flex;"><span><span style="color:#5af78e">    PLAY RECAP *********************************************************************
</span></span></span><span style="display:flex;"><span><span style="color:#5af78e">    localhost                  : ok=3    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0
</span></span></span><span style="display:flex;"><span><span style="color:#5af78e">    </span></span></span></code></pre></div>
<p>Using the uri module can be useful to perform a simple test to check
whether a web server is available, but you can also use it to check
accessibility or returned information from an API endpoint.</p>
<h4 class="h4" id="using-the-stat-module">Using the stat Module</h4>
<p>You can use the stat module to check on the status of files. Although
this module can be useful for checking on the status of just a few
files, it&rsquo;s not a file system integrity checker that was developed to
check file status on a large scale. If you need large-scale file system
integrity checking, you should use Linux utilities such as aide.</p>
<p>The stat module is useful in combination with <strong>register</strong>. In this use,
the stat module is used to register the status of a specific file, and
in a <strong>when</strong> statement, a check can be done to see whether the file
status is not as expected. In combination with the fail module, you can
use this module to generate a failure and error message if the file does
not meet the expected status. <a href="/ansible/troubleshooting/using-modules-for-troubleshooting-and-testing/#ch11.xhtml#list11_9">Listing 11-9</a> shows
an example, and <a href="/ansible/troubleshooting/using-modules-for-troubleshooting-and-testing/#ch11.xhtml#list11_10">Listing 11-10</a> shows the
resulting output, where you can see that the fail module fails the
playbook because the file owner is not root.</p>
<p><strong>Listing 11-9</strong> Using stat to Check Expected File Status</p>
<p>::: pre_1
&mdash;
- name: create a file
hosts: all
tasks:
- file:
path: /tmp/statfile
state: touch
owner: ansible</p>
<pre><code>- name: check file status
  hosts: all
  tasks:
  - stat:
      path: /tmp/statfile
    register: stat_out
  - fail:
      msg: &quot;/tmp/statfile file owner not as expected&quot;
    when: stat_out.stat.pw_name != â€™rootâ€™
</code></pre>
<p>:::</p>
<p><strong>Listing 11-10 ansible-playbook listing119.yaml</strong> Command Result</p>
<p>::: pre_1
[ansible@control rhce8-book]$ ansible-playbook listing119.yaml</p>
<pre><code>PLAY [create a file] ***********************************************************

TASK [Gathering Facts] *********************************************************
ok: [ansible2]
ok: [ansible1]
ok: [ansible3]
ok: [ansible4]
fatal: [ansible6]: UNREACHABLE! =&gt; {&quot;changed&quot;: false, &quot;msg&quot;: &quot;Failed to connect to the host via ssh: ansible@ansible6: Permission denied (publickey,gssapi-keyex,gssapi-with-mic,password).&quot;, &quot;unreachable&quot;: true}
fatal: [ansible5]: UNREACHABLE! =&gt; {&quot;changed&quot;: false, &quot;msg&quot;: &quot;Failed to connect to the host via ssh: ssh: connect to host ansible5 port 22: No route to host&quot;, &quot;unreachable&quot;: true}

TASK [file] ********************************************************************
changed: [ansible2]
changed: [ansible1]
changed: [ansible3]
changed: [ansible4]

PLAY [check file status] *******************************************************

TASK [Gathering Facts] *********************************************************
ok: [ansible1]
ok: [ansible2]
ok: [ansible3]
ok: [ansible4]

TASK [stat] ********************************************************************
ok: [ansible2]
ok: [ansible1]
ok: [ansible3]
ok: [ansible4]

TASK [fail] ********************************************************************
fatal: [ansible2]: FAILED! =&gt; {&quot;changed&quot;: false, &quot;msg&quot;: &quot;/tmp/statfile file owner not as expected&quot;}
fatal: [ansible1]: FAILED! =&gt; {&quot;changed&quot;: false, &quot;msg&quot;: &quot;/tmp/statfile file owner not as expected&quot;}
fatal: [ansible3]: FAILED! =&gt; {&quot;changed&quot;: false, &quot;msg&quot;: &quot;/tmp/statfile file owner not as expected&quot;}
fatal: [ansible4]: FAILED! =&gt; {&quot;changed&quot;: false, &quot;msg&quot;: &quot;/tmp/statfile file owner not as expected&quot;}

PLAY RECAP *********************************************************************
ansible1                   : ok=4    changed=1    unreachable=0    failed=1    skipped=0    rescued=0    ignored=0
ansible2                   : ok=4    changed=1    unreachable=0    failed=1    skipped=0    rescued=0    ignored=0
ansible3                   : ok=4    changed=1    unreachable=0    failed=1    skipped=0    rescued=0    ignored=0
ansible4                   : ok=4    changed=1    unreachable=0    failed=1    skipped=0    rescued=0    ignored=0
ansible5                   : ok=0    changed=0    unreachable=1    failed=0    skipped=0    rescued=0    ignored=0
ansible6                   : ok=0    changed=0    unreachable=1    failed=0    skipped=0    rescued=0    ignored=0
</code></pre>
<p>:::</p>
<h4 class="h4" id="using-the-assert-module">Using the assert Module</h4>
<p>The assert module is a bit like the fail module. You can use it to
perform a specific conditional action. The assert module works with a
<strong>that</strong> option that defines a list of conditionals. If any one of these
conditionals is false, the task fails, and if all the conditionals are
true, the task is successful. Based on the success or failure of a task,
the module uses the <strong>success_msg</strong> or <strong>fail_msg</strong> options to print a
message. <a href="/ansible/troubleshooting/using-modules-for-troubleshooting-and-testing/#ch11.xhtml#list11_11">Listing 11-11</a> shows an example that
uses the assert module.</p>
<p><strong>Listing 11-11</strong> Using the assert Module</p>
<p>::: pre_1
&mdash;
- hosts: localhost
vars_prompt:
- name: filesize
prompt: &ldquo;specify a file size in megabytes&rdquo;
tasks:
- name: check if file size is valid
assert:
that:
- &ldquo;{{ (filesize | int) &lt;= 100 }}&rdquo;
- &ldquo;{{ (filesize | int) &gt;= 1 }}&rdquo;
fail_msg: &ldquo;file size must be between 0 and 100&rdquo;
success_msg: &ldquo;file size is good, let\â€™s continue&rdquo;
- name: create a file
command: dd if=/dev/zero of=/bigfile bs=1 count={{ filesize }}
:::</p>
<p>The example in <a href="/ansible/troubleshooting/using-modules-for-troubleshooting-and-testing/#ch11.xhtml#list11_11">Listing 11-11</a> contains a few new
items. As you can see, the play header starts with a <strong>vars_prompt</strong>.
This defines a variable named <strong>filesize</strong>, which is based on the input
provided by the user. This <strong>filesize</strong> variable is next used by the
assert module. The <strong>that</strong> statement contains a list in which two
conditions are stated. If specified like this, all conditions stated in
the <strong>that</strong> condition must be true. So you are looking for <strong>filesize</strong>
to be equal to or bigger than 1, and smaller than or equal to 100.</p>
<p>Before this can be done, one little problem needs to be managed: when
<strong>vars_prompt</strong> is used, the variable type is set to be a string by
default. This means that a statement like</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>**filesize left <span style="color:#ff5c57">caret</span><span style="color:#ff6ac1">=</span> 100**</span></span></code></pre></div>
<p>would
fail with a type mismatch. That is why a Jinja2 filter is used to
convert the variable type from string to integer.</p>
<p>Filters are a powerful feature provided by the Jinja2 templating
language and can be used in Ansible to modify variables before
processing. For more information about filters, see
<a href="https://docs.ansible.com/ansible/latest/user_guide/playbooks_filters.html" rel="external" target="_blank">https://docs.ansible.com/ansible/latest/user_guide/playbooks_filters.html</a>.
The int filter can be used to convert the value of a string variable to
an integer. To do this, you need to rewrite the entire variable as a
Jinja2 operation, which is done using <strong>&quot;{{ (filesize | int) left caret= 100
}}&quot;</strong>.</p>
<p>In this line, the entire string is written as a variable. The variable
is further treated in a Jinja2 context. In this context, the part
<strong>(filesize | int)</strong> ensures that the string is converted to an
integer, which makes it possible to check if the value is smaller than
100.</p>
<p>When you run the code in <a href="/ansible/troubleshooting/using-modules-for-troubleshooting-and-testing/#ch11.xhtml#list11_11">Listing 11-11</a>, the
result shown in <a href="/ansible/troubleshooting/using-modules-for-troubleshooting-and-testing/#ch11.xhtml#list11_12">Listing 11-12</a> is produced.</p>
<p><strong>Listing 11-12 ansible-playbook listing1111.yaml</strong> Output</p>
<p>::: pre_1
[ansible@control rhce8-book]$ ansible-playbook listing1111.yaml</p>
<pre><code>PLAY [localhost] *****************************************************************

TASK [Gathering Facts] ***********************************************************
ok: [localhost]

TASK [check if file size is valid] ***********************************************
fatal: [localhost]: FAILED! =&gt; {
    &quot;assertion&quot;: &quot;filesize left caret= 100&quot;,
    &quot;changed&quot;: false,
    &quot;evaluated_to&quot;: false,
    &quot;msg&quot;: &quot;file size must be between 0 and 100&quot;
}

PLAY RECAP ***********************************************************************
localhost                  : ok=1    changed=0    unreachable=0    failed=1    skipped=0    rescued=0    ignored=0
</code></pre>
<p>:::</p>
<p>As you can see, the task that is defined with the assert module fails
because the variable has a value that is not between the minimum and
maximum sizes that are defined.</p>
<p>Understanding the need for using the filter to convert the variable type
might not be easy. So, let&rsquo;s also look at <a href="/ansible/troubleshooting/using-modules-for-troubleshooting-and-testing/#ch11.xhtml#list11_13">Listing
11-13</a>, which shows an example of a playbook that
will fail. You can see its behavior in <a href="/ansible/troubleshooting/using-modules-for-troubleshooting-and-testing/#ch11.xhtml#list11_14">Listing
11-14</a>, where the playbook is executed.</p>
<p><strong>Listing 11-13</strong> Failing Version of the <a href="/ansible/troubleshooting/using-modules-for-troubleshooting-and-testing/#ch11.xhtml#list11_11">Listing
11-11</a> Playbook</p>
<p>::: pre_1
&mdash;
- hosts: localhost
vars_prompt:
- name: filesize
prompt: &ldquo;specify a file size in megabytes&rdquo;
tasks:
- name: check if file size is valid
assert:
that:
- filesize &lt;= 100
- filesize &gt;= 1
fail_msg: &ldquo;file size must be between 0 and 100&rdquo;
success_msg: &ldquo;file size is good, let\â€™s continue&rdquo;
- name: create a file
command: dd if=/dev/zero of=/bigfile bs=1 count={{ filesize }}
:::</p>
<p><strong>Listing 11-14 ansible-playbook listing1113.yaml</strong> Failing Result</p>
<p>::: pre_1
[ansible@control rhce8-book]$ ansible-playbook listing1113.yaml
specify a file size in megabytes:</p>
<pre><code>PLAY [localhost] *****************************************************************

TASK [Gathering Facts] ***********************************************************
ok: [localhost]

TASK [check if file size is valid] ***********************************************
fatal: [localhost]: FAILED! =&gt; {&quot;msg&quot;: &quot;The conditional check â€™filesize left caret= 100â€™ failed. The error was: Unexpected templating type error occurred on ({% if filesize left caret= 100 %} True {% else %} False {% endif %}): â€™left caret=â€™ not supported between instances of â€™strâ€™ and â€™intâ€™&quot;}

PLAY RECAP ***********************************************************************
localhost                  : ok=1    changed=0    unreachable=0    failed=1    skipped=0    rescued=0    ignored=0
</code></pre>
<p>:::</p>
<p>As you can see, the code in <a href="/ansible/troubleshooting/using-modules-for-troubleshooting-and-testing/#ch11.xhtml#list11_13">Listing 11-13</a> fails
because the \left caret= test is not supported between a string and an integer.</p>
<p>In <a href="/ansible/troubleshooting/using-modules-for-troubleshooting-and-testing/#ch11.xhtml#exe11_2">Exercise 11-2</a> you work with some of the
modules discussed in this section.</p>
<p>::: box
<strong>Exercise 11-2 Using Modules for Troubleshooting</strong></p>
<p>1. Open your editor to create the file exercise112.yaml and define the
play header:</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0"><code class="language-pre1" data-lang="pre1">---
- name: using assert to check if volume group vgdata exists
  hosts: all
  tasks:</code></pre></div>
<p>2. Add a task that uses the command <strong>vgs vgdata</strong> to check whether a
volume group with the name vgdata exists. The task should use
<strong>register</strong> to register the command result, and it should continue if
this is not the case.</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0"><code class="language-pre1" data-lang="pre1">- name: check if vgdata exists
  command: vgs vgdata
  register: vg_result
  ignore_errors: true</code></pre></div>
<p>3. To make it easier to use <strong>assert</strong> in the next step on the right
variable, include a <strong>debug</strong> task to show the value of the variable:</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0"><code class="language-pre1" data-lang="pre1">- name: show vg_result variable
  debug:
    var: vg_result</code></pre></div>
<p>4. Add a task to print a success or failure message, depending on the
result of the <strong>vgs</strong> command from the first task:</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0"><code class="language-pre1" data-lang="pre1">- name: print a message
  assert:
    that:
    - vg_result.rc == 0
    fail_msg: volume group not found
    success_msg: volume group was found</code></pre></div>
<p>5. Use the command <strong>ansible-playbook exercise112.yaml</strong> to verify its
contents. Assuming that the LVM Volume Group vgdata was not found, it
should print &ldquo;volume group not found.&rdquo;</p>
<p>6. Change the playbook to verify that it will print the <strong>success_msg</strong>
if the requested volume group was found. You can do so by having it run
the command <strong>vgs cl</strong>, which on CentOS 8 should give a positive result.
:::</p>

  <footer class="footline">
  </footer>
</article>
<article class="default">
  <header class="headline">
  </header>

<h1 id="using-tags">Using Tags</h1>

<h3 id="using-tags">Using Tags</h3>
<p>When you are using larger playbooks, Ansible enables you to use the
<strong>tags</strong> attribute. A tag is a label that is applied to a task or
another item like a block or a play, and while using the
<strong>ansible-playbook --tags</strong> or <strong>ansible-playbook --skip-tags</strong>
command, you can specify which tags need to be executed. <a href="/ansible/troubleshooting/using-tags/#ch11.xhtml#list11_15">Listing
11-15</a> shows a simple playbook example where tags
are used, and in <a href="/ansible/troubleshooting/using-tags/#ch11.xhtml#list11_16">Listing 11-16</a> you can see the
output generated while running this playbook.</p>
<p><strong>Listing 11-15</strong> Using <strong>tags</strong> in a Playbook</p>
<p>::: pre_1
&mdash;
- name: using tags example
hosts: all
vars:
service:
- vsftpd
- httpd
tasks:
- yum:
name:
- httpd
- vsftpd
state: present
tags:
- install
- service:
name: &ldquo;{{ item }}&rdquo;
state: started
enabled: yes
loop: &ldquo;{{ services }}&rdquo;
tags:
- services
:::</p>
<p><strong>Listing 11-16 ansible-playbook --tags &ldquo;install&rdquo; listing1115.yaml</strong>
Output</p>
<p>::: pre_1
[ansible@control rhce8-book]$ ansible-playbook &ndash;tags &ldquo;install&rdquo; listing1115.yaml</p>
<pre><code>PLAY [using tags example] ******************************************************

TASK [Gathering Facts] *********************************************************
ok: [ansible2]
ok: [ansible1]
ok: [ansible4]
ok: [ansible3]

TASK [yum] *********************************************************************
ok: [ansible2]
ok: [ansible1]
changed: [ansible3]
changed: [ansible4]

PLAY RECAP *********************************************************************
ansible1                   : ok=2    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0
ansible2                   : ok=2    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0
ansible3                   : ok=2    changed=1    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0
ansible4                   : ok=2    changed=1    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0
</code></pre>
<p>:::</p>
<p>Tags can be applied to many structures, such as imported plays, tasks,
and roles, but the easiest way to get familiar with tags is to use them
on a task. Note that tags cannot be applied on items that are
dynamically included (instead of imported), using <strong>include_roles</strong> or
<strong>include_tasks</strong>.</p>
<p>While writing playbooks, you may apply the same tag multiple times. This
capability allows you to define groups of tasks, where multiple tasks
are configured with the same tag, and as a result, you can easily run a
specific part of the requested configuration. When multiple tasks with
multiple tags are used, you can get an overview of each using the
<strong>ansible-playbook --list-tasks --list-tags</strong> command. In <a href="/ansible/troubleshooting/using-tags/#ch11.xhtml#list11_17">Listing
11-17</a> you can see an example that is based on
the playbook listing1114.yaml.</p>
<p><strong>Listing 11-17</strong> Listing Tasks and Tags</p>
<p>::: pre_1
[ansible@control rhce8-book]$ ansible-playbook &ndash;list-tags &ndash;list-tasks listing1115.yaml</p>
<pre><code>playbook: listing1115.yaml

  play #1 (all): using tags example.    TAGS: []
    tasks:
      yum.       TAGS: [install]
      service.   TAGS: [services]
      TASK TAGS: [install, services]
</code></pre>
<p>:::</p>
<p>When working with tags, you can use some special tags. <a href="/ansible/troubleshooting/using-tags/#ch11.xhtml#tab11_5">Table
11-5</a> gives an overview.</p>
<p>::: group
<strong>Table 11-5</strong> Special Tags Overview</p>
<p><a href="#R-image-af667be66f78405e255ef5b2d1e44e75" class="lightbox-link"><img alt="Image" class="lazy lightbox figure-image" loading="lazy" src="/Images/11tab05.jpg" style="height: auto;width: auto;"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-af667be66f78405e255ef5b2d1e44e75"><img alt="Image" class="lazy lightbox lightbox-image" loading="lazy" src="/Images/11tab05.jpg"></a>{width=&ldquo;940&rdquo; height=&ldquo;252&rdquo;}
:::</p>
<p>Apart from these special tags, you might also want to set a <strong>debug</strong>
tag to easily identify tasks that should be run only if you specifically
want to run debug tasks as well. If combined with the <strong>never</strong> tag, the
task that is tagged with the <strong>debug,never</strong> tasks runs only if the
<strong>debug</strong> tag is specifically requested. So in case you want to run the
entire playbook, including tasks that have been tagged with <strong>debug</strong>,
you need to use the <strong>ansible-playbook --tags all,debug</strong> command. In
<a href="/ansible/troubleshooting/using-tags/#ch11.xhtml#exe11_3">Exercise 11-3</a> you can see how this can be used to
optimize the playbook that was previously used in <a href="/ansible/troubleshooting/using-tags/#ch11.xhtml#exe11_2">Exercise
11-2</a>.</p>
<p>::: box
<strong>Exercise 11-3 Using Tags to Make Debugging Easier</strong></p>
<p>1. Rewrite the exercise112.yaml playbook that you created in the
previous exercise, and include the line <strong>tags: [never, debug ]</strong> in
the <strong>debug</strong> task. The complete playbook looks as follows:</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0"><code class="language-pre1" data-lang="pre1">---
- name: using assert to check if volume group vgdata exists
  hosts: all
  tasks:
  - name: check if vgdata exists
    command: vgs vgdata
    register: vg_result
    ignore_errors: true
  - name: show vg_result variable
    debug:
      var: vg_result
    tags: [ never, debug ]
  - name: print a message
    assert:
      that:
      - vg_result.rc == 0
      fail_msg: volume group not found
      success_msg: volume group was found</code></pre></div>
<p>2. Run the playbook using <strong>ansible-playbook --tags all
exercise113.yaml</strong>. Notice that it does not run the <strong>debug</strong> task.</p>
<p>3. Run the playbook using <strong>ansible-playbook --tags all,debug
exercise113.yaml</strong>. Notice that it now does run the <strong>debug</strong> task as
well.
:::</p>

  <footer class="footline">
  </footer>
</article>
          </section>
<article class="default">
  <header class="headline">
  </header>

<h1 id="variable-and-facts">Variable and Facts</h1>

<div class="children children-type-card children-sort-"><ul class="card-container">
<li>
  <article class="card card-popout" aria-labelledby="R-card-71fa256a74da4a5d751fa4c247066682">
    <div class="card-content">
      <div class="card-title" id="R-card-71fa256a74da4a5d751fa4c247066682">
        <a href="/ansible/variables-and-facts/ansible-facts/">
        Ansible Facts
        </a>
      </div>
      <div class="card-content-text">
          <!-- raw HTML omitted -->

      </div>
    </div>
  </article>
</li>
<li>
  <article class="card card-popout" aria-labelledby="R-card-d33f8fdc7e9e140db7005072e82b2658">
    <div class="card-content">
      <div class="card-title" id="R-card-d33f8fdc7e9e140db7005072e82b2658">
        <a href="/ansible/variables-and-facts/ansible-vault/">
        Ansible Vault
        </a>
      </div>
      <div class="card-content-text">
          <!-- raw HTML omitted -->

      </div>
    </div>
  </article>
</li>
<li>
  <article class="card card-popout" aria-labelledby="R-card-94e0ee2b1808b8d3b50ef0d1916d0f73">
    <div class="card-content">
      <div class="card-title" id="R-card-94e0ee2b1808b8d3b50ef0d1916d0f73">
        <a href="/ansible/variables-and-facts/variables/">
        Variables
        </a>
      </div>
      <div class="card-content-text">
          <!-- raw HTML omitted -->

      </div>
    </div>
  </article>
</li>
</ul>
</div>

  <footer class="footline">
  </footer>
</article>
          <section>
            <h1 class="a11y-only">Subsections of Variable and Facts</h1>
<article class="default">
  <header class="headline">
  </header>

<h1 id="ansible-facts">Ansible Facts</h1>

<p>An ansible <strong>fact</strong> variable is a variable that is automatically set based on the managed system. Facts are a default behavior used to discover information to use in conditionals. They are collected when Ansible executes on a remote system.</p>
<p>There are <strong>systems facts</strong> and <strong>custom facts</strong>. Systems facts are system property values. And custom facts are user-defined variables stored on managed hosts.</p>
<p>If no variables are defined at the command prompt, it will use the variable set for the play. You can also define the variables with the <code>-e</code> flag when running the playbook:</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#ff6ac1">[</span>ansible@control base<span style="color:#ff6ac1">]</span>$ ansible-playbook variable-pb.yaml -e <span style="color:#ff5c57">users</span><span style="color:#ff6ac1">=</span>john
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>PLAY <span style="color:#ff6ac1">[</span>create a user using a variable<span style="color:#ff6ac1">]</span> ************************************************************************************************************************
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>TASK <span style="color:#ff6ac1">[</span>Gathering Facts<span style="color:#ff6ac1">]</span> ***************************************************************************************************************************************
</span></span><span style="display:flex;"><span>ok: <span style="color:#ff6ac1">[</span>ansible1<span style="color:#ff6ac1">]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>TASK <span style="color:#ff6ac1">[</span>create a user john on host ansible1<span style="color:#ff6ac1">]</span> *******************************************************************************************************************
</span></span><span style="display:flex;"><span>changed: <span style="color:#ff6ac1">[</span>ansible1<span style="color:#ff6ac1">]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>PLAY RECAP ***************************************************************************************************************************************************
</span></span><span style="display:flex;"><span>ansible1                   : <span style="color:#ff5c57">ok</span><span style="color:#ff6ac1">=</span><span style="color:#ff9f43">2</span>    <span style="color:#ff5c57">changed</span><span style="color:#ff6ac1">=</span><span style="color:#ff9f43">1</span>    <span style="color:#ff5c57">unreachable</span><span style="color:#ff6ac1">=</span><span style="color:#ff9f43">0</span>    <span style="color:#ff5c57">failed</span><span style="color:#ff6ac1">=</span><span style="color:#ff9f43">0</span>    <span style="color:#ff5c57">skipped</span><span style="color:#ff6ac1">=</span><span style="color:#ff9f43">0</span>    <span style="color:#ff5c57">rescued</span><span style="color:#ff6ac1">=</span><span style="color:#ff9f43">0</span>    <span style="color:#ff5c57">ignored</span><span style="color:#ff6ac1">=</span><span style="color:#ff9f43">0</span>   </span></span></code></pre></div>
<p>A <strong>magic variable</strong> is a system variable that is automatically set.</p>
<p>Notice the &ldquo;Gathering Facts&rdquo; task. when you run a playbook. This is an implicit tasks ran every time you run a playbook. This task grabs facts from managed hosts and stores them in the variable <strong>ansible_facts</strong>.</p>
<p>You can use the <strong>debug</strong> module to display variables like so:</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span>- <span style="color:#ff6ac1">name</span>: show facts
</span></span><span style="display:flex;"><span>  <span style="color:#ff6ac1">hosts</span>: all
</span></span><span style="display:flex;"><span>  <span style="color:#ff6ac1">tasks</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ff6ac1">name</span>: show facts
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">debug</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">var</span>: ansible_facts &lt;-- this module does require variables to be enclosed in curly brackets</span></span></code></pre></div>
<p>This outputs a gigantic list of facts from our managed nodes.</p>
<p>Two formats for using ansible facts variables:
Square brackets (prefered): <code>ansible_facts['default_ipv4']['address']</code>
Dotted: <code>ansible_facts.default_ipv4.address</code></p>
<p>Commonly used ansible_facts:</p>
<p><a href="#R-image-e026d3a835545f9e3cc52c5c6a7b814b" class="lightbox-link"><img class="lazy lightbox figure-image" loading="lazy" src="../../../images/Pasted%20image%2020250518052059.png" style="height: auto;width: auto;"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-e026d3a835545f9e3cc52c5c6a7b814b"><img class="lazy lightbox lightbox-image" loading="lazy" src="../../../images/Pasted%20image%2020250518052059.png"></a></p>
<p>There are additional Ansible modules for gathering more information. See `ansible-doc -l | grep fact</p>
<hr>
<p><code>package_facts</code> module collects information about software packages installed on managed hosts.</p>
<h3 id="two-ways-facts-are-displayed">Two ways facts are displayed</h3>
<p><strong>Ansible_facts variable</strong> (current way)</p>
<ul>
<li>All facts are stored in a dictionary with the name <strong>ansible_facts</strong>, and items in this dictionary are addressed using the notation with square brackets</li>
<li>ie: <code>ansible_facts['distribution_version']</code></li>
<li>Recommended to use this.</li>
</ul>
<p><strong>injected variables</strong> (old way)</p>
<ul>
<li>
<p>Variable are prefixed with the string ansible_</p>
</li>
<li>
<p>Will lose support eventually</p>
</li>
<li>
<p>Old approach and the new approach both still occur.</p>
<ul>
<li><code>ansible ansible1 -m setup</code> command Ansible facts are injected as variables.</li>
</ul>
</li>
</ul>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0"><code>    ansible1 | SUCCESS =&gt; {
        &#34;ansible_facts&#34;: {
            &#34;ansible_all_ipv4_addresses&#34;: [
                &#34;192.168.122.1&#34;,
                &#34;192.168.4.201&#34;
            ],
            &#34;ansible_all_ipv6_addresses&#34;: [
                &#34;fe80::e564:5033:5dec:aead&#34;
            ],
            &#34;ansible_apparmor&#34;: {</code></pre></div>
<p>Comparing ansible_facts Versus Injected Facts as Variables</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0"><code>ansible_facts                               Injected Variable
--------------------------------------------------------------
ansible_facts[&#39;hostname&#39;]                  ansible_hostname
ansible_facts[&#39;distribution&#39;]              ansible_distribution
ansible_facts[&#39;default_ipv4&#39;][&#39;address&#39;]   ansible_default_ipv4[&#39;address&#39;]
ansible_facts[&#39;interfaces&#39;]                ansible_interfaces
ansible_facts[&#39;devices&#39;]                   ansible_devices
ansible_facts[&#39;devices&#39;][&#39;sda&#39;]\
[&#39;partitions&#39;][&#39;sda1&#39;][&#39;size&#39;]             ansible_devices[&#39;sda&#39;][&#39;partitions&#39;][&#39;sda1&#39;][&#39;size&#39;]
ansible_facts[&#39;distribution_version&#39;]      ansible_distribution_version</code></pre></div>
<p>Different notations can be used in either method, the listings address the facts in dotted notation, not in the notation with square brackets.</p>
<p>Addressing Facts with Injected Variables:</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>    - hosts: all
</span></span><span style="display:flex;"><span>      tasks:
</span></span><span style="display:flex;"><span>      - name: show IP address
</span></span><span style="display:flex;"><span>        debug:
</span></span><span style="display:flex;"><span>          msg: &gt;
</span></span><span style="display:flex;"><span>            This host uses IP address <span style="color:#ff6ac1">{{</span> ansible_default_ipv4.address <span style="color:#ff6ac1">}}</span></span></span></code></pre></div>
<p>Addressing Facts Using the ansible_facts Variable</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0"><code>    ---
    - hosts: all
      tasks:
      - name: show IP address
        debug:
          msg: &gt;
            This host uses IP address {{ ansible_facts.default_ipv4.address }}</code></pre></div>
<p>If, for some reason, you want the method where facts are injected into variables to be the default method, you can use
<strong>inject_facts_as_vars=true</strong> in the <strong>[default]</strong> section of the ansible.cfg file.</p>
<p>â€¢ In Ansible versions since 2.5, all facts are stored in one variable: <strong>ansible_facts</strong>. This method is used while gathering facts from a playbook.</p>
<p>â€¢ Before Ansible version 2.5, facts were injected into variables such as <strong>ansible_hostname</strong>. This method is used by the setup module. (Note that this may change in future versions of Ansible.)</p>
<p>â€¢ Facts can be addressed in dotted notation:
<code>{{ansible_facts.default_ipv4.address }}</code></p>
<p>â€¢ Alternatively, facts can be addressed in square brackets notation:
<code>{{ ansible_facts['default_ipv4']['address'] }}</code>. (preferred)</p>
<h4 id="managing-fact-gathering">Managing Fact Gathering</h4>
<p>By default, upon execution of each playbook, facts are gathered. This does slow down playbooks, and for that reason, it is possible to disable fact gathering completely. To do so, you can use the <strong>gather_facts: no</strong> parameter in the play header. If later in the same playbook it is necessary to gather facts, you can do this by running the setup module in a task.</p>
<p>Even if it is possible to disable fact gathering for all of your Ansible configuration, this practice is not recommended. Too many playbooks use conditionals that are based on the current value of facts, and all of these conditionals would stop working if fact gathering were disabled altogether.</p>
<p>As an alternative to make working with facts more efficient, you can disable a fact cache. To do so, you need to install an external plug-in.
Currently, two plug-ins are available for this purpose: <strong>jsonfile</strong> and <strong>redis</strong>. To configure fact caching using the redis plug-in, you need to
install it first. Next, you can enable fact caching through ansible.cfg.</p>
<p>The following procedure describes how to do this:</p>
<p>1. Use <strong>yum install redis</strong>.</p>
<p>2. Use <strong>service redis start</strong>.</p>
<p>3. Use <strong>pip install redis</strong>.</p>
<p>4. Edit /etc/ansible/ansible.cfg and ensure it contains the following
parameters:</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0"><code class="language-pre1" data-lang="pre1">[defaults]
gathering = smart
fact_caching = redis
fact_caching_timeout = 86400</code></pre></div>
<p><strong>Note</strong></p>
<p>Fact caching can be convenient but should be used with caution. If, for instance, a playbook installs a certain package only if a sufficient
amount of disk space is available, it should not do this based on information that may be up to 24 hours old. For that reason, using a
fact cache is not recommended in many situations.</p>
<h4 id="custom-facts">Custom Facts</h4>
<ul>
<li>
<p>Used to provide a host with arbitrary values that Ansible can use to change the behavior of plays.</p>
</li>
<li>
<p>can be provided as static files.</p>
</li>
<li>
<p>files must</p>
<ul>
<li>be in either INI or JSON format,</li>
<li>have the extension .fact, and</li>
<li>on the managed hosts must be stored in the /etc/ansible/facts.d directory.</li>
</ul>
</li>
<li>
<p>can be generated by a script, and</p>
<ul>
<li>in that case the only requirement is that the script must generate its output in JSON format.</li>
</ul>
</li>
</ul>
<p>Dynamic custom facts are useful because they allow the facts to be determined at the moment that a script is running.  provides an example of a static custom fact file.</p>
<p>Custom Facts Sample File:</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0"><code>    [packages]
    web_package = httpd
    ftp_package = vsftpd
    
    [services]
    web_service = httpd
    ftp_service = vsftpd</code></pre></div>
<p>To get the custom facts files on the managed hosts, you can use a playbook that copies a local custom fact file (existing in the current Ansible project directory) to the appropriate location on the managed hosts. Notice that this playbook uses variables, which are explained in more detail in the section titled &ldquo;Working with Variables.&rdquo;</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0"><code>    ---
    - name: Install custom facts
      hosts: all
      vars:
        remote_dir: /etc/ansible/facts.d
        facts_file: listing68.fact
      tasks:
      - name: create remote directory
        file:
          state: directory
          recurse: yes
          path: &#34;{{ remote_dir }}&#34;
      - name: install new facts
        copy:
          src: &#34;{{ facts_file }}&#34;
          dest: &#34;{{ remote_dir }}&#34;</code></pre></div>
<p>Custom facts are stored in the variable <strong>ansible_facts.ansible_local</strong>.
In this variable, you use the filename of the custom fact file and the label in the custom fact file. For instance, after you run the playbook
in <a href="/ansible/variables-and-facts/ansible-facts/#ch06.xhtml#list6_9">Listing 6-9</a>, the web_package fact that was defined in listing68.fact is accessible as</p>
<pre><code>{{ ansible_facts[â€™ansible_localâ€™][â€™listing67â€™][â€™packagesâ€™][â€™web_packageâ€™] }}
</code></pre>
<p>To verify, you can use the setup module with the filter argument. Notice that because the setup module produces injected variables as a result, the ad hoc command to use is <code>ansible all -m setup -a &quot;filter=ansible_local&quot;</code> . The command <code>ansible all -m setup -a  &quot;filter=ansible_facts\['ansible_local'\]&quot;</code> does not work.</p>
<h3 id="lab-working-with-ansible-facts">Lab Working with Ansible Facts</h3>
<p>1. Create a custom fact file with the name custom.fact and the following contents:</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0"><code class="language-pre1" data-lang="pre1">[software]
package = httpd
service = httpd
state = started
enabled = true</code></pre></div>
<p>2. Write a playbook with the name copy_facts.yaml and the following contents:</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0"><code class="language-pre1" data-lang="pre1">---
- name: copy custom facts
  become: yes
  hosts: ansible1
  tasks:
  - name: create the custom facts directory
    file:
      state: directory
      recurse: yes
      path: /etc/ansible/facts.d
  - name: copy the custom facts
    copy:
      src: custom.fact
      dest: /etc/ansible/facts.d</code></pre></div>
<p>3. Apply the playbook using <code>ansible-playbook copy_facts.yaml -i inventory</code></p>
<p>4. Check the availability of the custom facts by using <code>ansible all -m setup -a &quot;filter=ansible_local&quot; -i inventory</code></p>
<p>5. Use an ad hoc command to ensure that the httpd service is not installed on any of the managed servers: <code>ansible all -m yum -a &quot;name=httpd state=absent&quot; -i inventory -b</code></p>
<p>6. Create a playbook with the name <strong>setup_with_facts.yaml</strong> that installs and enables the httpd service, using the custom facts:</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0"><code class="language-pre1" data-lang="pre1">---
- name: install and start the web service
  hosts: ansible1
  tasks:
  - name: install the package
    yum:
      name: &#34;{{ ansible_facts[&#39;ansible_local&#39;][&#39;custom&#39;][&#39;software&#39;][&#39;package&#39;] }}&#34;
      state: latest
  - name: start the service
    service:
      name: &#34;{{ ansible_facts[&#39;ansible_local&#39;][&#39;custom&#39;][&#39;software&#39;][&#39;service&#39;] }}&#34;
      state: &#34;{{ ansible_facts[&#39;ansible_local&#39;][&#39;custom&#39;][&#39;software&#39;][&#39;state&#39;] }}&#34;
      enabled: &#34;{{ ansible_facts[&#39;ansible_local&#39;][&#39;custom&#39;][&#39;software&#39;][&#39;enabled&#39;] }}&#34;</code></pre></div>
<p>7. Run the playbook to install and set up the service by using <code>ansible-playbook setup_with_facts.yaml -i inventory -b</code></p>
<p>8. Use an ad hoc command to verify the service is running: <code>ansible ansible1 -a &quot;systemctl status httpd&quot; -i inventory -b</code></p>

  <footer class="footline">
  </footer>
</article>
<article class="default">
  <header class="headline">
  </header>

<h1 id="ansible-vault">Ansible Vault</h1>

<h3 id="ansible-vault">Ansible Vault</h3>
<ul>
<li>For webkeys, passwords, and other types of sensitive data that you really shouldn&rsquo;t store as plain text in a playbook.</li>
<li>Can use Ansible Vault to encrypt and decrypt sensitive data to make it unreadable, and only while accessing data does it ask for a password so that it is decrypted.</li>
</ul>
<p>1. Sensitive data is stored as values in variables in a separate variable file.
2. The variable file is encrypted, using the <strong>ansible-vault</strong> command.
3. While accessing the variable file from a playbook, you enter a password to decrypt.</p>
<h4 id="managing-encrypted-files">Managing Encrypted Files</h4>
<p><code>ansible-vault create secret.yaml</code></p>
<ul>
<li>Ansible Vault prompts for a password and then opens the file using the default editor.</li>
<li>The password can be provided in a password file.(must be really well protected (for example, by putting it in the user root home directory))</li>
<li>If a password file is used, the encrypted variable file can be created using <code>ansible-vault create \--vault-password-file=passfile secret.yaml</code></li>
</ul>
<p><code>ansible-vault encrypt</code></p>
<ul>
<li>encrypt one or more existing files.</li>
<li>The encrypted file can next be used from a playbook, where a password needs to be entered to decrypt.</li>
</ul>
<p><code>ansible-vault decrypt</code></p>
<ul>
<li>used to decrypt the file.</li>
</ul>
<p>Commonly used <strong>ansible-vault</strong> commands:
<code>create</code></p>
<ul>
<li>Creates new encrypted file
<code>encrypt</code></li>
<li>Encrypts an existing file
<code>encrypt_string</code></li>
<li>Encrypts a string
<code>decrypt</code></li>
<li>Decrypts an existing file
<code>rekey</code></li>
<li>Changes password on an existing file
<code>view</code></li>
<li>Shows contents of an existing file
<code>edit</code></li>
<li>Edits an existing encrypted file</li>
</ul>
<h4 id="using-vault-in-playbooks">Using Vault in Playbooks</h4>
<p><code>--vault-id @prompt</code></p>
<ul>
<li>When a Vault-encrypted file is accessed from a playbook, a password must be entered.</li>
<li>Has the <code>ansible-playbook</code> command prompt for a password for each of the Vault-encrypted files that may be used</li>
<li>Enables a playbook to work with multiple Vault-encrypted files where these files are allowed to have different passwords set.</li>
</ul>
<p><code>ansible-playbook --ask-vault-pass</code></p>
<ul>
<li>Used if all Vault-encrypted files a playbook refers to have the same password set.</li>
</ul>
<p><code>ansible-playbook --vault-password-file=secret</code></p>
<ul>
<li>Obtain the Vault password from a password file.</li>
<li>Password file should contain a string that is stored as a single line in the file.</li>
<li>Make sure the vault password file is protected through file permissions, such that it is not accessible by unauthorized users!</li>
</ul>
<h4 id="managing-files-with-sensitive-variables">Managing Files with Sensitive Variables</h4>
<ul>
<li>
<p>You should separate files containing unencrypted variables from files that contain encrypted variables.</p>
</li>
<li>
<p>Use <strong>group_vars</strong> and <strong>host_vars</strong> variable inclusion for this.</p>
</li>
<li>
<p>You may create a directory (instead of a file) with the name of the host or host group.</p>
</li>
<li>
<p>Within that directory you can create a file with the name <strong>vars</strong>, which contains unencrypted variables, and a file with the name <strong>vault</strong>, which contains Vault-encrypted variables.</p>
</li>
<li>
<p>Vault-encrypted variables can be included from a file using the <code>vars_files</code> parameter.</p>
</li>
</ul>
<h3 id="lab--working-with-ansible-vault">Lab:  Working with Ansible Vault</h3>
<p>1. Create a secret file containing encrypted values for a variable user and a variable password by using <code>ansible-vault create secrets.yaml</code></p>
<p>Set the password to <strong>password</strong> and enter the following lines:</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0"><code class="language-pre1" data-lang="pre1">username: bob
pwhash: password</code></pre></div>
<p>When creating users, you cannot provide the password in plain text; it needs to be provided as a hashed value.
Because this exercise focuses on the use of Vault, the password is not provided as a hashed value, and as a result, a warning is displayed. You may ignore this warning.</p>
<p>2. Create the file create-users.yaml and provide the following contents:</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0"><code class="language-pre1" data-lang="pre1">---
- name: create a user with vaulted variables
  hosts: ansible1
  vars_files:
    - secrets.yaml
  tasks:
  - name: creating user
    user:
      name: &#34;{{ username }}&#34;
      password: &#34;{{ pwhash }}&#34;</code></pre></div>
<p>3. Run the playbook by using <code>ansible-playbook --ask-vault-pass create-users.yaml</code></p>
<p>4. Change the current password on <strong>secrets.yaml</strong> by using <code>ansible-vault rekey secrets.yaml</code> and set the new password to
<strong>secretpassword</strong>.</p>
<p>5. To automate the process of entering the password, use <code>echo secretpassword &gt; vault-pass</code></p>
<p>6. Use <code>chmod 400 vault-pass</code> to ensure the file is readable for the ansible user only; this is about as much as you can do to secure the file.</p>
<p>7. Verify that it&rsquo;s working by using <code>ansible-playbook --vault-password-file=vault-pass create-users.yaml</code>
JunctionScallopPoise</p>

  <footer class="footline">
  </footer>
</article>
<article class="default">
  <header class="headline">
  </header>

<h1 id="variables">Variables</h1>

<p>Using and working with variables</p>
<ul>
<li>Capture command output using register</li>
</ul>
<h3 id="variables">Variables</h3>
<p>Three types of variables:</p>
<ul>
<li>Fact</li>
<li>Variable</li>
<li>Magic Variable</li>
</ul>
<p><strong>Variables</strong> make Ansible really flexible. Especially when used in combination with conditionals. These are defined at the discretion of the user.:</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span>- <span style="color:#ff6ac1">name</span>: create a user using a variable
</span></span><span style="display:flex;"><span>  <span style="color:#ff6ac1">hosts</span>: ansible1
</span></span><span style="display:flex;"><span>  <span style="color:#ff6ac1">vars</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">users</span>: lisa &lt;-- defaults value for this play
</span></span><span style="display:flex;"><span>  <span style="color:#ff6ac1">tasks</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#ff6ac1">name</span>: create a user {{ users }} on host {{ ansible_hostname }} &lt;-- ansible fact variable
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">user</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">name</span>: <span style="color:#5af78e">&#34;{{ users }}&#34;</span> &lt;-- If value starts with variable, the whole line must have double quotes</span></span></code></pre></div>
<h3 id="working-with-variables">Working with Variables</h3>
<ul>
<li>Variables can be used to refer to a wide range of dynamic data, such as names of files, services, packages, users, URLs to specific servers, etc.</li>
</ul>
<h4 id="defining-variables">Defining Variables</h4>
<p>To define a variable</p>
<ul>
<li>key: value structure in a vars section in the play header.</li>
</ul>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0"><code>    ---
    - name: using variables
      hosts: ansible1
      vars: &lt;-------------
        ftp_package: vsftpd &lt;------------
      tasks:
      - name: install package
        yum:
          name: &#34;{{ ftp_package }}&#34; &lt;------------
          state: latest</code></pre></div>
<ul>
<li>As the variable is the first item in the value, its name must be placed between double curly brackets as well as double quotes.</li>
</ul>
<p>Variable equirements:</p>
<p>â€¢ Must start with a letter.
â€¢ Case sensitive.
â€¢ Can contain only letters, numbers, and underscores.</p>
<h4 id="using-include-files">Using Include Files</h4>
<ul>
<li>It is common to define variables in include files. Specific host and host group variables can be used as include files</li>
<li>it&rsquo;s also possible to include an arbitrary file as a variable file, using the <strong>vars_files:</strong> statement.</li>
<li>The <strong>vars_files:</strong> parameter can have a single value or a list providing multiple values. If a list is used, each item needs to start with a dash</li>
<li>When you include variables from files, it&rsquo;s a good idea to work with a separate directory that contains all variables because that makes it easier to manage as your projects grow bigger.</li>
</ul>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0"><code>    ---
    - name: using a variable include file
      hosts: ansible1
      vars_files: vars/common &lt;--------------
      tasks:
      - name: install package
        yum:
          name: &#34;{{ my_package }}&#34; &lt;------------
          state: latest</code></pre></div>
<p><strong>vars/common</strong></p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0"><code>    my_package: nmap
    my_ftp_service: vsftpd
    my_file_service: smb</code></pre></div>
<ul>
<li>If variables are defined in individual playbooks, they are spread all over, and it may be difficult to get an overview of all variables that are used on a site.</li>
</ul>
<h4 id="managing-host-and-group-variables">Managing Host and Group Variables</h4>
<p><strong>host_vars</strong> and <strong>group_vars</strong></p>
<ul>
<li>set variables for specific hosts or specific host groups.</li>
<li>In older versions of Ansible, it was common to set host variables and group variables in inventory, but this practice is now deprecated.</li>
</ul>
<p><strong>host_vars</strong></p>
<ul>
<li>Must create a subdirectory with the name <strong>host_vars</strong> within the Ansible project directory.</li>
<li>In this directory, create a file that matches the inventory name of the host to which the variables should be applied.</li>
<li>So the variables for host ansible1 are defined in <strong>host_vars/ansible1</strong>.</li>
</ul>
<p><strong>group_vars</strong></p>
<ul>
<li>Must create a directory with the name <strong>group_vars</strong>.</li>
<li>In this directory, a file with the name of the host group is created, and in this file all variables are defined.</li>
<li>ie: <strong>group_vars/webservers</strong></li>
</ul>
<h3 id="lab-using-host-and-host-group-variables">LAB: Using Host and Host Group Variables</h3>
<p>1. Create a project directory in your home directory. Type <strong>mkdir ~/chapter6</strong> to create the chapter6 project directory, and use <strong>cd ~/chapter6</strong> to go into this directory.</p>
<p>2. Type <strong>cp ../ansible.cfg .</strong> to copy the ansible.cfg file that you used before. No further modifications to this file are required.</p>
<p>3. Type <strong>vim inventory</strong> to create a file with the name inventory, and ensure it has the following contents:</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0"><code class="language-pre1" data-lang="pre1">[webservers]
ansible1

[dbservers]
ansible2</code></pre></div>
<p>4. Create the file webservers.yaml, containing the following contents. Notice that nothing is really changed by running this playbook. It just uses the debug module to show the current value of the variables.</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0"><code class="language-pre1" data-lang="pre1">---
- name: configure web services
  hosts: webservers
  tasks:
  - name: this is the {{ web_package }} package
    debug:
      msg: &#34;Installing {{ web_package }}&#34;
  - name: this is the {{ web_service }} service
    debug:
      msg: &#34;Starting the {{ web_service }}&#34;</code></pre></div>
<p>5. Create the file group_vars/webservers with the following contents:</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0"><code class="language-pre1" data-lang="pre1">web_package: httpd
web_service: httpd</code></pre></div>
<p>6. Run the playbook with some verbosity to verify it is working by using <code>ansible-playbook -vv webservers.yaml</code></p>
<h4 id="using-multivalued-variables">Using Multivalued Variables</h4>
<p>Two types of multivalued variables:</p>
<p><strong>array</strong> (list)</p>
<ul>
<li>key that can have multiple items as its value.</li>
<li>Each item in a list starts with a dash (-).</li>
<li>Individual items in a list can be addressed using the index number (starting at zero), as in {{ users[1] }} (which would print the key-value pairs that are set for user lisa)</li>
</ul>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0"><code>    users:
      - linda:
        username: linda
        homedir: /home/linda
        shell: /bin/bash
      - lisa:
        username: lisa
        homedir: /home/lisa
        shell: /bin/bash
      - anna:
        username: anna
        homedir: /home/anna
        shell: /bin/bash</code></pre></div>
<p><strong>dictionary</strong> (hash)</p>
<ul>
<li>Unordered collection of items, a collection of key-value pairs.</li>
<li>In Python, a dictionary is defined as my_dict = { key1: &lsquo;car&rsquo;, key2:&lsquo;bike&rsquo; }.</li>
<li>Because it is based on Python, Ansible lets users use dictionaries as an alternative notation to arrays</li>
<li>not as common in use as arrays.</li>
<li>Items in values in a dictionary are not started with a dash.</li>
</ul>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0"><code>    users:
      linda:
        username: linda
        homedir: /home/linda
        shell: /bin/bash
      lisa:
        username: lisa
        homedir: /home/lisa
        shell: /bin/bash
      anna:
        username: anna
        homedir: /home/anna
        shell: /bin/bash</code></pre></div>
<p>Addressing Specific Keys in a Dictionary Multivalued Variable:</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0"><code>    ---
    - name: show dictionary also known as hash
      hosts: ansible1
      vars_files:
      - vars/users-dictionary
      tasks:
      - name: print dictionary values
        debug:
          msg: &#34;User {{ users.linda.username }} has homedirectory {{ users.linda.homedir }} and shell {{ users.linda.shell }}&#34;</code></pre></div>
<p>Using the Square Brackets Notation to Address Multivalued Variables (recommended method)</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0"><code>    ---
    - name: show dictionary also known as hash
      hosts: ansible1
      vars_files:
        - vars/users-dictionary
      tasks:
        - name: print dictionary values
          debug:
            msg: &#34;User {{ users[â€™lindaâ€™][â€™usernameâ€™] }} has homedirectory {{ users[â€™lindaâ€™][â€™homedirâ€™] }} and shell {{ users[â€™lindaâ€™][â€™shellâ€™]  }}&#34;</code></pre></div>
<p><strong>Magic Variables</strong></p>
<ul>
<li>Variables that are set automatically by Ansible to reflect an Ansible internal state.</li>
<li>There are about 30 magic variables</li>
<li>Common Magic Variables</li>
</ul>
<p><a href="#R-image-db5b102bfeaaeb38d20197aa6e84b777" class="lightbox-link"><img alt="Image" class="lazy lightbox figure-image" loading="lazy" src="/Images/06tab05.jpg" style="height: auto;width: auto;"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-db5b102bfeaaeb38d20197aa6e84b777"><img alt="Image" class="lazy lightbox lightbox-image" loading="lazy" src="/Images/06tab05.jpg"></a></p>
<ul>
<li>you cannot use their name for anything else.</li>
<li>If you try to set a magic variable to another value anyway, it always resets to the default internal value.</li>
</ul>
<p>Debug module can be used to show the current values assigned to the hostvars magic variable.</p>
<ul>
<li>Shows many settings that you can change by modifying the ansible.cfg configuration file.</li>
<li>If local facts are defined on the host, you will see them also.</li>
</ul>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0"><code>    [ansible@control ~]$ ansible localhost -m debug -a &#39;var=hostvars[&#34;ansible1&#34;]&#39;
    localhost | SUCCESS =&gt; {
        &#34;hostvars[\&#34;ansible1\&#34;]&#34;: {
            &#34;ansible_check_mode&#34;: false,
            &#34;ansible_diff_mode&#34;: false,
            &#34;ansible_facts&#34;: {},
            &#34;ansible_forks&#34;: 5,
            &#34;ansible_inventory_sources&#34;: [
                &#34;/home/ansible/inventory&#34;
            ],
            &#34;ansible_playbook_python&#34;: &#34;/usr/bin/python3.6&#34;,
            &#34;ansible_verbosity&#34;: 0,
            &#34;ansible_version&#34;: {
                &#34;full&#34;: &#34;2.9.5&#34;,
                &#34;major&#34;: 2,
                &#34;minor&#34;: 9,
                &#34;revision&#34;: 5,
                &#34;string&#34;: &#34;2.9.5&#34;
            },
            &#34;group_names&#34;: [
                &#34;ungrouped&#34;
            ],
            &#34;groups&#34;: {
                &#34;all&#34;: [
                    &#34;ansible1&#34;,
                    &#34;ansible2&#34;
                ],
                &#34;ungrouped&#34;: [
                    &#34;ansible1&#34;,
                    &#34;ansible2&#34;
                ]
            },
            &#34;inventory_dir&#34;: &#34;/home/ansible&#34;,
            &#34;inventory_file&#34;: &#34;/home/ansible/inventory&#34;,
            &#34;inventory_hostname&#34;: &#34;ansible1&#34;,
            &#34;inventory_hostname_short&#34;: &#34;ansible1&#34;,
            &#34;omit&#34;: &#34;__omit_place_holder__38849508966537e44da5c665d4a784c3bc0060de&#34;,
            &#34;playbook_dir&#34;: &#34;/home/ansible&#34;
        }
    }</code></pre></div>
<h4 id="variable-precedence">Variable Precedence</h4>
<ul>
<li>Avoid using variables with the same names that are defined at different levels.</li>
<li>If a variable with the same name is defined at different levels, the most specific variable always wins.</li>
<li>Variables that are defined while running the <strong>playbook</strong> command using the <strong>-e key=value</strong> command-line argument have the highest precedence.</li>
<li>After variables that are passed as command-line options, playbook variables are considered.</li>
<li>Next are variables that are defined for inventory hosts or host groups.</li>
<li>Consult the Ansible documentation item &ldquo;Variable precedence&rdquo; for more details and an overview of the 22 different levels where variables can be set and how precedence works for them.</li>
</ul>
<p>1. Variables passed on the command line
2. Variables defined in or included from a playbook
3. Inventory variables</p>
<h3 id="capturing-command-output-using-register">Capturing Command Output Using register</h3>
<p>The result of commands can also be used as a variable byusing the <strong>register</strong> parameter in a task.</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0"><code>    ---
    - name: test register
      hosts: ansible1
      tasks:
      - shell: cat /etc/passwd
        register: passwd_contents
      - debug:
          var: &#34;passwd_contents&#34;</code></pre></div>
<p>The <code>cat /etc/passwd</code> command is executed by the shell module. Notice that in this playbook no names are used for tasks. Using names for tasks is
not mandatory; it&rsquo;s just recommended in more complex playbooks because this convention makes identification of the tasks easier. The entire contents of the command are next stored in the variable <strong>passwd_contents</strong>.</p>
<p>This variable contains the output of the command, stored in different keys. <a href="/ansible/variables-and-facts/variables/#ch06.xhtml#tab6_7">Table 6-7</a> provides an overview of the most
useful keys, and <a href="/ansible/variables-and-facts/variables/#ch06.xhtml#list6_19">Listing 6-19</a> shows the partial result of the <code>ansible-playbook listing618.yaml</code> command.</p>
<p>Keys Used with <strong>register</strong>
cmd</p>
<ul>
<li>Command that was used
rc</li>
<li>Return code of the command
stderr</li>
<li>Error messages
stderr_lines</li>
<li>Errors line by line
stdout</li>
<li>command output
stdout_line</li>
<li>Command output line by line</li>
</ul>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0"><code>    [ansible@control ~]$ ansible-playbook listing618.yaml
    
    PLAY [test register] *******************************************************************
    
    TASK [Gathering Facts] *****************************************************************
    ok: [ansible2]
    ok: [ansible1]
    
    TASK [shell] ***************************************************************************
    changed: [ansible2]
    changed: [ansible1]
    
    TASK [debug] ***************************************************************************
    ok: [ansible1] =&gt; {
        &#34;passwd_contents&#34;: {
            &#34;changed&#34;: true,
            &#34;cmd&#34;: &#34;cat /etc/passwd&#34;,
            &#34;delta&#34;: &#34;0:00:00.004149&#34;,
            &#34;end&#34;: &#34;2020-04-02 02:28:10.692306&#34;,
            &#34;failed&#34;: false,
            &#34;rc&#34;: 0,
            &#34;start&#34;: &#34;2020-04-02 02:28:10.688157&#34;,
            &#34;stderr&#34;: &#34;&#34;,
            &#34;stderr_lines&#34;: [],
            &#34;stdout&#34;: &#34;root:x:0:0:root:/root:/bin/bash\nbin:x:1:1:bin:/bin:/sbin/nologin\ndaemon:x:2:2:daemon:/sbin:/sbin/nologin\nadm:x:3:4:adm:/var/adm:/sbin/nologin\nlp:x:4:7:lp:/var/spool/lpd:/sbin/nologin\nsync:x:5:0:sync:/sbin:/bin/sync\nshutdown:x:6:0:shutdown:/sbin:/sbin/shutdown\nhalt:x:7:0:halt:/sbin:/sbin/halt\nansible:x:1000:1000:ansible:/home/ansible:/bin/bash\napache:x:48:48:Apache:/usr/share/httpd:/sbin/nologin\nlinda:x:1002:1002::/home/linda:/bin/bash\nlisa:x:1003:1003::/home/lisa:/bin/bash&#34;,
            &#34;stdout_lines&#34;: [
                &#34;root:x:0:0:root:/root:/bin/bash&#34;,
                &#34;bin:x:1:1:bin:/bin:/sbin/nologin&#34;,
                &#34;daemon:x:2:2:daemon:/sbin:/sbin/nologin&#34;,
                &#34;adm:x:3:4:adm:/var/adm:/sbin/nologin&#34;,
                &#34;lp:x:4:7:lp:/var/spool/lpd:/sbin/nologin&#34;,
                &#34;sync:x:5:0:sync:/sbin:/bin/sync&#34;,
                &#34;shutdown:x:6:0:shutdown:/sbin:/sbin/shutdown&#34;,
                &#34;halt:x:7:0:halt:/sbin:/sbin/halt&#34;,
                &#34;ansible:x:1000:1000:ansible:/home/ansible:/bin/bash&#34;,
                &#34;apache:x:48:48:Apache:/usr/share/httpd:/sbin/nologin&#34;,
                &#34;linda:x:1002:1002::/home/linda:/bin/bash&#34;,
                &#34;lisa:x:1003:1003::/home/lisa:/bin/bash&#34;
            ]
        }
    }</code></pre></div>
<p>Ensure that a task runs only if a command produces a specific result by using <strong>register</strong> with conditionals.</p>
<p><strong>register</strong> shows the values that are returned by specific tasks. Tasks have common return values, but modules may have specific
return values. That means you cannot assume, based on the result of an example using a specific module, that the return values you see are
available for all modules. Consult the module documentation for more information about specific return values.</p>

  <footer class="footline">
  </footer>
</article>
          </section>
          </section>
        </div>
      </main>
    </div>
    <script>
      window.MathJax = Object.assign( window.MathJax || {}, {
        tex: {
          inlineMath:  [['\\(', '\\)'], ['$',  '$']],  
          displayMath: [['\\[', '\\]'], ['$$', '$$']], 
        },
        options: {
          enableMenu: false 
        }
      }, JSON.parse("{}") );
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="/js/js-yaml/js-yaml.min.js?1762537089" defer></script>
    <script src="/js/d3/d3-color.min.js?1762537089" defer></script>
    <script src="/js/d3/d3-dispatch.min.js?1762537089" defer></script>
    <script src="/js/d3/d3-drag.min.js?1762537089" defer></script>
    <script src="/js/d3/d3-ease.min.js?1762537089" defer></script>
    <script src="/js/d3/d3-interpolate.min.js?1762537089" defer></script>
    <script src="/js/d3/d3-selection.min.js?1762537089" defer></script>
    <script src="/js/d3/d3-timer.min.js?1762537089" defer></script>
    <script src="/js/d3/d3-transition.min.js?1762537089" defer></script>
    <script src="/js/d3/d3-zoom.min.js?1762537089" defer></script>
    <script src="https://unpkg.com/mermaid/dist/mermaid.min.js" defer></script>
    <script>
      window.relearn.themeUseMermaid = JSON.parse("{ \"theme\": \"default\" }");
    </script>
    <script src="/js/clipboard/clipboard.min.js?1762537089" defer></script>
    <script src="/js/perfect-scrollbar/perfect-scrollbar.min.js?1762537089" defer></script>
    <script src="/js/theme.min.js?1762537089" defer></script>
  </body>
</html>
