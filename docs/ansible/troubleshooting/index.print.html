<!DOCTYPE html>
<html lang="en-us" dir="ltr" itemscope itemtype="http://schema.org/Article" data-r-output-format="print">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="height=device-height, width=device-width, initial-scale=1.0, minimum-scale=1.0">
    <meta name="generator" content="Hugo 0.152.2">
    <meta name="generator" content="Relearn 8.0.0+9803d5122ebb3276acea823f476e9eb44f607862">
    <meta name="description" content="Ansible DocumentationAnsible Documentation resources
Managing Ansible Errors and LogsManaging Ansible Errors and Logs
Troubleshooting Common ScenariosTroubleshooting Common Scenarios
Using Modules for Troubleshooting and TestingUsing Modules for Troubleshooting and Testing
Using TagsUsing Tags">
    <meta name="author" content="David Thomas">
    <meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="Troubleshooting :: Linux Reader">
    <meta name="twitter:description" content="Ansible DocumentationAnsible Documentation resources
Managing Ansible Errors and LogsManaging Ansible Errors and Logs
Troubleshooting Common ScenariosTroubleshooting Common Scenarios
Using Modules for Troubleshooting and TestingUsing Modules for Troubleshooting and Testing
Using TagsUsing Tags">
    <meta property="og:url" content="http://linuxreader.com/ansible/troubleshooting/">
    <meta property="og:site_name" content="Linux Reader">
    <meta property="og:title" content="Troubleshooting :: Linux Reader">
    <meta property="og:description" content="Ansible DocumentationAnsible Documentation resources
Managing Ansible Errors and LogsManaging Ansible Errors and Logs
Troubleshooting Common ScenariosTroubleshooting Common Scenarios
Using Modules for Troubleshooting and TestingUsing Modules for Troubleshooting and Testing
Using TagsUsing Tags">
    <meta property="og:locale" content="en_us">
    <meta property="og:type" content="website">
    <meta itemprop="name" content="Troubleshooting :: Linux Reader">
    <meta itemprop="description" content="Ansible DocumentationAnsible Documentation resources
Managing Ansible Errors and LogsManaging Ansible Errors and Logs
Troubleshooting Common ScenariosTroubleshooting Common Scenarios
Using Modules for Troubleshooting and TestingUsing Modules for Troubleshooting and Testing
Using TagsUsing Tags">
    <meta itemprop="wordCount" content="32">
    <title>Troubleshooting :: Linux Reader</title>
    <link href="http://linuxreader.com/ansible/troubleshooting/" rel="canonical" type="text/html" title="Troubleshooting :: Linux Reader">
    <link href="/ansible/troubleshooting/index.xml" rel="alternate" type="application/rss+xml" title="Troubleshooting :: Linux Reader">
    <link href="/images/favicon.svg?1762453719" rel="icon" type="image/svg+xml">
    <link href="/css/auto-complete/auto-complete.min.css?1762453719" rel="stylesheet">
    <script src="/js/auto-complete/auto-complete.min.js?1762453719" defer></script>
    <script src="/js/search-lunr.min.js?1762453719" defer></script>
    <script src="/js/search.min.js?1762453719" defer></script>
    <script>
      window.relearn = window.relearn || {};
      window.relearn.index_js_url="/searchindex.en.js?1762453719";
    </script>
    <script src="/js/lunr/lunr.min.js?1762453719" defer></script>
    <script src="/js/lunr/lunr.stemmer.support.min.js?1762453719" defer></script>
    <script src="/js/lunr/lunr.multi.min.js?1762453719" defer></script>
    <script src="/js/lunr/lunr.en.min.js?1762453719" defer></script>
    <script>
      window.relearn = window.relearn || {};
      window.relearn.contentLangs=['en'];
    </script>
    <link href="/fonts/fontawesome/css/fontawesome-all.min.css?1762453719" rel="stylesheet" media="print" onload="this.media='all';this.onload=null;"><noscript><link href="/fonts/fontawesome/css/fontawesome-all.min.css?1762453719" rel="stylesheet"></noscript>
    <link href="/css/perfect-scrollbar/perfect-scrollbar.min.css?1762453719" rel="stylesheet">
    <link href="/css/theme.min.css?1762453719" rel="stylesheet">
    <link href="/css/format-print.min.css?1762453719" rel="stylesheet" id="R-format-style">
    <script>
      window.relearn = window.relearn || {};
      // configuration
      window.relearn.min = `.min`;
      window.relearn.path='\/ansible\/troubleshooting\/';
      window.relearn.relBasePath='..\/..';
      window.relearn.relBaseUri='..\/..';
      window.relearn.absBaseUri='http:\/\/linuxreader.com';
      window.relearn.disableAnchorCopy=false;
      window.relearn.disableAnchorScrolling=false;
      window.relearn.disableInlineCopyToClipboard=true;
      window.relearn.enableBlockCodeWrap=true;
      // legal
      window.relearn.getItem = (s,n) => {return s.getItem(n)};
      window.relearn.setItem = (s,n,v) => {return s.setItem(n,v)};
      window.relearn.removeItem = (s,n) => {return s.removeItem(n)};
      // translations
      window.T_Copy_to_clipboard = `Copy to clipboard`;
      window.T_Copied_to_clipboard = `Copied to clipboard!`;
      window.T_Copy_link_to_clipboard = `Copy link to clipboard`;
      window.T_Link_copied_to_clipboard = `Copied link to clipboard!`;
      window.T_Reset_view = `Reset view`;
      window.T_View_reset = `View reset!`;
      window.T_No_results_found = `No results found for "{0}"`;
      window.T_N_results_found = `{1} results found for "{0}"`;
      // variant stuff
      window.relearn.themevariants = [ 'oled' ];
      window.relearn.customvariantname = "my-custom-variant";
      window.relearn.changeVariant = function(variant) {
        var oldVariant = document.documentElement.dataset.rThemeVariant;
        window.relearn.setItem(window.localStorage, window.relearn.absBaseUri + "/variant", variant);
        document.documentElement.dataset.rThemeVariant = variant;
        if (oldVariant != variant) {
          document.dispatchEvent( new CustomEvent('themeVariantLoaded', { detail: { variant, oldVariant } }) );
          window.relearn.markVariant();
        }
      }
      window.relearn.markVariant = function() {
        var variant = window.relearn.getItem(window.localStorage, window.relearn.absBaseUri + "/variant");
        document.querySelectorAll(".R-variantswitcher select").forEach((select) => {select.value = variant;});
      }
      window.relearn.initVariant = function() {
        var variant = window.relearn.getItem(window.localStorage, window.relearn.absBaseUri + "/variant") ?? "";
        if( variant == window.relearn.customvariantname ){
        }else if( !variant || !window.relearn.themevariants.includes(variant) ){
          variant = window.relearn.themevariants[0];
          window.relearn.setItem(window.localStorage, window.relearn.absBaseUri + "/variant", variant);
        }
        document.documentElement.dataset.rThemeVariant = variant;
      }
      window.relearn.initVariant();
      window.relearn.markVariant();
    </script><style>
:root {
    --MENU-WIDTH-S: 14.375rem;
    --MENU-WIDTH-M: 14.375rem;
    --MENU-WIDTH-L: 18.75rem;
    --MAIN-WIDTH-MAX: 80rem;
    font-size: 1.2rem;
}
</style>

  </head>
  <body class="mobile-support print" data-url="/ansible/troubleshooting/">
    <div id="R-body" class="default-animation">
      <div id="R-body-overlay"></div>
      <nav id="R-topbar">
        <div class="topbar-wrapper">
          <div class="topbar-sidebar-divider"></div>
          <div class="topbar-area topbar-area-start" data-area="start">
            <div class="topbar-button topbar-button-sidebar" data-content-empty="disable" data-width-s="show" data-width-m="hide" data-width-l="hide"><button class="topbar-control" onclick="toggleNav()" type="button" title="Menu (CTRL&#43;ALT&#43;n)"><i class="fa-fw fas fa-bars"></i></button>
            </div>
            <div class="topbar-button topbar-button-prev" data-content-empty="disable" data-width-s="show" data-width-m="show" data-width-l="show"><a class="topbar-control" href="/ansible/task-control/using-when-to-run-tasks-conditionally/" title="Using when to Run Tasks Conditionally (ðŸ¡)"><i class="fa-fw fas fa-chevron-left"></i></a>
            </div>

            <div class="topbar-button topbar-button-toc" data-content-empty="hide" data-width-s="show" data-width-m="show" data-width-l="show"><button class="topbar-control" onclick="toggleTopbarFlyout(this)" type="button" title="Table of Contents (CTRL&#43;ALT&#43;t)"><i class="fa-fw fas fa-list-alt"></i></button>
              <div class="topbar-content">
                <div class="topbar-content-wrapper"> 
                </div>
              </div>
            </div>


          </div>
          <span class="topbar-breadcrumbs highlightable">
            Troubleshooting
          </span>
          <div class="topbar-area topbar-area-end" data-area="end">
            <div class="topbar-button topbar-button-print" data-content-empty="disable" data-width-s="area-more" data-width-m="show" data-width-l="show"><a class="topbar-control" href="/ansible/troubleshooting/index.print.html" title="Print whole chapter (CTRL+ALT+p)"><i class="fa-fw fas fa-print"></i></a>
            </div>

            <div class="topbar-button topbar-button-next" data-content-empty="disable" data-width-s="show" data-width-m="show" data-width-l="show"><a class="topbar-control" href="/ansible/troubleshooting/ansible-documentation/" title="Ansible Documentation (ðŸ¡’)"><i class="fa-fw fas fa-chevron-right"></i></a>
            </div>







          </div>
        </div>
      </nav>
      <div id="R-main-overlay"></div>
      <main id="R-body-inner" class="highlightable ansible" tabindex="-1">
        <div class="flex-block-wrapper">
<article class="default">
  <header class="headline">
  </header>

<h1 id="troubleshooting">Troubleshooting</h1>

<div class="children children-h6 children-sort-">
  <h6 class="children-title" id="ansible-documentation"><a href="/ansible/troubleshooting/ansible-documentation/">Ansible Documentation</a></h6><p>Ansible Documentation resources</p>
  <h6 class="children-title" id="managing-ansible-errors-and-logs"><a href="/ansible/troubleshooting/managing-ansible-errors-and-logs/">Managing Ansible Errors and Logs</a></h6><p>Managing Ansible Errors and Logs</p>
  <h6 class="children-title" id="troubleshooting-common-scenarios"><a href="/ansible/troubleshooting/troubleshooting-common-scenarios/">Troubleshooting Common Scenarios</a></h6><p>Troubleshooting Common Scenarios</p>
  <h6 class="children-title" id="using-modules-for-troubleshooting-and-testing"><a href="/ansible/troubleshooting/using-modules-for-troubleshooting-and-testing/">Using Modules for Troubleshooting and Testing</a></h6><p>Using Modules for Troubleshooting and Testing</p>
  <h6 class="children-title" id="using-tags"><a href="/ansible/troubleshooting/using-tags/">Using Tags</a></h6><p>Using Tags</p>
</div>

  <footer class="footline">
  </footer>
</article>
          <section>
            <h1 class="a11y-only">Subsections of Troubleshooting</h1>
<article class="default">
  <header class="headline">
  </header>

<h1 id="ansible-documentation">Ansible Documentation</h1>

<h2 id="ansible-navigator"><code>ansible-navigator</code></h2>
<p>Was advised to start using this tools for Ansible because it is available during the RHCE exam.
<a href="https://ansible.readthedocs.io/projects/navigator/" rel="external" target="_blank">https://ansible.readthedocs.io/projects/navigator/</a></p>
<h2 id="ansible-docs">Ansible Docs</h2>
<p><a href="https://docs.ansible.com/" rel="external" target="_blank">https://docs.ansible.com/</a></p>
<h2 id="ansible-doc"><code>ansible-doc</code></h2>
<p><a href="https://docs.ansible.com/ansible/latest/cli/ansible-doc.html" rel="external" target="_blank">https://docs.ansible.com/ansible/latest/cli/ansible-doc.html</a></p>

  <footer class="footline">
  </footer>
</article>
<article class="default">
  <header class="headline">
  </header>

<h1 id="managing-ansible-errors-and-logs">Managing Ansible Errors and Logs</h1>

<h3 id="managing-ansible-errors-and-logs">Managing Ansible Errors and Logs</h3>
<h4 id="using-check-mode">Using Check Mode</h4>
<p>Before actually running a playbook in a way that all changes are
implemented, you can start the playbooks in check mode. To do this, you
use the <strong>--check</strong> or <strong>-C</strong> command-line argument to the <strong>ansible</strong>
or <strong>ansible-playbook</strong> command. The effect of using check mode is that
changes that would have been made are shown but not executed. You should
realize, though, that check mode is not supported in all cases. You
will, for instance, have problems with check mode if it is applied to
conditionals, where a specific task can do its work only after a
preceding task has made some changes. Also, to successfully use check
mode, the modules need to support it, but some don&rsquo;t. Modules that don&rsquo;t
support check mode don&rsquo;t show any result while running check mode, but
also they don&rsquo;t make any changes.</p>
<p>Apart from the command-line argument, you can use <strong>check_mode: yes</strong> or
<strong>check_mode: no</strong> with any task in a playbook. If <strong>check_mode: yes</strong>
is used, the task always runs in check mode (and does not implement any
changes), regardless of the use of the <strong>--check</strong> option. If a task
has <strong>check_mode: no</strong> set, it never runs in check mode and just does
its work, even if the <strong>ansible-playbook</strong> command is used with the
<strong>--check</strong> option. Using check mode on individual tasks might be a
good idea if using check mode on the entire playbook gives unpredicted
results: you can enable it on just a couple of tasks to ensure that they
run successfully before proceeding to the next set of tasks. Notice that
using <strong>check_mode: no</strong> for specific tasks can be dangerous; these
tasks will make changes, even if the entire playbook was started with
the <strong>--check</strong> option!</p>
<p>::: note</p>
<hr>
<p><strong>Note</strong></p>
<p>The <strong>check_mode</strong> argument is a replacement for the <strong>always_run</strong>
option that was used in Ansible 2.5 and earlier. In current Ansible
versions, you should not use <strong>always_run</strong> anymore.</p>
<p>Another option that is commonly used with the <strong>--check</strong> option is
<strong>--diff</strong>. This option reports changes to template files without
actually applying them. <a href="/ansible/troubleshooting/managing-ansible-errors-and-logs/#ch11.xhtml#list11_1">Listing 11-1</a> shows a
sample playbook, <a href="/ansible/troubleshooting/managing-ansible-errors-and-logs/#ch11.xhtml#list11_2">Listing 11-2</a> shows the template
that it is processing, and <a href="/ansible/troubleshooting/managing-ansible-errors-and-logs/#ch11.xhtml#list11_3">Listing 11-3</a> shows
the result of running this playbook with the <strong>ansible-playbook
listing111.yaml --check --diff</strong> command.</p>
<hr>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>    ---
</span></span><span style="display:flex;"><span>    - <span style="color:#ff6ac1">name</span>: simple template example
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">hosts</span>: ansible2
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">tasks</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#ff6ac1">template</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#ff6ac1">src</span>: listing112.j2
</span></span><span style="display:flex;"><span>          <span style="color:#ff6ac1">dest</span>: /etc/issue
</span></span><span style="display:flex;"><span><span style="color:#ff6ac1">::</span>:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#78787e">**Listing</span> <span style="color:#ff9f43">11-2</span><span style="color:#78787e">**</span> Sample Template File
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff6ac1">::</span>: pre_1
</span></span><span style="display:flex;"><span>    {<span style="color:#78787e"># /etc/issue #}</span>
</span></span><span style="display:flex;"><span>    Welcome to {{ ansible_facts[â€™hostnameâ€™] }}
</span></span><span style="display:flex;"><span><span style="color:#ff6ac1">::</span>:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#78787e">**Listing</span> <span style="color:#ff9f43">11-3</span><span style="color:#78787e">**</span> Running the listing111.yaml Sample Playbook
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff6ac1">::</span>: pre_1
</span></span><span style="display:flex;"><span>    [ansible@control rhce8-book]$ ansible-playbook listing111.yaml --check --diff
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    PLAY [simple template example] *************************************************
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    TASK [Gathering Facts] *********************************************************
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">ok</span>: [ansible2]
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    TASK [template] ****************************************************************
</span></span><span style="display:flex;"><span>    --- before
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">+++ after</span>: /home/ansible/.ansible/tmp/ansible-local-4493uxbpju1e/tmpm5gn7crg/listing112.j2
</span></span><span style="display:flex;"><span>    @@ -<span style="color:#ff9f43">0</span>,<span style="color:#ff9f43">0</span> +1,3 @@
</span></span><span style="display:flex;"><span>    +Welcome to ansible2
</span></span><span style="display:flex;"><span>    +
</span></span><span style="display:flex;"><span>    +
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">changed</span>: [ansible2]
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    PLAY RECAP *********************************************************************
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">ansible2                   </span>: ok=2    changed=1    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0</span></span></code></pre></div>
<h4 id="understanding-output">Understanding Output</h4>
<p>When you run the <strong>ansible-playbook</strong> command, output is generated.
You&rsquo;ve probably had a glimpse of it before, but let&rsquo;s look at the output
in a more structured way now. <a href="/ansible/troubleshooting/managing-ansible-errors-and-logs/#ch11.xhtml#list11_4">Listing 11-4</a> shows
some typical sample output generated by running the <strong>ansible-playbook</strong>
command.</p>
<p><strong>Listing 11-4 ansible-playbook</strong> Command Output</p>
<p>::: pre_1
[ansible@control rhce8-book]$ ansible-playbook listing52.yaml</p>
<pre><code>PLAY [install start and enable httpd] ******************************************

TASK [Gathering Facts] *********************************************************
ok: [ansible2]
ok: [ansible1]
ok: [ansible3]
ok: [ansible4]

TASK [install package] *********************************************************
changed: [ansible2]
changed: [ansible1]
changed: [ansible3]
changed: [ansible4]

TASK [start and enable service] ************************************************
changed: [ansible2]
changed: [ansible1]
changed: [ansible3]
changed: [ansible4]

PLAY RECAP *********************************************************************
ansible1                   : ok=3    changed=2    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0
ansible2                   : ok=3    changed=2    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0
ansible3                   : ok=3    changed=2    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0
ansible4                   : ok=3    changed=2    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0
</code></pre>
<p>:::</p>
<p>In the output of any <strong>ansible-playbook</strong> command, you can see different
items:</p>
<p><a href="#R-image-af2e4ecd03516270298cb1c4f8690fa5" class="lightbox-link"><img alt="Image" class="lazy lightbox figure-image" loading="lazy" src="/Images/key_topic_icon.jpg" style=" height: auto; width: auto;"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-af2e4ecd03516270298cb1c4f8690fa5"><img alt="Image" class="lazy lightbox lightbox-image" loading="lazy" src="/Images/key_topic_icon.jpg"></a>{width=&ldquo;64&rdquo; height=&ldquo;51&rdquo;}</p>
<p>â€¢ An indicator of the play that is started</p>
<p>â€¢ If not disabled, the Gathering Facts task that is executed for each
play</p>
<p>â€¢ Each individual task, including the task name if that was specified</p>
<p>â€¢ The Play Recap, which summarizes the play results</p>
<p>In the Play Recap, different results can be shown. <a href="/ansible/troubleshooting/managing-ansible-errors-and-logs/#ch11.xhtml#tab11_2">Table
11-2</a> gives an overview.</p>
<p>::: group
<strong>Table 11-2</strong> Playbook Recap Overview</p>
<p><a href="#R-image-2fcdfb0f2cce7558ed3adac89870425f" class="lightbox-link"><img alt="Image" class="lazy lightbox figure-image" loading="lazy" src="/Images/11tab02.jpg" style=" height: auto; width: auto;"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-2fcdfb0f2cce7558ed3adac89870425f"><img alt="Image" class="lazy lightbox lightbox-image" loading="lazy" src="/Images/11tab02.jpg"></a>{width=&ldquo;941&rdquo; height=&ldquo;338&rdquo;}
:::</p>
<p>As discussed before, when you use the <strong>ansible-playbook</strong> command, you
can increase the output verbosity level using one or more <strong>-v</strong>
options. <a href="/ansible/troubleshooting/managing-ansible-errors-and-logs/#ch11.xhtml#tab11_3">Table 11-3</a> lists what these options
accomplish. For generic troubleshooting, you might want to consider
using <strong>-vv</strong>, which shows output as well as input data. In particular
cases using the <strong>-vvv</strong> option can be useful because it adds connection
information as well.</p>
<p>The <strong>-vvvv</strong> option just brings too much information in many cases but
can be useful if you need to analyze which exact scripts are executed or
whether any problems were encountered in privilege escalation. Make sure
to capture the output of any command that runs with <strong>-vvvv</strong> to a text
file, though, so that you can read it in an easy way. Even for a simple
playbook, it can easily generate more than 10 screens of output.</p>
<p>::: group
<strong>Table 11-3</strong> Verbosity Options Overview</p>
<p><a href="#R-image-fb36c1b835e9662a89f037d947c56a0d" class="lightbox-link"><img alt="Image" class="lazy lightbox figure-image" loading="lazy" src="/Images/11tab03.jpg" style=" height: auto; width: auto;"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-fb36c1b835e9662a89f037d947c56a0d"><img alt="Image" class="lazy lightbox lightbox-image" loading="lazy" src="/Images/11tab03.jpg"></a>{width=&ldquo;941&rdquo; height=&ldquo;209&rdquo;}
:::</p>
<p>In <a href="/ansible/troubleshooting/managing-ansible-errors-and-logs/#ch11.xhtml#list11_5">Listing 11-5</a> you can see the output of a
small playbook that runs different tasks on the managed hosts. <a href="/ansible/troubleshooting/managing-ansible-errors-and-logs/#ch11.xhtml#list11_5">Listing
11-5</a> shows details about execution of one task on
host ansible4, and as you can see, it goes deep in the amount of detail
that is shown. One component is worth looking at, and that is the
escalation succeeded that you can see in the output. This means that
privilege escalation was successful and tasks were executed because
<strong>become_user</strong> was defined in ansible.cfg. Failing privilege escalation
is one of the common reasons why playbook execution may go wrong, which
is why it&rsquo;s worth keeping an eye on this indicator.</p>
<p><strong>Listing 11-5</strong> Analyzing Partial <strong>-vvvv</strong> Output</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0"><code>    &lt;ansible4&gt; ESTABLISH SSH CONNECTION FOR USER: ansible
    &lt;ansible4&gt; SSH: EXEC ssh -vvv -C -o ControlMaster=auto -o ControlPersist=60s -o StrictHostKeyChecking=no -o KbdInteractiveAuthentication=no -o PreferredAuthentications=gssapi-with-mic,gssapi-keyex,hostbased,publickey -o PasswordAuthentication=no -o â€™User=&#34;ansible&#34;â€™ -o ConnectTimeout=10 -o ControlPath=/home/ansible/.ansible/cp/859d5267e3 ansible4 â€™/bin/sh -c â€™&#34;â€™&#34;â€™chmod u+x /home/ansible/.ansible/tmp/ansible-tmp-1587544652.4716983-118789810824208/ /home/ansible/.ansible/tmp/ansible-tmp-1587544652.4716983-118789810824208/AnsiballZ_systemd.py &amp;&amp; sleep 0â€™&#34;â€™&#34;â€™â€™
    Escalation succeeded
    &lt;ansible4&gt; (0, bâ€™â€™, b&#34;OpenSSH_8.0p1, OpenSSL 1.1.1c FIPS  28 May 2019\r\ndebug1: Reading configuration data /etc/ssh/ssh_config\r\ndebug3: /etc/ssh/ssh_config line 51: Including file /etc/ssh/ssh_config.d/05-redhat.conf depth 0\r\ndebug1: Reading configuration data /etc/ssh/ssh_config.d/05-redhat.conf\r\ndebug2: checking match for â€™final allâ€™ host ansible4 originally ansible4\r\ndebug3: /etc/ssh/ssh_config.d/05-redhat.conf line 3: not matched â€™finalâ€™\r\ndebug2: match not found\r\ndebug3: /etc/ssh/ssh_config.d/05-redhat.conf line 5: Including file /etc/crypto-policies/back-ends/openssh.config depth 1 (parse only)\r\ndebug1: Reading configuration data /etc/crypto-policies/back-ends/openssh.config\r\ndebug3: gss kex names ok: [gss-gex-sha1-,gss-group14-sha1-]\r\ndebug3: kex names ok: [curve25519-sha256,curve25519-sha256@libssh.org,ecdh-sha2-nistp256,ecdh-sha2-nistp384,ecdh-sha2-nistp521,diffie-hellman-group-exchange-sha256,diffie-hellman-group14-sha256,diffie-hellman-group16-sha512,diffie-hellman-group18-sha512,diffie-hellman-group-exchange-sha1,diffie-hellman-group14-sha1]\r\ndebug1: configuration requests final Match pass\r\ndebug1: re-parsing configuration\r\ndebug1: Reading configuration data /etc/ssh/ssh_config\r\ndebug3: /etc/ssh/ssh_config line 51: Including file /etc/ssh/ssh_config.d/05-redhat.conf depth 0\r\ndebug1: Reading configuration data /etc/ssh/ssh_config.d/05-redhat.conf\r\ndebug2: checking match for â€™final allâ€™ host ansible4 originally ansible4\r\ndebug3: /etc/ssh/ssh_config.d/05-redhat.conf line 3: matched â€™finalâ€™\r\ndebug2: match found\r\ndebug3: /etc/ssh/ssh_config.d/05-redhat.conf line 5: Including file /etc/crypto-policies/back-ends/openssh.config depth 1\r\ndebug1: Reading configuration data /etc/crypto-policies/back-ends/openssh.config\r\ndebug3: gss kex names ok: [gss-gex-sha1-,gss-group14-sha1-]\r\ndebug3: kex names ok: [curve25519-sha256,curve25519-sha256@libssh.org,ecdh-sha2-nistp256,ecdh-sha2-nistp384,ecdh-sha2-nistp521,diffie-hellman-group-exchange-sha256,diffie-hellman-group14-sha256,diffie-hellman-group16-sha512,diffie-hellman-group18-sha512,diffie-hellman-group-exchange-sha1,diffie-hellman-group14-sha1]\r\ndebug1: auto-mux: Trying existing master\r\ndebug2: fd 4 setting O_NONBLOCK\r\ndebug2: mux_client_hello_exchange: master version 4\r\ndebug3: mux_client_forwards: request forwardings: 0 local, 0 remote\r\ndebug3: mux_client_request_session: entering\r\ndebug3: mux_client_request_alive: entering\r\ndebug3: mux_client_request_alive: done pid = 4764\r\ndebug3: mux_client_request_session: session request sent\r\ndebug3: mux_client_read_packet: read header failed: Broken pipe\r\ndebug2: Received exit status from master 0\r\n&#34;)
    &lt;ansible4&gt; ESTABLISH SSH CONNECTION FOR USER: ansible
    &lt;ansible4&gt; SSH: EXEC ssh -vvv -C -o ControlMaster=auto -o ControlPersist=60s -o StrictHostKeyChecking=no -o KbdInteractiveAuthentication=no -o PreferredAuthentications=gssapi-with-mic,gssapi-keyex,hostbased,publickey -o PasswordAuthentication=no -o â€™User=&#34;ansible&#34;â€™ -o ConnectTimeout=10 -o ControlPath=/home/ansible/.ansible/cp/859d5267e3 -tt ansible4 â€™/bin/sh -c â€™&#34;â€™&#34;â€™sudo -H -S -n  -u root /bin/sh -c â€™&#34;â€™&#34;â€™&#34;â€™&#34;â€™&#34;â€™&#34;â€™&#34;â€™&#34;â€™echo BECOME-SUCCESS-muvtpdvqkslnlegyhoibfcrilvlyjcqp ; /usr/libexec/platform-python /home/ansible/.ansible/tmp/ansible-tmp-1587544652.4716983-118789810824208/AnsiballZ_systemd.pyâ€™&#34;â€™&#34;â€™&#34;â€™&#34;â€™&#34;â€™&#34;â€™&#34;â€™&#34;â€™ &amp;&amp; sleep 0â€™&#34;â€™&#34;â€™â€™
    Escalation succeeded</code></pre></div>
<h4 id="optimizing-command-output-error-formatting">Optimizing Command Output Error Formatting</h4>
<p>You might have noticed that the formatting of error messages in Ansible
command output can be a bit hard to read. Fortunately, there&rsquo;s an easy
way to make it a little more readable by including two options in the
ansible.cfg file. These options are <strong>stdout_callback = debug</strong> and
<strong>stdout_callback = error</strong>. After including these options, you&rsquo;ll
notice it&rsquo;s a lot easier to read error output and distinguish between
its different components!</p>
<h4 class="h4" id="logging-to-files">Logging to Files</h4>
<p>By default, Ansible does not write anything to log files. The reason is
that the Ansible commands have all the options that may be useful to
write output to the STDOUT. If so required, it&rsquo;s always possible to use
shell redirection to write the command output to a file.</p>
<p>If you do need Ansible to write log files, you can set the <strong>log_path</strong>
parameter in ansible.cfg. Alternatively, Ansible can log to the filename
that is specified as the argument to the $ANSIBLE_LOG_PATH variable.
Notice that Ansible logs can grow big very fast, so if logging to output
files is enabled, make sure that Linux log rotation is configured to
ensure that files cannot grow beyond a specific maximum size.</p>
<h4 class="h4" id="running-task-by-task">Running Task by Task</h4>
<p>When you analyze playbook behavior, it&rsquo;s possible to run playbook tasks
one by one or to start running a playbook at a specific task. The
<strong>ansible-playbook --step</strong> command runs playbooks task by task and
prompts for confirmation before running the next task. Alternatively,
you can use the <strong>ansible-playbook --start-at-task=&quot;task name&quot;</strong>
command to start playbook execution as a specific task. Before using
this command, you might want to use <strong>ansible-playbook --list-tasks</strong>
for a list of all tasks that have been configured. To use these options
in an efficient way, you must configure each task with its own name. In
<a href="/ansible/troubleshooting/managing-ansible-errors-and-logs/#ch11.xhtml#list11_6">Listing 11-6</a> you can see what running playbooks
this way looks like. This listing first shows how to list tasks in a
playbook and next how the <strong>--start-at-task</strong> and <strong>--step</strong> options
are used.</p>
<p><strong>Listing 11-6</strong> Running Tasks One by One</p>
<p>::: pre_1
[ansible@control rhce8-book]$ ansible-playbook &ndash;list-tasks exercise81.yaml</p>
<pre><code>playbook: exercise81.yaml

  play #1 (ansible1): testing file manipulation skills.    TAGS: []
    tasks:
      create a new file              TAGS: []
      check status of the new file   TAGS: []
      for debugging purposes only    TAGS: []
      change file owner if needed    TAGS: []

  play #2 (ansible1): fetching a remote file.    TAGS: []
    tasks:
      fetch file from remote machine.    TAGS: []

  play #3 (localhost): adding text to the file that is now on localhost TAGS: []
    tasks:
      add a message.    TAGS: []

  play #4 (ansible2): copy the modified file to ansible2.    TAGS: []
    tasks:
      copy motd file.    TAGS: []
[ansible@control rhce8-book]$ ansible-playbook --start-at-task &quot;add a message&quot;  --step exercise81.yaml

PLAY [testing file manipulation skills] ****************************************

PLAY [fetching a remote file] **************************************************

PLAY [adding text to the file that is now on localhost] ************************
Perform task: TASK: Gathering Facts (N)o/(y)es/(c)ontinue:
</code></pre>
<p>:::</p>
<p>In <a href="/ansible/troubleshooting/managing-ansible-errors-and-logs/#ch11.xhtml#exe11_1">Exercise 11-1</a> you learn how to apply check
mode while working with templates.</p>
<p>::: box
<strong>Exercise 11-1 Using Templates in Check Mode</strong></p>
<p>1. Locate the file httpd.conf; you can find it in the rhce8-book
directory, which you can download from the GitHub repository at
<a href="https://github.com/sandervanvugt/rhce8-book" rel="external" target="_blank">https://github.com/sandervanvugt/rhce8-book</a>. Use <strong>mv httpd.conf
exercise111-httpd.j2</strong> to rename it to a Jinja2 template file.</p>
<p>2. Open the exercise111-httpd.j2 file with an editor, and apply
modifications to existing parameters so that they look like the
following:</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0"><code class="language-pre1" data-lang="pre1">ServerRoot &#34;{{ apache_root }}&#34;
User {{ apache_user }}
Group {{ apache_group }}</code></pre></div>
<p>3. Write a playbook that takes care of the complete Apache web server
setup and installation, starts and enables the service, opens a port in
the firewall, and uses the template module to create the
/etc/httpd/conf/httpd.conf file based on the template that you created
in step 2 of this exercise. The complete playbook with the name
exercise111.yaml looks like the following (make sure you have the
<em>exact</em> contents shown below and do <em>not</em> correct any typos):</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0"><code class="language-pre1" data-lang="pre1">---
- name: perform basic apache setup
  hosts: ansible2
  vars:
    apache_root: /etc/httpd
    apache_user: httpd
    apache_group: httpd
  tasks:
  - name: install RPM package
    yum:
      name: httpd
      state: latest
  - name: copy template file
    template:
      src: exercise111-httpd.j2
      dest: /etc/httpd/httpd.conf
  - name: start and enable service
    service:
      name: httpd
      state: started
      enabled: yes
  - name: open port in firewall
    firewalld:
      service: http
      permanent: yes
      state: enabled
      immediate: yes</code></pre></div>
<p>4. Run the command <strong>ansible-playbook --syntax-check
exercise111.yaml</strong>. If no errors are found in the playbook syntax, you
should just see the name of the playbook.</p>
<p>5. Run the command <strong>ansible-playbook --check --diff
exercise111.yaml</strong>. In the output of the command, pay attention to the
task copy template file. After the line that starts with <strong>+++ after</strong>,
you should see the lines in the template that were configured to use a
variable, using the right variables.</p>
<p>6. Run the playbook to perform all its tasks step by step, using the
command <strong>ansible-playbook --step exercise111.yaml</strong>. Press <strong>y</strong> to
confirm the first step. Next, press <strong>c</strong> to automatically continue. The
playbook will fail on the copy template file task because the target
directory does not exist. Notice that the <strong>--syntax-check</strong> and the
<strong>--check</strong> options do not check for any logical errors in the playbook
and for that reason have not detected this problem.</p>
<p>7. Edit the exercise111.yaml file and ensure the <strong>template</strong> task
contains the following corrected line: (replace the old line starting
with <strong>dest:</strong>):</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0"><code class="language-pre1" data-lang="pre1">dest: /etc/httpd/conf/httpd.conf</code></pre></div>
<p>8. Type <strong>ansible-playbook --list-tasks exercise111.yaml</strong> to list all
the tasks in the playbook.</p>
<p>9. To avoid running the entire playbook again, use <strong>ansible-playbook
--start-at-task=&quot;copy template file&quot; exercise111.yaml</strong> to run the
playbook to completion.
:::</p>

  <footer class="footline">
  </footer>
</article>
<article class="default">
  <header class="headline">
  </header>

<h1 id="troubleshooting-common-scenarios">Troubleshooting Common Scenarios</h1>

<h3 id="troubleshooting-common-scenarios">Troubleshooting Common Scenarios</h3>
<p>Apart from the problems that may arise in playbooks, another type of
error relates to connectivity issues. To connect to managed hosts, SSH
must be configured correctly, and also authentication and privilege
escalation must work as expected.</p>
<h4 class="h4" id="analyzing-connectivity-issues">Analyzing Connectivity Issues</h4>
<p>To be able to connect to a managed host, you need to have an IP network
connection. Apart from that, you need to make sure that the host has
been set up correctly:</p>
<p>â€¢ The SSH service needs to be accessible on the remote host.</p>
<p>â€¢ Python must be installed.</p>
<p>â€¢ Privilege escalation needs to be set up.</p>
<p>Apart from these, inventory settings may be specified to indicate how to
connect to a remote host. Normally, the inventory contains a host name
only. If a host resolves to multiple IP addresses, you may want to
specify how exactly the remote host must be connected to. The
<strong>ansible_host</strong> parameter can be configured to do so. In inventory, for
instance, you may include the following line to ensure that your host is
connected in the right way:</p>
<pre><code>ansible5.example.com ansible_host=192.168.4.55
</code></pre>
<p>Notice that this setting makes sense only in an environment where a host
can be reached on multiple different IP addresses.</p>
<p>To test connectivity to remote hosts, you can use the ping module. It
checks for IP connectivity, accessibility of the SSH service, sudo
privilege escalation, and the availability of a Python stack. The ping
module does not take any arguments. <a href="/ansible/troubleshooting/troubleshooting-common-scenarios/#ch11.xhtml#list11_18">Listing
11-18</a> shows the result of running on the ad hoc
command <strong>ansible all -m ping</strong> where hosts that are available send
&ldquo;pong&rdquo; as a reply, and for hosts that are not available, you see why
they are not available.</p>
<p><strong>Listing 11-18</strong> Verifying Connectivity Using the ping Module</p>
<p>::: pre_1
[ansible@control rhce8-book]$ ansible all -m ping
ansible2 | SUCCESS =&gt; {
&ldquo;ansible_facts&rdquo;: {
&ldquo;discovered_interpreter_python&rdquo;: &ldquo;/usr/libexec/platform-python&rdquo;
},
&ldquo;changed&rdquo;: false,
&ldquo;ping&rdquo;: &ldquo;pong&rdquo;
}
ansible1 | SUCCESS =&gt; {
&ldquo;ansible_facts&rdquo;: {
&ldquo;discovered_interpreter_python&rdquo;: &ldquo;/usr/libexec/platform-python&rdquo;
},
&ldquo;changed&rdquo;: false,
&ldquo;ping&rdquo;: &ldquo;pong&rdquo;
}
ansible3 | SUCCESS =&gt; {
&ldquo;ansible_facts&rdquo;: {
&ldquo;discovered_interpreter_python&rdquo;: &ldquo;/usr/libexec/platform-python&rdquo;
},
&ldquo;changed&rdquo;: false,
&ldquo;ping&rdquo;: &ldquo;pong&rdquo;
}
ansible4 | FAILED! =&gt; {
&ldquo;msg&rdquo;: &ldquo;Missing sudo password&rdquo;
}
:::</p>
<h4 class="h4" id="analyzing-authentication-issues">Analyzing Authentication Issues</h4>
<p>A few settings play a role in authentication on the remote host to
execute tasks:</p>
<p><a href="#R-image-59916467578dd7a61c6539be4b0066de" class="lightbox-link"><img alt="Image" class="lazy lightbox figure-image" loading="lazy" src="/Images/key_topic_icon.jpg" style=" height: auto; width: auto;"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-59916467578dd7a61c6539be4b0066de"><img alt="Image" class="lazy lightbox lightbox-image" loading="lazy" src="/Images/key_topic_icon.jpg"></a>{width=&ldquo;64&rdquo; height=&ldquo;51&rdquo;}</p>
<p>â€¢ The <strong>remote_user</strong> setting determines which user account to use on
the managed nodes.</p>
<p>â€¢ SSH keys need to be configured for the remote_user to enable smooth
authentication.</p>
<p>â€¢ The <strong>become</strong> parameter needs to be set to true.</p>
<p>â€¢ The <strong>become_user</strong> needs to be set to the root user account.</p>
<p>â€¢ Linux sudo needs to be set up correctly.</p>
<p>In <a href="/ansible/troubleshooting/troubleshooting-common-scenarios/#ch11.xhtml#exe11_4">Exercise 11-4</a> you work on troubleshooting some
common scenarios.</p>
<p>::: box
<strong>Exercise 11-4 Troubleshooting Connectivity Issues</strong></p>
<p>1. Use an editor to create the file exercise114-1.yaml and give it the
following contents:</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0"><code class="language-pre1" data-lang="pre1">---
- name: remove user from wheel group
  hosts: ansible4
  tasks:
  - user:
      name: ansible
      groups: â€™â€™</code></pre></div>
<p>2. Run the playbook using <strong>ansible-playbook exercise114-1.yaml</strong> and
use <strong>ansible ansible4 -m reboot</strong> to reboot node ansible4.</p>
<p>3. Once the reboot is completed, use <strong>ansible all -m ping</strong> to verify
connectivity. Host ansible4 should give a &ldquo;Missing sudo password&rdquo; error.</p>
<p>4. Type <strong>ansible ansible4 -m raw -a &ldquo;usermod -aG wheel ansible&rdquo; -u
root -k</strong> to make user ansible a member of the group wheel again.</p>
<p>5. Repeat the <strong>ansible all -m ping</strong> command. You should now be able
to connect normally to the host ansible4 again.
:::</p>

  <footer class="footline">
  </footer>
</article>
<article class="default">
  <header class="headline">
  </header>

<h1 id="using-modules-for-troubleshooting-and-testing">Using Modules for Troubleshooting and Testing</h1>

<h3 id="using-modules-for-troubleshooting-and-testing">Using Modules for Troubleshooting and Testing</h3>
<p>While working with playbooks, you may use different modules for
troubleshooting. The debug module was used in previous chapters and is
particularly useful for analyzing variable behavior. Some other modules
may prove useful when troubleshooting Ansible. <a href="/ansible/troubleshooting/using-modules-for-troubleshooting-and-testing/#ch11.xhtml#tab11_4">Table
11-4</a> gives an overview.</p>
<p>::: group
<strong>Table 11-4</strong> Troubleshooting Modules Overview</p>
<p><a href="#R-image-736ea0336763ed64f6eb27123ead2933" class="lightbox-link"><img alt="Image" class="lazy lightbox figure-image" loading="lazy" src="Images/11tab04.jpg" style=" height: auto; width: auto;"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-736ea0336763ed64f6eb27123ead2933"><img alt="Image" class="lazy lightbox lightbox-image" loading="lazy" src="Images/11tab04.jpg"></a> {width=&ldquo;940&rdquo; height=&ldquo;295&rdquo;}
:::</p>
<p>The following sections discuss how these modules can be used.</p>
<h4 class="h4" id="using-the-debug-module">Using the Debug Module</h4>
<p>The debug module is useful to visualize what is happening at a certain
point in a playbook. It works with two arguments: the <strong>msg</strong> argument
can be used to print a message, and the <strong>var</strong> argument can be used to
print the value of a variable. Notice that when you use the <strong>var</strong>
argument, the variable does not have to be referred to using the usual
<strong>{{ varname }}</strong> structure, just use <strong>varname</strong> instead. If variables
are used in the <strong>msg</strong> argument, they must be referred to the normal
way, using the <strong>{{ varname }}</strong> syntax.</p>
<p>Because you have already seen the debug module in action in numerous
examples in Chapters 6, 7, and 8 of this book, no new examples are
included here.</p>
<h4 class="h4" id="using-the-uri-module">Using the uri Module</h4>
<p>The best way to learn how to work with these modules is to look at some
examples. <a href="/ansible/troubleshooting/using-modules-for-troubleshooting-and-testing/#ch11.xhtml#list11_7">Listing 11-7</a> shows an example where
the uri module is used.</p>
<p><strong>Listing 11-7</strong> Using the uri Module</p>
<p>::: pre_1
&mdash;
- name: test webserver access
hosts: localhost
become: no
tasks:
- name: connect to the web server
uri:
url: <a href="http://ansible2.example.com" rel="external" target="_blank">http://ansible2.example.com</a>
return_content: yes
register: this
failed_when: &ldquo;â€™welcomeâ€™ not in this.content&rdquo;
- debug:
var: this.content
:::</p>
<p>The playbook in <a href="/ansible/troubleshooting/using-modules-for-troubleshooting-and-testing/#ch11.xhtml#list11_7">Listing 11-7</a> uses the uri module
to connect to a web server. The <strong>return_content</strong> argument captures the
web server content, which is stored in a variable using <strong>register</strong>.
Next, the <strong>failed_when</strong> statement makes this module fail if the text
&ldquo;welcome&rdquo; is not in the registered variable. For debugging purposes, the
debug module is used to show the contents of the variable.</p>
<p>In <a href="/ansible/troubleshooting/using-modules-for-troubleshooting-and-testing/#ch11.xhtml#list11_8">Listing 11-8</a> you can see the partial result
of running this playbook. Notice that the playbook does not generate a
failure because the default web page that is shown by the Apache web
server contains the text &ldquo;welcome.&rdquo;</p>
<p><strong>Listing 11-8 ansible-playbook listing117.yaml</strong> Command Result</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#ff6ac1">[</span>ansible@control rhce8-book<span style="color:#ff6ac1">]</span>$ ansible-playbook listing117.yaml
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    PLAY <span style="color:#ff6ac1">[</span><span style="color:#ff5c57">test</span> webserver access<span style="color:#ff6ac1">]</span> ***************************************************
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    TASK <span style="color:#ff6ac1">[</span>Gathering Facts<span style="color:#ff6ac1">]</span> *********************************************************
</span></span><span style="display:flex;"><span>    ok: <span style="color:#ff6ac1">[</span>localhost<span style="color:#ff6ac1">]</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    TASK <span style="color:#ff6ac1">[</span>connect to the web server<span style="color:#ff6ac1">]</span> ***********************************************
</span></span><span style="display:flex;"><span>    ok: <span style="color:#ff6ac1">[</span>localhost<span style="color:#ff6ac1">]</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    TASK <span style="color:#ff6ac1">[</span>debug<span style="color:#ff6ac1">]</span> *******************************************************************
</span></span><span style="display:flex;"><span>    ok: <span style="color:#ff6ac1">[</span>localhost<span style="color:#ff6ac1">]</span> <span style="color:#ff6ac1">=</span>&gt; <span style="color:#ff6ac1">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#5af78e">&#34;this.content&#34;</span>: <span style="color:#5af78e">&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#5af78e">    
</span></span></span><span style="display:flex;"><span><span style="color:#5af78e">    PLAY RECAP *********************************************************************
</span></span></span><span style="display:flex;"><span><span style="color:#5af78e">    localhost                  : ok=3    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0
</span></span></span><span style="display:flex;"><span><span style="color:#5af78e">    </span></span></span></code></pre></div>
<p>Using the uri module can be useful to perform a simple test to check
whether a web server is available, but you can also use it to check
accessibility or returned information from an API endpoint.</p>
<h4 class="h4" id="using-the-stat-module">Using the stat Module</h4>
<p>You can use the stat module to check on the status of files. Although
this module can be useful for checking on the status of just a few
files, it&rsquo;s not a file system integrity checker that was developed to
check file status on a large scale. If you need large-scale file system
integrity checking, you should use Linux utilities such as aide.</p>
<p>The stat module is useful in combination with <strong>register</strong>. In this use,
the stat module is used to register the status of a specific file, and
in a <strong>when</strong> statement, a check can be done to see whether the file
status is not as expected. In combination with the fail module, you can
use this module to generate a failure and error message if the file does
not meet the expected status. <a href="/ansible/troubleshooting/using-modules-for-troubleshooting-and-testing/#ch11.xhtml#list11_9">Listing 11-9</a> shows
an example, and <a href="/ansible/troubleshooting/using-modules-for-troubleshooting-and-testing/#ch11.xhtml#list11_10">Listing 11-10</a> shows the
resulting output, where you can see that the fail module fails the
playbook because the file owner is not root.</p>
<p><strong>Listing 11-9</strong> Using stat to Check Expected File Status</p>
<p>::: pre_1
&mdash;
- name: create a file
hosts: all
tasks:
- file:
path: /tmp/statfile
state: touch
owner: ansible</p>
<pre><code>- name: check file status
  hosts: all
  tasks:
  - stat:
      path: /tmp/statfile
    register: stat_out
  - fail:
      msg: &quot;/tmp/statfile file owner not as expected&quot;
    when: stat_out.stat.pw_name != â€™rootâ€™
</code></pre>
<p>:::</p>
<p><strong>Listing 11-10 ansible-playbook listing119.yaml</strong> Command Result</p>
<p>::: pre_1
[ansible@control rhce8-book]$ ansible-playbook listing119.yaml</p>
<pre><code>PLAY [create a file] ***********************************************************

TASK [Gathering Facts] *********************************************************
ok: [ansible2]
ok: [ansible1]
ok: [ansible3]
ok: [ansible4]
fatal: [ansible6]: UNREACHABLE! =&gt; {&quot;changed&quot;: false, &quot;msg&quot;: &quot;Failed to connect to the host via ssh: ansible@ansible6: Permission denied (publickey,gssapi-keyex,gssapi-with-mic,password).&quot;, &quot;unreachable&quot;: true}
fatal: [ansible5]: UNREACHABLE! =&gt; {&quot;changed&quot;: false, &quot;msg&quot;: &quot;Failed to connect to the host via ssh: ssh: connect to host ansible5 port 22: No route to host&quot;, &quot;unreachable&quot;: true}

TASK [file] ********************************************************************
changed: [ansible2]
changed: [ansible1]
changed: [ansible3]
changed: [ansible4]

PLAY [check file status] *******************************************************

TASK [Gathering Facts] *********************************************************
ok: [ansible1]
ok: [ansible2]
ok: [ansible3]
ok: [ansible4]

TASK [stat] ********************************************************************
ok: [ansible2]
ok: [ansible1]
ok: [ansible3]
ok: [ansible4]

TASK [fail] ********************************************************************
fatal: [ansible2]: FAILED! =&gt; {&quot;changed&quot;: false, &quot;msg&quot;: &quot;/tmp/statfile file owner not as expected&quot;}
fatal: [ansible1]: FAILED! =&gt; {&quot;changed&quot;: false, &quot;msg&quot;: &quot;/tmp/statfile file owner not as expected&quot;}
fatal: [ansible3]: FAILED! =&gt; {&quot;changed&quot;: false, &quot;msg&quot;: &quot;/tmp/statfile file owner not as expected&quot;}
fatal: [ansible4]: FAILED! =&gt; {&quot;changed&quot;: false, &quot;msg&quot;: &quot;/tmp/statfile file owner not as expected&quot;}

PLAY RECAP *********************************************************************
ansible1                   : ok=4    changed=1    unreachable=0    failed=1    skipped=0    rescued=0    ignored=0
ansible2                   : ok=4    changed=1    unreachable=0    failed=1    skipped=0    rescued=0    ignored=0
ansible3                   : ok=4    changed=1    unreachable=0    failed=1    skipped=0    rescued=0    ignored=0
ansible4                   : ok=4    changed=1    unreachable=0    failed=1    skipped=0    rescued=0    ignored=0
ansible5                   : ok=0    changed=0    unreachable=1    failed=0    skipped=0    rescued=0    ignored=0
ansible6                   : ok=0    changed=0    unreachable=1    failed=0    skipped=0    rescued=0    ignored=0
</code></pre>
<p>:::</p>
<h4 class="h4" id="using-the-assert-module">Using the assert Module</h4>
<p>The assert module is a bit like the fail module. You can use it to
perform a specific conditional action. The assert module works with a
<strong>that</strong> option that defines a list of conditionals. If any one of these
conditionals is false, the task fails, and if all the conditionals are
true, the task is successful. Based on the success or failure of a task,
the module uses the <strong>success_msg</strong> or <strong>fail_msg</strong> options to print a
message. <a href="/ansible/troubleshooting/using-modules-for-troubleshooting-and-testing/#ch11.xhtml#list11_11">Listing 11-11</a> shows an example that
uses the assert module.</p>
<p><strong>Listing 11-11</strong> Using the assert Module</p>
<p>::: pre_1
&mdash;
- hosts: localhost
vars_prompt:
- name: filesize
prompt: &ldquo;specify a file size in megabytes&rdquo;
tasks:
- name: check if file size is valid
assert:
that:
- &ldquo;{{ (filesize | int) &lt;= 100 }}&rdquo;
- &ldquo;{{ (filesize | int) &gt;= 1 }}&rdquo;
fail_msg: &ldquo;file size must be between 0 and 100&rdquo;
success_msg: &ldquo;file size is good, let\â€™s continue&rdquo;
- name: create a file
command: dd if=/dev/zero of=/bigfile bs=1 count={{ filesize }}
:::</p>
<p>The example in <a href="/ansible/troubleshooting/using-modules-for-troubleshooting-and-testing/#ch11.xhtml#list11_11">Listing 11-11</a> contains a few new
items. As you can see, the play header starts with a <strong>vars_prompt</strong>.
This defines a variable named <strong>filesize</strong>, which is based on the input
provided by the user. This <strong>filesize</strong> variable is next used by the
assert module. The <strong>that</strong> statement contains a list in which two
conditions are stated. If specified like this, all conditions stated in
the <strong>that</strong> condition must be true. So you are looking for <strong>filesize</strong>
to be equal to or bigger than 1, and smaller than or equal to 100.</p>
<p>Before this can be done, one little problem needs to be managed: when
<strong>vars_prompt</strong> is used, the variable type is set to be a string by
default. This means that a statement like</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>**filesize left <span style="color:#ff5c57">caret</span><span style="color:#ff6ac1">=</span> 100**</span></span></code></pre></div>
<p>would
fail with a type mismatch. That is why a Jinja2 filter is used to
convert the variable type from string to integer.</p>
<p>Filters are a powerful feature provided by the Jinja2 templating
language and can be used in Ansible to modify variables before
processing. For more information about filters, see
<a href="https://docs.ansible.com/ansible/latest/user_guide/playbooks_filters.html" rel="external" target="_blank">https://docs.ansible.com/ansible/latest/user_guide/playbooks_filters.html</a>.
The int filter can be used to convert the value of a string variable to
an integer. To do this, you need to rewrite the entire variable as a
Jinja2 operation, which is done using <strong>&quot;{{ (filesize | int) left caret= 100
}}&quot;</strong>.</p>
<p>In this line, the entire string is written as a variable. The variable
is further treated in a Jinja2 context. In this context, the part
<strong>(filesize | int)</strong> ensures that the string is converted to an
integer, which makes it possible to check if the value is smaller than
100.</p>
<p>When you run the code in <a href="/ansible/troubleshooting/using-modules-for-troubleshooting-and-testing/#ch11.xhtml#list11_11">Listing 11-11</a>, the
result shown in <a href="/ansible/troubleshooting/using-modules-for-troubleshooting-and-testing/#ch11.xhtml#list11_12">Listing 11-12</a> is produced.</p>
<p><strong>Listing 11-12 ansible-playbook listing1111.yaml</strong> Output</p>
<p>::: pre_1
[ansible@control rhce8-book]$ ansible-playbook listing1111.yaml</p>
<pre><code>PLAY [localhost] *****************************************************************

TASK [Gathering Facts] ***********************************************************
ok: [localhost]

TASK [check if file size is valid] ***********************************************
fatal: [localhost]: FAILED! =&gt; {
    &quot;assertion&quot;: &quot;filesize left caret= 100&quot;,
    &quot;changed&quot;: false,
    &quot;evaluated_to&quot;: false,
    &quot;msg&quot;: &quot;file size must be between 0 and 100&quot;
}

PLAY RECAP ***********************************************************************
localhost                  : ok=1    changed=0    unreachable=0    failed=1    skipped=0    rescued=0    ignored=0
</code></pre>
<p>:::</p>
<p>As you can see, the task that is defined with the assert module fails
because the variable has a value that is not between the minimum and
maximum sizes that are defined.</p>
<p>Understanding the need for using the filter to convert the variable type
might not be easy. So, let&rsquo;s also look at <a href="/ansible/troubleshooting/using-modules-for-troubleshooting-and-testing/#ch11.xhtml#list11_13">Listing
11-13</a>, which shows an example of a playbook that
will fail. You can see its behavior in <a href="/ansible/troubleshooting/using-modules-for-troubleshooting-and-testing/#ch11.xhtml#list11_14">Listing
11-14</a>, where the playbook is executed.</p>
<p><strong>Listing 11-13</strong> Failing Version of the <a href="/ansible/troubleshooting/using-modules-for-troubleshooting-and-testing/#ch11.xhtml#list11_11">Listing
11-11</a> Playbook</p>
<p>::: pre_1
&mdash;
- hosts: localhost
vars_prompt:
- name: filesize
prompt: &ldquo;specify a file size in megabytes&rdquo;
tasks:
- name: check if file size is valid
assert:
that:
- filesize &lt;= 100
- filesize &gt;= 1
fail_msg: &ldquo;file size must be between 0 and 100&rdquo;
success_msg: &ldquo;file size is good, let\â€™s continue&rdquo;
- name: create a file
command: dd if=/dev/zero of=/bigfile bs=1 count={{ filesize }}
:::</p>
<p><strong>Listing 11-14 ansible-playbook listing1113.yaml</strong> Failing Result</p>
<p>::: pre_1
[ansible@control rhce8-book]$ ansible-playbook listing1113.yaml
specify a file size in megabytes:</p>
<pre><code>PLAY [localhost] *****************************************************************

TASK [Gathering Facts] ***********************************************************
ok: [localhost]

TASK [check if file size is valid] ***********************************************
fatal: [localhost]: FAILED! =&gt; {&quot;msg&quot;: &quot;The conditional check â€™filesize left caret= 100â€™ failed. The error was: Unexpected templating type error occurred on ({% if filesize left caret= 100 %} True {% else %} False {% endif %}): â€™left caret=â€™ not supported between instances of â€™strâ€™ and â€™intâ€™&quot;}

PLAY RECAP ***********************************************************************
localhost                  : ok=1    changed=0    unreachable=0    failed=1    skipped=0    rescued=0    ignored=0
</code></pre>
<p>:::</p>
<p>As you can see, the code in <a href="/ansible/troubleshooting/using-modules-for-troubleshooting-and-testing/#ch11.xhtml#list11_13">Listing 11-13</a> fails
because the \left caret= test is not supported between a string and an integer.</p>
<p>In <a href="/ansible/troubleshooting/using-modules-for-troubleshooting-and-testing/#ch11.xhtml#exe11_2">Exercise 11-2</a> you work with some of the
modules discussed in this section.</p>
<p>::: box
<strong>Exercise 11-2 Using Modules for Troubleshooting</strong></p>
<p>1. Open your editor to create the file exercise112.yaml and define the
play header:</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0"><code class="language-pre1" data-lang="pre1">---
- name: using assert to check if volume group vgdata exists
  hosts: all
  tasks:</code></pre></div>
<p>2. Add a task that uses the command <strong>vgs vgdata</strong> to check whether a
volume group with the name vgdata exists. The task should use
<strong>register</strong> to register the command result, and it should continue if
this is not the case.</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0"><code class="language-pre1" data-lang="pre1">- name: check if vgdata exists
  command: vgs vgdata
  register: vg_result
  ignore_errors: true</code></pre></div>
<p>3. To make it easier to use <strong>assert</strong> in the next step on the right
variable, include a <strong>debug</strong> task to show the value of the variable:</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0"><code class="language-pre1" data-lang="pre1">- name: show vg_result variable
  debug:
    var: vg_result</code></pre></div>
<p>4. Add a task to print a success or failure message, depending on the
result of the <strong>vgs</strong> command from the first task:</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0"><code class="language-pre1" data-lang="pre1">- name: print a message
  assert:
    that:
    - vg_result.rc == 0
    fail_msg: volume group not found
    success_msg: volume group was found</code></pre></div>
<p>5. Use the command <strong>ansible-playbook exercise112.yaml</strong> to verify its
contents. Assuming that the LVM Volume Group vgdata was not found, it
should print &ldquo;volume group not found.&rdquo;</p>
<p>6. Change the playbook to verify that it will print the <strong>success_msg</strong>
if the requested volume group was found. You can do so by having it run
the command <strong>vgs cl</strong>, which on CentOS 8 should give a positive result.
:::</p>

  <footer class="footline">
  </footer>
</article>
<article class="default">
  <header class="headline">
  </header>

<h1 id="using-tags">Using Tags</h1>

<h3 id="using-tags">Using Tags</h3>
<p>When you are using larger playbooks, Ansible enables you to use the
<strong>tags</strong> attribute. A tag is a label that is applied to a task or
another item like a block or a play, and while using the
<strong>ansible-playbook --tags</strong> or <strong>ansible-playbook --skip-tags</strong>
command, you can specify which tags need to be executed. <a href="/ansible/troubleshooting/using-tags/#ch11.xhtml#list11_15">Listing
11-15</a> shows a simple playbook example where tags
are used, and in <a href="/ansible/troubleshooting/using-tags/#ch11.xhtml#list11_16">Listing 11-16</a> you can see the
output generated while running this playbook.</p>
<p><strong>Listing 11-15</strong> Using <strong>tags</strong> in a Playbook</p>
<p>::: pre_1
&mdash;
- name: using tags example
hosts: all
vars:
service:
- vsftpd
- httpd
tasks:
- yum:
name:
- httpd
- vsftpd
state: present
tags:
- install
- service:
name: &ldquo;{{ item }}&rdquo;
state: started
enabled: yes
loop: &ldquo;{{ services }}&rdquo;
tags:
- services
:::</p>
<p><strong>Listing 11-16 ansible-playbook --tags &ldquo;install&rdquo; listing1115.yaml</strong>
Output</p>
<p>::: pre_1
[ansible@control rhce8-book]$ ansible-playbook &ndash;tags &ldquo;install&rdquo; listing1115.yaml</p>
<pre><code>PLAY [using tags example] ******************************************************

TASK [Gathering Facts] *********************************************************
ok: [ansible2]
ok: [ansible1]
ok: [ansible4]
ok: [ansible3]

TASK [yum] *********************************************************************
ok: [ansible2]
ok: [ansible1]
changed: [ansible3]
changed: [ansible4]

PLAY RECAP *********************************************************************
ansible1                   : ok=2    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0
ansible2                   : ok=2    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0
ansible3                   : ok=2    changed=1    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0
ansible4                   : ok=2    changed=1    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0
</code></pre>
<p>:::</p>
<p>Tags can be applied to many structures, such as imported plays, tasks,
and roles, but the easiest way to get familiar with tags is to use them
on a task. Note that tags cannot be applied on items that are
dynamically included (instead of imported), using <strong>include_roles</strong> or
<strong>include_tasks</strong>.</p>
<p>While writing playbooks, you may apply the same tag multiple times. This
capability allows you to define groups of tasks, where multiple tasks
are configured with the same tag, and as a result, you can easily run a
specific part of the requested configuration. When multiple tasks with
multiple tags are used, you can get an overview of each using the
<strong>ansible-playbook --list-tasks --list-tags</strong> command. In <a href="/ansible/troubleshooting/using-tags/#ch11.xhtml#list11_17">Listing
11-17</a> you can see an example that is based on
the playbook listing1114.yaml.</p>
<p><strong>Listing 11-17</strong> Listing Tasks and Tags</p>
<p>::: pre_1
[ansible@control rhce8-book]$ ansible-playbook &ndash;list-tags &ndash;list-tasks listing1115.yaml</p>
<pre><code>playbook: listing1115.yaml

  play #1 (all): using tags example.    TAGS: []
    tasks:
      yum.       TAGS: [install]
      service.   TAGS: [services]
      TASK TAGS: [install, services]
</code></pre>
<p>:::</p>
<p>When working with tags, you can use some special tags. <a href="/ansible/troubleshooting/using-tags/#ch11.xhtml#tab11_5">Table
11-5</a> gives an overview.</p>
<p>::: group
<strong>Table 11-5</strong> Special Tags Overview</p>
<p><a href="#R-image-ce61d8ac6291ec4b99a597ea750a5d53" class="lightbox-link"><img alt="Image" class="lazy lightbox figure-image" loading="lazy" src="/Images/11tab05.jpg" style=" height: auto; width: auto;"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-ce61d8ac6291ec4b99a597ea750a5d53"><img alt="Image" class="lazy lightbox lightbox-image" loading="lazy" src="/Images/11tab05.jpg"></a>{width=&ldquo;940&rdquo; height=&ldquo;252&rdquo;}
:::</p>
<p>Apart from these special tags, you might also want to set a <strong>debug</strong>
tag to easily identify tasks that should be run only if you specifically
want to run debug tasks as well. If combined with the <strong>never</strong> tag, the
task that is tagged with the <strong>debug,never</strong> tasks runs only if the
<strong>debug</strong> tag is specifically requested. So in case you want to run the
entire playbook, including tasks that have been tagged with <strong>debug</strong>,
you need to use the <strong>ansible-playbook --tags all,debug</strong> command. In
<a href="/ansible/troubleshooting/using-tags/#ch11.xhtml#exe11_3">Exercise 11-3</a> you can see how this can be used to
optimize the playbook that was previously used in <a href="/ansible/troubleshooting/using-tags/#ch11.xhtml#exe11_2">Exercise
11-2</a>.</p>
<p>::: box
<strong>Exercise 11-3 Using Tags to Make Debugging Easier</strong></p>
<p>1. Rewrite the exercise112.yaml playbook that you created in the
previous exercise, and include the line <strong>tags: [never, debug ]</strong> in
the <strong>debug</strong> task. The complete playbook looks as follows:</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0"><code class="language-pre1" data-lang="pre1">---
- name: using assert to check if volume group vgdata exists
  hosts: all
  tasks:
  - name: check if vgdata exists
    command: vgs vgdata
    register: vg_result
    ignore_errors: true
  - name: show vg_result variable
    debug:
      var: vg_result
    tags: [ never, debug ]
  - name: print a message
    assert:
      that:
      - vg_result.rc == 0
      fail_msg: volume group not found
      success_msg: volume group was found</code></pre></div>
<p>2. Run the playbook using <strong>ansible-playbook --tags all
exercise113.yaml</strong>. Notice that it does not run the <strong>debug</strong> task.</p>
<p>3. Run the playbook using <strong>ansible-playbook --tags all,debug
exercise113.yaml</strong>. Notice that it now does run the <strong>debug</strong> task as
well.
:::</p>

  <footer class="footline">
  </footer>
</article>
          </section>
        </div>
      </main>
    </div>
    <script>
      window.MathJax = Object.assign( window.MathJax || {}, {
        tex: {
          inlineMath:  [['\\(', '\\)'], ['$',  '$']],  
          displayMath: [['\\[', '\\]'], ['$$', '$$']], 
        },
        options: {
          enableMenu: false 
        }
      }, JSON.parse("{}") );
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="/js/js-yaml/js-yaml.min.js?1762453719" defer></script>
    <script src="/js/d3/d3-color.min.js?1762453719" defer></script>
    <script src="/js/d3/d3-dispatch.min.js?1762453719" defer></script>
    <script src="/js/d3/d3-drag.min.js?1762453719" defer></script>
    <script src="/js/d3/d3-ease.min.js?1762453719" defer></script>
    <script src="/js/d3/d3-interpolate.min.js?1762453719" defer></script>
    <script src="/js/d3/d3-selection.min.js?1762453719" defer></script>
    <script src="/js/d3/d3-timer.min.js?1762453719" defer></script>
    <script src="/js/d3/d3-transition.min.js?1762453719" defer></script>
    <script src="/js/d3/d3-zoom.min.js?1762453719" defer></script>
    <script src="https://unpkg.com/mermaid/dist/mermaid.min.js" defer></script>
    <script>
      window.relearn.themeUseMermaid = JSON.parse("{ \"theme\": \"default\" }");
    </script>
    <script src="/js/clipboard/clipboard.min.js?1762453719" defer></script>
    <script src="/js/perfect-scrollbar/perfect-scrollbar.min.js?1762453719" defer></script>
    <script src="/js/theme.min.js?1762453719" defer></script>
  </body>
</html>
