<!DOCTYPE html>
<html lang="en-us" dir="ltr" itemscope itemtype="http://schema.org/Article" data-r-output-format="print">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="height=device-height, width=device-width, initial-scale=1.0, minimum-scale=1.0">
    <meta name="generator" content="Hugo 0.152.2">
    <meta name="generator" content="Relearn 8.2.0+d150cc8909ed7836ff5d545e76544f6923ffacf5">
    <meta name="description" content="Configuring Storage Advanced ExerciseDiscovering storage related factsManaging Partitions and LVMNFS Setup">
    <meta name="author" content="David Thomas">
    <meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="Storage :: Linux Reader">
    <meta name="twitter:description" content="Configuring Storage Advanced ExerciseDiscovering storage related factsManaging Partitions and LVMNFS Setup">
    <meta property="og:url" content="http://linuxreader.com/ansible/storage/">
    <meta property="og:site_name" content="Linux Reader">
    <meta property="og:title" content="Storage :: Linux Reader">
    <meta property="og:description" content="Configuring Storage Advanced ExerciseDiscovering storage related factsManaging Partitions and LVMNFS Setup">
    <meta property="og:locale" content="en_us">
    <meta property="og:type" content="website">
    <meta itemprop="name" content="Storage :: Linux Reader">
    <meta itemprop="description" content="Configuring Storage Advanced ExerciseDiscovering storage related factsManaging Partitions and LVMNFS Setup">
    <meta itemprop="wordCount" content="14">
    <title>Storage :: Linux Reader</title>
    <link href="http://linuxreader.com/ansible/storage/" rel="canonical" type="text/html" title="Storage :: Linux Reader">
    <link href="/ansible/storage/index.xml" rel="alternate" type="application/rss+xml" title="Storage :: Linux Reader">
    <link href="/images/favicon.svg?1762527413" rel="icon" type="image/svg+xml">
    <link href="/css/auto-complete/auto-complete.min.css?1762527413" rel="stylesheet">
    <script src="/js/auto-complete/auto-complete.min.js?1762527413" defer></script>
    <script src="/js/search-lunr.min.js?1762527413" defer></script>
    <script src="/js/search.min.js?1762527413" defer></script>
    <script>
      window.relearn = window.relearn || {};
      window.relearn.index_js_url="/searchindex.en.js?1762527413";
    </script>
    <script src="/js/lunr/lunr.min.js?1762527413" defer></script>
    <script src="/js/lunr/lunr.stemmer.support.min.js?1762527413" defer></script>
    <script src="/js/lunr/lunr.multi.min.js?1762527413" defer></script>
    <script src="/js/lunr/lunr.en.min.js?1762527413" defer></script>
    <script>
      window.relearn = window.relearn || {};
      window.relearn.contentLangs=['en'];
    </script>
    <link href="/fonts/fontawesome/css/fontawesome-all.min.css?1762527413" rel="stylesheet" media="print" onload="this.media='all';this.onload=null;"><noscript><link href="/fonts/fontawesome/css/fontawesome-all.min.css?1762527413" rel="stylesheet"></noscript>
    <link href="/css/perfect-scrollbar/perfect-scrollbar.min.css?1762527413" rel="stylesheet">
    <link href="/css/theme.min.css?1762527413" rel="stylesheet">
    <link href="/css/format-print.min.css?1762527413" rel="stylesheet" id="R-format-style">
    <script>
      window.relearn = window.relearn || {};
      // configuration
      window.relearn.min = `.min`;
      window.relearn.path='\/ansible\/storage\/';
      window.relearn.relBasePath='..\/..';
      window.relearn.relBaseUri='..\/..';
      window.relearn.absBaseUri='http:\/\/linuxreader.com';
      window.relearn.disableAnchorCopy=false;
      window.relearn.disableAnchorScrolling=false;
      window.relearn.disableInlineCopyToClipboard=true;
      window.relearn.enableBlockCodeWrap=true;
      // legal
      window.relearn.getItem = (s,n) => {return s.getItem(n)};
      window.relearn.setItem = (s,n,v) => {return s.setItem(n,v)};
      window.relearn.removeItem = (s,n) => {return s.removeItem(n)};
      // translations
      window.T_Copy_to_clipboard = `Copy to clipboard`;
      window.T_Copied_to_clipboard = `Copied to clipboard!`;
      window.T_Copy_link_to_clipboard = `Copy link to clipboard`;
      window.T_Link_copied_to_clipboard = `Copied link to clipboard!`;
      window.T_Reset_view = `Reset view`;
      window.T_View_reset = `View reset!`;
      window.T_No_results_found = `No results found for "{0}"`;
      window.T_N_results_found = `{1} results found for "{0}"`;
      // variant stuff
      window.relearn.themevariants = [ 'oled' ];
      window.relearn.customvariantname = "my-custom-variant";
      window.relearn.changeVariant = function(variant) {
        var oldVariant = document.documentElement.dataset.rThemeVariant;
        window.relearn.setItem(window.localStorage, window.relearn.absBaseUri + "/variant", variant);
        document.documentElement.dataset.rThemeVariant = variant;
        if (oldVariant != variant) {
          document.dispatchEvent( new CustomEvent('themeVariantLoaded', { detail: { variant, oldVariant } }) );
          window.relearn.markVariant();
        }
      }
      window.relearn.markVariant = function() {
        var variant = window.relearn.getItem(window.localStorage, window.relearn.absBaseUri + "/variant");
        document.querySelectorAll(".R-variantswitcher select").forEach((select) => {select.value = variant;});
      }
      window.relearn.initVariant = function() {
        var variant = window.relearn.getItem(window.localStorage, window.relearn.absBaseUri + "/variant") ?? "";
        if( variant == window.relearn.customvariantname ){
        }else if( !variant || !window.relearn.themevariants.includes(variant) ){
          variant = window.relearn.themevariants[0];
          window.relearn.setItem(window.localStorage, window.relearn.absBaseUri + "/variant", variant);
        }
        document.documentElement.dataset.rThemeVariant = variant;
      }
      window.relearn.initVariant();
      window.relearn.markVariant();
    </script><style>
:root {
    --MENU-WIDTH-S: 14.375rem;
    --MENU-WIDTH-M: 14.375rem;
    --MENU-WIDTH-L: 18.75rem;
    --MAIN-WIDTH-MAX: 80rem;
    font-size: 1.2rem;
}
</style>

  </head>
  <body class="mobile-support print" data-url="/ansible/storage/">
    <div id="R-body" class="default-animation">
      <div id="R-body-overlay"></div>
      <nav id="R-topbar">
        <div class="topbar-wrapper">
          <div class="topbar-sidebar-divider"></div>
          <div class="topbar-area topbar-area-start" data-area="start">
            <div class="topbar-button topbar-button-sidebar" data-content-empty="disable" data-width-s="show" data-width-m="hide" data-width-l="hide">
<span class="btn cstyle link noborder notitle interactive"><button onclick="toggleNav()" type="button" title="Menu (CTRL&#43;ALT&#43;n)"><i class="fa-fw fas fa-bars"></i></button></span>
            </div>
            <div class="topbar-button topbar-button-prev" data-content-empty="disable" data-width-s="show" data-width-m="show" data-width-l="show">
<span class="btn cstyle link noborder notitle interactive"><a href="/ansible/roles/using-rhel-system-roles/" title="Using RHEL System roles (ðŸ¡)"><i class="fa-fw fas fa-chevron-left"></i></a></span>
            </div>

            <div class="topbar-button topbar-button-toc" data-content-empty="hide" data-width-s="show" data-width-m="show" data-width-l="show">
<span class="btn cstyle link noborder notitle interactive"><button onclick="toggleTopbarFlyout(this)" type="button" title="Table of Contents (CTRL&#43;ALT&#43;t)"><i class="fa-fw fas fa-list-alt"></i></button></span>
              <div class="topbar-content">
                <div class="topbar-content-wrapper"> 
                </div>
              </div>
            </div>


          </div>
          <span class="topbar-breadcrumbs highlightable">
            Storage
          </span>
          <div class="topbar-area topbar-area-end" data-area="end">
            <div class="topbar-button topbar-button-print" data-content-empty="disable" data-width-s="area-more" data-width-m="show" data-width-l="show">
<span class="btn cstyle link noborder notitle interactive"><a href="/ansible/storage/index.print.html" title="Print whole chapter (CTRL+ALT+p)"><i class="fa-fw fas fa-print"></i></a></span>
            </div>

            <div class="topbar-button topbar-button-next" data-content-empty="disable" data-width-s="show" data-width-m="show" data-width-l="show">
<span class="btn cstyle link noborder notitle interactive"><a href="/ansible/storage/configuring-storage-advanced-exercise/" title="Configuring Storage Advanced Exercise (ðŸ¡’)"><i class="fa-fw fas fa-chevron-right"></i></a></span>
            </div>







          </div>
        </div>
      </nav>
      <div id="R-main-overlay"></div>
      <main id="R-body-inner" class="highlightable ansible" tabindex="-1">
        <div class="flex-block-wrapper">
<article class="default">
  <header class="headline">
  </header>

<h1 id="storage">Storage</h1>

<div class="children children-type-card children-sort-"><ul class="card-container">
<li>
  <article class="card card-popout" aria-labelledby="R-card-d13c51518915b53ebe0de34724fa202c">
    <div class="card-content">
      <div class="card-title" id="R-card-d13c51518915b53ebe0de34724fa202c">
        <a href="/ansible/storage/configuring-storage-advanced-exercise/">
        Configuring Storage Advanced Exercise
        </a>
      </div>
      <div class="card-content-text">
          <!-- raw HTML omitted -->

      </div>
    </div>
  </article>
</li>
<li>
  <article class="card card-popout" aria-labelledby="R-card-bfa03f180ddc6d9800338159481ea0d2">
    <div class="card-content">
      <div class="card-title" id="R-card-bfa03f180ddc6d9800338159481ea0d2">
        <a href="/ansible/storage/discovering-storage-related-facts/">
        Discovering storage related facts
        </a>
      </div>
      <div class="card-content-text">
          <!-- raw HTML omitted -->

      </div>
    </div>
  </article>
</li>
<li>
  <article class="card card-popout" aria-labelledby="R-card-65a5c52b45d73f711e23bdc68ff33ba5">
    <div class="card-content">
      <div class="card-title" id="R-card-65a5c52b45d73f711e23bdc68ff33ba5">
        <a href="/ansible/storage/managing-partitions-and-lvm/">
        Managing Partitions and LVM
        </a>
      </div>
      <div class="card-content-text">
          <!-- raw HTML omitted -->

      </div>
    </div>
  </article>
</li>
<li>
  <article class="card card-popout" aria-labelledby="R-card-353dd4376db37870191dc176994936d5">
    <div class="card-content">
      <div class="card-title" id="R-card-353dd4376db37870191dc176994936d5">
        <a href="/ansible/storage/nfs-setup/">
        NFS Setup
        </a>
      </div>
      <div class="card-content-text">
          <!-- raw HTML omitted -->

      </div>
    </div>
  </article>
</li>
</ul>
</div>

  <footer class="footline">
  </footer>
</article>
          <section>
            <h1 class="a11y-only">Subsections of Storage</h1>
<article class="default">
  <header class="headline">
  </header>

<h1 id="configuring-storage-advanced-exercise">Configuring Storage Advanced Exercise</h1>

<h3 id="configuring-storage-advanced-exercise">Configuring Storage Advanced Exercise</h3>
<p>To work on this exercise, you need managed machines with an additional disk device: add
a 10 GB second disk to host ansible2 and a 5 GB second disk to host ansible3. The exercise assumes the name of the second disk is /dev/sdb; if a different disk name is used in your configuration, change this according to your specifications.</p>
<p><strong>Exercise 15-3 Setting Up an Advanced Storage Solution</strong></p>
<p>In this exercise you need to set up a storage solution that meets the
following requirements:</p>
<p>â€¢ Tasks in this playbook should be executed only on hosts where the device /dev/sdb exists.</p>
<p>â€¢ If no device /dev/sdb exists, the playbook should print &ldquo;device sdb not present&rdquo; and stop executing tasks on that host.</p>
<p>â€¢ Configure the device with one partition that includes all available disk space.</p>
<p>â€¢ Create an LVM volume group with the name vgfiles.</p>
<p>â€¢ If the volume group is bigger than 5 GB, create an LVM logical volume with the name lvfiles and a size of 6 GB. Note that you must check the LVM volume group size and not the /dev/sdb1 size because in theory you could have multiple block devices in a volume group.</p>
<p>â€¢ If the volume group is equal to or smaller than 5 GB, create an LVM logical volume with the name lvfiles and a size of 3 GB.</p>
<p>â€¢ Format the volume with the XFS file system.</p>
<p>â€¢ Mount it on the /files directory.</p>
<p>1. Check the size of the volume group. You can, however, write a test that works on a default volume group, and that is what you&rsquo;re going to do first, using the name of the default volume group on CentOS 8, which is &ldquo;cl&rdquo;. The purpose is to test the constructions, which is why it doesn&rsquo;t really matter that the two tasks have overlapping <strong>when</strong> statements. So create a file with the name exercise153-dev1.yaml and give it the following contents:</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0"><code class="language-pre1" data-lang="pre1">---
- name: get vg sizes
  hosts: all
  tasks:
  - name: find small vgroup sizes
    debug:
      msg: volume group smaller than or equal to 20G
    when:
    - ansible_facts[â€™lvmâ€™][â€™vgsâ€™][â€™clâ€™] is defined
    - ansible_facts[â€™lvmâ€™][â€™vgsâ€™][â€™clâ€™][â€™size_gâ€™] &lt;= 20.00
  - name: find large vgroup size
    debug:
      msg: volume group larger than or equal to 19G
    when:
    - ansible_facts[â€™lvmâ€™][â€™vgsâ€™][â€™clâ€™] is defined
    - ansible_facts[â€™lvmâ€™][â€™vgsâ€™][â€™clâ€™][â€™size_gâ€™] &gt;= 19.00</code></pre></div>
<p>2. Run the playbook by using <strong>ansible-playbook
exercise153-dev1.yaml</strong>. You&rsquo;ll notice that it fails with the error
shown in <a href="/ansible/storage/configuring-storage-advanced-exercise/#ch15.xhtml#list15_12">Listing 15-12</a>.</p>
<p><strong>Listing 15-12 exercise153-dev1.yaml</strong> Failure Message</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0"><code>TASK [find small vgroups sizes] ***************************************************
fatal: [ansible1]: FAILED! =&gt; \{\&#34;msg&#34;: &#34;The conditional check â€™ansible_facts[â€™lvmâ€™][â€™vgsâ€™][â€™clâ€™][â€™size_gâ€™] \\&lt;= 20.00â€™ failed. The error was: Unexpected templating type error occurred on ({% if ansible_facts[â€™lvmâ€™][â€™vgsâ€™][â€™clâ€™][â€™size_gâ€™] &lt;= 20.00 %} True {% else %} False {% endif %}): â€™&lt;=â€™ not supported between instances of â€™AnsibleUnsafeTextâ€™ and â€™floatâ€™\n\nThe error appears to be in â€™/home/ansible/rhce8-book/exercise153-dev1.yamlâ€™: line 5, column 5, but may\nbe elsewhere in the file depending on the exact syntax problem.\n\nThe offending line appears to be:\n\n  tasks:\n  - name: find small vgroups sizes\n    ^ here\n&#34;}
fatal: [ansible2]: FAILED! =&gt; {&#34;msg&#34;: &#34;The conditional check â€™ansible_facts[â€™lvmâ€™][â€™vgsâ€™][â€™clâ€™][â€™size_gâ€™] &lt;= 20.00â€™ failed. The error was: Unexpected templating type error occurred on ({% if ansible_facts[â€™lvmâ€™][â€™vgsâ€™][â€™clâ€™][â€™size_gâ€™] &lt;= 20.00 %} True {% else %} False {% endif %}): â€™&lt;=â€™ not supported between instances of â€™AnsibleUnsafeTextâ€™ and â€™floatâ€™\n\nThe error appears to be in â€™/home/ansible/rhce8-book/exercise153-dev1.yamlâ€™: line 5, column 5, but may\nbe elsewhere in the file depending on the exact syntax problem.\n\nThe offending line appears to be:\n\n  tasks:\n  - name: find small vgroups sizes\n    ^ here\n&#34;}
fatal: [ansible3]: FAILED! =&gt; {&#34;msg&#34;: &#34;The conditional check â€™ansible_facts[â€™lvmâ€™][â€™vgsâ€™][â€™clâ€™][â€™size_gâ€™] &lt;= 20.00â€™ failed. The error was: Unexpected templating type error occurred on ({% if ansible_facts[â€™lvmâ€™][â€™vgsâ€™][â€™clâ€™][â€™size_gâ€™] &lt;= 20.00 %} True {% else %} False {% endif %}): â€™&lt;=â€™ not supported between instances of â€™AnsibleUnsafeTextâ€™ and â€™floatâ€™\n\nThe error appears to be in â€™/home/ansible/rhce8-book/exercise153-dev1.yamlâ€™: line 5, column 5, but may\nbe elsewhere in the file depending on the exact syntax problem.\n\nThe offending line appears to be:\n\n  tasks:\n  - name: find small vgroups sizes\n    ^ here\n&#34;}
fatal: [ansible4]: FAILED! =&gt; {&#34;msg&#34;: &#34;The conditional check â€™ansible_facts[â€™lvmâ€™][â€™vgsâ€™][â€™clâ€™][â€™size_gâ€™] &lt;= 20.00â€™ failed. The error was: Unexpected templating type error occurred on ({% if ansible_facts[â€™lvmâ€™][â€™vgsâ€™][â€™clâ€™][â€™size_gâ€™] &lt;= 20.00 %} True {% else %} False {% endif %}): â€™&lt;=â€™ not supported between instances of â€™AnsibleUnsafeTextâ€™ and â€™floatâ€™\n\nThe error appears to be in â€™/home/ansible/rhce8-book/exercise153-dev1.yamlâ€™: line 5, column 5, but may\nbe elsewhere in the file depending on the exact syntax problem.\n\nThe offending line appears to be:\n\n  tasks:\n  - name: find small vgroups sizes\n    ^ here\n&#34;}
skipping: [ansible5]
skipping: [ansible6]

TASK [find large vgroups sizes] ***************************************************
skipping: [ansible5]
skipping: [ansible6]</code></pre></div>
<p>:::</p>
<p>3. As you can see in the errors in <a href="/ansible/storage/configuring-storage-advanced-exercise/#ch15.xhtml#list15_12">Listing
15-12</a>, there are two problems in the playbook.
The first problem is that there is no <strong>ignore_errors</strong> in the failing
play, which means that only hosts that haven&rsquo;t failed will reach the
next task. The second error is the &ldquo;Unexpected templating error&rdquo;. The
playbook in its current form is trying to perform a logical test to
compare the value of two variables that have an incompatible variable
type. The Ansible fact has the type &ldquo;AnsibleUnsafeText&rdquo;, and the value
of 20.00 is a float, not an integer. To make this test work, you must
force the type of both variables to be set to an integer. Now write
<strong>exercise153-dev2.yaml</strong> where this is happening; notice the use of the
filter <strong>int</strong>, which is essential for the success of this playbook:</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0"><code class="language-pre1" data-lang="pre1">---
- name: get vg sizes
  ignore_errors: yes
  hosts: all
  tasks:
  - name: set vgroup sizes in variables
    set_fact:
      vgsize: &#34;{{ ansible_facts[â€™lvmâ€™][â€™vgsâ€™][â€™clâ€™][â€™size_gâ€™] | int }}&#34;
  - name: debug this
    debug:
      msg: the value of vgsize is {{ vgsize }}
  - name: testing big vgsize value
    debug:
      msg: the value of vgsize is bigger than 5
    when: vgsize | int &gt; 5
  - name: testing small vgsize value
    debug:
      msg: the value of vgsize is smaller than 5
    when: vgsize | int &lt;= 5</code></pre></div>
<p>4. Run this playbook. You&rsquo;ll notice it skips and ignores some tasks but
doesn&rsquo;t fail anywhere, which means that this playbook&mdash;although
absolutely not perfect&mdash;is usable as an example to test the size of the
vgfiles volume group later in this exercise.</p>
<p>5. Now that you&rsquo;ve tested the most complex part of the assignment, you
can start writing the rest of the playbook. Do this in a new file with
the name exercise153.yaml. Because this playbook has quite a few tasks
to accomplish, it might be smart to define the rough structure and
ensure that all elements that are needed later are at least documented
so that you can later work out the details. So let&rsquo;s start with the
first part, where the play header is defined, as well as the rough
structure. This is the part where you still have the global overview of
all the tasks in this requirement, so you need to make sure you won&rsquo;t
forget about them later, which is a real risk if you&rsquo;ve been into the
details too much for too long.</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0"><code class="language-pre1" data-lang="pre1">---
- name: set up hosts that have an sdb device
  hosts: all
  tasks:
  - name: getting out with a nice failure message if there is no second disk
    # fail:
    debug:
      msg: write a nice failure message and a when test here
    # when: something
  - name: create a partition
    #parted
    debug:
      msg: creating the partition
  - name: create a volume group
    #lvg:
    debug:
      msg: creating the volume group
  - name: get the vg size and store it in a variable
    #set_fact:
    debug:
      msg: storing variable as an integer
  - name: create an LVM on big volume groups
    #lvol:
    debug:
      msg: use when statement to create 6g lvol if vsize &gt; 5
  - name: create an LVM on small volume groups
    #lvol:
    debug:
      msg: use when statement to create 3g lvol if vsize &lt;= 5
  - name: formatting the XFS filesystem
    # filesystem
    debug:
      msg: creating the filesystem
  - name: mounting /dev/vgfiles/lvfiles
    # mount:
    debug:
      msg: mounting the volume</code></pre></div>
<p>6. The advantage of a generic structure like the one you just defined
is that you can run a test at any moment. Now it&rsquo;s time to fill it in.
Start with the play header and then check whether /dev/sdb is present on
the managed system:</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0"><code class="language-pre1" data-lang="pre1">---
- name: setup up hosts that have an sdb device
  hosts: all
  tasks:
  - name: getting out with a nice failure message if there is no second disk
    fail:
      msg: there is no second disk
    when: ansible_facts[â€™devicesâ€™][â€™sdbâ€™] is not defined</code></pre></div>
<p>7. At this point I recommend you run a test to see that the playbook
really does skip all hosts that don&rsquo;t have a second disk device. Use
<strong>ansible-playbook exercise153.yaml</strong> to do so and observe that you see
a lot of skipping messages in the output.</p>
<p>8. If all is well so far, you can continue to create the partition and
create the logical volume group as well. Here are the tasks you need to
enter. Notice that no size is specified at any point, which means that
the partition and the volume group will be allowed to grow up to the
maximum size.</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0"><code class="language-pre1" data-lang="pre1">- name: create a partition
  parted:
    device: /dev/sdb
    number: 1
    state: present
- name: create a volume group
  lvg:
    pvs: /dev/sdb1
    vg: vgfiles</code></pre></div>
<p>9. At this point you can insert the part where you save the volume
group size into a variable, which can be used in the <strong>when</strong> statement
that will occur in one of the next tasks. Also, because it&rsquo;s good to
check a lot while you are writing a complex playbook, use the debug
module to verify the results.</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0"><code class="language-pre1" data-lang="pre1">- name: get vg size and convert to integer in new variable
  set_fact:
    vgsize: &#34;{{ ansible_facts[â€™lvmâ€™][â€™vgsâ€™][â€™vgfilesâ€™][â€™size_gâ€™] | int }}&#34;
- name: show vgsize value
  debug:
    var: &#34;{{ vgsize }}&#34;</code></pre></div>
<p>10. After this important step, it&rsquo;s time to run a test. If you need it,
you can find a sample playbook of the state so far named
exercise153-step9.yaml in the GitHub repository at
<a href="https://github.com/sandervanvugt/rhce8-book" rel="external" target="_blank">https://github.com/sandervanvugt/rhce8-book</a>, but it&rsquo;s obviously much
better and recommended to run your own code! So use <strong>ansible-playbook
exercise153.yaml</strong> to verify what you&rsquo;ve got so far. Notice that you
<em>must</em> make sure to run it on hosts that don&rsquo;t have any configuration
yet. If a configuration already exists, that will most likely give you
false positives! If you want to make sure all is clean, use <strong>ansible
all -a &ldquo;dd if=/dev/zero of=/dev/sdb bs=1M count=10&rdquo;</strong> to wipe the
/dev/sdb devices on your managed hosts, followed by <strong>ansible all -m
reboot</strong> to reboot all of them before you test. The purpose of all this
is that at this point you see the error message shown in <a href="/ansible/storage/configuring-storage-advanced-exercise/#ch15.xhtml#list15_13">Listing
15-13</a>. Before moving on to the next step, try to
understand what is going wrong.</p>
<p><strong>Listing 15-13</strong> Error Message After <a href="/ansible/storage/configuring-storage-advanced-exercise/#ch15.xhtml#exe15_3">Exercise
15-3</a> Step 10</p>
<p>::: pre_1</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0"><code class="language-pre1" data-lang="pre1">TASK [get vg size and convert to integer in new variable] ******************************
fatal: [ansible2]: FAILED! =&gt; {&#34;msg&#34;: &#34;The task includes an option with an undefined variable. The error was: â€™dict objectâ€™ has no attribute â€™vgfilesâ€™\n\nThe error appears to be in â€™/home/ansible/rhce8-book/exercise153-step9.yamlâ€™: line 18, column 5, but may\nbe elsewhere in the file depending on the exact syntax problem.\n\nThe offending line appears to be:\n\n      vg: vgfiles\n  - name: get vg size and convert to integer in new variable\n    ^ here\n&#34;}
fatal: [ansible3]: FAILED! =&gt; {&#34;msg&#34;: &#34;The task includes an option with an undefined variable. The error was: â€™dict objectâ€™ has no attribute â€™vgfilesâ€™\n\nThe error appears to be in â€™/home/ansible/rhce8-book/exercise153-step9.yamlâ€™: line 18, column 5, but may\nbe elsewhere in the file depending on the exact syntax problem.\n\nThe offending line appears to be:\n\n      vg: vgfiles\n  - name: get vg size and convert to integer in new variable\n    ^ here\n&#34;}</code></pre></div>
<p>:::</p>
<p>11. As you can see, the variable that you are trying to use has no
value yet. And that is for the simple reason that fact gathering is
required to set the variable, and fact gathering is happening at the
beginning of the playbook. At this point, you need to add a task that
runs the setup module right after creating the volume group, and then
you can try again. In the output you have to look at the [show vgsize
value] task, which should look all right now, and everything after that
can be ignored. See exercise153-step11.yaml in the GitHub repository if
you need the complete example.</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0"><code class="language-pre1" data-lang="pre1"># skipping first part of the playbook in this listing
- name: create a volume group
  lvg:
    pvs: /dev/sdb1
    vg: vgfiles
- name: run the setup module so that we can use updated facts
  setup:
- name: get vg size and convert to integer in new variable
  set_fact:
    vgsize: &#34;{{ ansible_facts[â€™lvmâ€™][â€™vgsâ€™][â€™vgfilesâ€™][â€™size_gâ€™] | int }}&#34;
- name: show vgsize value
  debug:
    var: &#34;{{ vgsize }}&#34;</code></pre></div>
<p>12. Assuming that all went well, you can now add the two conditional
tests, where according to the <strong>vgsize</strong> value, the lvol module is used
to create the logical volumes:</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0"><code class="language-pre1" data-lang="pre1">- name: create an LVM on big volume groups
  lvol:
    vg: vgfiles
    lv: lvfiles
    size: 6g
  when: vgsize | int &gt; 5
- name: create an LVM on small volume groups
  lvol:
    vg: vgfiles
    lv: lvfiles
    size: 3g
  when: vgsize | int &lt;= 5</code></pre></div>
<p>13. Add the tasks to format the volumes with the XFS file system and
mount them:</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0"><code class="language-pre1" data-lang="pre1">- name: formatting the XFS filesystem
  filesystem:
    dev: /dev/vgfiles/lvfiles
    fstype: xfs
- name: mounting /dev/vgfile/lvfiles
  mount:
    path: /file
    state: mounted
    src: /dev/vgfiles/lvfiles
    fstype: xfs</code></pre></div>
<p>14. That&rsquo;s all! The playbook is now ready for use. Run it by using
<strong>ansible-playbook exercise153.yaml</strong> and verify its output.</p>
<p>15. Use the ad hoc command <strong>ansible ansible2,ansible3 -a &ldquo;lvs&rdquo;</strong> to
show LVM logical volume sizes on the machines with the additional hard
drive. You should see that all has worked out well and you are done!
:::</p>

  <footer class="footline">
  </footer>
</article>
<article class="default">
  <header class="headline">
  </header>

<h1 id="discovering-storage-related-facts">Discovering storage related facts</h1>

<p><strong>Table 15-2</strong> Modules for Managing Storage</p>
<p><a href="#R-image-e1d65c5966710d3824edb476d380722c" class="lightbox-link"><img alt="Image" class="lazy lightbox figure-image" loading="lazy" src="/Images/15tab02.jpg" style="height: auto;width: auto;"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-e1d65c5966710d3824edb476d380722c"><img alt="Image" class="lazy lightbox lightbox-image" loading="lazy" src="/Images/15tab02.jpg"></a></p>
<p>To make sure that your playbook is applied to the right devices, you first need to find which devices are available on your managed system.</p>
<p>After you find them, you can use conditionals to make sure that tasks are executed on the right devices.</p>
<h4 id="using-storage-related-facts">Using Storage-Related Facts</h4>
<p>Ansible_facts related to storage</p>
<p>ansible_devices</p>
<ul>
<li>Available storage and device info
ansible_device_links</li>
<li>info on how to access storage and other device info
ansible_mounts</li>
<li>Mount point info</li>
</ul>
<p><code>ansible ansible1 -m setup -a 'filter=ansible_devices'</code></p>
<ul>
<li>
<p>Find generic information about storage devices.</p>
</li>
<li>
<p>The <strong>filter</strong> argument to the setup module uses a shell-style wildcard to search for matching items and for that reason can search in the highest level facts, such as <strong>ansible_devices</strong>, but it is incapable of further specifying what is searched for. For that reason, in the <strong>filter</strong> argument to the setup module, you cannot use a construction like <code>ansible ansible1 -m setup -a &quot;filter=ansible_devices.sda&quot;</code> which is common when looking up the variable in conditional statements.</p>
</li>
</ul>
<h4 id="using-storage-related-facts-in-conditional-statements">Using Storage-Related Facts in Conditional Statements</h4>
<p>Assert module</p>
<ul>
<li>show an error message if a device does not exist and to perform a task if the device exists.</li>
<li>For an easier solution, you can also use a <strong>when</strong> statement to look for the existence of a device.</li>
<li>The advantage of using the assert module is that an error message can be printed if the condition is not met.</li>
</ul>
<p><strong>Listing 15-2</strong> Using assert to Run a Task Only If a Device Exists</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yml" data-lang="yml"><span style="display:flex;"><span>    ---
</span></span><span style="display:flex;"><span>    - <span style="color:#ff6ac1">name</span>: search for /dev/sdb continue only if it is found
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">hosts</span>: all
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">vars</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">disk_name</span>: sdb
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">tasks</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#ff6ac1">name</span>: abort if second disk does not exist
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">assert</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#ff6ac1">that</span>:
</span></span><span style="display:flex;"><span>            - <span style="color:#5af78e">&#34;ansible_facts[&#39;devices&#39;][&#39;{{ disk_name }}&#39;] is defined&#34;</span>
</span></span><span style="display:flex;"><span>          <span style="color:#ff6ac1">fail_msg</span>: second hard disk not found
</span></span><span style="display:flex;"><span>      - <span style="color:#ff6ac1">debug</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#ff6ac1">msg</span>: <span style="color:#5af78e">&#34;{{ disk_name }} was found, lets continue&#34;</span></span></span></code></pre></div>
<p>Write a playbook that finds out the name of the disk device and puts that in a variable that you can work with further on in the playbook.</p>
<p>The <strong>set_fact</strong> argument comes in handy to do so.</p>
<p>You can use it in combination with a <strong>when</strong> conditional statement to store a detected device name in a variable.</p>
<p>Storing the Detected Disk Device Name in a Variable</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>    ---
</span></span><span style="display:flex;"><span>    - <span style="color:#ff6ac1">name</span>: define variable according to diskname detected
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">hosts</span>: all
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">tasks</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#ff6ac1">ignore_errors</span>: <span style="color:#ff6ac1">yes</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">set_fact</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#ff6ac1">disk2name</span>: sdb
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">when</span>: ansible_facts[â€™devicesâ€™][â€™sdbâ€™]</span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>  - <span style="color:#ff6ac1">name</span>: Detect secondary disk name
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">ignore_errors</span>: <span style="color:#ff6ac1">yes</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">set_fact</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">disk2name</span>: vda
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">when</span>: ansible_facts[&#39;devices&#39;][&#39;vda&#39;] is defined
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  - <span style="color:#ff6ac1">name</span>: Search for second disk, continue only if it is found
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">assert</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">that</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#5af78e">&#34;ansible_facts[&#39;devices&#39;][disk2name] is defined&#34;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">fail_msg</span>: second hard disk not found
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  - <span style="color:#ff6ac1">name</span>: Debug detected disk
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">debug</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">msg</span>: <span style="color:#5af78e">&#34;{{ disk2name }} was found. Moving forward.&#34;</span>
</span></span><span style="display:flex;"><span>~                                                      </span></span></code></pre></div>
<p>Next, see <a href="/ansible/storage/managing-partitions-and-lvm/">Managing Partitions and LVM</a></p>

  <footer class="footline">
  </footer>
</article>
<article class="default">
  <header class="headline">
  </header>

<h1 id="managing-partitions-and-lvm">Managing Partitions and LVM</h1>

<h3 id="managing-partitions-and-lvm">Managing Partitions and LVM</h3>
<p>After detecting the disk device that needs to be used, you can move on and start creating partitions and logical volumes.</p>
<ul>
<li>partition a disk using the parted module,</li>
<li>work with the lvg and lvol modules to manage LVM logical volumes,</li>
<li>create file systems using the filesystem module and mount them using the mount module</li>
<li>manage swap storage.</li>
</ul>
<h4 id="creating-partitions">Creating Partitions</h4>
<p><strong>Parted Module</strong>
name:</p>
<ul>
<li>Assign unique name, required for GPT partitions
label:</li>
<li>type of partition table, msdos is default, gpt for gpt
device:</li>
<li>Device where you are creating partition
number:</li>
<li>partition number
state:</li>
<li>present or absent to add/remove</li>
</ul>
<p>part_start:</p>
<ul>
<li>Starting position expressed as an offset from the beginning of the disk
part_end:</li>
<li>Where to end the partition
If these arguments are not used, the partition starts at 0% and ends at 100% of
the available disk space.</li>
</ul>
<p>flags:</p>
<ul>
<li>Set specific partition properties such as LVM partition type.</li>
<li>Required for LVM partition type</li>
</ul>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>      - <span style="color:#ff6ac1">name</span>: create new partition
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">parted</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#ff6ac1">name</span>: files
</span></span><span style="display:flex;"><span>          <span style="color:#ff6ac1">label</span>: gpt
</span></span><span style="display:flex;"><span>          <span style="color:#ff6ac1">device</span>: /dev/sdb
</span></span><span style="display:flex;"><span>          <span style="color:#ff6ac1">number</span>: <span style="color:#ff9f43">1</span>
</span></span><span style="display:flex;"><span>          <span style="color:#ff6ac1">state</span>: present
</span></span><span style="display:flex;"><span>          <span style="color:#ff6ac1">part_start</span>: 1MiB
</span></span><span style="display:flex;"><span>          <span style="color:#ff6ac1">part_end</span>: 2GiB
</span></span><span style="display:flex;"><span>      - <span style="color:#ff6ac1">name</span>: create another new partition
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">parted</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#ff6ac1">name</span>: swap
</span></span><span style="display:flex;"><span>          <span style="color:#ff6ac1">label</span>: gpt
</span></span><span style="display:flex;"><span>          <span style="color:#ff6ac1">device</span>: /dev/sdb
</span></span><span style="display:flex;"><span>          <span style="color:#ff6ac1">number</span>: <span style="color:#ff9f43">2</span>
</span></span><span style="display:flex;"><span>          <span style="color:#ff6ac1">state</span>: present
</span></span><span style="display:flex;"><span>          <span style="color:#ff6ac1">part_start</span>: 2GiB
</span></span><span style="display:flex;"><span>          <span style="color:#ff6ac1">part_end</span>: 4GiB
</span></span><span style="display:flex;"><span>          <span style="color:#ff6ac1">flags</span>: [ lvm ]</span></span></code></pre></div>
<h4 id="managing-volume-groups-and-lvm-logical-volumes">Managing Volume Groups and LVM Logical Volumes</h4>
<p><strong>lvg</strong> module</p>
<ul>
<li>manage LVM logical volumes</li>
<li>managing LVM volume groups</li>
</ul>
<p><strong>lvol</strong> module</p>
<ul>
<li>managing LVM logical volumes.</li>
</ul>
<p>Creating an LVM volume group</p>
<ul>
<li><strong>vg</strong> argument to set the name of the volume group</li>
<li><strong>pvs</strong> argument to identify the physical volume (which is often a partition or a disk device) on which the volume group needs to be created.</li>
<li>May need to specify the <strong>pesize</strong> to refer to the size of the physical extents.</li>
</ul>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>- <span style="color:#ff6ac1">name</span>: create a volume group
</span></span><span style="display:flex;"><span>  <span style="color:#ff6ac1">lvg</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">vg</span>: vgdata
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">pesize</span>: <span style="color:#5af78e">&#34;8&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">pvs</span>: /dev/sdb1</span></span></code></pre></div>
<p>After you create an LVM volume group, you can create LVM logical volumes.</p>
<p><strong>lvol</strong> Common Options:
lv</p>
<ul>
<li>Name of the LV
pvs</li>
<li>comma separated list of pvs, if it is a partition then it should have the lvm option set
resizefs</li>
<li>Indicates whether to resize filesystem when the lv is expanded
size</li>
<li>size of the lv
snapshot</li>
<li>specify name if this lv is a snapshot
vg</li>
<li>VG is which the lv should be created</li>
</ul>
<p>Creating an LVM Logical Volume</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>- <span style="color:#ff6ac1">name</span>: create a logical volume
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">lvol</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">lv</span>: lvdata
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">size</span>: <span style="color:#ff9f43">100</span>%FREE
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">vg</span>: vgdata</span></span></code></pre></div>
<h4 id="creating-and-mounting-file-systems">Creating and Mounting File Systems</h4>
<p><strong>filesystem</strong> module</p>
<ul>
<li>Supports creating as well as resizing file systems.</li>
</ul>
<p>Options:
dev</p>
<ul>
<li>block device name
fstype</li>
<li>filesystem type
opts</li>
<li>options passed to mkfs command
resizefs</li>
<li>Extends the filesystem if set to yes. Extended to the current block size</li>
</ul>
<p>Creating an XFS File System</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>- <span style="color:#ff6ac1">name</span>: create an XFS filesystem
</span></span><span style="display:flex;"><span>  <span style="color:#ff6ac1">filesystem</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">dev</span>: /dev/vgdata/lvdata
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">fstype</span>: xfs</span></span></code></pre></div>
<h3 id="mounting-a-filesystem">Mounting a filesystem</h3>
<p><strong>mount</strong> module.</p>
<ul>
<li>Used to mount a filesystem</li>
</ul>
<p>Options:
fstype</p>
<ul>
<li>Filesystem type is not automatically dedected.</li>
<li>Used to specify filesystem type
path</li>
<li>directory to mount the filesystem to
src</li>
<li>device to be mounted
state</li>
<li>Current mount state</li>
<li>mounted to mount device now</li>
<li>present to set in /etc/fstab but not mount it now</li>
</ul>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>      - <span style="color:#ff6ac1">name</span>: mount the filesystem
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">mount</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#ff6ac1">src</span>: /dev/vgdata/lvdata
</span></span><span style="display:flex;"><span>          <span style="color:#ff6ac1">fstype</span>: xfs
</span></span><span style="display:flex;"><span>          <span style="color:#ff6ac1">state</span>: mounted
</span></span><span style="display:flex;"><span>          <span style="color:#ff6ac1">path</span>: /mydir</span></span></code></pre></div>
<h4 id="configuring-swap-space">Configuring Swap Space</h4>
<ul>
<li>
<p>To set up swap space, you first must format a device as swap space and next mount the swap space.</p>
</li>
<li>
<p>To format a device as swap space, you use the filesystem module.</p>
</li>
<li>
<p>There is no specific Ansible module to activate theswap space, so you use the command module to run the Linux <strong>swapon</strong> command.</p>
</li>
<li>
<p>Because adding swap space is not always required, it can be done in a conditional statement.</p>
</li>
<li>
<p>In the statement, use the <strong>ansible_swaptotal_mb</strong> fact to discover how much swap is actually available.</p>
</li>
<li>
<p>If that amount falls below a specific threshold, the swap space can be created and activated.</p>
</li>
</ul>
<p>A conditional check is performed, and additional swap space is configured if the current
amount of swap space is lower than 256 MiB.</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>    ---
</span></span><span style="display:flex;"><span>    - <span style="color:#ff6ac1">name</span>: configure swap storage
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">hosts</span>: ansible2
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">tasks</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#ff6ac1">name</span>: setup swap
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">block</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#ff6ac1">name</span>: make the swap filesystem
</span></span><span style="display:flex;"><span>          <span style="color:#ff6ac1">filesystem</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#ff6ac1">fstype</span>: swap
</span></span><span style="display:flex;"><span>            <span style="color:#ff6ac1">dev</span>: /dev/sdb1
</span></span><span style="display:flex;"><span>        - <span style="color:#ff6ac1">name</span>: activate swap space
</span></span><span style="display:flex;"><span>          <span style="color:#ff6ac1">command</span>: swapon /dev/sdb1
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">when</span>: ansible_swaptotal_mb &lt; 256</span></span></code></pre></div>
<p>Run an ad hoc command to ensure that /dev/sdb on the target host is empty:</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>ansible ansible2 -a <span style="color:#5af78e">&#34;dd if=/dev/zero of=/dev/sdb bs=1M count=10&#34;</span></span></span></code></pre></div>
<p>To make sure that you don&rsquo;t get any errors about partitions that are in use, also reboot the target host:</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0"><code class="language-pre1" data-lang="pre1">ansible ansible2 -m reboot</code></pre></div>
<ul>
<li>Lack of idempotency if the size is specified as 100%FREE, which is a relative value, not an absolute value.</li>
<li>This value works the first time you run the playbook, but it does not the second time you run the playbook.</li>
<li>Because no free space is available, the LVM layer interprets the task as if you wanted to create a logical volume with a size of 0 MiB and will complain about that. To ensure that plays are written in an idempotent way, make sure that you use absolute values, not relative values.</li>
</ul>

  <footer class="footline">
  </footer>
</article>
<article class="default">
  <header class="headline">
  </header>

<h1 id="nfs-setup">NFS Setup</h1>

<p>Server hosting the storage:</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>--- 
</span></span><span style="display:flex;"><span>  - <span style="color:#ff6ac1">name</span>: Install Packages
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">package</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">name</span>:
</span></span><span style="display:flex;"><span>        - nfs-utils
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">state</span>: present
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  - <span style="color:#ff6ac1">name</span>: Ensure directories to export exist
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">file</span>:  <span style="color:#78787e"># noqa 208</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">path</span>: <span style="color:#5af78e">&#34;{{ item }}&#34;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">state</span>: directory
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">with_items</span>: <span style="color:#5af78e">&#34;{{ nfs_exports | map(&#39;split&#39;) | map(&#39;first&#39;) | unique }}&#34;</span>
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  - <span style="color:#ff6ac1">name</span>: Copy exports file
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">template</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">src</span>: exports.j2
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">dest</span>: /etc/exports
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">owner</span>: root
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">group</span>: root
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">mode</span>: <span style="color:#ff9f43">0644</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">notify</span>: reload nfs
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  - <span style="color:#ff6ac1">name</span>: Add firewall rule to enable NFS service
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">ansible.posix.firewalld</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">immediate</span>: <span style="color:#ff6ac1">true</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">state</span>: enabled
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">permanent</span>: <span style="color:#ff6ac1">true</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">service</span>: nfs
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">notify</span>: reload firewalld
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  - <span style="color:#ff6ac1">name</span>: Start and enable NFS service
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">service</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">name</span>: nfs-server
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">state</span>: started
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">enabled</span>: <span style="color:#ff6ac1">yes</span>
</span></span><span style="display:flex;"><span>     <span style="color:#ff6ac1">when</span>: nfs_exports|length &gt; 0
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  - <span style="color:#ff6ac1">name</span>: Set SELinux boolean for NFS
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">ansible.posix.seboolean</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">name</span>: nfs_export_all_rw
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">state</span>: <span style="color:#ff6ac1">yes</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">persistent</span>: <span style="color:#ff6ac1">yes</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  - <span style="color:#ff6ac1">name</span>: install required package for sefcontext module
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">yum</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">name</span>: policycoreutils-python-utils
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">state</span>: present
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  - <span style="color:#ff6ac1">name</span>: Set proper SELinux context on export dir
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">sefcontext</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">target</span>: /{{ item }}(/.*)?
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">setype</span>: nfs_t
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">state</span>: present
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">notify</span>: run restorecon
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">with_items</span>: <span style="color:#5af78e">&#34;{{ nfs_exports | map(&#39;split&#39;) | map(&#39;first&#39;) | unique }}&#34;</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0"><code class="language-j2" data-lang="j2">{% for host in nfs_hosts %}
/data {{ host }} (rw,wdelay,root_squash,no_subtree_check,sec=sys,rw,root_squash,no_all_squash)
{% endfor %}</code></pre></div>
<p>Variables:
nfs_exports:</p>
<ul>
<li>/data server(rw,wdelay,root_squash,no_subtree_check,sec=sys,rw,root_squash,no_all_squash)</li>
</ul>
<p>Handlers</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span>- <span style="color:#ff6ac1">name</span>: reload nfs
</span></span><span style="display:flex;"><span>  <span style="color:#ff6ac1">command</span>: <span style="color:#5af78e">&#39;exportfs -ra&#39;</span>
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>- <span style="color:#ff6ac1">name</span>: reload firewalld
</span></span><span style="display:flex;"><span>  <span style="color:#ff6ac1">command</span>: firewall-cmd --reload
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>- <span style="color:#ff6ac1">name</span>: run restorecon
</span></span><span style="display:flex;"><span>  <span style="color:#ff6ac1">command</span>: restorecon -Rv /codata</span></span></code></pre></div>
<p>storage:</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span> <span style="color:#ff6ac1">name</span>: Detect secondary disk name
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">ignore_errors</span>: <span style="color:#ff6ac1">yes</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">set_fact</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">disk2name</span>: vda
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">when</span>: ansible_facts[&#39;devices&#39;][&#39;vda&#39;] is defined
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  - <span style="color:#ff6ac1">name</span>: Search for second disk, continue only if it is found
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">assert</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">that</span>:
</span></span><span style="display:flex;"><span>        - disk2name is defined
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">fail_msg</span>: second hard disk not found
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  - <span style="color:#ff6ac1">name</span>: Debug detected disk
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">debug</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">msg</span>: <span style="color:#5af78e">&#34;{{ disk2name }} was found. Moving forward.&#34;</span>  
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  - <span style="color:#ff6ac1">name</span>: Create LVM and partitions
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">block</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#ff6ac1">name</span>: Create LVM Partition on second disk
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">parted</span>: 
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">name</span>: data
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">label</span>: gpt
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">device</span>: /dev/{{ disk2name }}
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">number</span>: <span style="color:#ff9f43">1</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">state</span>: present
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">flags</span>: [ lvm ]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    - <span style="color:#ff6ac1">name</span>: Create an LVM volume group
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">lvg</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">vg</span>: vgcodata
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">pvs</span>: /dev/{{ disk2name }}1
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    - <span style="color:#ff6ac1">name</span>: Create lv
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">lvol</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">lv</span>: lvdata
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">size</span>: <span style="color:#ff9f43">100</span>%FREE
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">vg</span>: vgdata
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    - <span style="color:#ff6ac1">name</span>: create filesystem
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">filesystem</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">dev</span>: /dev/vgdata/lvdata
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">fstype</span>: xfs
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">when</span>: ansible_facts[&#39;devices&#39;][&#39;vda&#39;][&#39;partitions&#39;] is not defined
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>  - <span style="color:#ff6ac1">name</span>: Create data directory
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">file</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">dest</span>: /data
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">mode</span>: <span style="color:#ff9f43">777</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">state</span>: directory
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>  - <span style="color:#ff6ac1">name</span>: Mount the filesystem
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">mount</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">src</span>: /dev/vgdata/lvdata
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">fstype</span>: xfs
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">state</span>: present
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">path</span>: /data
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  - <span style="color:#ff6ac1">name</span>: Set permissions on mounted filesystem
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">file</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">path</span>: /data
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">state</span>: directory
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">mode</span>: <span style="color:#5af78e">&#39;0777&#39;</span>
</span></span><span style="display:flex;"><span>    ```</span></span></code></pre></div>

  <footer class="footline">
  </footer>
</article>
          </section>
        </div>
      </main>
    </div>
    <script>
      window.MathJax = Object.assign( window.MathJax || {}, {
        tex: {
          inlineMath:  [['\\(', '\\)'], ['$',  '$']],  
          displayMath: [['\\[', '\\]'], ['$$', '$$']], 
        },
        options: {
          enableMenu: false 
        }
      }, JSON.parse("{}") );
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="/js/js-yaml/js-yaml.min.js?1762527413" defer></script>
    <script src="/js/d3/d3-color.min.js?1762527413" defer></script>
    <script src="/js/d3/d3-dispatch.min.js?1762527413" defer></script>
    <script src="/js/d3/d3-drag.min.js?1762527413" defer></script>
    <script src="/js/d3/d3-ease.min.js?1762527413" defer></script>
    <script src="/js/d3/d3-interpolate.min.js?1762527413" defer></script>
    <script src="/js/d3/d3-selection.min.js?1762527413" defer></script>
    <script src="/js/d3/d3-timer.min.js?1762527413" defer></script>
    <script src="/js/d3/d3-transition.min.js?1762527413" defer></script>
    <script src="/js/d3/d3-zoom.min.js?1762527413" defer></script>
    <script src="https://unpkg.com/mermaid/dist/mermaid.min.js" defer></script>
    <script>
      window.relearn.themeUseMermaid = JSON.parse("{ \"theme\": \"default\" }");
    </script>
    <script src="/js/clipboard/clipboard.min.js?1762527413" defer></script>
    <script src="/js/perfect-scrollbar/perfect-scrollbar.min.js?1762527413" defer></script>
    <script src="/js/theme.min.js?1762527413" defer></script>
  </body>
</html>
