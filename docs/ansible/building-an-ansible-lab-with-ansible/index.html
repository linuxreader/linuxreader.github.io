<!DOCTYPE html>
<html lang="en-us" dir="ltr" itemscope itemtype="http://schema.org/Article" data-r-output-format="html">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="height=device-height, width=device-width, initial-scale=1.0, minimum-scale=1.0">
    <meta name="generator" content="Hugo 0.152.2">
    <meta name="generator" content="Relearn 8.2.0+d150cc8909ed7836ff5d545e76544f6923ffacf5">
    <meta name="description" content="Building an Ansible lab with Ansible using Ansible and Libvirt">
    <meta name="author" content="David Thomas">
    <meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="Building an Ansible lab with Ansible :: Linux Reader">
    <meta name="twitter:description" content="Building an Ansible lab with Ansible using Ansible and Libvirt">
    <meta property="og:url" content="https://linuxreader.com/ansible/building-an-ansible-lab-with-ansible/">
    <meta property="og:site_name" content="Linux Reader">
    <meta property="og:title" content="Building an Ansible lab with Ansible :: Linux Reader">
    <meta property="og:description" content="Building an Ansible lab with Ansible using Ansible and Libvirt">
    <meta property="og:locale" content="en_us">
    <meta property="og:type" content="article">
    <meta property="article:section" content="Ansible">
    <meta itemprop="name" content="Building an Ansible lab with Ansible :: Linux Reader">
    <meta itemprop="description" content="Building an Ansible lab with Ansible using Ansible and Libvirt">
    <meta itemprop="wordCount" content="1516">
    <title>Building an Ansible lab with Ansible :: Linux Reader</title>
    <link href="/ansible/building-an-ansible-lab-with-ansible/index.xml" rel="alternate" type="application/rss+xml" title="Building an Ansible lab with Ansible :: Linux Reader">
    <link href="/ansible/building-an-ansible-lab-with-ansible/index.print.html" rel="alternate" type="text/html" title="Building an Ansible lab with Ansible :: Linux Reader">
    <link href="/images/favicon.svg?1764692661" rel="icon" type="image/svg+xml">
    <link href="/css/auto-complete/auto-complete.min.css?1764692661" rel="stylesheet">
    <script src="/js/auto-complete/auto-complete.min.js?1764692661" defer></script>
    <script src="/js/search-lunr.min.js?1764692661" defer></script>
    <script src="/js/search.min.js?1764692661" defer></script>
    <script>
      window.relearn = window.relearn || {};
      window.relearn.index_js_url="/searchindex.en.js?1764692661";
    </script>
    <script src="/js/lunr/lunr.min.js?1764692661" defer></script>
    <script src="/js/lunr/lunr.stemmer.support.min.js?1764692661" defer></script>
    <script src="/js/lunr/lunr.multi.min.js?1764692661" defer></script>
    <script src="/js/lunr/lunr.en.min.js?1764692661" defer></script>
    <script>
      window.relearn = window.relearn || {};
      window.relearn.contentLangs=['en'];
    </script>
    <link href="/fonts/fontawesome/css/fontawesome-all.min.css?1764692661" rel="stylesheet" media="print" onload="this.media='all';this.onload=null;"><noscript><link href="/fonts/fontawesome/css/fontawesome-all.min.css?1764692661" rel="stylesheet"></noscript>
    <link href="/css/perfect-scrollbar/perfect-scrollbar.min.css?1764692661" rel="stylesheet">
    <link href="/css/theme.min.css?1764692661" rel="stylesheet">
    <link href="/css/format-html.min.css?1764692661" rel="stylesheet" id="R-format-style">
    <script>
      window.relearn = window.relearn || {};
      // configuration
      window.relearn.min = `.min`;
      window.relearn.path='\/ansible\/building-an-ansible-lab-with-ansible\/';
      window.relearn.relBasePath='..\/..';
      window.relearn.relBaseUri='..\/..';
      window.relearn.absBaseUri='https:\/\/linuxreader.com';
      window.relearn.disableAnchorCopy=false;
      window.relearn.disableAnchorScrolling=false;
      window.relearn.disableInlineCopyToClipboard=true;
      window.relearn.enableBlockCodeWrap=true;
      // legal
      window.relearn.getItem = (s,n) => {return s.getItem(n)};
      window.relearn.setItem = (s,n,v) => {return s.setItem(n,v)};
      window.relearn.removeItem = (s,n) => {return s.removeItem(n)};
      // translations
      window.T_Copy_to_clipboard = `Copy to clipboard`;
      window.T_Copied_to_clipboard = `Copied to clipboard!`;
      window.T_Copy_link_to_clipboard = `Copy link to clipboard`;
      window.T_Link_copied_to_clipboard = `Copied link to clipboard!`;
      window.T_Reset_view = `Reset view`;
      window.T_View_reset = `View reset!`;
      window.T_No_results_found = `No results found for "{0}"`;
      window.T_N_results_found = `{1} results found for "{0}"`;
      // variant stuff
      window.relearn.themevariants = [ 'oled' ];
      window.relearn.customvariantname = "my-custom-variant";
      window.relearn.changeVariant = function(variant) {
        var oldVariant = document.documentElement.dataset.rThemeVariant;
        window.relearn.setItem(window.localStorage, window.relearn.absBaseUri + "/variant", variant);
        document.documentElement.dataset.rThemeVariant = variant;
        if (oldVariant != variant) {
          document.dispatchEvent( new CustomEvent('themeVariantLoaded', { detail: { variant, oldVariant } }) );
          window.relearn.markVariant();
        }
      }
      window.relearn.markVariant = function() {
        var variant = window.relearn.getItem(window.localStorage, window.relearn.absBaseUri + "/variant");
        document.querySelectorAll(".R-variantswitcher select").forEach((select) => {select.value = variant;});
      }
      window.relearn.initVariant = function() {
        var variant = window.relearn.getItem(window.localStorage, window.relearn.absBaseUri + "/variant") ?? "";
        if( variant == window.relearn.customvariantname ){
        }else if( !variant || !window.relearn.themevariants.includes(variant) ){
          variant = window.relearn.themevariants[0];
          window.relearn.setItem(window.localStorage, window.relearn.absBaseUri + "/variant", variant);
        }
        document.documentElement.dataset.rThemeVariant = variant;
      }
      window.relearn.initVariant();
      window.relearn.markVariant();
    </script>




   
   <!-- Thanks for using github/divinerites/plausible-hugo v1.22.0. Please, consider leaving a star on Github if you like it. -->











    
        <link rel="preconnect" href="https://https://analytics.linuxreader.com:8443">
    
        
            
            <script defer  data-domain="linuxreader.com" src="https://https://analytics.linuxreader.com:8443/js/script.js" ></script>

<!-- If you are using Content-Security-Policy, do not forget to add this code to your CSP : 
  script-src 'unsafe-inline' https://https://analytics.linuxreader.com:8443
  connect-src 'unsafe-inline' https://https://analytics.linuxreader.com:8443
  or just add the partial 'plausible_csp.html' to those 2 csp directives in your 'index.headers' file
-->



    
    <script>window.plausible = window.plausible || function() { (window.plausible.q = window.plausible.q || []).push(arguments) }</script>
    <script>
         
         
         
    </script>

    

<style>
:root {
    --MENU-WIDTH-S: 14.375rem;
    --MENU-WIDTH-M: 14.375rem;
    --MENU-WIDTH-L: 18.75rem;
    --MAIN-WIDTH-MAX: 80rem;
    font-size: 1.2rem;
}
</style>

  </head>
  <body class="mobile-support html" data-url="/ansible/building-an-ansible-lab-with-ansible/">
    <div id="R-body" class="default-animation">
      <div id="R-body-overlay"></div>
      <nav id="R-topbar">
        <div class="topbar-wrapper">
          <div class="topbar-sidebar-divider"></div>
          <div class="topbar-area topbar-area-start" data-area="start">
            <div class="topbar-button topbar-button-sidebar" data-content-empty="disable" data-width-s="show" data-width-m="hide" data-width-l="hide">
<span class="btn cstyle link noborder notitle interactive"><button onclick="toggleNav()" type="button" title="Menu (CTRL&#43;ALT&#43;n)"><i class="fa-fw fas fa-bars"></i></button></span>
            </div>
            <div class="topbar-button topbar-button-prev" data-content-empty="disable" data-width-s="show" data-width-m="show" data-width-l="show">
<span class="btn cstyle link noborder notitle interactive"><a href="/ansible/boot-process/" title="Boot Process (ðŸ¡)"><i class="fa-fw fas fa-chevron-left"></i></a></span>
            </div>

            <div class="topbar-button topbar-button-toc" data-content-empty="hide" data-width-s="show" data-width-m="show" data-width-l="show">
<span class="btn cstyle link noborder notitle interactive"><button onclick="toggleTopbarFlyout(this)" type="button" title="Table of Contents (CTRL&#43;ALT&#43;t)"><i class="fa-fw fas fa-list-alt"></i></button></span>
              <div class="topbar-content">
                <div class="topbar-content-wrapper">
<nav class="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#creating-the-role">Creating the role</a></li>
        <li><a href="#define-variables">Define variables</a></li>
        <li><a href="#defining-a-vm-template">Defining a VM template</a></li>
      </ul>
    </li>
    <li><a href="#define-tasks-for-the-role-to-perform">Define tasks for the role to perform</a></li>
  </ul>
</nav>
                </div>
              </div>
            </div>


          </div>
          <span class="topbar-breadcrumbs highlightable">
            Building an Ansible lab with Ansible
          </span>
          <div class="topbar-area topbar-area-end" data-area="end">
            <div class="topbar-button topbar-button-print" data-content-empty="disable" data-width-s="area-more" data-width-m="show" data-width-l="show">
<span class="btn cstyle link noborder notitle interactive"><a href="/ansible/building-an-ansible-lab-with-ansible/index.print.html" title="Print whole chapter (CTRL+ALT+p)"><i class="fa-fw fas fa-print"></i></a></span>
            </div>

            <div class="topbar-button topbar-button-next" data-content-empty="disable" data-width-s="show" data-width-m="show" data-width-l="show">
<span class="btn cstyle link noborder notitle interactive"><a href="/ansible/common-modules-with-examples/" title="Common modules with examples (ðŸ¡’)"><i class="fa-fw fas fa-chevron-right"></i></a></span>
            </div>







          </div>
        </div>
      </nav>
      <div id="R-main-overlay"></div>
      <main id="R-body-inner" class="highlightable ansible" tabindex="-1">
        <div class="flex-block-wrapper">
<article class="default">
  <header class="headline">
  </header>

<h1 id="building-an-ansible-lab-with-ansible">Building an Ansible lab with Ansible</h1>

<p>When I started studying for RHCE, the study guide had me manually set up virtual machines for the Ansible lab environment. I thought.. Why not start my automation journey right, and automate them using Vagrant.</p>
<p>I use Libvirt to manage KVM/QEMU Virtual Machines and the Virt-Manager app to set them up. I figured I could use Vagrant to automatically build this lab from a file. And I got part of the way. I ended up with this Vagrant file:</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>Vagrant.configure<span style="color:#ff6ac1">(</span><span style="color:#5af78e">&#34;2&#34;</span><span style="color:#ff6ac1">)</span> <span style="color:#ff6ac1">do</span> |config|
</span></span><span style="display:flex;"><span>  config.vm.box <span style="color:#ff6ac1">=</span> <span style="color:#5af78e">&#34;almalinux/9&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  config.vm.provider :libvirt <span style="color:#ff6ac1">do</span> |libvirt|
</span></span><span style="display:flex;"><span>    libvirt.uri <span style="color:#ff6ac1">=</span> <span style="color:#5af78e">&#34;qemu:///system&#34;</span>
</span></span><span style="display:flex;"><span>    libvirt.cpus <span style="color:#ff6ac1">=</span> <span style="color:#ff9f43">2</span>
</span></span><span style="display:flex;"><span>    libvirt.memory <span style="color:#ff6ac1">=</span> <span style="color:#ff9f43">2048</span>
</span></span><span style="display:flex;"><span>  end
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>   config.vm.define <span style="color:#5af78e">&#34;control&#34;</span> <span style="color:#ff6ac1">do</span> |control|
</span></span><span style="display:flex;"><span>    control.vm.network <span style="color:#5af78e">&#34;private_network&#34;</span>, ip: <span style="color:#5af78e">&#34;192.168.124.200&#34;</span>
</span></span><span style="display:flex;"><span>    control.vm.hostname <span style="color:#ff6ac1">=</span> <span style="color:#5af78e">&#34;control.example.com&#34;</span>
</span></span><span style="display:flex;"><span>  end
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  config.vm.define <span style="color:#5af78e">&#34;ansible1&#34;</span> <span style="color:#ff6ac1">do</span> |ansible1|
</span></span><span style="display:flex;"><span>    ansible1.vm.network <span style="color:#5af78e">&#34;private_network&#34;</span>, ip: <span style="color:#5af78e">&#34;192.168.124.201&#34;</span>
</span></span><span style="display:flex;"><span>    ansible1.vm.hostname <span style="color:#ff6ac1">=</span> <span style="color:#5af78e">&#34;ansible1.example.com&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  end
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  config.vm.define <span style="color:#5af78e">&#34;ansible2&#34;</span> <span style="color:#ff6ac1">do</span> |ansible2|
</span></span><span style="display:flex;"><span>    ansible2.vm.network <span style="color:#5af78e">&#34;private_network&#34;</span>, ip: <span style="color:#5af78e">&#34;192.168.124.202&#34;</span>
</span></span><span style="display:flex;"><span>    ansible2.vm.hostname <span style="color:#ff6ac1">=</span> <span style="color:#5af78e">&#34;ansible2.example.com&#34;</span>
</span></span><span style="display:flex;"><span>  end
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>end</span></span></code></pre></div>
<p>I could run this Vagrant file and Build and destroy the lab in seconds. But there was a problem. The Libvirt plugin, or Vagrant itself, I&rsquo;m not sure which, kept me from doing a couple important things.</p>
<p>First, I could not specify the initial disk creation size. I could add additional disks of varying sizes but, if I wanted to change the size of the first disk, I would have to go back in after the fact and expand it manually&hellip;</p>
<p>Second, the Libvirt plugin networking settings were a bit confusing. When you add the private network option as seen in the Vagrant file, it would add this as a secondary connection, and route everything through a different public connection.</p>
<p>Now I couldn&rsquo;t get the VMs to run using the public connection for whatever reason, and it seems the only workaround was to make DHCP reservations for the guests Mac addresses which gave me even more problems to solve. But I won&rsquo;t go there..</p>
<p>So why not get my feet wet and learn how to deploy VMs with Ansible? This way, I would get the granularity and control that Ansible gives me, some extra practice with Ansible, and not having to use software that has just enough abstraction to get in the way.</p>
<p>The guide I followed to set this up can be found on Redhat&rsquo;s blog <a href="https://www.redhat.com/en/blog/build-VM-fast-ansible" rel="external" target="_blank">here.</a> And it was pretty easy to set up all things considered.</p>
<p>I&rsquo;ll rehash the steps here:</p>
<ol>
<li>Download a cloud image</li>
<li>Customize the image</li>
<li>Install and start a VM</li>
<li>Access the VM</li>
</ol>
<h3 id="creating-the-role">Creating the role</h3>
<p>Move to roles directory
<code>cd roles</code></p>
<p>Initialize the role
<code>ansible-galaxy role init kvm_provision</code></p>
<p>Switch into the role directory
<code>cd kvm_provision/</code></p>
<p>Remove unused directories
<code>rm -r files handlers vars</code></p>
<h3 id="define-variables">Define variables</h3>
<p>Add default variables to main.yml
<code>cd defaults/ &amp;&amp; vim main.yml</code></p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span><span style="color:#78787e"># defaults file for kvm_provision</span>
</span></span><span style="display:flex;"><span><span style="color:#ff6ac1">base_image_name</span>: AlmaLinux-9-GenericCloud-9.5-20241120.x86_64.qcow2
</span></span><span style="display:flex;"><span><span style="color:#ff6ac1">base_image_url</span>: https://repo.almalinux.org/almalinux/9/cloud/x86_64/images/{{ base_image_name }}
</span></span><span style="display:flex;"><span><span style="color:#ff6ac1">base_image_sha</span>: abddf01589d46c841f718cec239392924a03b34c4fe84929af5d543c50e37e37
</span></span><span style="display:flex;"><span><span style="color:#ff6ac1">libvirt_pool_dir</span>: <span style="color:#5af78e">&#34;/var/lib/libvirt/images&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff6ac1">vm_name</span>: f34-dev
</span></span><span style="display:flex;"><span><span style="color:#ff6ac1">vm_vcpus</span>: <span style="color:#ff9f43">2</span>
</span></span><span style="display:flex;"><span><span style="color:#ff6ac1">vm_ram_mb</span>: <span style="color:#ff9f43">2048</span>
</span></span><span style="display:flex;"><span><span style="color:#ff6ac1">vm_net</span>: default
</span></span><span style="display:flex;"><span><span style="color:#ff6ac1">vm_root_pass</span>: test123
</span></span><span style="display:flex;"><span><span style="color:#ff6ac1">cleanup_tmp</span>: <span style="color:#ff6ac1">no</span>
</span></span><span style="display:flex;"><span><span style="color:#ff6ac1">ssh_key</span>: /root/.ssh/id_rsa.pub
</span></span><span style="display:flex;"><span><span style="color:#78787e"># Added option to configure ip address</span>
</span></span><span style="display:flex;"><span><span style="color:#ff6ac1">ip_addr</span>: <span style="color:#ff9f43">192.168.124.250</span>
</span></span><span style="display:flex;"><span><span style="color:#ff6ac1">gw_addr</span>: <span style="color:#ff9f43">192.168.124.1</span>
</span></span><span style="display:flex;"><span><span style="color:#78787e"># Added option to configure disk size</span>
</span></span><span style="display:flex;"><span><span style="color:#ff6ac1">vm_disksize</span>: <span style="color:#ff9f43">20</span></span></span></code></pre></div>
<h3 id="defining-a-vm-template">Defining a VM template</h3>
<p>The community.libvirt.virt module is used to provision a KVM VM. This module uses a VM definition in XML format with libvirt syntax. You can dump a VM definition of a current VM and then convert it to a template from there. Or you can just use this:</p>
<p><code>cd templates/ &amp;&amp; vim vm-template.xml.j2</code></p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="color:#ff6ac1">&lt;domain</span> <span style="color:#57c7ff">type=</span><span style="color:#5af78e">&#39;kvm&#39;</span><span style="color:#ff6ac1">&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff6ac1">&lt;name&gt;</span>{{ vm_name }}<span style="color:#ff6ac1">&lt;/name&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff6ac1">&lt;memory</span> <span style="color:#57c7ff">unit=</span><span style="color:#5af78e">&#39;MiB&#39;</span><span style="color:#ff6ac1">&gt;</span>{{ vm_ram_mb }}<span style="color:#ff6ac1">&lt;/memory&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff6ac1">&lt;vcpu</span> <span style="color:#57c7ff">placement=</span><span style="color:#5af78e">&#39;static&#39;</span><span style="color:#ff6ac1">&gt;</span>{{ vm_vcpus }}<span style="color:#ff6ac1">&lt;/vcpu&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff6ac1">&lt;os&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">&lt;type</span> <span style="color:#57c7ff">arch=</span><span style="color:#5af78e">&#39;x86_64&#39;</span> <span style="color:#57c7ff">machine=</span><span style="color:#5af78e">&#39;pc-q35-5.2&#39;</span><span style="color:#ff6ac1">&gt;</span>hvm<span style="color:#ff6ac1">&lt;/type&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">&lt;boot</span> <span style="color:#57c7ff">dev=</span><span style="color:#5af78e">&#39;hd&#39;</span><span style="color:#ff6ac1">/&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff6ac1">&lt;/os&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff6ac1">&lt;cpu</span> <span style="color:#57c7ff">mode=</span><span style="color:#5af78e">&#39;host-model&#39;</span> <span style="color:#57c7ff">check=</span><span style="color:#5af78e">&#39;none&#39;</span><span style="color:#ff6ac1">/&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff6ac1">&lt;devices&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">&lt;emulator&gt;</span>/usr/bin/qemu-system-x86_64<span style="color:#ff6ac1">&lt;/emulator&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">&lt;disk</span> <span style="color:#57c7ff">type=</span><span style="color:#5af78e">&#39;file&#39;</span> <span style="color:#57c7ff">device=</span><span style="color:#5af78e">&#39;disk&#39;</span><span style="color:#ff6ac1">&gt;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">&lt;driver</span> <span style="color:#57c7ff">name=</span><span style="color:#5af78e">&#39;qemu&#39;</span> <span style="color:#57c7ff">type=</span><span style="color:#5af78e">&#39;qcow2&#39;</span><span style="color:#ff6ac1">/&gt;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">&lt;source</span> <span style="color:#57c7ff">file=</span><span style="color:#5af78e">&#39;{{ libvirt_pool_dir }}/{{ vm_name }}.qcow2&#39;</span><span style="color:#ff6ac1">/&gt;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">&lt;target</span> <span style="color:#57c7ff">dev=</span><span style="color:#5af78e">&#39;vda&#39;</span> <span style="color:#57c7ff">bus=</span><span style="color:#5af78e">&#39;virtio&#39;</span><span style="color:#ff6ac1">/&gt;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">&lt;address</span> <span style="color:#57c7ff">type=</span><span style="color:#5af78e">&#39;pci&#39;</span> <span style="color:#57c7ff">domain=</span><span style="color:#5af78e">&#39;0x0000&#39;</span> <span style="color:#57c7ff">bus=</span><span style="color:#5af78e">&#39;0x05&#39;</span> <span style="color:#57c7ff">slot=</span><span style="color:#5af78e">&#39;0x00&#39;</span> <span style="color:#57c7ff">function=</span><span style="color:#5af78e">&#39;0x0&#39;</span><span style="color:#ff6ac1">/&gt;</span>
</span></span><span style="display:flex;"><span>       <span style="color:#78787e">&lt;!-- Added: Specify the disk size using a variable --&gt;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">&lt;size</span> <span style="color:#57c7ff">unit=</span><span style="color:#5af78e">&#39;GiB&#39;</span><span style="color:#ff6ac1">&gt;</span>{{ disk_size }}<span style="color:#ff6ac1">&lt;/size&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">&lt;/disk&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">&lt;interface</span> <span style="color:#57c7ff">type=</span><span style="color:#5af78e">&#39;network&#39;</span><span style="color:#ff6ac1">&gt;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">&lt;source</span> <span style="color:#57c7ff">network=</span><span style="color:#5af78e">&#39;{{ vm_net }}&#39;</span><span style="color:#ff6ac1">/&gt;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">&lt;model</span> <span style="color:#57c7ff">type=</span><span style="color:#5af78e">&#39;virtio&#39;</span><span style="color:#ff6ac1">/&gt;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">&lt;address</span> <span style="color:#57c7ff">type=</span><span style="color:#5af78e">&#39;pci&#39;</span> <span style="color:#57c7ff">domain=</span><span style="color:#5af78e">&#39;0x0000&#39;</span> <span style="color:#57c7ff">bus=</span><span style="color:#5af78e">&#39;0x01&#39;</span> <span style="color:#57c7ff">slot=</span><span style="color:#5af78e">&#39;0x00&#39;</span> <span style="color:#57c7ff">function=</span><span style="color:#5af78e">&#39;0x0&#39;</span><span style="color:#ff6ac1">/&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">&lt;/interface&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">&lt;channel</span> <span style="color:#57c7ff">type=</span><span style="color:#5af78e">&#39;unix&#39;</span><span style="color:#ff6ac1">&gt;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">&lt;target</span> <span style="color:#57c7ff">type=</span><span style="color:#5af78e">&#39;virtio&#39;</span> <span style="color:#57c7ff">name=</span><span style="color:#5af78e">&#39;org.qemu.guest_agent.0&#39;</span><span style="color:#ff6ac1">/&gt;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">&lt;address</span> <span style="color:#57c7ff">type=</span><span style="color:#5af78e">&#39;virtio-serial&#39;</span> <span style="color:#57c7ff">controller=</span><span style="color:#5af78e">&#39;0&#39;</span> <span style="color:#57c7ff">bus=</span><span style="color:#5af78e">&#39;0&#39;</span> <span style="color:#57c7ff">port=</span><span style="color:#5af78e">&#39;1&#39;</span><span style="color:#ff6ac1">/&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">&lt;/channel&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">&lt;channel</span> <span style="color:#57c7ff">type=</span><span style="color:#5af78e">&#39;spicevmc&#39;</span><span style="color:#ff6ac1">&gt;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">&lt;target</span> <span style="color:#57c7ff">type=</span><span style="color:#5af78e">&#39;virtio&#39;</span> <span style="color:#57c7ff">name=</span><span style="color:#5af78e">&#39;com.redhat.spice.0&#39;</span><span style="color:#ff6ac1">/&gt;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">&lt;address</span> <span style="color:#57c7ff">type=</span><span style="color:#5af78e">&#39;virtio-serial&#39;</span> <span style="color:#57c7ff">controller=</span><span style="color:#5af78e">&#39;0&#39;</span> <span style="color:#57c7ff">bus=</span><span style="color:#5af78e">&#39;0&#39;</span> <span style="color:#57c7ff">port=</span><span style="color:#5af78e">&#39;2&#39;</span><span style="color:#ff6ac1">/&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">&lt;/channel&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">&lt;input</span> <span style="color:#57c7ff">type=</span><span style="color:#5af78e">&#39;tablet&#39;</span> <span style="color:#57c7ff">bus=</span><span style="color:#5af78e">&#39;usb&#39;</span><span style="color:#ff6ac1">&gt;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">&lt;address</span> <span style="color:#57c7ff">type=</span><span style="color:#5af78e">&#39;usb&#39;</span> <span style="color:#57c7ff">bus=</span><span style="color:#5af78e">&#39;0&#39;</span> <span style="color:#57c7ff">port=</span><span style="color:#5af78e">&#39;1&#39;</span><span style="color:#ff6ac1">/&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">&lt;/input&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">&lt;input</span> <span style="color:#57c7ff">type=</span><span style="color:#5af78e">&#39;mouse&#39;</span> <span style="color:#57c7ff">bus=</span><span style="color:#5af78e">&#39;ps2&#39;</span><span style="color:#ff6ac1">/&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">&lt;input</span> <span style="color:#57c7ff">type=</span><span style="color:#5af78e">&#39;keyboard&#39;</span> <span style="color:#57c7ff">bus=</span><span style="color:#5af78e">&#39;ps2&#39;</span><span style="color:#ff6ac1">/&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">&lt;graphics</span> <span style="color:#57c7ff">type=</span><span style="color:#5af78e">&#39;spice&#39;</span> <span style="color:#57c7ff">autoport=</span><span style="color:#5af78e">&#39;yes&#39;</span><span style="color:#ff6ac1">&gt;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">&lt;listen</span> <span style="color:#57c7ff">type=</span><span style="color:#5af78e">&#39;address&#39;</span><span style="color:#ff6ac1">/&gt;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">&lt;image</span> <span style="color:#57c7ff">compression=</span><span style="color:#5af78e">&#39;off&#39;</span><span style="color:#ff6ac1">/&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">&lt;/graphics&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">&lt;video&gt;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">&lt;model</span> <span style="color:#57c7ff">type=</span><span style="color:#5af78e">&#39;qxl&#39;</span> <span style="color:#57c7ff">ram=</span><span style="color:#5af78e">&#39;65536&#39;</span> <span style="color:#57c7ff">vram=</span><span style="color:#5af78e">&#39;65536&#39;</span> <span style="color:#57c7ff">vgamem=</span><span style="color:#5af78e">&#39;16384&#39;</span> <span style="color:#57c7ff">heads=</span><span style="color:#5af78e">&#39;1&#39;</span> <span style="color:#57c7ff">primary=</span><span style="color:#5af78e">&#39;yes&#39;</span><span style="color:#ff6ac1">/&gt;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">&lt;address</span> <span style="color:#57c7ff">type=</span><span style="color:#5af78e">&#39;pci&#39;</span> <span style="color:#57c7ff">domain=</span><span style="color:#5af78e">&#39;0x0000&#39;</span> <span style="color:#57c7ff">bus=</span><span style="color:#5af78e">&#39;0x00&#39;</span> <span style="color:#57c7ff">slot=</span><span style="color:#5af78e">&#39;0x01&#39;</span> <span style="color:#57c7ff">function=</span><span style="color:#5af78e">&#39;0x0&#39;</span><span style="color:#ff6ac1">/&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">&lt;/video&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">&lt;memballoon</span> <span style="color:#57c7ff">model=</span><span style="color:#5af78e">&#39;virtio&#39;</span><span style="color:#ff6ac1">&gt;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">&lt;address</span> <span style="color:#57c7ff">type=</span><span style="color:#5af78e">&#39;pci&#39;</span> <span style="color:#57c7ff">domain=</span><span style="color:#5af78e">&#39;0x0000&#39;</span> <span style="color:#57c7ff">bus=</span><span style="color:#5af78e">&#39;0x06&#39;</span> <span style="color:#57c7ff">slot=</span><span style="color:#5af78e">&#39;0x00&#39;</span> <span style="color:#57c7ff">function=</span><span style="color:#5af78e">&#39;0x0&#39;</span><span style="color:#ff6ac1">/&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">&lt;/memballoon&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">&lt;rng</span> <span style="color:#57c7ff">model=</span><span style="color:#5af78e">&#39;virtio&#39;</span><span style="color:#ff6ac1">&gt;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">&lt;backend</span> <span style="color:#57c7ff">model=</span><span style="color:#5af78e">&#39;random&#39;</span><span style="color:#ff6ac1">&gt;</span>/dev/urandom<span style="color:#ff6ac1">&lt;/backend&gt;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">&lt;address</span> <span style="color:#57c7ff">type=</span><span style="color:#5af78e">&#39;pci&#39;</span> <span style="color:#57c7ff">domain=</span><span style="color:#5af78e">&#39;0x0000&#39;</span> <span style="color:#57c7ff">bus=</span><span style="color:#5af78e">&#39;0x07&#39;</span> <span style="color:#57c7ff">slot=</span><span style="color:#5af78e">&#39;0x00&#39;</span> <span style="color:#57c7ff">function=</span><span style="color:#5af78e">&#39;0x0&#39;</span><span style="color:#ff6ac1">/&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">&lt;/rng&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff6ac1">&lt;/devices&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff6ac1">&lt;/domain&gt;</span></span></span></code></pre></div>
<p>The template uses some of the variables from earlier. This allows flexibility to changes things by just changing the variables.</p>
<h2 id="define-tasks-for-the-role-to-perform">Define tasks for the role to perform</h2>
<p><code>cd ../tasks/ &amp;&amp; vim main.yml</code></p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span><span style="color:#78787e"># tasks file for kvm_provision</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#78787e">#Â ensure the required package dependenciesÂ `guestfs-tools`Â andÂ `python3-libvirt`Â are installed. This role requires these packages to connect toÂ `libvirt`Â and to customize the virtual image in a later step. These package names work on Fedora Linux. If you&#39;re using RHEL 8 or CentOS, useÂ `libguestfs-tools`Â instead ofÂ `guestfs-tools`. For other distributions, adjust accordingly.</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>- <span style="color:#ff6ac1">name</span>: Ensure requirements in place
</span></span><span style="display:flex;"><span>  <span style="color:#ff6ac1">package</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">name</span>:
</span></span><span style="display:flex;"><span>      - guestfs-tools
</span></span><span style="display:flex;"><span>      - python3-libvirt
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">state</span>: present
</span></span><span style="display:flex;"><span>  <span style="color:#ff6ac1">become</span>: <span style="color:#ff6ac1">yes</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#78787e"># obtain a list of existing VMs so that you don&#39;t overwrite an existing VM on accident. uses theÂ `virt`Â module from the collectionÂ `community.libvirt`, which interacts with a running instance of KVM withÂ `libvirt`. It obtains the list of VMs by specifying the parameterÂ `command: list_vms`Â and saves the results in a variableÂ `existing_vms`. `changed_when: no`Â for this task to ensure that it&#39;s not marked as changed in the playbook results. This task doesn&#39;t make any change in the machine; it only checks the existing VMs. This is a good practice when developing Ansible automation to prevent false reports of changes.</span>
</span></span><span style="display:flex;"><span>- <span style="color:#ff6ac1">name</span>: Get VMs list
</span></span><span style="display:flex;"><span>  <span style="color:#ff6ac1">community.libvirt.virt</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">command</span>: list_vms
</span></span><span style="display:flex;"><span>  <span style="color:#ff6ac1">register</span>: existing_vms
</span></span><span style="display:flex;"><span>  <span style="color:#ff6ac1">changed_when</span>: <span style="color:#ff6ac1">no</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#78787e">#execute only when the VM name the user provides doesn&#39;t exist. And uses the moduleÂ `get_url`Â to download the base cloud image into theÂ `/tmp`Â directory</span>
</span></span><span style="display:flex;"><span>- <span style="color:#ff6ac1">name</span>: Create VM if not exists
</span></span><span style="display:flex;"><span>  <span style="color:#ff6ac1">block</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ff6ac1">name</span>: Download base image
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">get_url</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">url</span>: <span style="color:#5af78e">&#34;{{ base_image_url }}&#34;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">dest</span>: <span style="color:#5af78e">&#34;/tmp/{{ base_image_name }}&#34;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">checksum</span>: <span style="color:#5af78e">&#34;sha256:{{ base_image_sha }}&#34;</span>
</span></span><span style="display:flex;"><span>      
</span></span><span style="display:flex;"><span><span style="color:#78787e"># copy the file to libvirt&#39;s pool directory so we don&#39;t edit the original, which can be used to provision other VMS later</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#ff6ac1">name</span>: Copy base image to libvirt directory
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">copy</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">dest</span>: <span style="color:#5af78e">&#34;{{ libvirt_pool_dir }}/{{ vm_name }}.qcow2&#34;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">src</span>: <span style="color:#5af78e">&#34;/tmp/{{ base_image_name }}&#34;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">force</span>: <span style="color:#ff6ac1">no</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">remote_src</span>: <span style="color:#ff6ac1">yes</span> 
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">mode</span>: <span style="color:#ff9f43">0660</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">register</span>: copy_results
</span></span><span style="display:flex;"><span>  - 
</span></span><span style="display:flex;"><span><span style="color:#78787e"># Resize the VM disk</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#ff6ac1">name</span>: Resize VM disk
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">command</span>: qemu-img resize &#34;{{ libvirt_pool_dir }}/{{ vm_name }}.qcow2&#34; &#34;{{ disk_size }}G&#34;
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">when</span>: copy_results is changed
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#78787e"># uses command module to run virt-customize to customize the image</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#ff6ac1">name</span>: Configure the image
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">command</span>: |<span style="color:#5af78e">
</span></span></span><span style="display:flex;"><span><span style="color:#5af78e">      virt-customize -a {{ libvirt_pool_dir }}/{{ vm_name }}.qcow2 \
</span></span></span><span style="display:flex;"><span><span style="color:#5af78e">      --hostname {{ vm_name }} \
</span></span></span><span style="display:flex;"><span><span style="color:#5af78e">      --root-password password:{{ vm_root_pass }} \
</span></span></span><span style="display:flex;"><span><span style="color:#5af78e">      --ssh-inject &#39;root:file:{{ ssh_key }}&#39; \
</span></span></span><span style="display:flex;"><span><span style="color:#5af78e">      --uninstall cloud-init --selinux-relabel</span>
</span></span><span style="display:flex;"><span><span style="color:#78787e"># Added option to configure an IP address</span>
</span></span><span style="display:flex;"><span>      --firstboot-command &#34;nmcli c m eth0 con-name eth0 ip4 {{ ip_addr }}/24 gw4 {{ gw_addr }} ipv4.method manual &amp;&amp; nmcli c d eth0 &amp;&amp; nmcli c u eth0&#34;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">when</span>: copy_results is changed
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  - <span style="color:#ff6ac1">name</span>: Define vm
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">community.libvirt.virt</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">command</span>: define
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">xml</span>: <span style="color:#5af78e">&#34;{{ lookup(&#39;template&#39;, &#39;vm-template.xml.j2&#39;) }}&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">when</span>: <span style="color:#5af78e">&#34;vm_name not in existing_vms.list_vms&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>- <span style="color:#ff6ac1">name</span>: Ensure VM is started
</span></span><span style="display:flex;"><span>  <span style="color:#ff6ac1">community.libvirt.virt</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">name</span>: <span style="color:#5af78e">&#34;{{ vm_name }}&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">state</span>: running
</span></span><span style="display:flex;"><span>  <span style="color:#ff6ac1">register</span>: vm_start_results
</span></span><span style="display:flex;"><span>  <span style="color:#ff6ac1">until</span>: <span style="color:#5af78e">&#34;vm_start_results is success&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff6ac1">retries</span>: <span style="color:#ff9f43">15</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff6ac1">delay</span>: <span style="color:#ff9f43">2</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>- <span style="color:#ff6ac1">name</span>: Ensure temporary file is deleted
</span></span><span style="display:flex;"><span>  <span style="color:#ff6ac1">file</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">path</span>: <span style="color:#5af78e">&#34;/tmp/{{ base_image_name }}&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">state</span>: absent
</span></span><span style="display:flex;"><span>  <span style="color:#ff6ac1">when</span>: cleanup_tmp | bool</span></span></code></pre></div>
<p>Changed my user to own the libvirt directory:
<code>chown -R david:david /var/lib/libvirt/images</code></p>
<p>Create playbook <code>kvm_provision.yaml</code></p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yml" data-lang="yml"><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span>- <span style="color:#ff6ac1">name</span>: Deploys VM based on cloud image
</span></span><span style="display:flex;"><span>  <span style="color:#ff6ac1">hosts</span>: localhost
</span></span><span style="display:flex;"><span>  <span style="color:#ff6ac1">gather_facts</span>: <span style="color:#ff6ac1">yes</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff6ac1">become</span>: <span style="color:#ff6ac1">yes</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff6ac1">vars</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">pool_dir</span>: <span style="color:#5af78e">&#34;/var/lib/libvirt/images&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">vm</span>: control
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">vcpus</span>: <span style="color:#ff9f43">2</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">ram_mb</span>: <span style="color:#ff9f43">2048</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">cleanup</span>: <span style="color:#ff6ac1">no</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">net</span>: default
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">ssh_pub_key</span>: <span style="color:#5af78e">&#34;/home/davidt/.ssh/id_ed25519.pub&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">disksize</span>: <span style="color:#ff9f43">20</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff6ac1">tasks</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#ff6ac1">name</span>: KVM Provision role
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">include_role</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">name</span>: kvm_provision
</span></span><span style="display:flex;"><span>      <span style="color:#ff6ac1">vars</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">libvirt_pool_dir</span>: <span style="color:#5af78e">&#34;{{ pool_dir }}&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">vm_name</span>: <span style="color:#5af78e">&#34;{{ vm }}&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">vm_vcpus</span>: <span style="color:#5af78e">&#34;{{ vcpus }}&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">vm_ram_mb</span>: <span style="color:#5af78e">&#34;{{ ram_mb }}&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">vm_net</span>: <span style="color:#5af78e">&#34;{{ net }}&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">cleanup_tmp</span>: <span style="color:#5af78e">&#34;{{ cleanup }}&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">ssh_key</span>: <span style="color:#5af78e">&#34;{{ ssh_pub_key }}&#34;</span></span></span></code></pre></div>
<p>Add the libvirt collection
<code>ansible-galaxy collection install community.libvirt</code></p>
<p>Create a VM with a new name
<code>ansible-playbook -K kvm_provision.yaml -e vm=ansible1</code></p>
<p>&ndash;run-command &rsquo;nmcli c a type Ethernet ifname eth0 con-name eth0 ip4 192.168.124.200 gw4 192.168.124.1'</p>
<p>parted /dev/vda resizepargit t 4 100%
Warning: Partition /dev/vda4 is being used. Are you sure you want to continue?
Yes/No? y                                                              <br>
Information: You may need to update /etc/fstab.</p>
<p>lsblk
NAME   MAJ:MIN RM  SIZE RO TYPE MOUNTPOINTS
vda    252:0    0   20G  0 disk
â”œâ”€vda2 252:2    0  200M  0 part /boot/efi
â”œâ”€vda3 252:3    0    1G  0 part /boot
â””â”€vda4 252:4    0  8.8G  0 part /</p>
<p>variables
{{ ansible_user }}
{{ ansible_password }}
{{ gw_addr }}
{{ ip_addr }}</p>
<p>; useradd -m -p {{ ansible_user }} ; chage -d 0 {{ ansible_user }} ; cat {{ ansible_password }} &gt; passwd {{ ansible_user }} &ndash;stdin&quot; \</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0"><code>  - name: Configure the image
    command: |
      virt-customize -a {{ libvirt_pool_dir }}/{{ vm_name }}.qcow2 \
      --hostname {{ vm_name }} \
      --root-password password:{{ vm_root_pass }} \
      --uninstall cloud-init --selinux-relabel \
      --firstboot-command &#34;nmcli c m eth0 con-name eth0 ip4 \
                           {{ ip_addr }}/24 gw4 {{ gw_addr }} \
                           ipv4.method manual &amp;&amp; nmcli c d eth0 \
                           &amp;&amp; nmcli c u eth0 &amp;&amp; adduser \
                           {{ ansible_user }} &amp;&amp; echo \
                           &#34;{{ ansible_password }}&#34; | passwd \
                           --stdin {{ ansible_user }}&#34;
    when: copy_results is changed

  - name: Add ssh keys
    command: |
      virt-customize -a {{ libvirt_pool_dir }}/{{ vm_name }}.qcow2 \
      --ssh-inject &#39;{{ ansible_user }}:file:{{ ssh_key }}&#39;</code></pre></div>

  <footer class="footline">
  </footer>
</article>
        </div>
      </main>
    </div>
    <aside id="R-sidebar" class="default-animation">
      <div id="R-header-topbar" class="default-animation"></div>
      <div id="R-header-wrapper" class="default-animation">
        <div id="R-header" class="default-animation">
<a href="https://linuxreader.com">
  <img src="/images/linuxreader.svg" alt="Linux Reader" >
</a>

        </div>
        <search><form action="/search/" method="get">
          <div class="searchbox default-animation">
            <button class="search-detail" type="submit" title="Search (CTRL+ALT+f)"><i class="fas fa-search"></i></button>
            <label class="a11y-only" for="R-search-by">Search</label>
            <input data-search-input id="R-search-by" name="search-by" class="search-by" type="search" placeholder="Search...">
            <button class="search-clear" type="button" data-search-clear="" title="Clear search"><i class="fas fa-times" title="Clear search"></i></button>
          </div>
        </form></search>
      </div>
      <div id="R-homelinks" class="default-animation">
        <div class="R-menu-divider default-animation">
          <hr class="padding">
        </div>
        <div class="R-sidebarmenu R-shortcutmenu-homelinks">
          <ul class="space collapsible-menu">
          </ul>
        </div>
        <div class="R-menu-divider default-animation">
          <hr class="padding">
        </div>
        <div class="R-sidebarmenu R-shortcutmenu-headercontrols">
          <ul class="">
          </ul>
        </div>
        <div class="R-menu-divider default-animation">
          <hr class="padding">
        </div>
      </div>
      <div id="R-content-wrapper" class="highlightable">
        <div class="R-sidebarmenu R-shortcutmenu-main">
          <ul class="enlarge morespace collapsible-menu">
            <li class="parent " data-nav-url="/ansible/"><a class="padding" href="/ansible/"><i class="fa-solid fa-robot"></i> Ansible</a><ul id="R-subsections-e5b911977d99c31c82b120cc3d2f2606" class="collapsible-menu">
            <li class="" data-nav-url="/ansible/ansible-builder/"><a class="padding" href="/ansible/ansible-builder/">Ansible Builder</a></li>
            <li class="" data-nav-url="/ansible/ansible-documentation/"><a class="padding" href="/ansible/ansible-documentation/">Ansible Documentation</a></li>
            <li class="" data-nav-url="/ansible/ansible-facts/"><a class="padding" href="/ansible/ansible-facts/">Ansible Facts</a></li>
            <li class="" data-nav-url="/ansible/ansible-galaxy-roles/"><a class="padding" href="/ansible/ansible-galaxy-roles/">Ansible Galaxy Roles</a></li>
            <li class="" data-nav-url="/ansible/ansible-inventory/"><a class="padding" href="/ansible/ansible-inventory/">Ansible Inventory and Ansible.cfg</a></li>
            <li class="" data-nav-url="/ansible/ansible-playbooks/"><a class="padding" href="/ansible/ansible-playbooks/">Ansible Playbooks</a></li>
            <li class="" data-nav-url="/ansible/using-ansible-roles/"><a class="padding" href="/ansible/using-ansible-roles/">Ansible Roles</a></li>
            <li class="" data-nav-url="/ansible/ansible-vault/"><a class="padding" href="/ansible/ansible-vault/">Ansible Vault</a></li>
            <li class="" data-nav-url="/ansible/ansible-inventory-command/"><a class="padding" href="/ansible/ansible-inventory-command/">Ansible-inventory command</a></li>
            <li class="" data-nav-url="/ansible/ansible.cfg/"><a class="padding" href="/ansible/ansible.cfg/">Ansible.cfg</a></li>
            <li class="" data-nav-url="/ansible/boot-process/"><a class="padding" href="/ansible/boot-process/">Boot Process</a></li>
            <li class="active " data-nav-url="/ansible/building-an-ansible-lab-with-ansible/"><a class="padding" href="/ansible/building-an-ansible-lab-with-ansible/">Building an Ansible lab with Ansible</a></li>
            <li class="" data-nav-url="/ansible/common-modules-with-examples/"><a class="padding" href="/ansible/common-modules-with-examples/">Common modules with examples</a></li>
            <li class="" data-nav-url="/ansible/deploying-files/"><a class="padding" href="/ansible/deploying-files/">Deploying files</a></li>
            <li class="" data-nav-url="/ansible/discovering-storage-related-facts/"><a class="padding" href="/ansible/discovering-storage-related-facts/">Discovering storage related facts</a></li>
            <li class="" data-nav-url="/ansible/dynamic-inventory/"><a class="padding" href="/ansible/dynamic-inventory/">Dynamic Inventory</a></li>
            <li class="" data-nav-url="/ansible/encrypted-passwords/"><a class="padding" href="/ansible/encrypted-passwords/">Encrypted passwords</a></li>
            <li class="" data-nav-url="/ansible/execution-environments/"><a class="padding" href="/ansible/execution-environments/">Execution Environments</a></li>
            <li class="" data-nav-url="/ansible/handlers/"><a class="padding" href="/ansible/handlers/">Handlers</a></li>
            <li class="" data-nav-url="/ansible/host-name-patterns/"><a class="padding" href="/ansible/host-name-patterns/">Host Name Patterns</a></li>
            <li class="" data-nav-url="/ansible/including-and-importing-files/"><a class="padding" href="/ansible/including-and-importing-files/">Including and importing Files</a></li>
            <li class="" data-nav-url="/ansible/jinja2-templates/"><a class="padding" href="/ansible/jinja2-templates/">Jinja2 templates</a></li>
            <li class="" data-nav-url="/ansible/managing-ansible-errors-and-logs/"><a class="padding" href="/ansible/managing-ansible-errors-and-logs/">Managing Ansible Errors and Logs</a></li>
            <li class="" data-nav-url="/ansible/managing-packages/"><a class="padding" href="/ansible/managing-packages/">Managing Packages</a></li>
            <li class="" data-nav-url="/ansible/managing-partitions-and-lvm/"><a class="padding" href="/ansible/managing-partitions-and-lvm/">Managing Partitions and LVM</a></li>
            <li class="" data-nav-url="/ansible/managing-services/"><a class="padding" href="/ansible/managing-services/">Managing Services</a></li>
            <li class="" data-nav-url="/ansible/networking-with-ansible/"><a class="padding" href="/ansible/networking-with-ansible/">Networking with Ansible</a></li>
            <li class="" data-nav-url="/ansible/nfs-setup/"><a class="padding" href="/ansible/nfs-setup/">NFS Setup</a></li>
            <li class="" data-nav-url="/ansible/optimizing-ansible-processing/"><a class="padding" href="/ansible/optimizing-ansible-processing/">Optimizing Ansible Processing</a></li>
            <li class="" data-nav-url="/ansible/repositories-and-subscriptions/"><a class="padding" href="/ansible/repositories-and-subscriptions/">Repositories and subscriptions</a></li>
            <li class="" data-nav-url="/ansible/selinux-file-properties/"><a class="padding" href="/ansible/selinux-file-properties/">SeLinux File Properties</a></li>
            <li class="" data-nav-url="/ansible/setting-up-an-ansible-lab/"><a class="padding" href="/ansible/setting-up-an-ansible-lab/">Setting up an Ansible Lab</a></li>
            <li class="" data-nav-url="/ansible/ssh-connections/"><a class="padding" href="/ansible/ssh-connections/">SSH Connections</a></li>
            <li class="" data-nav-url="/ansible/troubleshooting-common-scenarios/"><a class="padding" href="/ansible/troubleshooting-common-scenarios/">Troubleshooting Common Scenarios</a></li>
            <li class="" data-nav-url="/ansible/users-and-groups/"><a class="padding" href="/ansible/users-and-groups/">Users and Groups</a></li>
            <li class="" data-nav-url="/ansible/using-ad-hoc-commands-in-scripts/"><a class="padding" href="/ansible/using-ad-hoc-commands-in-scripts/">Using Ad Hoc commands in scripts</a></li>
            <li class="" data-nav-url="/ansible/using-loops-and-items/"><a class="padding" href="/ansible/using-loops-and-items/">Using Loops and Items</a></li>
            <li class="" data-nav-url="/ansible/using-modules-for-troubleshooting-and-testing/"><a class="padding" href="/ansible/using-modules-for-troubleshooting-and-testing/">Using Modules for Troubleshooting and Testing</a></li>
            <li class="" data-nav-url="/ansible/using-multiple-inventories/"><a class="padding" href="/ansible/using-multiple-inventories/">Using Multiple Inventories</a></li>
            <li class="" data-nav-url="/ansible/using-rhel-system-roles/"><a class="padding" href="/ansible/using-rhel-system-roles/">Using RHEL System roles</a></li>
            <li class="" data-nav-url="/ansible/using-tags/"><a class="padding" href="/ansible/using-tags/">Using Tags</a></li>
            <li class="" data-nav-url="/ansible/using-when-to-run-tasks-conditionally/"><a class="padding" href="/ansible/using-when-to-run-tasks-conditionally/">Using when to Run Tasks Conditionally</a></li>
            <li class="" data-nav-url="/ansible/variables/"><a class="padding" href="/ansible/variables/">Variables</a></li></ul></li>
            <li class="" data-nav-url="/bash/"><a class="padding" href="/bash/"><i class="fa-fw fas fa-code"></i> Bash</a><ul id="R-subsections-4b42c24c987a75657a389c72aa61a56d" class="collapsible-menu"></ul></li>
            <li class="" data-nav-url="/boot/"><a class="padding" href="/boot/"><i class="fa-solid fa-hourglass-start"></i> Boot</a><ul id="R-subsections-a53bfb333437907a8d5bdc636d15c75d" class="collapsible-menu"></ul></li>
            <li class="" data-nav-url="/containers/"><a class="padding" href="/containers/"><i class="fa-solid fa-cubes"></i> Containers</a><ul id="R-subsections-98e55644e7defe4a283b28e510b18cf5" class="collapsible-menu"></ul></li>
            <li class="" data-nav-url="/cyber-security/"><a class="padding" href="/cyber-security/"><i class="fa-solid fa-user-secret"></i> Cyber Security</a><ul id="R-subsections-f95cf8cea1c115dd046e46a833f33dfa" class="collapsible-menu"></ul></li>
            <li class="" data-nav-url="/desktop/"><a class="padding" href="/desktop/"><i class="fa-fw fas fa-computer"></i> Desktop</a><ul id="R-subsections-e1fc414efb00462ad25041a21e45e696" class="collapsible-menu"></ul></li>
            <li class="" data-nav-url="/files/"><a class="padding" href="/files/"><i class="fa-solid fa-copy"></i> Files</a><ul id="R-subsections-31e56884d732922d4a0e407592968056" class="collapsible-menu"></ul></li>
            <li class="" data-nav-url="/networking/"><a class="padding" href="/networking/"><i class="fa-fw fas fa-network-wired"></i> Networking</a><ul id="R-subsections-d7c3359b808d40df139a3bb9f9073483" class="collapsible-menu"></ul></li>
            <li class="" data-nav-url="/packages/"><a class="padding" href="/packages/"><i class="fa-solid fa-box-open"></i> Packages</a><ul id="R-subsections-bdf1e8ce92aa8ff6883c617f10480430" class="collapsible-menu"></ul></li>
            <li class="" data-nav-url="/storage/"><a class="padding" href="/storage/"><i class="fa-solid fa-hard-drive"></i> Storage</a><ul id="R-subsections-28a53f7a259bc0e6bfd5bf73591250a9" class="collapsible-menu"></ul></li>
            <li class="" data-nav-url="/system/"><a class="padding" href="/system/"><i class="fa-solid fa-server"></i> System</a><ul id="R-subsections-0ea554b019cc5a3e6337c45b68b3a647" class="collapsible-menu"></ul></li>
            <li class="" data-nav-url="/tools/"><a class="padding" href="/tools/"><i class="fa-solid fa-screwdriver-wrench"></i> Tools</a><ul id="R-subsections-bf1399820dde3dd110e03ace4147ff86" class="collapsible-menu"></ul></li>
            <li class="" data-nav-url="/users-and-groups/"><a class="padding" href="/users-and-groups/"><i class="fa-solid fa-users"></i> Users and Groups</a><ul id="R-subsections-ea23e0c86f0adbd857ee01a4f4dd70e4" class="collapsible-menu"></ul></li>
            <li class="" data-nav-url="/virtualization/"><a class="padding" href="/virtualization/"><i class="fa-solid fa-microchip"></i> Virtualization</a><ul id="R-subsections-da8ee4406de37987b502b79e5b0a9d1c" class="collapsible-menu"></ul></li>
          </ul>
        </div>
        <div class="R-sidebarmenu R-shortcutmenu-shortcuts">
          <div class="nav-title padding">More</div>
          <ul class="space collapsible-menu">
            <li class="" data-nav-url="/about/"><a class="padding" href="/about/"><i class='fas fa-solid fa-circle-info'></i> About</a></li>
            <li class="" data-nav-url="https://www.youtube.com/@linuxreader"><a class="padding" href="https://www.youtube.com/@linuxreader" rel="external" target="_blank"><i class='fas fa-fw fa-play'></i> YouTube</a></li>
            <li class="" data-nav-url="/contact/"><a class="padding" href="/contact/"><i class='fas fa-fw fa-envelope'></i> Contact</a></li>
            <li class="" data-nav-url="https://github.com/linuxreader"><a class="padding" href="https://github.com/linuxreader" rel="external" target="_blank"><i class='fab fa-fw fa-github'></i> GitHub</a></li>
            <li class="" data-nav-url="https://linkedin.com/in/linuxreader/"><a class="padding" href="https://linkedin.com/in/linuxreader/" rel="external" target="_blank"><i class='fab fa-fw fa-linkedin'></i> LinkedIn</a></li>
          </ul>
        </div>
        <div id="R-footer-margin"></div>
        <div class="R-menu-divider default-animation">
          <hr class="padding">
        </div>
        <div class="R-sidebarmenu R-shortcutmenu-footercontrols">
          <ul class="">
          </ul>
        </div>
<div id="R-footer"><p>Built with <a href="https://github.com/McShelby/hugo-theme-relearn" title="love"><i class="fas fa-heart"></i></a> by <a href="https://gohugo.io/">Hugo</a></p></div>
      </div>
    </aside>
    <script>
      window.MathJax = Object.assign( window.MathJax || {}, {
        tex: {
          inlineMath:  [['\\(', '\\)'], ['$',  '$']],  
          displayMath: [['\\[', '\\]'], ['$$', '$$']], 
        },
        options: {
          enableMenu: false 
        }
      }, JSON.parse("{}") );
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="/js/js-yaml/js-yaml.min.js?1764692661" defer></script>
    <script src="/js/d3/d3-color.min.js?1764692661" defer></script>
    <script src="/js/d3/d3-dispatch.min.js?1764692661" defer></script>
    <script src="/js/d3/d3-drag.min.js?1764692661" defer></script>
    <script src="/js/d3/d3-ease.min.js?1764692661" defer></script>
    <script src="/js/d3/d3-interpolate.min.js?1764692661" defer></script>
    <script src="/js/d3/d3-selection.min.js?1764692661" defer></script>
    <script src="/js/d3/d3-timer.min.js?1764692661" defer></script>
    <script src="/js/d3/d3-transition.min.js?1764692661" defer></script>
    <script src="/js/d3/d3-zoom.min.js?1764692661" defer></script>
    <script src="https://unpkg.com/mermaid/dist/mermaid.min.js" defer></script>
    <script>
      window.relearn.themeUseMermaid = JSON.parse("{ \"theme\": \"default\" }");
    </script>
    <script src="/js/clipboard/clipboard.min.js?1764692661" defer></script>
    <script src="/js/perfect-scrollbar/perfect-scrollbar.min.js?1764692661" defer></script>
    <script src="/js/theme.min.js?1764692661" defer></script><script async src="https://eomail5.com/form/d37e6864-cf88-11f0-8615-fbed900cb19e.js" data-form="d37e6864-cf88-11f0-8615-fbed900cb19e"></script>

  </body>
</html>
