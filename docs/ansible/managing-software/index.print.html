<!DOCTYPE html>
<html lang="en-us" dir="ltr" itemscope itemtype="http://schema.org/Article" data-r-output-format="print">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="height=device-height, width=device-width, initial-scale=1.0, minimum-scale=1.0">
    <meta name="generator" content="Hugo 0.152.2">
    <meta name="generator" content="Relearn 8.2.0+d150cc8909ed7836ff5d545e76544f6923ffacf5">
    <meta name="description" content="Managing PackagesManaging Packages
Repositories and subscriptionsRepositories and subscriptions">
    <meta name="author" content="David Thomas">
    <meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="Managing Software :: Linux Reader">
    <meta name="twitter:description" content="Managing PackagesManaging Packages
Repositories and subscriptionsRepositories and subscriptions">
    <meta property="og:url" content="http://linuxreader.com/ansible/managing-software/">
    <meta property="og:site_name" content="Linux Reader">
    <meta property="og:title" content="Managing Software :: Linux Reader">
    <meta property="og:description" content="Managing PackagesManaging Packages
Repositories and subscriptionsRepositories and subscriptions">
    <meta property="og:locale" content="en_us">
    <meta property="og:type" content="website">
    <meta itemprop="name" content="Managing Software :: Linux Reader">
    <meta itemprop="description" content="Managing PackagesManaging Packages
Repositories and subscriptionsRepositories and subscriptions">
    <meta itemprop="wordCount" content="8">
    <title>Managing Software :: Linux Reader</title>
    <link href="http://linuxreader.com/ansible/managing-software/" rel="canonical" type="text/html" title="Managing Software :: Linux Reader">
    <link href="/ansible/managing-software/index.xml" rel="alternate" type="application/rss+xml" title="Managing Software :: Linux Reader">
    <link href="/images/favicon.svg?1762473041" rel="icon" type="image/svg+xml">
    <link href="/css/auto-complete/auto-complete.min.css?1762473041" rel="stylesheet">
    <script src="/js/auto-complete/auto-complete.min.js?1762473041" defer></script>
    <script src="/js/search-lunr.min.js?1762473041" defer></script>
    <script src="/js/search.min.js?1762473041" defer></script>
    <script>
      window.relearn = window.relearn || {};
      window.relearn.index_js_url="/searchindex.en.js?1762473041";
    </script>
    <script src="/js/lunr/lunr.min.js?1762473041" defer></script>
    <script src="/js/lunr/lunr.stemmer.support.min.js?1762473041" defer></script>
    <script src="/js/lunr/lunr.multi.min.js?1762473041" defer></script>
    <script src="/js/lunr/lunr.en.min.js?1762473041" defer></script>
    <script>
      window.relearn = window.relearn || {};
      window.relearn.contentLangs=['en'];
    </script>
    <link href="/fonts/fontawesome/css/fontawesome-all.min.css?1762473041" rel="stylesheet" media="print" onload="this.media='all';this.onload=null;"><noscript><link href="/fonts/fontawesome/css/fontawesome-all.min.css?1762473041" rel="stylesheet"></noscript>
    <link href="/css/perfect-scrollbar/perfect-scrollbar.min.css?1762473041" rel="stylesheet">
    <link href="/css/theme.min.css?1762473041" rel="stylesheet">
    <link href="/css/format-print.min.css?1762473041" rel="stylesheet" id="R-format-style">
    <script>
      window.relearn = window.relearn || {};
      // configuration
      window.relearn.min = `.min`;
      window.relearn.path='\/ansible\/managing-software\/';
      window.relearn.relBasePath='..\/..';
      window.relearn.relBaseUri='..\/..';
      window.relearn.absBaseUri='http:\/\/linuxreader.com';
      window.relearn.disableAnchorCopy=false;
      window.relearn.disableAnchorScrolling=false;
      window.relearn.disableInlineCopyToClipboard=true;
      window.relearn.enableBlockCodeWrap=true;
      // legal
      window.relearn.getItem = (s,n) => {return s.getItem(n)};
      window.relearn.setItem = (s,n,v) => {return s.setItem(n,v)};
      window.relearn.removeItem = (s,n) => {return s.removeItem(n)};
      // translations
      window.T_Copy_to_clipboard = `Copy to clipboard`;
      window.T_Copied_to_clipboard = `Copied to clipboard!`;
      window.T_Copy_link_to_clipboard = `Copy link to clipboard`;
      window.T_Link_copied_to_clipboard = `Copied link to clipboard!`;
      window.T_Reset_view = `Reset view`;
      window.T_View_reset = `View reset!`;
      window.T_No_results_found = `No results found for "{0}"`;
      window.T_N_results_found = `{1} results found for "{0}"`;
      // variant stuff
      window.relearn.themevariants = [ 'oled' ];
      window.relearn.customvariantname = "my-custom-variant";
      window.relearn.changeVariant = function(variant) {
        var oldVariant = document.documentElement.dataset.rThemeVariant;
        window.relearn.setItem(window.localStorage, window.relearn.absBaseUri + "/variant", variant);
        document.documentElement.dataset.rThemeVariant = variant;
        if (oldVariant != variant) {
          document.dispatchEvent( new CustomEvent('themeVariantLoaded', { detail: { variant, oldVariant } }) );
          window.relearn.markVariant();
        }
      }
      window.relearn.markVariant = function() {
        var variant = window.relearn.getItem(window.localStorage, window.relearn.absBaseUri + "/variant");
        document.querySelectorAll(".R-variantswitcher select").forEach((select) => {select.value = variant;});
      }
      window.relearn.initVariant = function() {
        var variant = window.relearn.getItem(window.localStorage, window.relearn.absBaseUri + "/variant") ?? "";
        if( variant == window.relearn.customvariantname ){
        }else if( !variant || !window.relearn.themevariants.includes(variant) ){
          variant = window.relearn.themevariants[0];
          window.relearn.setItem(window.localStorage, window.relearn.absBaseUri + "/variant", variant);
        }
        document.documentElement.dataset.rThemeVariant = variant;
      }
      window.relearn.initVariant();
      window.relearn.markVariant();
    </script><style>
:root {
    --MENU-WIDTH-S: 14.375rem;
    --MENU-WIDTH-M: 14.375rem;
    --MENU-WIDTH-L: 18.75rem;
    --MAIN-WIDTH-MAX: 80rem;
    font-size: 1.2rem;
}
</style>

  </head>
  <body class="mobile-support print" data-url="/ansible/managing-software/">
    <div id="R-body" class="default-animation">
      <div id="R-body-overlay"></div>
      <nav id="R-topbar">
        <div class="topbar-wrapper">
          <div class="topbar-sidebar-divider"></div>
          <div class="topbar-area topbar-area-start" data-area="start">
            <div class="topbar-button topbar-button-sidebar" data-content-empty="disable" data-width-s="show" data-width-m="hide" data-width-l="hide">
<span class="btn cstyle link noborder notitle interactive"><button onclick="toggleNav()" type="button" title="Menu (CTRL&#43;ALT&#43;n)"><i class="fa-fw fas fa-bars"></i></button></span>
            </div>
            <div class="topbar-button topbar-button-prev" data-content-empty="disable" data-width-s="show" data-width-m="show" data-width-l="show">
<span class="btn cstyle link noborder notitle interactive"><a href="/ansible/managing-processes-and-tasks/managing-services/" title="Managing Services (ðŸ¡)"><i class="fa-fw fas fa-chevron-left"></i></a></span>
            </div>

            <div class="topbar-button topbar-button-toc" data-content-empty="hide" data-width-s="show" data-width-m="show" data-width-l="show">
<span class="btn cstyle link noborder notitle interactive"><button onclick="toggleTopbarFlyout(this)" type="button" title="Table of Contents (CTRL&#43;ALT&#43;t)"><i class="fa-fw fas fa-list-alt"></i></button></span>
              <div class="topbar-content">
                <div class="topbar-content-wrapper"> 
                </div>
              </div>
            </div>


          </div>
          <span class="topbar-breadcrumbs highlightable">
            Managing Software
          </span>
          <div class="topbar-area topbar-area-end" data-area="end">
            <div class="topbar-button topbar-button-print" data-content-empty="disable" data-width-s="area-more" data-width-m="show" data-width-l="show">
<span class="btn cstyle link noborder notitle interactive"><a href="/ansible/managing-software/index.print.html" title="Print whole chapter (CTRL+ALT+p)"><i class="fa-fw fas fa-print"></i></a></span>
            </div>

            <div class="topbar-button topbar-button-next" data-content-empty="disable" data-width-s="show" data-width-m="show" data-width-l="show">
<span class="btn cstyle link noborder notitle interactive"><a href="/ansible/managing-software/managing-packages/" title="Managing Packages (ðŸ¡’)"><i class="fa-fw fas fa-chevron-right"></i></a></span>
            </div>







          </div>
        </div>
      </nav>
      <div id="R-main-overlay"></div>
      <main id="R-body-inner" class="highlightable ansible" tabindex="-1">
        <div class="flex-block-wrapper">
<article class="default">
  <header class="headline">
  </header>

<h1 id="managing-software">Managing Software</h1>

<div class="children children-type-list children-sort-">
  <div class="children-title children-title-1"><a href="/ansible/managing-software/managing-packages/">Managing Packages</a></div><p>Managing Packages</p>
  <div class="children-title children-title-1"><a href="/ansible/managing-software/repositories-and-subscriptions/">Repositories and subscriptions</a></div><p>Repositories and subscriptions</p>
</div>

  <footer class="footline">
  </footer>
</article>
          <section>
            <h1 class="a11y-only">Subsections of Managing Software</h1>
<article class="default">
  <header class="headline">
  </header>

<h1 id="managing-packages">Managing Packages</h1>

<h3 id="using-modules-to-manage-packages">Using Modules to Manage Packages</h3>
<p>Managing software packages on managed nodes is one of the firstrequirements when working with Ansible. Different modules are available.
<a href="/ansible/managing-software/managing-packages/#ch12.xhtml#tab12_2">Table 12-2</a> provides an overview.</p>
<p><strong>Table 12-2</strong> Software Management Modules Overview</p>
<p><a href="#R-image-a742e0223db6cf310943cc76125b2912" class="lightbox-link"><img alt="Image" class="lazy lightbox figure-image" loading="lazy" src="/Images/12tab02.jpg" style="height: auto;width: auto;"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-a742e0223db6cf310943cc76125b2912"><img alt="Image" class="lazy lightbox lightbox-image" loading="lazy" src="/Images/12tab02.jpg"></a>{width=&ldquo;941&rdquo; height=&ldquo;295&rdquo;}
:::</p>
<h4 id="configuring-repository-access">Configuring Repository Access</h4>
<p>Before you can manage any software packages, you need to set up access
to a repository. To do so, the yum_repository module is provided. If you
have worked with yum repository files in the /etc/yum.repos.d/
directory, using the yum_repository module is not difficult because it
uses the same information.</p>
<p><a href="/ansible/managing-software/managing-packages/#ch12.xhtml#list12_1">Listing 12-1</a> shows an example of a playbook that
sets up access to a yum repository. Notice that this is an example only,
and it doesn&rsquo;t work yet because the repository has not been set up yet.</p>
<p><strong>Listing 12-1</strong> Configuring Repository Access</p>
<p>::: pre_1
&mdash;
- name: setting up repository access
hosts: all
tasks:
- name: connect to example repo
yum_repository:
name: example repo
description: RHCE8 example repo
file: examplerepo
baseurl: <a href="ftp://control.example.com/repo/" rel="external" target="_blank">ftp://control.example.com/repo/</a>
gpgcheck: no
:::</p>
<p>While setting up repository access, you should use a few arguments. You
can see an example of them in <a href="/ansible/managing-software/managing-packages/#ch12.xhtml#list12_1">Listing 12-1</a>.
<a href="/ansible/managing-software/managing-packages/#ch12.xhtml#tab12_3">Table 12-3</a> provides an overview.</p>
<p>::: group
<strong>Table 12-3</strong> yum_repository Key Arguments</p>
<p><a href="#R-image-584bd27d56a8ee9fbfe22421673826fc" class="lightbox-link"><img alt="Image" class="lazy lightbox figure-image" loading="lazy" src="/Images/12tab03.jpg" style="height: auto;width: auto;"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-584bd27d56a8ee9fbfe22421673826fc"><img alt="Image" class="lazy lightbox lightbox-image" loading="lazy" src="/Images/12tab03.jpg"></a>{width=&ldquo;941&rdquo; height=&ldquo;275&rdquo;}
:::</p>
<p>Notice that use of the <strong>gpgcheck</strong> argument is recommended but not
mandatory. Most repositories are provided with a GPG key to verify that
packages in the repository have not been tampered with. However, if no
GPG key is set up for the repository, the <strong>gpgcheck</strong> parameter can be
set to no to skip checking the GPG key.</p>
<h4 class="h4" id="managing-software-with-yum">Managing Software with yum</h4>
<p>The yum module can be used to manage software packages. You use it to
install and remove packages or to update packages. This can be done for
individual packages, as well as package groups and modules. Let&rsquo;s look
at some examples that go beyond the mere installation or removal of
packages, which was covered sufficiently in earlier chapters.</p>
<p><a href="/ansible/managing-software/managing-packages/#ch12.xhtml#list12_2">Listing 12-2</a> shows a module that will update all
packages on this system.</p>
<p><strong>Listing 12-2</strong> Using yum to Perform a System Update</p>
<p>::: pre_1
&mdash;
- name: updating all packages
hosts: ansible2
tasks:
- name: system update
yum:
name: â€™*â€™
state: latest
:::</p>
<p>Notice the use of the <strong>name</strong> argument to the yum module. It has
<strong>&rsquo;*&rsquo;</strong> as its argument. To prevent the wildcard from being interpreted
by the shell, you must make sure it is placed between single quotes.</p>
<p><a href="/ansible/managing-software/managing-packages/#ch12.xhtml#list12_3">Listing 12-3</a> shows an example where yum package
groups are used to install the Virtualization Host package group.</p>
<p><strong>Listing 12-3</strong> Installing Package Groups</p>
<p>::: pre_1
&mdash;
- name: install or update a package group
hosts: ansible2
tasks:
- name: install or update a package group
yum:
name: â€™@Virtualization Hostâ€™
state: latest
:::</p>
<p>When a yum package group instead of an individual package needs to be
installed, the name of the package group needs to start with an at sign
(@), and the entire package group name needs to be put between single
quotes. Also notice the use of <strong>state: latest</strong> in <a href="/ansible/managing-software/managing-packages/#ch12.xhtml#list12_3">Listing
12-3</a>. This line ensures that the packages in the
package group are installed if they have not been installed yet. If they
have already been installed, they are updated to the latest version.</p>
<p>A new feature in RHEL 8 is the yum AppStream module. Modules as listed
by the Linux <strong>yum modules list</strong> command can be managed with the
Ansible yum module also. Working with yum modules is similar to working
with yum package groups. In the example in <a href="/ansible/managing-software/managing-packages/#ch12.xhtml#list12_4">Listing
12-4</a>, the main difference is that a version
number and the installation profile are included in the module name.</p>
<p><strong>Listing 12-4</strong> Installing AppStream Modules with the yum Module</p>
<p>::: pre_1
&mdash;
- name: installing an AppStream module
hosts: ansible2
tasks:
- name: install or update an AppStream module
yum:
name: â€™@php:7.3/develâ€™
state: present
:::</p>
<p>::: note</p>
<hr>
<p><strong>Note</strong></p>
<p>When using the yum module to install multiple packages, you can provide
the <strong>name</strong> argument with a list of multiple packages. Alternatively,
you can provide multiple packages in a loop. Of these solutions, using a
list of multiple packages as the argument to <strong>name</strong> is always
preferred. If multiple package names are provided in a loop, the module
must execute a task for every single package. If multiple package names
are provided as the argument to <strong>name</strong>, yum can install all these
packages in one single task.</p>
<hr>
<p>:::</p>
<h4 class="h4" id="managing-package-facts">Managing Package Facts</h4>
<p>When Ansible is gathering facts, package facts are not included. To
include package facts as well, you need to run a separate task; that is,
you need to use the package_facts module. Facts that have been gathered
about packages are stored to the ansible_facts.packages variable. The
sample playbook in <a href="/ansible/managing-software/managing-packages/#ch12.xhtml#list12_5">Listing 12-5</a> shows how to use
the package_facts module.</p>
<p><strong>Listing 12-5</strong> Using the package_facts Module to Show Package Details</p>
<p>::: pre_1
&mdash;
- name: using package facts
hosts: ansible2
vars:
my_package: nmap
tasks:
- name: install package
yum:
name: &ldquo;{{ my_package }}&rdquo;
state: present
- name: update package facts
package_facts:
manager: auto
- name: show package facts for {{ my_package }}
debug:
var: ansible_facts.packages[my_package]
when: my_package in ansible_facts.packages
:::</p>
<p>As you can see, the package_facts module does not need much to do its
work. The only argument used here is the <strong>manager</strong> argument, which
specifies which package manager to communicate to. Its default value of
<strong>auto</strong> automatically detects the appropriate package manager and uses
that. If you want, you can specify the package manager manually, using
any package manager such as yum or dnf. <a href="/ansible/managing-software/managing-packages/#ch12.xhtml#list12_6">Listing
12-6</a> shows the output of running the <a href="/ansible/managing-software/managing-packages/#ch12.xhtml#list12_5">Listing
12-5</a> playbook, where you can see details that are
collected by the package_facts module.</p>
<p><strong>Listing 12-6</strong> Running <strong>ansible-playbook listing125.yaml</strong> Results</p>
<p>::: pre_1
[ansible@control rhce8-book]$ ansible-playbook listing125.yaml</p>
<pre><code>PLAY [using package facts] **************************************************************

TASK [Gathering Facts] ******************************************************************
ok: [ansible2]

TASK [install package] ******************************************************************
ok: [ansible2]

TASK [update package facts] *************************************************************
ok: [ansible2]

TASK [show package facts for my_package] ************************************************
ok: [ansible2] =&gt; {
    &quot;ansible_facts.packages[my_package]&quot;: [
        {
            &quot;arch&quot;: &quot;x86_64&quot;,
            &quot;epoch&quot;: 2,
            &quot;name&quot;: &quot;nmap&quot;,
            &quot;release&quot;: &quot;5.el8&quot;,
            &quot;source&quot;: &quot;rpm&quot;,
            &quot;version&quot;: &quot;7.70&quot;
        }
    ]
}

PLAY RECAP ******************************************************************************
ansible2                   : ok=4    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0
</code></pre>
<p>:::</p>
<p>In <a href="/ansible/managing-software/managing-packages/#ch12.xhtml#exe12_1">Exercise 12-1</a> you can practice working with
the different tools Ansible provides for module management.</p>
<p>::: box
<strong>Exercise 12-1 Managing Software Packages</strong></p>
<p>1. Use your editor to create a new file with the name exercise121.yaml.</p>
<p>2. Write a play header that defines the variable <strong>my_package</strong> and
sets its value to <strong>virt-manager</strong>:</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0"><code class="language-pre1" data-lang="pre1">---
- name: exercise121
  hosts: ansible2
  vars:
    my_package: virt-manager
  tasks:</code></pre></div>
<p>3. Add a task that installs the package based on the name of the
variable that was provided:</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0"><code class="language-pre1" data-lang="pre1">- name: install package
  yum:
    name: &#34;{{ my_package }}&#34;
    state: present</code></pre></div>
<p>4. Add a task that gathers facts about installed packages:</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0"><code class="language-pre1" data-lang="pre1">- name: update package facts
  package_facts:
    manager: auto</code></pre></div>
<p>5. As the last part of this exercise, add a task that shows facts about
the package that you have just installed:</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0"><code class="language-pre1" data-lang="pre1">- name: show package facts for {{ my_package }}
  debug:
    var: ansible_facts.packages[my_package]
  when: my_package in ansible_facts.packages</code></pre></div>
<p>6. Run the playbook using <strong>ansible-playbook exercise121.yaml</strong> and
verify its output.
:::</p>

  <footer class="footline">
  </footer>
</article>
<article class="default">
  <header class="headline">
  </header>

<h1 id="repositories-and-subscriptions">Repositories and subscriptions</h1>

<h3 id="using-modules-to-manage-repositories-and-subscriptions">Using Modules to Manage Repositories and Subscriptions</h3>
<p>To work with software packages, you need to make sure that repositories
are accessible and subscriptions are available. In the previous section
you learned how to write a playbook that enables you to access an
existing repository. In this section you learn how to set up the server
part of a repository if that still needs to be done. Also, you learn how
to manage RHEL subscriptions using Ansible.</p>
<h4 class="h4" id="setting-up-repositories">Setting Up Repositories</h4>
<p>Most managed systems access the default distributions that are provided
while installing the operating system. In some cases external
repositories might not be accessible. If that happens, you need to set
up a repository yourself. Before you can do that, however, it&rsquo;s
important to know what a repository is. A repository is a directory that
contains RPM files, as well as the repository metadata, which is an
index that allows the repository client to figure out which packages are
available in the repository.</p>
<p>Ansible does not provide a specific module to set up a repository. You
must use a number of modules instead. Exactly which modules are involved
depends on how you want to set up the repository. For instance, if you
want to set up an FTP-based repository on the Ansible control host, you
need to accomplish the following tasks:</p>
<p>â€¢ Install the FTP package.</p>
<p>â€¢ Start and enable the FTP server.</p>
<p>â€¢ Open the firewall for FTP traffic.</p>
<p>â€¢ Make sure the FTP shared repository directory is available.</p>
<p>â€¢ Download packages to the repository directory.</p>
<p>â€¢ Use the Linux <strong>createrepo</strong> command to generate the index that is
required in each repository.</p>
<p>The playbook in <a href="/ansible/managing-software/repositories-and-subscriptions/#ch12.xhtml#list12_7">Listing 12-7</a> provides an example
of how this can be done.</p>
<p><strong>Listing 12-7</strong> Setting Up an FTP-based Repository</p>
<p>::: pre_1
- name: install FTP to export repo
hosts: localhost
tasks:
- name: install FTP server
yum:
name:
- vsftpd
- createrepo_c
state: latest
- name: start FTP server
service:
name: vsftpd
state: started
enabled: yes
- name: open firewall for FTP
firewalld:
service: ftp
state: enabled
permanent: yes</p>
<pre><code>- name: setup the repo directory
  hosts: localhost
  tasks:
  - name: make directory
    file:
      path: /var/ftp/repo
      state: directory
  - name: download packages
    yum:
      name: nmap
      download_only: yes
      download_dir: /var/ftp/repo
  - name: createrepo
    command: createrepo /var/ftp/repo
</code></pre>
<p>:::</p>
<p>The most significant tasks in setting up the repository are the
<strong>download packages</strong> and <strong>createrepo</strong> tasks. In the <strong>download
packages</strong> task, the yum module is used to download a single package. To
do so, the <strong>download_only</strong> argument is used to ensure that the package
is not installed but downloaded to a directory. When you use the
<strong>download_only</strong> argument, you also must specify where the package
needs to be installed. To do this, the task uses the <strong>download_dir</strong>
argument.</p>
<p>There is one disadvantage in using this approach to download the
package, though: it requires repository access. If repository access is
not available, the fetch module can be used instead to download a file
from a specific URL.</p>
<h4 class="h4" id="managing-gpg-keys">Managing GPG Keys</h4>
<p>To guarantee the integrity of packages, most repositories are set up
with a GPG key. This enables the client to verify that packages have not
been tampered with while transmitted between the repository server and
client. For that reason, if packages are installed from a repository
server on the Internet, you should always make sure that <strong>gpgcheck:
yes</strong> is set while using the yum_repository module.</p>
<p>However, if you want to make sure that a GPG check is performed, you
need to make sure the client knows where to fetch the repository key. To
help with that, you can use the rpm_key module. You can see how to do
this in <a href="/ansible/managing-software/repositories-and-subscriptions/#ch12.xhtml#list12_8">Listing 12-8</a>. Notice that the playbook
in this listing doesn&rsquo;t work because no GPG-protected repository is
available. Setting up GPG-protected repositories is complex and outside
the scope of the EX294 objectives, and for that reason is not covered
here.</p>
<p><strong>Listing 12-8</strong> Using rpm_key to Fetch an RPM Key</p>
<p>::: pre_1
- name: use rpm_key in repository access
hosts: all
tasks:
- name: get the GPG public key
rpm_key:
key: <a href="ftp://control.example.com/repo/RPM-GPG-KEY" rel="external" target="_blank">ftp://control.example.com/repo/RPM-GPG-KEY</a>
state: present
- name: set up the repository client
yum_repository:
file: myrepo
name: myrepo
description: example repo
baseurl: <a href="ftp://control.example.com/repo" rel="external" target="_blank">ftp://control.example.com/repo</a>
enabled: yes
gpgcheck: yes
state: present
:::</p>
<h4 class="h4" id="managing-rhel-subscriptions">Managing RHEL Subscriptions</h4>
<p>When you work with Red Hat Enterprise Linux, configuring repository
access using the method described before is not enough. Red Hat
Enterprise Linux works with subscriptions, and to be able to access
software that is provided through your subscription entitlement, you
need to set up managed systems to access these subscriptions.</p>
<p>::: note</p>
<hr>
<p><strong>Tip</strong></p>
<p>Free developer subscriptions are available for RHEL as well as Ansible.
Register yourself at <a href="https://developers.redhat.com" rel="external" target="_blank">https://developers.redhat.com</a> and sign up for a
free subscription if you want to test the topics described in this
section on RHEL and you don&rsquo;t have a valid subscription yet.</p>
<hr>
<p>:::</p>
<p>To understand how to use the Ansible modules to register a RHEL system,
you need to understand how to use the Linux command-line utilities. When
you are managing subscriptions from the Linux command line, multiple
steps are involved.</p>
<p>1. First, you use the <strong>subscription-manager register</strong> command to
provide your RHEL credentials. Use, for instance, <strong>subscription-manager
register --username=yourname --password=yourpassword</strong>.</p>
<p>2. Next, you need to find out which pools are available in your
account. A pool is a collection of software channels available to your
account. Use <strong>subscription-manager list --available</strong> for an overview.</p>
<p>3. Now you can connect to a specific pool using <strong>subscription-manager
attach --pool=<em>poolID</em></strong>. Note that if only one subscription pool is
available in your account, you don&rsquo;t have to provide the <strong>--pool</strong>
argument.</p>
<p>4. Next, you need to find out which additional repositories are
available to your account by using <strong>subscription-manager repos
--list</strong>.</p>
<p>5. To register to use additional repositories, you use
<strong>subscription-manager repos --enable &ldquo;repos name&rdquo;</strong>. Your system then
has full access to its subscription and related repositories.</p>
<p>Two significant modules are provided by Ansible:</p>
<p>â€¢ <strong>redhat_subscription:</strong> This module enables you to perform
subscription and registration in one task.</p>
<p>â€¢ <strong>rhsm_repository:</strong> This module enables you to add subscription
manager repositories.</p>
<p><a href="/ansible/managing-software/repositories-and-subscriptions/#ch12.xhtml#list12_9">Listing 12-9</a> shows an example of a playbook that
uses these modules to fully register a new RHEL 8 machine and add a new
repository to the managed machine. Notice that this playbook is not
runnable as such because important additional information needs to be
provided. <a href="/ansible/managing-software/repositories-and-subscriptions/#ch12.xhtml#exe12_3">Exercise 12-3</a>, later in the section
titled &ldquo;Implementing a Playbook to Manage Software,&rdquo; will guide you to a
scenario that shows how to use this code in production.</p>
<p><strong>Listing 12-9</strong> Using Subscription Manager to Set Up Ansible</p>
<p>::: pre_1
&mdash;
- name: use subscription manager to register and set up repos
hosts: ansible5
tasks:
- name: register and subscribe ansible5
redhat_subscription:
username: <a href="mailto:bob@example.com" rel="external" target="_blank">bob@example.com</a>
password: verysecretpassword
state: present
- name: configure additional repo access
rhsm_repository:
name:
- rh-gluster-3-client-for-rhel-8-x86_64-rpms
- rhel-8-for-x86_64-appstream-debug-rpms
state: present
:::</p>
<p>In the sample playbook in <a href="/ansible/managing-software/repositories-and-subscriptions/#ch12.xhtml#list12_9">Listing 12-9</a>, you can
see how the redhat_subscription and rhsm_repository modules are used.
Notice that redhat_subscription requires a password. In <a href="/ansible/managing-software/repositories-and-subscriptions/#ch12.xhtml#list12_9">Listing
12-9</a> the username and password are provided as
clear-text values in the playbook. From a security perspective, this is
very bad practice. You should use Ansible Vault instead. <a href="/ansible/managing-software/repositories-and-subscriptions/#ch12.xhtml#exe12_3">Exercise
12-3</a> will guide you through a setup where this is
done.</p>
<p>In <a href="/ansible/managing-software/repositories-and-subscriptions/#ch12.xhtml#exe12_2">Exercise 12-2</a> you are guided through the
procedure of setting up your own repository and using it. This procedure
consists of two distinct parts. In the first part you set up a
repository server that is based on FTP. Because in Ansible you often
need to configure topics that don&rsquo;t have your primary attention, you set
up the FTP server and also change its configuration. Next, you write a
second playbook that configures the clients with appropriate repository
access, and after doing so, install a package.</p>
<p>::: box
<strong>Exercise 12-2 Setting Up a Repository</strong></p>
<p>1. Use your editor to create the file exercise122-server.yaml.</p>
<p>2. Define the play that sets up the basic FTP configuration. Because
all its tasks should be familiar to you at this point, you can enter all
the tasks at once:</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0"><code class="language-pre1" data-lang="pre1">---
- name: install, configure, start and enable FTP
  hosts: localhost
  tasks:
  - name: install FTP server
    yum:
      name: vsftpd
      state: latest
  - name: allow anonymous access to FTP
    lineinfile:
      path: /etc/vsftpd/vsftpd.conf
      regexp: â€™^anonymous_enable=NOâ€™
      line: anonymous_enable=YES
  - name: start FTP server
    service:
      name: vsftpd
      state: started
      enabled: yes
  - name: open firewall for FTP
    firewalld:
      service: ftp
      state: enabled
      immediate: yes
      permanent: yes</code></pre></div>
<p>3. Set up a repository directory. Add the following play to the
playbook. Notice the use of the download packages task, which uses the
yum module to download a package without installing it. Also notice the
createrepo task, which creates the repository metadata that converts the
/var/ftp/repo directory into a repository.</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0"><code class="language-pre1" data-lang="pre1">- name: setup the repo directory
  hosts: localhost
  tasks:
  - name: make directory
    file:
      path: /var/ftp/repo
      state: directory
  - name: download packages
    yum:
      name: nmap
      download_only: yes
      download_dir: /var/ftp/repo
  - name: install createrepo package
    yum:
      name: createrepo_c
      state: latest
  - name: createrepo
    command: createrepo /var/ftp/repo
    notify:
    - restart_ftp
  handlers:
  - name: restart_ftp
    service:
      name: vsftpd
      state: restarted</code></pre></div>
<p>4. Use the command <strong>ansible-playbook exercise122-server.yaml</strong> to set
up the FTP server on control.example.com. If you haven&rsquo;t made any typos,
you shouldn&rsquo;t encounter any errors.</p>
<p>5. Now that the repository server has been installed, it&rsquo;s time to set
up the repository client. Use your editor to create the file
exercise122-client.yaml and write the play header as follows:</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0"><code class="language-pre1" data-lang="pre1">---
- name: configure repository
  hosts: all
  vars:
    my_package: nmap
  tasks:</code></pre></div>
<p>6. Add a task that uses the yum_repository module to configure access
to the new repository:</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0"><code class="language-pre1" data-lang="pre1">- name: connect to example repo
  yum_repository:
    name: exercise122
    description: RHCE8 exercise 122 repo
    file: exercise122
    baseurl: ftp://control.example.com/repo/
    gpgcheck: no</code></pre></div>
<p>7. After setting up the repository client, you also need to make sure
that the clients know how to reach the repository server by addressing
its name. Add the next task that writes a new line to /etc/hosts to make
sure host name resolving on the clients is set up correctly:</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0"><code class="language-pre1" data-lang="pre1">- name: ensure control is resolvable
  lineinfile:
    path: /etc/hosts
    line: 192.168.4.200  control.example.com  control

- name: install package
  yum:
    name: &#34;{{ my_package }}&#34;
    state: present</code></pre></div>
<p>8. If you are using the package_facts module, you need to remember to
update it after installing new packages. Add the following task to get
this done:</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0"><code class="language-pre1" data-lang="pre1">- name: update package facts
  package_facts:
    manager: auto</code></pre></div>
<p>9. As the last task, just because it&rsquo;s fun, use the debug module
together with the package facts to get information about the newly
installed package:</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0"><code class="language-pre1" data-lang="pre1">- name: show package facts for {{ my_package }}
  debug:
    var: ansible_facts.packages[my_package]
  when: my_package in ansible_facts.packages</code></pre></div>
<p>10. Use the command <strong>ansible-playbook exercise122-client.yaml -e
my_package=redis</strong>. That&rsquo;s right; this command overwrites the my_package
variable that was set in the playbook&mdash;just to remind you a bit about
variable precedence.
:::</p>

  <footer class="footline">
  </footer>
</article>
          </section>
        </div>
      </main>
    </div>
    <script>
      window.MathJax = Object.assign( window.MathJax || {}, {
        tex: {
          inlineMath:  [['\\(', '\\)'], ['$',  '$']],  
          displayMath: [['\\[', '\\]'], ['$$', '$$']], 
        },
        options: {
          enableMenu: false 
        }
      }, JSON.parse("{}") );
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="/js/js-yaml/js-yaml.min.js?1762473041" defer></script>
    <script src="/js/d3/d3-color.min.js?1762473041" defer></script>
    <script src="/js/d3/d3-dispatch.min.js?1762473041" defer></script>
    <script src="/js/d3/d3-drag.min.js?1762473041" defer></script>
    <script src="/js/d3/d3-ease.min.js?1762473041" defer></script>
    <script src="/js/d3/d3-interpolate.min.js?1762473041" defer></script>
    <script src="/js/d3/d3-selection.min.js?1762473041" defer></script>
    <script src="/js/d3/d3-timer.min.js?1762473041" defer></script>
    <script src="/js/d3/d3-transition.min.js?1762473041" defer></script>
    <script src="/js/d3/d3-zoom.min.js?1762473041" defer></script>
    <script src="https://unpkg.com/mermaid/dist/mermaid.min.js" defer></script>
    <script>
      window.relearn.themeUseMermaid = JSON.parse("{ \"theme\": \"default\" }");
    </script>
    <script src="/js/clipboard/clipboard.min.js?1762473041" defer></script>
    <script src="/js/perfect-scrollbar/perfect-scrollbar.min.js?1762473041" defer></script>
    <script src="/js/theme.min.js?1762473041" defer></script>
  </body>
</html>
